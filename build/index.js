var yQ=Object.defineProperty;var j0=(Q,$)=>{for(var K in $)yQ(Q,K,{get:$[K],enumerable:!0,configurable:!0,set:(J)=>$[K]=()=>J})};var D=0.000001,T=typeof Float32Array!=="undefined"?Float32Array:Array,l=Math.random,QJ=Math.PI/180;if(!Math.hypot)Math.hypot=function(){var Q=0,$=arguments.length;while($--)Q+=arguments[$]*arguments[$];return Math.sqrt(Q)};function d0(){var Q=new T(9);if(T!=Float32Array)Q[1]=0,Q[2]=0,Q[3]=0,Q[5]=0,Q[6]=0,Q[7]=0;return Q[0]=1,Q[4]=1,Q[8]=1,Q}var q={};j0(q,{transpose:()=>{{return dQ}},translate:()=>{{return eQ}},targetTo:()=>{{return R$}},subtract:()=>{{return a0}},sub:()=>{{return S$}},str:()=>{{return k$}},set:()=>{{return iQ}},scale:()=>{{return uQ}},rotateZ:()=>{{return Q$}},rotateY:()=>{{return tQ}},rotateX:()=>{{return aQ}},rotate:()=>{{return oQ}},perspectiveZO:()=>{{return C$}},perspectiveNO:()=>{{return u0}},perspectiveFromFieldOfView:()=>{{return U$}},perspective:()=>{{return j$}},orthoZO:()=>{{return E$}},orthoNO:()=>{{return o0}},ortho:()=>{{return O$}},multiplyScalarAndAdd:()=>{{return M$}},multiplyScalar:()=>{{return G$}},multiply:()=>{{return b0}},mul:()=>{{return T$}},lookAt:()=>{{return N$}},invert:()=>{{return sQ}},identity:()=>{{return s0}},getTranslation:()=>{{return P$}},getScaling:()=>{{return e0}},getRotation:()=>{{return F$}},frustum:()=>{{return W$}},fromZRotation:()=>{{return Y$}},fromYRotation:()=>{{return V$}},fromXRotation:()=>{{return B$}},fromValues:()=>{{return mQ}},fromTranslation:()=>{{return $$}},fromScaling:()=>{{return K$}},fromRotationTranslationScaleOrigin:()=>{{return X$}},fromRotationTranslationScale:()=>{{return H$}},fromRotationTranslation:()=>{{return r0}},fromRotation:()=>{{return J$}},fromQuat2:()=>{{return Z$}},fromQuat:()=>{{return A$}},frob:()=>{{return _$}},exactEquals:()=>{{return q$}},equals:()=>{{return L$}},determinant:()=>{{return rQ}},create:()=>{{return cQ}},copy:()=>{{return lQ}},clone:()=>{{return nQ}},adjoint:()=>{{return bQ}},add:()=>{{return D$}}});function cQ(){var Q=new T(16);if(T!=Float32Array)Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0;return Q[0]=1,Q[5]=1,Q[10]=1,Q[15]=1,Q}function nQ(Q){var $=new T(16);return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$[3]=Q[3],$[4]=Q[4],$[5]=Q[5],$[6]=Q[6],$[7]=Q[7],$[8]=Q[8],$[9]=Q[9],$[10]=Q[10],$[11]=Q[11],$[12]=Q[12],$[13]=Q[13],$[14]=Q[14],$[15]=Q[15],$}function lQ(Q,$){return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q[3]=$[3],Q[4]=$[4],Q[5]=$[5],Q[6]=$[6],Q[7]=$[7],Q[8]=$[8],Q[9]=$[9],Q[10]=$[10],Q[11]=$[11],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15],Q}function mQ(Q,$,K,J,B,V,Y,Z,P,F,H,X,j,W,U,C){var A=new T(16);return A[0]=Q,A[1]=$,A[2]=K,A[3]=J,A[4]=B,A[5]=V,A[6]=Y,A[7]=Z,A[8]=P,A[9]=F,A[10]=H,A[11]=X,A[12]=j,A[13]=W,A[14]=U,A[15]=C,A}function iQ(Q,$,K,J,B,V,Y,Z,P,F,H,X,j,W,U,C,A){return Q[0]=$,Q[1]=K,Q[2]=J,Q[3]=B,Q[4]=V,Q[5]=Y,Q[6]=Z,Q[7]=P,Q[8]=F,Q[9]=H,Q[10]=X,Q[11]=j,Q[12]=W,Q[13]=U,Q[14]=C,Q[15]=A,Q}function s0(Q){return Q[0]=1,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=1,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=1,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function dQ(Q,$){if(Q===$){var K=$[1],J=$[2],B=$[3],V=$[6],Y=$[7],Z=$[11];Q[1]=$[4],Q[2]=$[8],Q[3]=$[12],Q[4]=K,Q[6]=$[9],Q[7]=$[13],Q[8]=J,Q[9]=V,Q[11]=$[14],Q[12]=B,Q[13]=Y,Q[14]=Z}else Q[0]=$[0],Q[1]=$[4],Q[2]=$[8],Q[3]=$[12],Q[4]=$[1],Q[5]=$[5],Q[6]=$[9],Q[7]=$[13],Q[8]=$[2],Q[9]=$[6],Q[10]=$[10],Q[11]=$[14],Q[12]=$[3],Q[13]=$[7],Q[14]=$[11],Q[15]=$[15];return Q}function sQ(Q,$){var K=$[0],J=$[1],B=$[2],V=$[3],Y=$[4],Z=$[5],P=$[6],F=$[7],H=$[8],X=$[9],j=$[10],W=$[11],U=$[12],C=$[13],A=$[14],E=$[15],G=K*Z-J*Y,_=K*P-B*Y,k=K*F-V*Y,N=J*P-B*Z,R=J*F-V*Z,w=B*F-V*P,S=H*C-X*U,h=H*A-j*U,I=H*E-W*U,v=X*A-j*C,g=X*E-W*C,p=j*E-W*A,M=G*p-_*g+k*v+N*I-R*h+w*S;if(!M)return null;return M=1/M,Q[0]=(Z*p-P*g+F*v)*M,Q[1]=(B*g-J*p-V*v)*M,Q[2]=(C*w-A*R+E*N)*M,Q[3]=(j*R-X*w-W*N)*M,Q[4]=(P*I-Y*p-F*h)*M,Q[5]=(K*p-B*I+V*h)*M,Q[6]=(A*k-U*w-E*_)*M,Q[7]=(H*w-j*k+W*_)*M,Q[8]=(Y*g-Z*I+F*S)*M,Q[9]=(J*I-K*g-V*S)*M,Q[10]=(U*R-C*k+E*G)*M,Q[11]=(X*k-H*R-W*G)*M,Q[12]=(Z*h-Y*v-P*S)*M,Q[13]=(K*v-J*h+B*S)*M,Q[14]=(C*_-U*N-A*G)*M,Q[15]=(H*N-X*_+j*G)*M,Q}function bQ(Q,$){var K=$[0],J=$[1],B=$[2],V=$[3],Y=$[4],Z=$[5],P=$[6],F=$[7],H=$[8],X=$[9],j=$[10],W=$[11],U=$[12],C=$[13],A=$[14],E=$[15];return Q[0]=Z*(j*E-W*A)-X*(P*E-F*A)+C*(P*W-F*j),Q[1]=-(J*(j*E-W*A)-X*(B*E-V*A)+C*(B*W-V*j)),Q[2]=J*(P*E-F*A)-Z*(B*E-V*A)+C*(B*F-V*P),Q[3]=-(J*(P*W-F*j)-Z*(B*W-V*j)+X*(B*F-V*P)),Q[4]=-(Y*(j*E-W*A)-H*(P*E-F*A)+U*(P*W-F*j)),Q[5]=K*(j*E-W*A)-H*(B*E-V*A)+U*(B*W-V*j),Q[6]=-(K*(P*E-F*A)-Y*(B*E-V*A)+U*(B*F-V*P)),Q[7]=K*(P*W-F*j)-Y*(B*W-V*j)+H*(B*F-V*P),Q[8]=Y*(X*E-W*C)-H*(Z*E-F*C)+U*(Z*W-F*X),Q[9]=-(K*(X*E-W*C)-H*(J*E-V*C)+U*(J*W-V*X)),Q[10]=K*(Z*E-F*C)-Y*(J*E-V*C)+U*(J*F-V*Z),Q[11]=-(K*(Z*W-F*X)-Y*(J*W-V*X)+H*(J*F-V*Z)),Q[12]=-(Y*(X*A-j*C)-H*(Z*A-P*C)+U*(Z*j-P*X)),Q[13]=K*(X*A-j*C)-H*(J*A-B*C)+U*(J*j-B*X),Q[14]=-(K*(Z*A-P*C)-Y*(J*A-B*C)+U*(J*P-B*Z)),Q[15]=K*(Z*j-P*X)-Y*(J*j-B*X)+H*(J*P-B*Z),Q}function rQ(Q){var $=Q[0],K=Q[1],J=Q[2],B=Q[3],V=Q[4],Y=Q[5],Z=Q[6],P=Q[7],F=Q[8],H=Q[9],X=Q[10],j=Q[11],W=Q[12],U=Q[13],C=Q[14],A=Q[15],E=$*Y-K*V,G=$*Z-J*V,_=$*P-B*V,k=K*Z-J*Y,N=K*P-B*Y,R=J*P-B*Z,w=F*U-H*W,S=F*C-X*W,h=F*A-j*W,I=H*C-X*U,v=H*A-j*U,g=X*A-j*C;return E*g-G*v+_*I+k*h-N*S+R*w}function b0(Q,$,K){var J=$[0],B=$[1],V=$[2],Y=$[3],Z=$[4],P=$[5],F=$[6],H=$[7],X=$[8],j=$[9],W=$[10],U=$[11],C=$[12],A=$[13],E=$[14],G=$[15],_=K[0],k=K[1],N=K[2],R=K[3];return Q[0]=_*J+k*Z+N*X+R*C,Q[1]=_*B+k*P+N*j+R*A,Q[2]=_*V+k*F+N*W+R*E,Q[3]=_*Y+k*H+N*U+R*G,_=K[4],k=K[5],N=K[6],R=K[7],Q[4]=_*J+k*Z+N*X+R*C,Q[5]=_*B+k*P+N*j+R*A,Q[6]=_*V+k*F+N*W+R*E,Q[7]=_*Y+k*H+N*U+R*G,_=K[8],k=K[9],N=K[10],R=K[11],Q[8]=_*J+k*Z+N*X+R*C,Q[9]=_*B+k*P+N*j+R*A,Q[10]=_*V+k*F+N*W+R*E,Q[11]=_*Y+k*H+N*U+R*G,_=K[12],k=K[13],N=K[14],R=K[15],Q[12]=_*J+k*Z+N*X+R*C,Q[13]=_*B+k*P+N*j+R*A,Q[14]=_*V+k*F+N*W+R*E,Q[15]=_*Y+k*H+N*U+R*G,Q}function eQ(Q,$,K){var J=K[0],B=K[1],V=K[2],Y,Z,P,F,H,X,j,W,U,C,A,E;if($===Q)Q[12]=$[0]*J+$[4]*B+$[8]*V+$[12],Q[13]=$[1]*J+$[5]*B+$[9]*V+$[13],Q[14]=$[2]*J+$[6]*B+$[10]*V+$[14],Q[15]=$[3]*J+$[7]*B+$[11]*V+$[15];else Y=$[0],Z=$[1],P=$[2],F=$[3],H=$[4],X=$[5],j=$[6],W=$[7],U=$[8],C=$[9],A=$[10],E=$[11],Q[0]=Y,Q[1]=Z,Q[2]=P,Q[3]=F,Q[4]=H,Q[5]=X,Q[6]=j,Q[7]=W,Q[8]=U,Q[9]=C,Q[10]=A,Q[11]=E,Q[12]=Y*J+H*B+U*V+$[12],Q[13]=Z*J+X*B+C*V+$[13],Q[14]=P*J+j*B+A*V+$[14],Q[15]=F*J+W*B+E*V+$[15];return Q}function uQ(Q,$,K){var J=K[0],B=K[1],V=K[2];return Q[0]=$[0]*J,Q[1]=$[1]*J,Q[2]=$[2]*J,Q[3]=$[3]*J,Q[4]=$[4]*B,Q[5]=$[5]*B,Q[6]=$[6]*B,Q[7]=$[7]*B,Q[8]=$[8]*V,Q[9]=$[9]*V,Q[10]=$[10]*V,Q[11]=$[11]*V,Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15],Q}function oQ(Q,$,K,J){var B=J[0],V=J[1],Y=J[2],Z=Math.hypot(B,V,Y),P,F,H,X,j,W,U,C,A,E,G,_,k,N,R,w,S,h,I,v,g,p,M,y;if(Z<D)return null;if(Z=1/Z,B*=Z,V*=Z,Y*=Z,P=Math.sin(K),F=Math.cos(K),H=1-F,X=$[0],j=$[1],W=$[2],U=$[3],C=$[4],A=$[5],E=$[6],G=$[7],_=$[8],k=$[9],N=$[10],R=$[11],w=B*B*H+F,S=V*B*H+Y*P,h=Y*B*H-V*P,I=B*V*H-Y*P,v=V*V*H+F,g=Y*V*H+B*P,p=B*Y*H+V*P,M=V*Y*H-B*P,y=Y*Y*H+F,Q[0]=X*w+C*S+_*h,Q[1]=j*w+A*S+k*h,Q[2]=W*w+E*S+N*h,Q[3]=U*w+G*S+R*h,Q[4]=X*I+C*v+_*g,Q[5]=j*I+A*v+k*g,Q[6]=W*I+E*v+N*g,Q[7]=U*I+G*v+R*g,Q[8]=X*p+C*M+_*y,Q[9]=j*p+A*M+k*y,Q[10]=W*p+E*M+N*y,Q[11]=U*p+G*M+R*y,$!==Q)Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q}function aQ(Q,$,K){var J=Math.sin(K),B=Math.cos(K),V=$[4],Y=$[5],Z=$[6],P=$[7],F=$[8],H=$[9],X=$[10],j=$[11];if($!==Q)Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q[3]=$[3],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q[4]=V*B+F*J,Q[5]=Y*B+H*J,Q[6]=Z*B+X*J,Q[7]=P*B+j*J,Q[8]=F*B-V*J,Q[9]=H*B-Y*J,Q[10]=X*B-Z*J,Q[11]=j*B-P*J,Q}function tQ(Q,$,K){var J=Math.sin(K),B=Math.cos(K),V=$[0],Y=$[1],Z=$[2],P=$[3],F=$[8],H=$[9],X=$[10],j=$[11];if($!==Q)Q[4]=$[4],Q[5]=$[5],Q[6]=$[6],Q[7]=$[7],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q[0]=V*B-F*J,Q[1]=Y*B-H*J,Q[2]=Z*B-X*J,Q[3]=P*B-j*J,Q[8]=V*J+F*B,Q[9]=Y*J+H*B,Q[10]=Z*J+X*B,Q[11]=P*J+j*B,Q}function Q$(Q,$,K){var J=Math.sin(K),B=Math.cos(K),V=$[0],Y=$[1],Z=$[2],P=$[3],F=$[4],H=$[5],X=$[6],j=$[7];if($!==Q)Q[8]=$[8],Q[9]=$[9],Q[10]=$[10],Q[11]=$[11],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q[0]=V*B+F*J,Q[1]=Y*B+H*J,Q[2]=Z*B+X*J,Q[3]=P*B+j*J,Q[4]=F*B-V*J,Q[5]=H*B-Y*J,Q[6]=X*B-Z*J,Q[7]=j*B-P*J,Q}function $$(Q,$){return Q[0]=1,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=1,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=1,Q[11]=0,Q[12]=$[0],Q[13]=$[1],Q[14]=$[2],Q[15]=1,Q}function K$(Q,$){return Q[0]=$[0],Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=$[1],Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=$[2],Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function J$(Q,$,K){var J=K[0],B=K[1],V=K[2],Y=Math.hypot(J,B,V),Z,P,F;if(Y<D)return null;return Y=1/Y,J*=Y,B*=Y,V*=Y,Z=Math.sin($),P=Math.cos($),F=1-P,Q[0]=J*J*F+P,Q[1]=B*J*F+V*Z,Q[2]=V*J*F-B*Z,Q[3]=0,Q[4]=J*B*F-V*Z,Q[5]=B*B*F+P,Q[6]=V*B*F+J*Z,Q[7]=0,Q[8]=J*V*F+B*Z,Q[9]=B*V*F-J*Z,Q[10]=V*V*F+P,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function B$(Q,$){var K=Math.sin($),J=Math.cos($);return Q[0]=1,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=J,Q[6]=K,Q[7]=0,Q[8]=0,Q[9]=-K,Q[10]=J,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function V$(Q,$){var K=Math.sin($),J=Math.cos($);return Q[0]=J,Q[1]=0,Q[2]=-K,Q[3]=0,Q[4]=0,Q[5]=1,Q[6]=0,Q[7]=0,Q[8]=K,Q[9]=0,Q[10]=J,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function Y$(Q,$){var K=Math.sin($),J=Math.cos($);return Q[0]=J,Q[1]=K,Q[2]=0,Q[3]=0,Q[4]=-K,Q[5]=J,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=1,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function r0(Q,$,K){var J=$[0],B=$[1],V=$[2],Y=$[3],Z=J+J,P=B+B,F=V+V,H=J*Z,X=J*P,j=J*F,W=B*P,U=B*F,C=V*F,A=Y*Z,E=Y*P,G=Y*F;return Q[0]=1-(W+C),Q[1]=X+G,Q[2]=j-E,Q[3]=0,Q[4]=X-G,Q[5]=1-(H+C),Q[6]=U+A,Q[7]=0,Q[8]=j+E,Q[9]=U-A,Q[10]=1-(H+W),Q[11]=0,Q[12]=K[0],Q[13]=K[1],Q[14]=K[2],Q[15]=1,Q}function Z$(Q,$){var K=new T(3),J=-$[0],B=-$[1],V=-$[2],Y=$[3],Z=$[4],P=$[5],F=$[6],H=$[7],X=J*J+B*B+V*V+Y*Y;if(X>0)K[0]=(Z*Y+H*J+P*V-F*B)*2/X,K[1]=(P*Y+H*B+F*J-Z*V)*2/X,K[2]=(F*Y+H*V+Z*B-P*J)*2/X;else K[0]=(Z*Y+H*J+P*V-F*B)*2,K[1]=(P*Y+H*B+F*J-Z*V)*2,K[2]=(F*Y+H*V+Z*B-P*J)*2;return r0(Q,$,K),Q}function P$(Q,$){return Q[0]=$[12],Q[1]=$[13],Q[2]=$[14],Q}function e0(Q,$){var K=$[0],J=$[1],B=$[2],V=$[4],Y=$[5],Z=$[6],P=$[8],F=$[9],H=$[10];return Q[0]=Math.hypot(K,J,B),Q[1]=Math.hypot(V,Y,Z),Q[2]=Math.hypot(P,F,H),Q}function F$(Q,$){var K=new T(3);e0(K,$);var J=1/K[0],B=1/K[1],V=1/K[2],Y=$[0]*J,Z=$[1]*B,P=$[2]*V,F=$[4]*J,H=$[5]*B,X=$[6]*V,j=$[8]*J,W=$[9]*B,U=$[10]*V,C=Y+H+U,A=0;if(C>0)A=Math.sqrt(C+1)*2,Q[3]=0.25*A,Q[0]=(X-W)/A,Q[1]=(j-P)/A,Q[2]=(Z-F)/A;else if(Y>H&&Y>U)A=Math.sqrt(1+Y-H-U)*2,Q[3]=(X-W)/A,Q[0]=0.25*A,Q[1]=(Z+F)/A,Q[2]=(j+P)/A;else if(H>U)A=Math.sqrt(1+H-Y-U)*2,Q[3]=(j-P)/A,Q[0]=(Z+F)/A,Q[1]=0.25*A,Q[2]=(X+W)/A;else A=Math.sqrt(1+U-Y-H)*2,Q[3]=(Z-F)/A,Q[0]=(j+P)/A,Q[1]=(X+W)/A,Q[2]=0.25*A;return Q}function H$(Q,$,K,J){var B=$[0],V=$[1],Y=$[2],Z=$[3],P=B+B,F=V+V,H=Y+Y,X=B*P,j=B*F,W=B*H,U=V*F,C=V*H,A=Y*H,E=Z*P,G=Z*F,_=Z*H,k=J[0],N=J[1],R=J[2];return Q[0]=(1-(U+A))*k,Q[1]=(j+_)*k,Q[2]=(W-G)*k,Q[3]=0,Q[4]=(j-_)*N,Q[5]=(1-(X+A))*N,Q[6]=(C+E)*N,Q[7]=0,Q[8]=(W+G)*R,Q[9]=(C-E)*R,Q[10]=(1-(X+U))*R,Q[11]=0,Q[12]=K[0],Q[13]=K[1],Q[14]=K[2],Q[15]=1,Q}function X$(Q,$,K,J,B){var V=$[0],Y=$[1],Z=$[2],P=$[3],F=V+V,H=Y+Y,X=Z+Z,j=V*F,W=V*H,U=V*X,C=Y*H,A=Y*X,E=Z*X,G=P*F,_=P*H,k=P*X,N=J[0],R=J[1],w=J[2],S=B[0],h=B[1],I=B[2],v=(1-(C+E))*N,g=(W+k)*N,p=(U-_)*N,M=(W-k)*R,y=(1-(j+E))*R,s=(A+G)*R,b=(U+_)*w,m0=(A-G)*w,i0=(1-(j+C))*w;return Q[0]=v,Q[1]=g,Q[2]=p,Q[3]=0,Q[4]=M,Q[5]=y,Q[6]=s,Q[7]=0,Q[8]=b,Q[9]=m0,Q[10]=i0,Q[11]=0,Q[12]=K[0]+S-(v*S+M*h+b*I),Q[13]=K[1]+h-(g*S+y*h+m0*I),Q[14]=K[2]+I-(p*S+s*h+i0*I),Q[15]=1,Q}function A$(Q,$){var K=$[0],J=$[1],B=$[2],V=$[3],Y=K+K,Z=J+J,P=B+B,F=K*Y,H=J*Y,X=J*Z,j=B*Y,W=B*Z,U=B*P,C=V*Y,A=V*Z,E=V*P;return Q[0]=1-X-U,Q[1]=H+E,Q[2]=j-A,Q[3]=0,Q[4]=H-E,Q[5]=1-F-U,Q[6]=W+C,Q[7]=0,Q[8]=j+A,Q[9]=W-C,Q[10]=1-F-X,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function W$(Q,$,K,J,B,V,Y){var Z=1/(K-$),P=1/(B-J),F=1/(V-Y);return Q[0]=V*2*Z,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=V*2*P,Q[6]=0,Q[7]=0,Q[8]=(K+$)*Z,Q[9]=(B+J)*P,Q[10]=(Y+V)*F,Q[11]=-1,Q[12]=0,Q[13]=0,Q[14]=Y*V*2*F,Q[15]=0,Q}function u0(Q,$,K,J,B){var V=1/Math.tan($/2),Y;if(Q[0]=V/K,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=V,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[11]=-1,Q[12]=0,Q[13]=0,Q[15]=0,B!=null&&B!==Infinity)Y=1/(J-B),Q[10]=(B+J)*Y,Q[14]=2*B*J*Y;else Q[10]=-1,Q[14]=-2*J;return Q}function C$(Q,$,K,J,B){var V=1/Math.tan($/2),Y;if(Q[0]=V/K,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=V,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[11]=-1,Q[12]=0,Q[13]=0,Q[15]=0,B!=null&&B!==Infinity)Y=1/(J-B),Q[10]=B*Y,Q[14]=B*J*Y;else Q[10]=-1,Q[14]=-J;return Q}function U$(Q,$,K,J){var B=Math.tan($.upDegrees*Math.PI/180),V=Math.tan($.downDegrees*Math.PI/180),Y=Math.tan($.leftDegrees*Math.PI/180),Z=Math.tan($.rightDegrees*Math.PI/180),P=2/(Y+Z),F=2/(B+V);return Q[0]=P,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=F,Q[6]=0,Q[7]=0,Q[8]=-((Y-Z)*P*0.5),Q[9]=(B-V)*F*0.5,Q[10]=J/(K-J),Q[11]=-1,Q[12]=0,Q[13]=0,Q[14]=J*K/(K-J),Q[15]=0,Q}function o0(Q,$,K,J,B,V,Y){var Z=1/($-K),P=1/(J-B),F=1/(V-Y);return Q[0]=-2*Z,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=-2*P,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=2*F,Q[11]=0,Q[12]=($+K)*Z,Q[13]=(B+J)*P,Q[14]=(Y+V)*F,Q[15]=1,Q}function E$(Q,$,K,J,B,V,Y){var Z=1/($-K),P=1/(J-B),F=1/(V-Y);return Q[0]=-2*Z,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=-2*P,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=F,Q[11]=0,Q[12]=($+K)*Z,Q[13]=(B+J)*P,Q[14]=V*F,Q[15]=1,Q}function N$(Q,$,K,J){var B,V,Y,Z,P,F,H,X,j,W,U=$[0],C=$[1],A=$[2],E=J[0],G=J[1],_=J[2],k=K[0],N=K[1],R=K[2];if(Math.abs(U-k)<D&&Math.abs(C-N)<D&&Math.abs(A-R)<D)return s0(Q);if(H=U-k,X=C-N,j=A-R,W=1/Math.hypot(H,X,j),H*=W,X*=W,j*=W,B=G*j-_*X,V=_*H-E*j,Y=E*X-G*H,W=Math.hypot(B,V,Y),!W)B=0,V=0,Y=0;else W=1/W,B*=W,V*=W,Y*=W;if(Z=X*Y-j*V,P=j*B-H*Y,F=H*V-X*B,W=Math.hypot(Z,P,F),!W)Z=0,P=0,F=0;else W=1/W,Z*=W,P*=W,F*=W;return Q[0]=B,Q[1]=Z,Q[2]=H,Q[3]=0,Q[4]=V,Q[5]=P,Q[6]=X,Q[7]=0,Q[8]=Y,Q[9]=F,Q[10]=j,Q[11]=0,Q[12]=-(B*U+V*C+Y*A),Q[13]=-(Z*U+P*C+F*A),Q[14]=-(H*U+X*C+j*A),Q[15]=1,Q}function R$(Q,$,K,J){var B=$[0],V=$[1],Y=$[2],Z=J[0],P=J[1],F=J[2],H=B-K[0],X=V-K[1],j=Y-K[2],W=H*H+X*X+j*j;if(W>0)W=1/Math.sqrt(W),H*=W,X*=W,j*=W;var U=P*j-F*X,C=F*H-Z*j,A=Z*X-P*H;if(W=U*U+C*C+A*A,W>0)W=1/Math.sqrt(W),U*=W,C*=W,A*=W;return Q[0]=U,Q[1]=C,Q[2]=A,Q[3]=0,Q[4]=X*A-j*C,Q[5]=j*U-H*A,Q[6]=H*C-X*U,Q[7]=0,Q[8]=H,Q[9]=X,Q[10]=j,Q[11]=0,Q[12]=B,Q[13]=V,Q[14]=Y,Q[15]=1,Q}function k$(Q){return"mat4("+Q[0]+", "+Q[1]+", "+Q[2]+", "+Q[3]+", "+Q[4]+", "+Q[5]+", "+Q[6]+", "+Q[7]+", "+Q[8]+", "+Q[9]+", "+Q[10]+", "+Q[11]+", "+Q[12]+", "+Q[13]+", "+Q[14]+", "+Q[15]+")"}function _$(Q){return Math.hypot(Q[0],Q[1],Q[2],Q[3],Q[4],Q[5],Q[6],Q[7],Q[8],Q[9],Q[10],Q[11],Q[12],Q[13],Q[14],Q[15])}function D$(Q,$,K){return Q[0]=$[0]+K[0],Q[1]=$[1]+K[1],Q[2]=$[2]+K[2],Q[3]=$[3]+K[3],Q[4]=$[4]+K[4],Q[5]=$[5]+K[5],Q[6]=$[6]+K[6],Q[7]=$[7]+K[7],Q[8]=$[8]+K[8],Q[9]=$[9]+K[9],Q[10]=$[10]+K[10],Q[11]=$[11]+K[11],Q[12]=$[12]+K[12],Q[13]=$[13]+K[13],Q[14]=$[14]+K[14],Q[15]=$[15]+K[15],Q}function a0(Q,$,K){return Q[0]=$[0]-K[0],Q[1]=$[1]-K[1],Q[2]=$[2]-K[2],Q[3]=$[3]-K[3],Q[4]=$[4]-K[4],Q[5]=$[5]-K[5],Q[6]=$[6]-K[6],Q[7]=$[7]-K[7],Q[8]=$[8]-K[8],Q[9]=$[9]-K[9],Q[10]=$[10]-K[10],Q[11]=$[11]-K[11],Q[12]=$[12]-K[12],Q[13]=$[13]-K[13],Q[14]=$[14]-K[14],Q[15]=$[15]-K[15],Q}function G$(Q,$,K){return Q[0]=$[0]*K,Q[1]=$[1]*K,Q[2]=$[2]*K,Q[3]=$[3]*K,Q[4]=$[4]*K,Q[5]=$[5]*K,Q[6]=$[6]*K,Q[7]=$[7]*K,Q[8]=$[8]*K,Q[9]=$[9]*K,Q[10]=$[10]*K,Q[11]=$[11]*K,Q[12]=$[12]*K,Q[13]=$[13]*K,Q[14]=$[14]*K,Q[15]=$[15]*K,Q}function M$(Q,$,K,J){return Q[0]=$[0]+K[0]*J,Q[1]=$[1]+K[1]*J,Q[2]=$[2]+K[2]*J,Q[3]=$[3]+K[3]*J,Q[4]=$[4]+K[4]*J,Q[5]=$[5]+K[5]*J,Q[6]=$[6]+K[6]*J,Q[7]=$[7]+K[7]*J,Q[8]=$[8]+K[8]*J,Q[9]=$[9]+K[9]*J,Q[10]=$[10]+K[10]*J,Q[11]=$[11]+K[11]*J,Q[12]=$[12]+K[12]*J,Q[13]=$[13]+K[13]*J,Q[14]=$[14]+K[14]*J,Q[15]=$[15]+K[15]*J,Q}function q$(Q,$){return Q[0]===$[0]&&Q[1]===$[1]&&Q[2]===$[2]&&Q[3]===$[3]&&Q[4]===$[4]&&Q[5]===$[5]&&Q[6]===$[6]&&Q[7]===$[7]&&Q[8]===$[8]&&Q[9]===$[9]&&Q[10]===$[10]&&Q[11]===$[11]&&Q[12]===$[12]&&Q[13]===$[13]&&Q[14]===$[14]&&Q[15]===$[15]}function L$(Q,$){var K=Q[0],J=Q[1],B=Q[2],V=Q[3],Y=Q[4],Z=Q[5],P=Q[6],F=Q[7],H=Q[8],X=Q[9],j=Q[10],W=Q[11],U=Q[12],C=Q[13],A=Q[14],E=Q[15],G=$[0],_=$[1],k=$[2],N=$[3],R=$[4],w=$[5],S=$[6],h=$[7],I=$[8],v=$[9],g=$[10],p=$[11],M=$[12],y=$[13],s=$[14],b=$[15];return Math.abs(K-G)<=D*Math.max(1,Math.abs(K),Math.abs(G))&&Math.abs(J-_)<=D*Math.max(1,Math.abs(J),Math.abs(_))&&Math.abs(B-k)<=D*Math.max(1,Math.abs(B),Math.abs(k))&&Math.abs(V-N)<=D*Math.max(1,Math.abs(V),Math.abs(N))&&Math.abs(Y-R)<=D*Math.max(1,Math.abs(Y),Math.abs(R))&&Math.abs(Z-w)<=D*Math.max(1,Math.abs(Z),Math.abs(w))&&Math.abs(P-S)<=D*Math.max(1,Math.abs(P),Math.abs(S))&&Math.abs(F-h)<=D*Math.max(1,Math.abs(F),Math.abs(h))&&Math.abs(H-I)<=D*Math.max(1,Math.abs(H),Math.abs(I))&&Math.abs(X-v)<=D*Math.max(1,Math.abs(X),Math.abs(v))&&Math.abs(j-g)<=D*Math.max(1,Math.abs(j),Math.abs(g))&&Math.abs(W-p)<=D*Math.max(1,Math.abs(W),Math.abs(p))&&Math.abs(U-M)<=D*Math.max(1,Math.abs(U),Math.abs(M))&&Math.abs(C-y)<=D*Math.max(1,Math.abs(C),Math.abs(y))&&Math.abs(A-s)<=D*Math.max(1,Math.abs(A),Math.abs(s))&&Math.abs(E-b)<=D*Math.max(1,Math.abs(E),Math.abs(b))}var j$=u0,O$=o0,T$=b0,S$=a0;var u={};j0(u,{str:()=>{{return MK}},squaredLength:()=>{{return LQ}},sqrLen:()=>{{return gK}},sqlerp:()=>{{return yK}},slerp:()=>{{return K0}},setAxisAngle:()=>{{return NQ}},setAxes:()=>{{return xK}},set:()=>{{return SK}},scale:()=>{{return GQ}},rotationTo:()=>{{return zK}},rotateZ:()=>{{return EK}},rotateY:()=>{{return OK}},rotateX:()=>{{return UK}},random:()=>{{return kK}},pow:()=>{{return RK}},normalize:()=>{{return E0}},multiply:()=>{{return RQ}},mul:()=>{{return IK}},ln:()=>{{return _Q}},lerp:()=>{{return wK}},length:()=>{{return qQ}},len:()=>{{return vK}},invert:()=>{{return _K}},identity:()=>{{return WK}},getAxisAngle:()=>{{return jK}},getAngle:()=>{{return CK}},fromValues:()=>{{return LK}},fromMat3:()=>{{return DQ}},fromEuler:()=>{{return GK}},exp:()=>{{return kQ}},exactEquals:()=>{{return fK}},equals:()=>{{return pK}},dot:()=>{{return MQ}},create:()=>{{return O0}},copy:()=>{{return TK}},conjugate:()=>{{return DK}},clone:()=>{{return qK}},calculateW:()=>{{return NK}},add:()=>{{return hK}}});var i={};j0(i,{zero:()=>{{return QK}},transformQuat:()=>{{return e$}},transformMat4:()=>{{return b$}},transformMat3:()=>{{return r$}},subtract:()=>{{return QQ}},sub:()=>{{return BK}},str:()=>{{return $K}},squaredLength:()=>{{return VQ}},squaredDistance:()=>{{return BQ}},sqrLen:()=>{{return FK}},sqrDist:()=>{{return PK}},set:()=>{{return w$}},scaleAndAdd:()=>{{return c$}},scale:()=>{{return x$}},round:()=>{{return y$}},rotateZ:()=>{{return a$}},rotateY:()=>{{return o$}},rotateX:()=>{{return u$}},random:()=>{{return s$}},normalize:()=>{{return C0}},negate:()=>{{return n$}},multiply:()=>{{return $Q}},mul:()=>{{return VK}},min:()=>{{return p$}},max:()=>{{return z$}},lerp:()=>{{return m$}},length:()=>{{return t0}},len:()=>{{return U0}},inverse:()=>{{return l$}},hermite:()=>{{return i$}},fromValues:()=>{{return Q0}},forEach:()=>{{return HK}},floor:()=>{{return f$}},exactEquals:()=>{{return KK}},equals:()=>{{return JK}},dot:()=>{{return $0}},divide:()=>{{return KQ}},div:()=>{{return YK}},distance:()=>{{return JQ}},dist:()=>{{return ZK}},cross:()=>{{return e}},create:()=>{{return t}},copy:()=>{{return I$}},clone:()=>{{return h$}},ceil:()=>{{return g$}},bezier:()=>{{return d$}},angle:()=>{{return t$}},add:()=>{{return v$}}});function t(){var Q=new T(3);if(T!=Float32Array)Q[0]=0,Q[1]=0,Q[2]=0;return Q}function h$(Q){var $=new T(3);return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$}function t0(Q){var $=Q[0],K=Q[1],J=Q[2];return Math.hypot($,K,J)}function Q0(Q,$,K){var J=new T(3);return J[0]=Q,J[1]=$,J[2]=K,J}function I$(Q,$){return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q}function w$(Q,$,K,J){return Q[0]=$,Q[1]=K,Q[2]=J,Q}function v$(Q,$,K){return Q[0]=$[0]+K[0],Q[1]=$[1]+K[1],Q[2]=$[2]+K[2],Q}function QQ(Q,$,K){return Q[0]=$[0]-K[0],Q[1]=$[1]-K[1],Q[2]=$[2]-K[2],Q}function $Q(Q,$,K){return Q[0]=$[0]*K[0],Q[1]=$[1]*K[1],Q[2]=$[2]*K[2],Q}function KQ(Q,$,K){return Q[0]=$[0]/K[0],Q[1]=$[1]/K[1],Q[2]=$[2]/K[2],Q}function g$(Q,$){return Q[0]=Math.ceil($[0]),Q[1]=Math.ceil($[1]),Q[2]=Math.ceil($[2]),Q}function f$(Q,$){return Q[0]=Math.floor($[0]),Q[1]=Math.floor($[1]),Q[2]=Math.floor($[2]),Q}function p$(Q,$,K){return Q[0]=Math.min($[0],K[0]),Q[1]=Math.min($[1],K[1]),Q[2]=Math.min($[2],K[2]),Q}function z$(Q,$,K){return Q[0]=Math.max($[0],K[0]),Q[1]=Math.max($[1],K[1]),Q[2]=Math.max($[2],K[2]),Q}function y$(Q,$){return Q[0]=Math.round($[0]),Q[1]=Math.round($[1]),Q[2]=Math.round($[2]),Q}function x$(Q,$,K){return Q[0]=$[0]*K,Q[1]=$[1]*K,Q[2]=$[2]*K,Q}function c$(Q,$,K,J){return Q[0]=$[0]+K[0]*J,Q[1]=$[1]+K[1]*J,Q[2]=$[2]+K[2]*J,Q}function JQ(Q,$){var K=$[0]-Q[0],J=$[1]-Q[1],B=$[2]-Q[2];return Math.hypot(K,J,B)}function BQ(Q,$){var K=$[0]-Q[0],J=$[1]-Q[1],B=$[2]-Q[2];return K*K+J*J+B*B}function VQ(Q){var $=Q[0],K=Q[1],J=Q[2];return $*$+K*K+J*J}function n$(Q,$){return Q[0]=-$[0],Q[1]=-$[1],Q[2]=-$[2],Q}function l$(Q,$){return Q[0]=1/$[0],Q[1]=1/$[1],Q[2]=1/$[2],Q}function C0(Q,$){var K=$[0],J=$[1],B=$[2],V=K*K+J*J+B*B;if(V>0)V=1/Math.sqrt(V);return Q[0]=$[0]*V,Q[1]=$[1]*V,Q[2]=$[2]*V,Q}function $0(Q,$){return Q[0]*$[0]+Q[1]*$[1]+Q[2]*$[2]}function e(Q,$,K){var J=$[0],B=$[1],V=$[2],Y=K[0],Z=K[1],P=K[2];return Q[0]=B*P-V*Z,Q[1]=V*Y-J*P,Q[2]=J*Z-B*Y,Q}function m$(Q,$,K,J){var B=$[0],V=$[1],Y=$[2];return Q[0]=B+J*(K[0]-B),Q[1]=V+J*(K[1]-V),Q[2]=Y+J*(K[2]-Y),Q}function i$(Q,$,K,J,B,V){var Y=V*V,Z=Y*(2*V-3)+1,P=Y*(V-2)+V,F=Y*(V-1),H=Y*(3-2*V);return Q[0]=$[0]*Z+K[0]*P+J[0]*F+B[0]*H,Q[1]=$[1]*Z+K[1]*P+J[1]*F+B[1]*H,Q[2]=$[2]*Z+K[2]*P+J[2]*F+B[2]*H,Q}function d$(Q,$,K,J,B,V){var Y=1-V,Z=Y*Y,P=V*V,F=Z*Y,H=3*V*Z,X=3*P*Y,j=P*V;return Q[0]=$[0]*F+K[0]*H+J[0]*X+B[0]*j,Q[1]=$[1]*F+K[1]*H+J[1]*X+B[1]*j,Q[2]=$[2]*F+K[2]*H+J[2]*X+B[2]*j,Q}function s$(Q,$){$=$||1;var K=l()*2*Math.PI,J=l()*2-1,B=Math.sqrt(1-J*J)*$;return Q[0]=Math.cos(K)*B,Q[1]=Math.sin(K)*B,Q[2]=J*$,Q}function b$(Q,$,K){var J=$[0],B=$[1],V=$[2],Y=K[3]*J+K[7]*B+K[11]*V+K[15];return Y=Y||1,Q[0]=(K[0]*J+K[4]*B+K[8]*V+K[12])/Y,Q[1]=(K[1]*J+K[5]*B+K[9]*V+K[13])/Y,Q[2]=(K[2]*J+K[6]*B+K[10]*V+K[14])/Y,Q}function r$(Q,$,K){var J=$[0],B=$[1],V=$[2];return Q[0]=J*K[0]+B*K[3]+V*K[6],Q[1]=J*K[1]+B*K[4]+V*K[7],Q[2]=J*K[2]+B*K[5]+V*K[8],Q}function e$(Q,$,K){var J=K[0],B=K[1],V=K[2],Y=K[3],Z=$[0],P=$[1],F=$[2],H=B*F-V*P,X=V*Z-J*F,j=J*P-B*Z,W=B*j-V*X,U=V*H-J*j,C=J*X-B*H,A=Y*2;return H*=A,X*=A,j*=A,W*=2,U*=2,C*=2,Q[0]=Z+H+W,Q[1]=P+X+U,Q[2]=F+j+C,Q}function u$(Q,$,K,J){var B=[],V=[];return B[0]=$[0]-K[0],B[1]=$[1]-K[1],B[2]=$[2]-K[2],V[0]=B[0],V[1]=B[1]*Math.cos(J)-B[2]*Math.sin(J),V[2]=B[1]*Math.sin(J)+B[2]*Math.cos(J),Q[0]=V[0]+K[0],Q[1]=V[1]+K[1],Q[2]=V[2]+K[2],Q}function o$(Q,$,K,J){var B=[],V=[];return B[0]=$[0]-K[0],B[1]=$[1]-K[1],B[2]=$[2]-K[2],V[0]=B[2]*Math.sin(J)+B[0]*Math.cos(J),V[1]=B[1],V[2]=B[2]*Math.cos(J)-B[0]*Math.sin(J),Q[0]=V[0]+K[0],Q[1]=V[1]+K[1],Q[2]=V[2]+K[2],Q}function a$(Q,$,K,J){var B=[],V=[];return B[0]=$[0]-K[0],B[1]=$[1]-K[1],B[2]=$[2]-K[2],V[0]=B[0]*Math.cos(J)-B[1]*Math.sin(J),V[1]=B[0]*Math.sin(J)+B[1]*Math.cos(J),V[2]=B[2],Q[0]=V[0]+K[0],Q[1]=V[1]+K[1],Q[2]=V[2]+K[2],Q}function t$(Q,$){var K=Q[0],J=Q[1],B=Q[2],V=$[0],Y=$[1],Z=$[2],P=Math.sqrt(K*K+J*J+B*B),F=Math.sqrt(V*V+Y*Y+Z*Z),H=P*F,X=H&&$0(Q,$)/H;return Math.acos(Math.min(Math.max(X,-1),1))}function QK(Q){return Q[0]=0,Q[1]=0,Q[2]=0,Q}function $K(Q){return"vec3("+Q[0]+", "+Q[1]+", "+Q[2]+")"}function KK(Q,$){return Q[0]===$[0]&&Q[1]===$[1]&&Q[2]===$[2]}function JK(Q,$){var K=Q[0],J=Q[1],B=Q[2],V=$[0],Y=$[1],Z=$[2];return Math.abs(K-V)<=D*Math.max(1,Math.abs(K),Math.abs(V))&&Math.abs(J-Y)<=D*Math.max(1,Math.abs(J),Math.abs(Y))&&Math.abs(B-Z)<=D*Math.max(1,Math.abs(B),Math.abs(Z))}var BK=QQ,VK=$Q,YK=KQ,ZK=JQ,PK=BQ,U0=t0,FK=VQ,HK=function(){var Q=t();return function($,K,J,B,V,Y){var Z,P;if(!K)K=3;if(!J)J=0;if(B)P=Math.min(B*K+J,$.length);else P=$.length;for(Z=J;Z<P;Z+=K)Q[0]=$[Z],Q[1]=$[Z+1],Q[2]=$[Z+2],V(Q,Q,Y),$[Z]=Q[0],$[Z+1]=Q[1],$[Z+2]=Q[2];return $}}();function XK(){var Q=new T(4);if(T!=Float32Array)Q[0]=0,Q[1]=0,Q[2]=0,Q[3]=0;return Q}function YQ(Q){var $=new T(4);return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$[3]=Q[3],$}function ZQ(Q,$,K,J){var B=new T(4);return B[0]=Q,B[1]=$,B[2]=K,B[3]=J,B}function PQ(Q,$){return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q[3]=$[3],Q}function FQ(Q,$,K,J,B){return Q[0]=$,Q[1]=K,Q[2]=J,Q[3]=B,Q}function HQ(Q,$,K){return Q[0]=$[0]+K[0],Q[1]=$[1]+K[1],Q[2]=$[2]+K[2],Q[3]=$[3]+K[3],Q}function XQ(Q,$,K){return Q[0]=$[0]*K,Q[1]=$[1]*K,Q[2]=$[2]*K,Q[3]=$[3]*K,Q}function AQ(Q){var $=Q[0],K=Q[1],J=Q[2],B=Q[3];return Math.hypot($,K,J,B)}function WQ(Q){var $=Q[0],K=Q[1],J=Q[2],B=Q[3];return $*$+K*K+J*J+B*B}function jQ(Q,$){var K=$[0],J=$[1],B=$[2],V=$[3],Y=K*K+J*J+B*B+V*V;if(Y>0)Y=1/Math.sqrt(Y);return Q[0]=K*Y,Q[1]=J*Y,Q[2]=B*Y,Q[3]=V*Y,Q}function CQ(Q,$){return Q[0]*$[0]+Q[1]*$[1]+Q[2]*$[2]+Q[3]*$[3]}function UQ(Q,$,K,J){var B=$[0],V=$[1],Y=$[2],Z=$[3];return Q[0]=B+J*(K[0]-B),Q[1]=V+J*(K[1]-V),Q[2]=Y+J*(K[2]-Y),Q[3]=Z+J*(K[3]-Z),Q}function OQ(Q,$){return Q[0]===$[0]&&Q[1]===$[1]&&Q[2]===$[2]&&Q[3]===$[3]}function EQ(Q,$){var K=Q[0],J=Q[1],B=Q[2],V=Q[3],Y=$[0],Z=$[1],P=$[2],F=$[3];return Math.abs(K-Y)<=D*Math.max(1,Math.abs(K),Math.abs(Y))&&Math.abs(J-Z)<=D*Math.max(1,Math.abs(J),Math.abs(Z))&&Math.abs(B-P)<=D*Math.max(1,Math.abs(B),Math.abs(P))&&Math.abs(V-F)<=D*Math.max(1,Math.abs(V),Math.abs(F))}var $J=function(){var Q=XK();return function($,K,J,B,V,Y){var Z,P;if(!K)K=4;if(!J)J=0;if(B)P=Math.min(B*K+J,$.length);else P=$.length;for(Z=J;Z<P;Z+=K)Q[0]=$[Z],Q[1]=$[Z+1],Q[2]=$[Z+2],Q[3]=$[Z+3],V(Q,Q,Y),$[Z]=Q[0],$[Z+1]=Q[1],$[Z+2]=Q[2],$[Z+3]=Q[3];return $}}();function O0(){var Q=new T(4);if(T!=Float32Array)Q[0]=0,Q[1]=0,Q[2]=0;return Q[3]=1,Q}function WK(Q){return Q[0]=0,Q[1]=0,Q[2]=0,Q[3]=1,Q}function NQ(Q,$,K){K=K*0.5;var J=Math.sin(K);return Q[0]=J*$[0],Q[1]=J*$[1],Q[2]=J*$[2],Q[3]=Math.cos(K),Q}function jK(Q,$){var K=Math.acos($[3])*2,J=Math.sin(K/2);if(J>D)Q[0]=$[0]/J,Q[1]=$[1]/J,Q[2]=$[2]/J;else Q[0]=1,Q[1]=0,Q[2]=0;return K}function CK(Q,$){var K=MQ(Q,$);return Math.acos(2*K*K-1)}function RQ(Q,$,K){var J=$[0],B=$[1],V=$[2],Y=$[3],Z=K[0],P=K[1],F=K[2],H=K[3];return Q[0]=J*H+Y*Z+B*F-V*P,Q[1]=B*H+Y*P+V*Z-J*F,Q[2]=V*H+Y*F+J*P-B*Z,Q[3]=Y*H-J*Z-B*P-V*F,Q}function UK(Q,$,K){K*=0.5;var J=$[0],B=$[1],V=$[2],Y=$[3],Z=Math.sin(K),P=Math.cos(K);return Q[0]=J*P+Y*Z,Q[1]=B*P+V*Z,Q[2]=V*P-B*Z,Q[3]=Y*P-J*Z,Q}function OK(Q,$,K){K*=0.5;var J=$[0],B=$[1],V=$[2],Y=$[3],Z=Math.sin(K),P=Math.cos(K);return Q[0]=J*P-V*Z,Q[1]=B*P+Y*Z,Q[2]=V*P+J*Z,Q[3]=Y*P-B*Z,Q}function EK(Q,$,K){K*=0.5;var J=$[0],B=$[1],V=$[2],Y=$[3],Z=Math.sin(K),P=Math.cos(K);return Q[0]=J*P+B*Z,Q[1]=B*P-J*Z,Q[2]=V*P+Y*Z,Q[3]=Y*P-V*Z,Q}function NK(Q,$){var K=$[0],J=$[1],B=$[2];return Q[0]=K,Q[1]=J,Q[2]=B,Q[3]=Math.sqrt(Math.abs(1-K*K-J*J-B*B)),Q}function kQ(Q,$){var K=$[0],J=$[1],B=$[2],V=$[3],Y=Math.sqrt(K*K+J*J+B*B),Z=Math.exp(V),P=Y>0?Z*Math.sin(Y)/Y:0;return Q[0]=K*P,Q[1]=J*P,Q[2]=B*P,Q[3]=Z*Math.cos(Y),Q}function _Q(Q,$){var K=$[0],J=$[1],B=$[2],V=$[3],Y=Math.sqrt(K*K+J*J+B*B),Z=Y>0?Math.atan2(Y,V)/Y:0;return Q[0]=K*Z,Q[1]=J*Z,Q[2]=B*Z,Q[3]=0.5*Math.log(K*K+J*J+B*B+V*V),Q}function RK(Q,$,K){return _Q(Q,$),GQ(Q,Q,K),kQ(Q,Q),Q}function K0(Q,$,K,J){var B=$[0],V=$[1],Y=$[2],Z=$[3],P=K[0],F=K[1],H=K[2],X=K[3],j,W,U,C,A;if(W=B*P+V*F+Y*H+Z*X,W<0)W=-W,P=-P,F=-F,H=-H,X=-X;if(1-W>D)j=Math.acos(W),U=Math.sin(j),C=Math.sin((1-J)*j)/U,A=Math.sin(J*j)/U;else C=1-J,A=J;return Q[0]=C*B+A*P,Q[1]=C*V+A*F,Q[2]=C*Y+A*H,Q[3]=C*Z+A*X,Q}function kK(Q){var $=l(),K=l(),J=l(),B=Math.sqrt(1-$),V=Math.sqrt($);return Q[0]=B*Math.sin(2*Math.PI*K),Q[1]=B*Math.cos(2*Math.PI*K),Q[2]=V*Math.sin(2*Math.PI*J),Q[3]=V*Math.cos(2*Math.PI*J),Q}function _K(Q,$){var K=$[0],J=$[1],B=$[2],V=$[3],Y=K*K+J*J+B*B+V*V,Z=Y?1/Y:0;return Q[0]=-K*Z,Q[1]=-J*Z,Q[2]=-B*Z,Q[3]=V*Z,Q}function DK(Q,$){return Q[0]=-$[0],Q[1]=-$[1],Q[2]=-$[2],Q[3]=$[3],Q}function DQ(Q,$){var K=$[0]+$[4]+$[8],J;if(K>0)J=Math.sqrt(K+1),Q[3]=0.5*J,J=0.5/J,Q[0]=($[5]-$[7])*J,Q[1]=($[6]-$[2])*J,Q[2]=($[1]-$[3])*J;else{var B=0;if($[4]>$[0])B=1;if($[8]>$[B*3+B])B=2;var V=(B+1)%3,Y=(B+2)%3;J=Math.sqrt($[B*3+B]-$[V*3+V]-$[Y*3+Y]+1),Q[B]=0.5*J,J=0.5/J,Q[3]=($[V*3+Y]-$[Y*3+V])*J,Q[V]=($[V*3+B]+$[B*3+V])*J,Q[Y]=($[Y*3+B]+$[B*3+Y])*J}return Q}function GK(Q,$,K,J){var B=0.5*Math.PI/180;$*=B,K*=B,J*=B;var V=Math.sin($),Y=Math.cos($),Z=Math.sin(K),P=Math.cos(K),F=Math.sin(J),H=Math.cos(J);return Q[0]=V*P*H-Y*Z*F,Q[1]=Y*Z*H+V*P*F,Q[2]=Y*P*F-V*Z*H,Q[3]=Y*P*H+V*Z*F,Q}function MK(Q){return"quat("+Q[0]+", "+Q[1]+", "+Q[2]+", "+Q[3]+")"}var qK=YQ,LK=ZQ,TK=PQ,SK=FQ,hK=HQ,IK=RQ,GQ=XQ,MQ=CQ,wK=UQ,qQ=AQ,vK=qQ,LQ=WQ,gK=LQ,E0=jQ,fK=OQ,pK=EQ,zK=function(){var Q=t(),$=Q0(1,0,0),K=Q0(0,1,0);return function(J,B,V){var Y=$0(B,V);if(Y<-0.999999){if(e(Q,$,B),U0(Q)<0.000001)e(Q,K,B);return C0(Q,Q),NQ(J,Q,Math.PI),J}else if(Y>0.999999)return J[0]=0,J[1]=0,J[2]=0,J[3]=1,J;else return e(Q,B,V),J[0]=Q[0],J[1]=Q[1],J[2]=Q[2],J[3]=1+Y,E0(J,J)}}(),yK=function(){var Q=O0(),$=O0();return function(K,J,B,V,Y,Z){return K0(Q,J,Y,Z),K0($,B,V,Z),K0(K,Q,$,2*Z*(1-Z)),K}}(),xK=function(){var Q=d0();return function($,K,J,B){return Q[0]=J[0],Q[3]=J[1],Q[6]=J[2],Q[1]=B[0],Q[4]=B[1],Q[7]=B[2],Q[2]=-K[0],Q[5]=-K[1],Q[8]=-K[2],E0($,DQ($,Q))}}();var cK=Math.PI/90;class x{m4=Float32Array.from(q.create());constructor(){this.identity()}static create(){return new x}identity(){return q.identity(this.m4),this}invert(Q){return q.invert(this.m4,Q.getMatrix()),this}multiply(Q){return q.multiply(this.m4,this.m4,Q.getMatrix()),this}multiply2(Q,$){return q.multiply(this.m4,Q.getMatrix(),$.getMatrix()),this}multiply3(Q,$,K){return this.multiply2(Q,$),this.multiply(K),this}translate(Q,$,K){return q.translate(this.m4,this.m4,[Q,$,K]),this}translateToMatrix(Q){const $=Q.getMatrix();return this.translate(-$[12],-$[13],-$[14])}rotateX(Q){return q.rotateX(this.m4,this.m4,Q),this}rotateY(Q){return q.rotateY(this.m4,this.m4,Q),this}rotateZ(Q){return q.rotateZ(this.m4,this.m4,Q),this}scale(Q,$,K){return q.scale(this.m4,this.m4,[Q,$,K]),this}perspective(Q,$,K,J){return q.perspective(this.m4,Q*cK,$,K,J),this}ortho(Q,$,K,J,B,V){return q.ortho(this.m4,Q,$,K,J,B,V),this}static aTemp=q.create();static bTemp=q.create();combine(Q,$,K=0.5){return q.multiplyScalar(x.aTemp,Q.getMatrix(),1-K),q.multiplyScalar(x.bTemp,$.getMatrix(),K),q.add(this.m4,x.aTemp,x.bTemp),this}static tempQuat=u.create();moveMatrix(Q,$,K,J){const B=i.fromValues(-Q,$,K);if(J)q.getRotation(x.tempQuat,J.getMatrix()),u.invert(x.tempQuat,x.tempQuat),i.transformQuat(B,B,x.tempQuat);return q.translate(this.m4,this.m4,B),this}getMatrix(){return this.m4}}var L=x;class N0 extends L{constructor(){super(...arguments)}perspectiveMatrix=L.create();orthoMatrix=L.create();perspectiveLevel=1;configPerspectiveMatrix(Q){this.perspectiveMatrix.perspective(45,Q,0.01,1000)}configOrthoMatrix(Q){this.orthoMatrix.ortho(-Q,Q,-1,1,-1000,1000)}configure(Q,$){const K=Q/$;this.configPerspectiveMatrix(K),this.configOrthoMatrix(K)}setPerspective(Q){this.perspectiveLevel=Q,this.combine(this.orthoMatrix,this.perspectiveMatrix,this.perspectiveLevel)}}var z;(function(K){K["PROJECTION"]="PROJECTION";K["VIEW"]="VIEW"})(z||(z={}));class R0{needsRefresh=!1;camPositionMatrix=L.create().translate(0,0,-1);projectionMatrix=new N0;camTiltMatrix=L.create();camTurnMatrix=L.create();camMatrix=L.create();pespectiveLevel=1;cameraMatrices={[z.PROJECTION]:this.projectionMatrix,[z.VIEW]:this.camMatrix};configProjectionMatrix(Q,$){this.projectionMatrix.configure(Q,$),this.updatePerspective()}refresh(){if(!this.needsRefresh)return!1;return this.invertedCamTiltMatrix.invert(this.camTiltMatrix),this.invertedCamTurnMatrix.invert(this.camTurnMatrix),this.camMatrix.multiply3(this.camTiltMatrix,this.camTurnMatrix,this.camPositionMatrix),this.needsRefresh=!1,!0}updatePerspective(Q){this.projectionMatrix.setPerspective(Q??this.pespectiveLevel),this.needsRefresh=!0}getCameraMatrix(Q){return this.cameraMatrices[Q].getMatrix()}moveCam(Q,$,K){this.camPositionMatrix.moveMatrix(Q,$,K,this.camTurnMatrix),this.needsRefresh=!0}turnCam(Q){this.camTurnMatrix.rotateY(Q),this.needsRefresh=!0}tilt(Q){this.camTiltMatrix.rotateX(Q),this.needsRefresh=!0}invertedCamTurnMatrix=L.create();invertedCamTiltMatrix=L.create();syncHud(Q){Q?.identity().translateToMatrix(this.camPositionMatrix).multiply(this.invertedCamTurnMatrix).multiply(this.invertedCamTiltMatrix).translate(0,0,-0.9)}}class J0{Q;$;K;constructor(Q,$,K){this.type=Q;this.world=$;this.engine=K}update(){const{world:Q,engine:$}=this,K=Q.getCameraMatrix(this.type);$.updateCameraMatrix(this.type,K)}}var k0=0,_0=1,D0=2,G0=3,M0=4,q0=5,m=512;class L0{Q;updatedSpriteTransforms=new Set;updatedSpriteTextureSlots=new Set;updateSpriteIds=new Set;hudMatrix=L.create();hudSpriteId=0;camera=new R0;cameraUpdate;medias={[M0]:{type:"video",src:"sample.mp4",volume:0,fps:30},[k0]:{type:"image",src:"dobuki.png"},[_0]:{type:"draw",draw:(Q)=>{const{canvas:$}=Q;$.width=m,$.height=m;const K=$.width/2,J=$.height/2,B=$.width/2;Q.imageSmoothingEnabled=!0,Q.fillStyle="#ddd",Q.lineWidth=$.width/50,Q.fillRect(0,0,$.width,$.height),Q.strokeStyle="black",Q.fillStyle="gold",Q.beginPath(),Q.arc(K,J,B*0.8,0,2*Math.PI),Q.fill(),Q.stroke(),Q.beginPath(),Q.arc(K,J,B*0.5,0,Math.PI),Q.stroke(),Q.beginPath(),Q.arc($.width/3,$.height/3,B*0.1,0,Math.PI,!0),Q.stroke(),Q.beginPath(),Q.arc($.width/3*2,$.height/3,B*0.1,0,Math.PI*2,!0),Q.stroke()}},[D0]:{type:"draw",draw:(Q)=>{const{canvas:$}=Q;$.width=m,$.height=m,Q.imageSmoothingEnabled=!0,Q.fillStyle="#ddd",Q.lineWidth=$.width/50,Q.fillRect(0,0,$.width,$.height),Q.strokeStyle="black",Q.fillStyle="silver",Q.beginPath(),Q.rect($.width*0.2,$.height*0.2,$.width*0.6,$.height*0.6),Q.fill(),Q.stroke()}},[G0]:{type:"draw",draw:(Q)=>{const{canvas:$}=Q;$.width=m,$.height=m,Q.lineWidth=$.width/50,Q.strokeStyle="black",Q.beginPath(),Q.rect(30,30,$.width-60,$.height-60),Q.stroke()}},[q0]:{type:"draw",draw:(Q)=>{const{canvas:$}=Q;$.width=m,$.height=m,Q.imageSmoothingEnabled=!0,Q.lineWidth=5,Q.strokeStyle="green",Q.beginPath(),Q.rect(10,10,$.width-20,$.height-20),Q.stroke()}}};constructor(Q){this.core=Q;this.sprites.forEach(($,K)=>{this.updatedSpriteTransforms.add(K),this.updatedSpriteTextureSlots.add(K)}),this.cameraUpdate={PROJECTION:new J0(z.PROJECTION,this,this.core.engine),VIEW:[new J0(z.VIEW,this,this.core.engine),{update:()=>this.camera.syncHud(this.hudMatrix)},{update:()=>this.updatedSpriteTransforms.add(this.hudSpriteId)}]},[_0,D0,G0,k0,M0,q0].forEach(($)=>this.updateSpriteIds.add($)),this.core.motor.registerUpdate(this.cameraUpdate[z.VIEW]),this.core.motor.registerUpdate(this.cameraUpdate[z.PROJECTION]),this.onResize=this.onResize.bind(this)}onResize(Q,$){this.camera.configProjectionMatrix(Q,$),this.core.motor.registerUpdate(this.cameraUpdate[z.PROJECTION])}period;getCamera(){return this.camera}getCameraMatrix(Q){return this.camera.getCameraMatrix(Q)}getUpdateImageIds(){return this.updateSpriteIds}getUpdatedSpriteTextureSlot(){return this.updatedSpriteTextureSlots}getMedia(Q){return this.medias[Q]}sprites=[{imageId:G0,transforms:[this.hudMatrix.getMatrix()]},{imageId:k0,transforms:[L.create().translate(0,0,0).getMatrix()]},...[L.create().translate(-1,0,1).rotateY(Math.PI/2).scale(1,1,1).getMatrix(),L.create().translate(1,0,1).rotateY(-Math.PI/2).scale(1,1,1).getMatrix()].map((Q)=>({imageId:_0,transforms:[Q]})),...[L.create().translate(0,-1,1).rotateX(-Math.PI/2).scale(1,1,1).getMatrix(),L.create().translate(0,-1,3).rotateX(-Math.PI/2).scale(1,1,1).getMatrix(),L.create().translate(-2,-1,3).rotateX(-Math.PI/2).scale(1,1,1).getMatrix(),L.create().translate(2,-1,3).rotateX(-Math.PI/2).scale(1,1,1).getMatrix()].map((Q)=>({imageId:D0,transforms:[Q]})),{imageId:M0,transforms:[L.create().translate(0,5,-10).scale(9.6,5.4,1).getMatrix()]},...new Array(400).fill(0).map((Q,$)=>L.create().translate($%20-10,-1.5,Math.floor($/20)-10).rotateX(-Math.PI/2).scale(1,1,1).getMatrix()).map((Q)=>({imageId:q0,transforms:[Q]}))];getMaxSpriteCount(){return this.sprites.length}getSprite(Q){return this.sprites[Q]}update(Q,$){const K=$/80,J=$/400;if(this.keys.KeyW||this.keys.ArrowUp&&!this.keys.ShiftRight)this.camera.moveCam(0,0,K);if(this.keys.KeyS||this.keys.ArrowDown&&!this.keys.ShiftRight)this.camera.moveCam(0,0,-K);if(this.keys.KeyA||this.keys.ArrowLeft&&!this.keys.ShiftRight)this.camera.moveCam(-K,0,0);if(this.keys.KeyD||this.keys.ArrowRight&&!this.keys.ShiftRight)this.camera.moveCam(K,0,0);if(this.keys.KeyQ||this.keys.ArrowLeft&&this.keys.ShiftRight)this.camera.turnCam(-J);if(this.keys.KeyE||this.keys.ArrowRight&&this.keys.ShiftRight)this.camera.turnCam(J);if(this.keys.ArrowUp&&this.keys.ShiftRight)this.camera.tilt(-J);if(this.keys.ArrowDown&&this.keys.ShiftRight)this.camera.tilt(J);if(this.camera.refresh())this.core.motor.registerUpdate(this.cameraUpdate[z.VIEW])}getUpdatedSpriteTransforms(){return this.updatedSpriteTransforms}keys={};activate(){const Q=(K)=>this.keys[K.code]=!0,$=(K)=>this.keys[K.code]=!1;return document.addEventListener("keydown",Q),document.addEventListener("keyup",$),this.core.engine.addResizeListener(this.onResize),()=>{document.removeEventListener("keydown",Q),document.removeEventListener("keyup",$),this.core.engine.removeResizeListener(this.onResize)}}}class f{disposables;own(Q){if(!this.disposables)this.disposables=new Set;return this.disposables.add(Q),Q}addOnDestroy(Q){this.disposables?.add({destroy:Q})}destroy(){this.disposables?.forEach((Q)=>Q.destroy())}}var O=globalThis.WebGL2RenderingContext??{},TQ="position",SQ="index",T0="transform",S0="slotSize_and_number",hQ="cam",IQ="projection",wQ="maxTextureSize",vQ="uTextures";var nK=function(Q,$,K){function J(H,X){function j(U){return U===Q?.VERTEX_SHADER?"vertex":U===Q?.FRAGMENT_SHADER?"fragment":void 0}if(X!==Q.VERTEX_SHADER&&X!==Q.FRAGMENT_SHADER)throw new Error(`Shader error in ${j(X)}`);const W=Q.createShader(X);if(!W)throw new Error(`Unable to generate ${j(X)} shader.`);if(Q.shaderSource(W,H),Q.compileShader(W),!Q.getShaderParameter(W,Q.COMPILE_STATUS))console.error(`Shader compile error in ${j(X)}:`+Q.getShaderInfoLog(W));return W}const B=Q.createProgram();if(!B)throw new Error("Unable to create program.");const V=J($,Q.VERTEX_SHADER),Y=J(K,Q.FRAGMENT_SHADER),Z=Q.getShaderInfoLog(V),P=Q.getShaderInfoLog(Y);if(Z)console.log("VERTEX",Z);if(P)console.log("FRAGMENT",P);Q.attachShader(B,V),Q.attachShader(B,Y),Q.linkProgram(B);const F=Q.getProgramInfoLog(B);if(F)console.log("PROGRAM",F);if(Q.detachShader(B,V),Q.detachShader(B,Y),Q.deleteShader(V),Q.deleteShader(Y),Q.validateProgram(B),Object.entries(O).forEach(([H,X])=>{if(X&&Q.getError()===X)console.log(`gl.${H}`)}),!Q.getProgramParameter(B,Q.LINK_STATUS))throw new Error("Unable to initialize the shader program:\n"+Q.getProgramInfoLog(B));return B},lK=function(Q,$){Q.deleteProgram($)};class h0 extends f{gl;program;constructor(Q,$,K){super();this.gl=Q,this.program=nK(Q,$.trim(),K.trim())}use(){this.gl.useProgram(this.program)}destroy(){super.destroy(),lK(this.gl,this.program)}}class I0 extends f{activeProgramId="";gl;programs={};constructor(Q){super();this.gl=Q}addProgram(Q,$,K){if(this.programs[Q])this.removeProgram(Q);this.programs[Q]=this.own(new h0(this.gl,$,K))}useProgram(Q){if(this.activeProgramId!==Q)this.activeProgramId=Q,this.programs[Q].use()}removeProgram(Q){this.programs[Q].destroy(),delete this.programs[Q]}getProgram(Q){return this.programs[Q??this.activeProgramId]?.program}}class w0 extends f{gl;triangleArray;constructor(Q){super();this.gl=Q,this.triangleArray=Q.createVertexArray(),Q.bindVertexArray(this.triangleArray)}destroy(){this.gl.deleteVertexArray(this.triangleArray)}}class v0 extends f{bufferRecord={};gl;programs;constructor(Q,$){super();this.gl=Q,this.programs=$}getAttributeLocation(Q,$){const K=this.programs.getProgram($);return K?this.gl.getAttribLocation(K,Q)??-1:-1}createBuffer(Q){this.deleteBuffer(Q);const $=this.gl?.createBuffer();if(!$)throw new Error(`Unable to create buffer "${Q}"`);const K={buffer:$,location:this.getAttributeLocation(Q)};return this.bufferRecord[Q]=K,K}deleteBuffer(Q){if(this.bufferRecord[Q])this.gl.deleteBuffer(this.bufferRecord[Q].buffer),delete this.bufferRecord[Q]}getAttributeBuffer(Q){const $=this.bufferRecord[Q];if(!$)throw new Error(`Attribute "${Q}" not created. Make sure "createBuffer" is called.`);return $}destroy(){Object.keys(this.bufferRecord).forEach((Q)=>this.deleteBuffer(Q))}}class g0 extends f{gl;programs;constructor(Q,$){super();this.gl=Q,this.programs=$}getUniformLocation(Q,$){const K=this.programs.getProgram($);return this.gl.getUniformLocation(K,Q)}}function gQ(Q,$=(K)=>K.key){var K=[];return f0(Q,"",!0,(J)=>K.push(J),$),K.join("")}var f0=function(Q,$,K,J,B){if(Q){J(`${$}${K?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 "}${B(Q)}\n`);const V=$+(K?"    ":"\u2502   ");if(Q.left)f0(Q.left,V,!1,J,B);if(Q.right)f0(Q.right,V,!0,J,B)}};function B0(Q){if(Q===null)return!0;var $=V0(Q.left),K=V0(Q.right);if(Math.abs($-K)<=1&&B0(Q.left)&&B0(Q.right))return!0;return!1}var V0=function(Q){return Q?1+Math.max(V0(Q.left),V0(Q.right)):0};function Y0(Q,$,K,J,B){const V=B-J;if(V>0){const Y=J+Math.floor(V/2),Z=$[Y],P=K[Y],F={key:Z,data:P,parent:Q};return F.left=Y0(F,$,K,J,Y),F.right=Y0(F,$,K,Y+1,B),F}return null}function Z0(Q){if(Q===null)return 0;const $=Z0(Q.left),K=Z0(Q.right);return Q.balanceFactor=$-K,Math.max($,K)+1}function P0(Q,$,K,J,B){if(K>=J)return;const V=Q[K+J>>1];let Y=K-1,Z=J+1;while(!0){do Y++;while(B(Q[Y],V)<0);do Z--;while(B(Q[Z],V)>0);if(Y>=Z)break;let P=Q[Y];Q[Y]=Q[Z],Q[Z]=P,P=$[Y],$[Y]=$[Z],$[Z]=P}P0(Q,$,K,Z,B),P0(Q,$,Z+1,J,B)}var mK=function(Q,$){return Q>$?1:Q<$?-1:0},F0=function(Q){var $=Q.right;if(Q.right=$.left,$.left)$.left.parent=Q;if($.parent=Q.parent,$.parent)if($.parent.left===Q)$.parent.left=$;else $.parent.right=$;if(Q.parent=$,$.left=Q,Q.balanceFactor+=1,$.balanceFactor<0)Q.balanceFactor-=$.balanceFactor;if($.balanceFactor+=1,Q.balanceFactor>0)$.balanceFactor+=Q.balanceFactor;return $},H0=function(Q){var $=Q.left;if(Q.left=$.right,Q.left)Q.left.parent=Q;if($.parent=Q.parent,$.parent)if($.parent.left===Q)$.parent.left=$;else $.parent.right=$;if(Q.parent=$,$.right=Q,Q.balanceFactor-=1,$.balanceFactor>0)Q.balanceFactor-=$.balanceFactor;if($.balanceFactor-=1,Q.balanceFactor<0)$.balanceFactor+=Q.balanceFactor;return $};class d{constructor(Q,$=!1){this._comparator=Q||mK,this._root=null,this._size=0,this._noDuplicates=!!$}destroy(){return this.clear()}clear(){return this._root=null,this._size=0,this}get size(){return this._size}contains(Q){if(this._root){var $=this._root,K=this._comparator;while($){var J=K(Q,$.key);if(J===0)return!0;else if(J<0)$=$.left;else $=$.right}}return!1}next(Q){var $=Q;if($)if($.right){$=$.right;while($.left)$=$.left}else{$=Q.parent;while($&&$.right===Q)Q=$,$=$.parent}return $}prev(Q){var $=Q;if($)if($.left){$=$.left;while($.right)$=$.right}else{$=Q.parent;while($&&$.left===Q)Q=$,$=$.parent}return $}forEach(Q){var $=this._root,K=[],J=!1,B=0;while(!J)if($)K.push($),$=$.left;else if(K.length>0)$=K.pop(),Q($,B++),$=$.right;else J=!0;return this}range(Q,$,K,J){const B=[],V=this._comparator;let Y=this._root,Z;while(B.length!==0||Y)if(Y)B.push(Y),Y=Y.left;else{if(Y=B.pop(),Z=V(Y.key,$),Z>0)break;else if(V(Y.key,Q)>=0){if(K.call(J,Y))return this}Y=Y.right}return this}keys(){var Q=this._root,$=[],K=[],J=!1;while(!J)if(Q)$.push(Q),Q=Q.left;else if($.length>0)Q=$.pop(),K.push(Q.key),Q=Q.right;else J=!0;return K}values(){var Q=this._root,$=[],K=[],J=!1;while(!J)if(Q)$.push(Q),Q=Q.left;else if($.length>0)Q=$.pop(),K.push(Q.data),Q=Q.right;else J=!0;return K}at(Q){var $=this._root,K=[],J=!1,B=0;while(!J)if($)K.push($),$=$.left;else if(K.length>0){if($=K.pop(),B===Q)return $;B++,$=$.right}else J=!0;return null}minNode(){var Q=this._root;if(!Q)return null;while(Q.left)Q=Q.left;return Q}maxNode(){var Q=this._root;if(!Q)return null;while(Q.right)Q=Q.right;return Q}min(){var Q=this._root;if(!Q)return null;while(Q.left)Q=Q.left;return Q.key}max(){var Q=this._root;if(!Q)return null;while(Q.right)Q=Q.right;return Q.key}isEmpty(){return!this._root}pop(){var Q=this._root,$=null;if(Q){while(Q.left)Q=Q.left;$={key:Q.key,data:Q.data},this.remove(Q.key)}return $}popMax(){var Q=this._root,$=null;if(Q){while(Q.right)Q=Q.right;$={key:Q.key,data:Q.data},this.remove(Q.key)}return $}find(Q){var $=this._root,K=$,J,B=this._comparator;while(K)if(J=B(Q,K.key),J===0)return K;else if(J<0)K=K.left;else K=K.right;return null}insert(Q,$){if(!this._root)return this._root={parent:null,left:null,right:null,balanceFactor:0,key:Q,data:$},this._size++,this._root;var K=this._comparator,J=this._root,B=null,V=0;if(this._noDuplicates)while(J)if(V=K(Q,J.key),B=J,V===0)return null;else if(V<0)J=J.left;else J=J.right;else while(J)if(V=K(Q,J.key),B=J,V<=0)J=J.left;else J=J.right;var Y={left:null,right:null,balanceFactor:0,parent:B,key:Q,data:$},Z;if(V<=0)B.left=Y;else B.right=Y;while(B){if(V=K(B.key,Q),V<0)B.balanceFactor-=1;else B.balanceFactor+=1;if(B.balanceFactor===0)break;else if(B.balanceFactor<-1){if(B.right.balanceFactor===1)H0(B.right);if(Z=F0(B),B===this._root)this._root=Z;break}else if(B.balanceFactor>1){if(B.left.balanceFactor===-1)F0(B.left);if(Z=H0(B),B===this._root)this._root=Z;break}B=B.parent}return this._size++,Y}remove(Q){if(!this._root)return null;var $=this._root,K=this._comparator,J=0;while($)if(J=K(Q,$.key),J===0)break;else if(J<0)$=$.left;else $=$.right;if(!$)return null;var B=$.key,V,Y;if($.left){V=$.left;while(V.left||V.right){while(V.right)V=V.right;if($.key=V.key,$.data=V.data,V.left)$=V,V=V.left}$.key=V.key,$.data=V.data,$=V}if($.right){Y=$.right;while(Y.left||Y.right){while(Y.left)Y=Y.left;if($.key=Y.key,$.data=Y.data,Y.right)$=Y,Y=Y.right}$.key=Y.key,$.data=Y.data,$=Y}var Z=$.parent,P=$,F;while(Z){if(Z.left===P)Z.balanceFactor-=1;else Z.balanceFactor+=1;if(Z.balanceFactor<-1){if(Z.right.balanceFactor===1)H0(Z.right);if(F=F0(Z),Z===this._root)this._root=F;Z=F}else if(Z.balanceFactor>1){if(Z.left.balanceFactor===-1)F0(Z.left);if(F=H0(Z),Z===this._root)this._root=F;Z=F}if(Z.balanceFactor===-1||Z.balanceFactor===1)break;P=Z,Z=Z.parent}if($.parent)if($.parent.left===$)$.parent.left=null;else $.parent.right=null;if($===this._root)this._root=null;return this._size--,B}load(Q=[],$=[],K){if(this._size!==0)throw new Error("bulk-load: tree is not empty");const J=Q.length;if(K)P0(Q,$,0,J-1,this._comparator);return this._root=Y0(null,Q,$,0,J),Z0(this._root),this._size=J,this}isBalanced(){return B0(this._root)}toString(Q){return gQ(this._root,Q)}}d.default=d;class c{size;slotNumber;x;y;textureIndex;parent;sibbling;textureSizeLimits;constructor(Q,$,K,J){this.textureSizeLimits=K?.textureSizeLimits??J??{min:p0,max:z0},this.size=Q,this.slotNumber=$,this.parent=K,this.sibbling=void 0;const{x:B,y:V,textureIndex:Y}=this.calculatePosition(Q,$);this.x=B,this.y=V,this.textureIndex=Y}calculateTextureIndex(Q,$){const[K,J]=Q,B=this.textureSizeLimits.max/K*(this.textureSizeLimits.max/J);return Math.floor($/B)}calculatePosition(Q,$){const[K,J]=Q,B=this.textureSizeLimits.max/K,V=this.textureSizeLimits.max/J,Y=$%B*K,Z=Math.floor($/B)%V*J;return{x:Y,y:Z,textureIndex:this.calculateTextureIndex(Q,$)}}getTag(){return c.getTag(this)}static getTag(Q){return`${Q.size[0]}x${Q.size[1]}-#${Q.slotNumber}`}static positionToTextureSlot(Q,$,K,J,B){const[V,Y]=K,Z=B.textureSizeLimits.max/V,F=B.textureSizeLimits.max/V*(B.textureSizeLimits.max/Y)*J+$/Y*Z+Q/V;return new c(K,F,B)}getPosition(){return{x:this.x,y:this.y,size:this.size,textureIndex:this.textureIndex}}canSplitHorizontally(){const[,Q]=this.size;return Q>this.textureSizeLimits.min}canSplitVertically(){const[Q]=this.size;return Q>this.textureSizeLimits.min}splitHorizontally(){const{x:Q,y:$,size:K,textureIndex:J}=this,[B,V]=K;if(!this.canSplitHorizontally())throw new Error(`Cannot split texture slot of size ${B} horizontally`);const Y=B/2,Z=c.positionToTextureSlot(Q,$,[Y,V],J,this),P=c.positionToTextureSlot(Q+Y,$,[Y,V],J,this);return Z.sibbling=P,P.sibbling=Z,[Z,P]}splitVertically(){const{x:Q,y:$,size:K,textureIndex:J}=this,[B,V]=K;if(!this.canSplitVertically())throw new Error(`Cannot split texture slot of size ${V} vertically`);const Y=V/2,Z=c.positionToTextureSlot(Q,$,[B,Y],J,this),P=c.positionToTextureSlot(Q,$+Y,[B,Y],J,this);return Z.sibbling=P,P.sibbling=Z,[Z,P]}}function X0(Q,$){return Math.max($,Math.pow(2,Math.ceil(Math.log(Q)/Math.log(2))))}function fQ(Q,$,K,J){if(K<1)throw new Error("Invalid count");const B=X0(Q,J.min),V=X0($,J.min),Y=new Map;let Z=J.min;for(let P=1;P<=K;P++){Z=X0(B*P,J.min);const F=X0(V*Math.ceil(K/P),J.min);Y.set(Z,F)}for(let P=Z;P<=J.max;P*=2)if(!Y.has(P))Y.set(P,V);return Y}var iK=!1,p0=16,z0=4096,dK=16;class A0{textureSlots=new d((Q,$)=>{const K=Q.size[0]*Q.size[1]-$.size[0]*$.size[1];if(K!==0)return K;return Q.slotNumber-$.slotNumber},!1);allocatedTextures={};minTextureSize;maxTextureSize;numTextureSheets;initialSlots=[];constructor({numTextureSheets:Q,minTextureSize:$,maxTextureSize:K,excludeTexture:J}={},B){if(this.numTextureSheets=Q??dK,this.minTextureSize=$??p0,this.maxTextureSize=K??z0,B)this.numTextureSheets=Math.min(this.numTextureSheets,B.getParameter(WebGL2RenderingContext.MAX_TEXTURE_IMAGE_UNITS)),this.maxTextureSize=Math.min(this.maxTextureSize,B.getParameter(WebGL2RenderingContext.MAX_TEXTURE_SIZE)),this.minTextureSize=Math.min(this.minTextureSize,this.maxTextureSize);for(let V=0;V<this.numTextureSheets;V++){if(J?.(V))continue;this.initialSlots.push(new c([this.maxTextureSize,this.maxTextureSize],V,void 0,{min:this.minTextureSize,max:this.maxTextureSize}))}this.initialSlots.forEach((V)=>this.textureSlots.insert(V))}allocate(Q,$,K=1){const{size:J,slotNumber:B,x:V,y:Y,textureIndex:Z}=this.allocateHelper(Q,$,K);return{size:J,slotNumber:B,x:V,y:Y,textureIndex:Z}}deallocate(Q){if(!this.isSlotUsed(Q))throw new Error("Slot is not allocated");const $=this.allocatedTextures[c.getTag(Q)];this.deallocateHelper($)}get countUsedTextureSheets(){return this.initialSlots.filter((Q)=>this.isSlotUsed(Q)).length}allocateHelper(Q,$,K=1){const J=fQ(Q,$,K,{min:this.minTextureSize,max:this.maxTextureSize}),B=this.findSlot(J);if(!B)throw new Error(`Could not find a slot for texture to fit ${K} sprites of size ${Q}x${$}`);this.textureSlots.remove(B);const[V,Y]=this.bestFit(J,B);return this.fitSlot(B,V,Y)}findSlot(Q){for(let $=0;$<this.textureSlots.size;$++){const J=this.textureSlots.at($).key,[B,V]=J.size;if(Q.get(B)<=V)return J}return null}calculateRatio(Q,$){return Math.max(Q/$,$/Q)}bestFit(Q,$){const[K,J]=$.size;let B=$.textureSizeLimits.max;return Q.forEach((V,Y)=>{if(Y<=K&&V<=J){const Z=Y*V,P=Q.get(B)*B;if(Z<P)B=Y;else if(Z===P){if(this.calculateRatio(Y,V)<this.calculateRatio(B,Q.get(B)))B=Y}}}),[B,Q.get(B)]}isSlotUsed(Q){return!!this.allocatedTextures[c.getTag(Q)]}deallocateHelper(Q){if(Q.parent&&Q.sibbling&&!this.isSlotUsed(Q.sibbling)){const $=Q.sibbling;if(this.textureSlots.remove($),iK&&this.textureSlots.find(Q))throw new Error("Slot is not expected to be in the tree");const K=Q.parent;this.deallocateHelper(K);return}this.textureSlots.insert(Q),delete this.allocatedTextures[Q.getTag()]}trySplitHorizontally(Q,$,K){if(Q.canSplitHorizontally()){const[J,B]=Q.splitHorizontally();if(J.size[0]>=$)return this.textureSlots.insert(B),this.fitSlot(J,$,K)}return null}trySplitVertically(Q,$,K){if(Q.canSplitVertically()){const[J,B]=Q.splitVertically();if(J.size[1]>=K)return this.textureSlots.insert(B),this.fitSlot(J,$,K)}return null}fitSlot(Q,$,K){if(this.allocatedTextures[Q.getTag()]=Q,Q.size[0]>Q.size[1]){const J=this.trySplitHorizontally(Q,$,K)??this.trySplitVertically(Q,$,K);if(J)return J}else{const J=this.trySplitVertically(Q,$,K)??this.trySplitHorizontally(Q,$,K);if(J)return J}return Q}listSlots(){this.textureSlots.forEach((Q)=>{console.log(Q.key?.getTag())})}}var W0=15;class y0 extends f{gl;uniforms;textureBuffers={};tempContext=new OffscreenCanvas(1,1).getContext("2d");textureSlotAllocator=new A0({excludeTexture:(Q)=>Q===W0});textureSlotAllocatorForVideo=new A0({excludeTexture:(Q)=>Q!==W0});constructor(Q,$){super();this.gl=Q,this.uniforms=$,this.tempContext.imageSmoothingEnabled=!0}initialize(){this.initTextureUniforms(),this.initMaxTexture()}getTexture(Q){if(!this.textureBuffers[Q]){const $=this.gl.createTexture();if(!$)return;this.gl.bindTexture(O.TEXTURE_2D,$),this.gl.texImage2D(O.TEXTURE_2D,0,O.RGBA,this.textureSlotAllocator.maxTextureSize,this.textureSlotAllocator.maxTextureSize,0,O.RGBA,O.UNSIGNED_BYTE,null),this.textureBuffers[Q]=$,this.addOnDestroy(()=>this.gl.deleteTexture($))}return this.textureBuffers[Q]}loadTexture(Q,$,K,J,B){this.gl.activeTexture(O[$]),this.gl.bindTexture(O.TEXTURE_2D,K),this.applyTexImage2d(Q,J,B),this.gl.texParameteri(O.TEXTURE_2D,O.TEXTURE_MIN_FILTER,O.LINEAR)}applyTexImage2d(Q,[$,K,J,B],[V,Y,Z,P]){if(J===Z&&B===P&&!$&&!K)this.gl.texSubImage2D(O.TEXTURE_2D,0,V,Y,Z,P,O.RGBA,O.UNSIGNED_BYTE,Q.texImgSrc);else{const F=this.tempContext.canvas;if(Q.texImgSrc instanceof ImageData){if(F.width=Z||Q.width,F.height=P||Q.height,this.tempContext.putImageData(Q.texImgSrc,0,0),$||K)console.warn("Offset not available when sending imageData")}else{const H=J||Q.width,X=B||Q.height;F.width=Z||H,F.height=P||X,this.tempContext.drawImage(Q.texImgSrc,$,K,H,X,0,0,F.width,F.height)}this.gl.texSubImage2D(O.TEXTURE_2D,0,V,Y,F.width,F.height,O.RGBA,O.UNSIGNED_BYTE,F)}}allocateSlotForImage(Q){const K=(Q.isVideo?this.textureSlotAllocatorForVideo:this.textureSlotAllocator).allocate(Q.width,Q.height),J=`TEXTURE${K.textureIndex}`,B=this.getTexture(J);if(!B)throw new Error(`Invalid texture Id ${J}`);const V=this.assignImageToTexture(Q,J,B,[0,0,Q.width,Q.height],[K.x,K.y,...K.size]);return{slot:K,refreshCallback:V}}assignImageToTexture(Q,$,K,J,B){const V=J??[0,0,Q.width,Q.height],Y=B??[0,0,V[2],V[3]],Z=()=>{this.gl.bindTexture(O.TEXTURE_2D,K),this.applyTexImage2d(Q,V,Y)};if(Q.active)Z();else this.loadTexture(Q,$,K,V,Y),Q.active=!0;return Z}setupTextureForVideo(Q){const $=this.getTexture(Q);if($)this.gl.activeTexture(O[Q]),this.gl.bindTexture(O.TEXTURE_2D,$),this.gl.texParameteri(O.TEXTURE_2D,O.TEXTURE_MIN_FILTER,O.LINEAR),this.gl.texParameteri(O.TEXTURE_2D,O.TEXTURE_MAG_FILTER,O.LINEAR)}generateMipMap(Q){const $=this.getTexture(Q);if($)this.gl.activeTexture(O[Q]),this.gl.bindTexture(O.TEXTURE_2D,$),this.gl.texParameteri(O.TEXTURE_2D,O.TEXTURE_MIN_FILTER,O.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(O.TEXTURE_2D,O.TEXTURE_MAG_FILTER,O.LINEAR),this.gl.generateMipmap(O.TEXTURE_2D)}initTextureUniforms(){const Q=this.gl.getParameter(O.MAX_TEXTURE_IMAGE_UNITS),$=new Array(Q).fill(null).map((J,B)=>B),K=this.uniforms.getUniformLocation(vQ);this.gl.uniform1iv(K,$)}initMaxTexture(){const Q=this.uniforms.getUniformLocation(wQ);this.gl.uniform1f(Q,this.textureSlotAllocator.maxTextureSize)}}class n extends f{texImgSrc;active=!1;width;height;isVideo;schedule;constructor(Q,$){super();this.texImgSrc=Q;const K=Q;if(this.isVideo=!!(K.videoWidth||K.videoHeight),this.width=K.naturalWidth??K.videoWidth??K.displayWidth??K.width?.baseValue?.value??K.width,this.height=K.naturalHeight??K.videoHeight??K.displayHeight??K.height?.baseValue?.value??K.height,this.schedule=$?{period:1000/$}:void 0,!this.width||!this.height)throw new Error("Invalid image")}update(){this.refreshCallback?.()}static createFromCanvas(Q){return new n(Q)}static async loadImage(Q){const $=await new Promise((K,J)=>{const B=new Image,V=(Y)=>J(Y.error);B.addEventListener("error",V),B.addEventListener("load",()=>K(B),{once:!0}),B.src=Q});return new n($)}static async loadVideo(Q,$,K=30){const J=await new Promise((V,Y)=>{const Z=document.createElement("video");if(Z.loop=!0,$!==void 0)Z.volume=$;Z.addEventListener("loadedmetadata",()=>{Z.play(),V(Z)},{once:!0}),Z.addEventListener("error",(P)=>Y(P.error)),Z.src=Q}),B=new n(J,K);return B.addOnDestroy(()=>J.pause()),B}static async loadWebcam(Q){const $=await new Promise((B,V)=>{const Y=document.createElement("video");Y.loop=!0,Y.addEventListener("loadedmetadata",()=>Y.play()),Y.addEventListener("playing",()=>B(Y),{once:!0}),Y.addEventListener("error",(Z)=>V(Z.error))}),K=new n($);let J=!1;return navigator.mediaDevices.getUserMedia({video:{deviceId:Q}}).then((B)=>{if(!J)$.srcObject=B,K.addOnDestroy(()=>B.getTracks().forEach((V)=>V.stop()))}),K.addOnDestroy(()=>{J=!0,$.pause()}),K}}var o=function(Q){return Q};class x0 extends f{constructor(){super(...arguments)}images=[];renderProcedures={image:o((Q,$)=>this.loadImage(Q,$.src)),video:o((Q,$)=>this.loadVideo(Q,$.src,$.volume,$.fps)),draw:o((Q,$)=>this.drawImage(Q,$.draw)),canvas:o((Q,$)=>this.loadCanvas(Q,$.canvas)),webcam:o((Q,$)=>this.loadWebCam(Q,$.deviceId))};hasImageId(Q){return!!this.getMedia(Q)}getMedia(Q){return this.images[Q]}setImage(Q,$){this.images[Q]=$}async renderMedia(Q,$){return this.renderProcedures[$.type](Q,$)}async drawImage(Q,$){const K=new OffscreenCanvas(1,1);$(K.getContext("2d"));const J=n.createFromCanvas(K);return this.images[Q]=this.own(J),J}async loadCanvas(Q,$){const K=n.createFromCanvas($);return $.getContext("2d"),this.images[Q]=this.own(K),K}async loadImage(Q,$){const K=await n.loadImage($);return this.images[Q]=this.own(K),K}async loadVideo(Q,$,K,J){const B=await n.loadVideo($,K,J);return this.images[Q]=this.own(B),B}async loadWebCam(Q,$){const K=await n.loadWebcam($);return this.images[Q]=this.own(K),K}}var pQ=`#version 300 es
//  ~{AUTHOR}

precision highp float;

//  IN
//  shape
layout(location = 0) in vec2 position;
layout(location = 1) in mat4 transform;
//  2, 3, 4 reserved for transform
//  animation
layout(location = 5) in vec2 slotSize_and_number;

//  UNIFORM
uniform float maxTextureSize;
uniform mat4 cam;
uniform mat4 projection;

//  OUT
out vec2 vTex;
out float textureIndex;

void main() {
  vec2 tex = position.xy * vec2(0.49, -0.49) + 0.5;
  vec2 slotSize = vec2(
    pow(2.0, floor(slotSize_and_number.x / 16.0)),
    pow(2.0, mod(slotSize_and_number.x, 16.0)));
  float slotNumber = slotSize_and_number.y;
  float maxCols = maxTextureSize / slotSize.x;
  float maxRows = maxTextureSize / slotSize.y;
  float slotX = mod(slotNumber, maxCols);
  float slotY = mod(floor(slotNumber / maxCols), maxRows);

  gl_Position = projection * cam * transform * vec4(position, 0.0, 1.0);
  vTex = (vec2(slotX, slotY) + tex) * slotSize / maxTextureSize;
  textureIndex = floor(slotNumber / (maxCols * maxRows));
}
`;var zQ=`#version 300 es
//  ~{AUTHOR}
precision highp float;

//  CONST
const int NUM_TEXTURES = 16;
const float threshold = 0.00001;

//  IN
//  texture
uniform sampler2D uTextures[NUM_TEXTURES];
in float textureIndex;
in vec2 vTex;
in float opacity;

//  OUT
out vec4 fragColor;

//  FUNCTIONS
vec4 getTextureColor(float textureSlot, vec2 vTexturePoint);

void main() {
  vec4 color = getTextureColor(textureIndex, vTex);
  if (color.a <= .0001) {
    discard;
  };
  fragColor = color;
}

vec4 getTextureColor(float textureSlot, vec2 vTexturePoint) {
  if (abs(0.0 - textureSlot) < threshold) {
    return texture(uTextures[0], vTexturePoint);
  }
  if (abs(1.0 - textureSlot) < threshold) {
    return texture(uTextures[1], vTexturePoint);
  }
  if (abs(2.0 - textureSlot) < threshold) {
    return texture(uTextures[2], vTexturePoint);
  }
  if (abs(3.0 - textureSlot) < threshold) {
    return texture(uTextures[3], vTexturePoint);
  }
  if (abs(4.0 - textureSlot) < threshold) {
    return texture(uTextures[4], vTexturePoint);
  }
  if (abs(5.0 - textureSlot) < threshold) {
    return texture(uTextures[5], vTexturePoint);
  }
  if (abs(6.0 - textureSlot) < threshold) {
    return texture(uTextures[6], vTexturePoint);
  }
  if (abs(7.0 - textureSlot) < threshold) {
    return texture(uTextures[7], vTexturePoint);
  }
  if (abs(8.0 - textureSlot) < threshold) {
    return texture(uTextures[8], vTexturePoint);
  }
  if (abs(9.0 - textureSlot) < threshold) {
    return texture(uTextures[9], vTexturePoint);
  }
  if (abs(10.0 - textureSlot) < threshold) {
    return texture(uTextures[10], vTexturePoint);
  }
  if (abs(11.0 - textureSlot) < threshold) {
    return texture(uTextures[11], vTexturePoint);
  }
  if (abs(12.0 - textureSlot) < threshold) {
    return texture(uTextures[12], vTexturePoint);
  }
  if (abs(13.0 - textureSlot) < threshold) {
    return texture(uTextures[13], vTexturePoint);
  }
  if (abs(14.0 - textureSlot) < threshold) {
    return texture(uTextures[14], vTexturePoint);
  }
  if (abs(15.0 - textureSlot) < threshold) {
    return texture(uTextures[15], vTexturePoint);
  }
  return texture(uTextures[0], vTexturePoint);
}
`;function c0(Q,$){return Q.replace(/~\{(\w+)\}/g,(K,J)=>{return $?.[J]||K})}var oK=function(Q){if(!uK)return Q;return new Proxy(Q,{get(K,J){const B=K,V=B[J];if(typeof V==="function")return(...Z)=>{const P=V.apply(B,Z);return console.log(`gl.${String(J)}(`,Z,") = ",P),P};else return console.log(`gl.${String(J)} = `,V),V}})},rK={alpha:!0,antialias:!1,depth:!0,desynchronized:!0,failIfMajorPerformanceCaveat:void 0,powerPreference:"default",premultipliedAlpha:!0,preserveDrawingBuffer:!1,stencil:!1},eK=6,uK=!1;class a extends f{gl;programs;attributeBuffers;uniforms;canvas;textureManager;imageManager;textureSlots=[];world;onDeactivateWorlds=new Set;onCleanupBuffers=new Set;onResize=new Set;topVisibleSprite=-1;cameraMatrixUniforms={};constructor(Q,{attributes:$}={}){super();const K=Q.getContext("webgl2",{...rK,...$});this.gl=oK(K),this.canvas=Q,this.programs=this.own(new I0(this.gl)),this.uniforms=this.own(new g0(this.gl,this.programs)),this.attributeBuffers=this.own(new v0(this.gl,this.programs)),this.textureManager=new y0(this.gl,this.uniforms),this.imageManager=new x0;const J=this.checkCanvasSize.bind(this);window.addEventListener("resize",J),this.addOnDestroy(()=>window.removeEventListener("resize",J)),this.addOnDestroy(()=>this.resetWorld()),this.initialize()}addResizeListener(Q){Q(this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.onResize.add(Q)}removeResizeListener(Q){this.onResize.delete(Q)}resetWorld(){this.textureSlots.length=0,this.onDeactivateWorlds.forEach((Q)=>Q()),this.onDeactivateWorlds.clear(),this.onCleanupBuffers.forEach((Q)=>Q()),this.onCleanupBuffers.clear()}setWorld(Q){this.resetWorld(),this.world=Q,this.initializeBuffers(Q?.getMaxSpriteCount()??0);const $=Q?.activate();if($)this.onDeactivateWorlds.add($)}checkCanvasSize(){if(this.canvas instanceof HTMLCanvasElement)this.canvas.width=this.canvas.offsetWidth*2,this.canvas.height=this.canvas.offsetHeight*2;this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.onResize.forEach((Q)=>Q(this.gl.drawingBufferWidth,this.gl.drawingBufferHeight))}initialize(){const $={AUTHOR:"Jack le hamster"};this.programs.addProgram("main",c0(pQ,$),c0(zQ,$)),this.programs.useProgram("main"),this.cameraMatrixUniforms[z.PROJECTION]=this.uniforms.getUniformLocation(IQ,"main"),this.cameraMatrixUniforms[z.VIEW]=this.uniforms.getUniformLocation(hQ,"main"),this.gl.enable(O.DEPTH_TEST),this.gl.depthFunc(O.LESS),this.gl.clearDepth(1),this.gl.enable(O.BLEND),this.gl.blendFunc(O.SRC_ALPHA,O.ONE_MINUS_SRC_ALPHA),this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.gl.disable(this.gl.CULL_FACE),this.textureManager.initialize(),this.checkCanvasSize()}initializeBuffers(Q){if(this.onCleanupBuffers.forEach(($)=>$()),this.onCleanupBuffers.clear(),Q)[this.initializeIndexBuffer(SQ),this.initializePositionBuffer(TQ),this.initializeTransformBuffer(T0,Q),this.initializeSlotSizeBuffer(S0,Q)].forEach((K)=>this.onCleanupBuffers.add(K))}initializeIndexBuffer(Q){const $=this.attributeBuffers.createBuffer(Q);return this.gl.bindBuffer(O.ELEMENT_ARRAY_BUFFER,$.buffer),this.gl.bufferData(O.ELEMENT_ARRAY_BUFFER,Uint16Array.from([0,1,2,2,3,0]),O.STATIC_DRAW),()=>{this.attributeBuffers.deleteBuffer(Q)}}initializePositionBuffer(Q){const $=this.attributeBuffers.createBuffer(Q);return this.gl.bindBuffer(O.ARRAY_BUFFER,$.buffer),this.gl.vertexAttribPointer($.location,2,O.FLOAT,!1,0,0),this.gl.enableVertexAttribArray($.location),this.gl.bufferData(O.ARRAY_BUFFER,Float32Array.from([-1,-1,1,-1,1,1,-1,1]),O.STATIC_DRAW),()=>{this.gl.disableVertexAttribArray($.location),this.attributeBuffers.deleteBuffer(Q)}}initializeTransformBuffer(Q,$){const K=this.attributeBuffers.createBuffer(Q);this.gl.bindBuffer(O.ARRAY_BUFFER,K.buffer);for(let J=0;J<4;J++){const B=K.location+J;this.gl.vertexAttribPointer(B,4,O.FLOAT,!1,16*Float32Array.BYTES_PER_ELEMENT,J*4*Float32Array.BYTES_PER_ELEMENT),this.gl.enableVertexAttribArray(B),this.gl.vertexAttribDivisor(B,1)}return this.gl.bufferData(O.ARRAY_BUFFER,$*4*4*Float32Array.BYTES_PER_ELEMENT,O.DYNAMIC_DRAW),()=>{this.gl.disableVertexAttribArray(K.location),this.attributeBuffers.deleteBuffer(Q)}}initializeSlotSizeBuffer(Q,$){const K=this.attributeBuffers.createBuffer(Q);this.gl.bindBuffer(O.ARRAY_BUFFER,K.buffer);const J=K.location;return this.gl.vertexAttribPointer(J,2,O.FLOAT,!1,2*Float32Array.BYTES_PER_ELEMENT,0),this.gl.enableVertexAttribArray(J),this.gl.vertexAttribDivisor(J,1),this.gl.bufferData(O.ARRAY_BUFFER,$*2*Float32Array.BYTES_PER_ELEMENT,O.DYNAMIC_DRAW),()=>{this.gl.disableVertexAttribArray(K.location),this.attributeBuffers.deleteBuffer(Q)}}static spriteMatrix=L.create();updateSprite(Q,$){a.spriteMatrix.identity();const K=a.spriteMatrix.getMatrix(),J=$.getSprite(Q);return J?.transforms.forEach((B)=>q.multiply(K,K,B)),this.gl.bufferSubData(O.ARRAY_BUFFER,16*Float32Array.BYTES_PER_ELEMENT*Q,K),!!J}async updateTextures(Q,$){const K=await Promise.all(Q.map(async(V)=>{const Y=$.getMedia(V);return{mediaData:await this.imageManager.renderMedia(V,Y),imageId:V}})),J=await Promise.all(K.map(async({mediaData:V,imageId:Y})=>{const{slot:Z,refreshCallback:P}=this.textureManager.allocateSlotForImage(V),F=Math.log2(Z.size[0]),H=Math.log2(Z.size[1]),X=F*16+H;return this.textureSlots[Y]={buffer:Float32Array.from([X,Z.slotNumber])},V.refreshCallback=P,Z.textureIndex}));return new Set(J).forEach((V)=>{if(V===W0)this.textureManager.setupTextureForVideo(`TEXTURE${V}`);else this.textureManager.generateMipMap(`TEXTURE${V}`)}),K.map(({mediaData:V})=>V)}drawElementsInstanced(Q,$){this.gl.drawElementsInstanced(O.TRIANGLES,Q,O.UNSIGNED_SHORT,0,$)}updateSprites(Q){const $=Q.getUpdatedSpriteTransforms();if($.size){const J=this.attributeBuffers.getAttributeBuffer(T0);this.gl.bindBuffer(O.ARRAY_BUFFER,J.buffer),$?.forEach((B)=>{if(this.updateSprite(B,Q))this.topVisibleSprite=Math.max(this.topVisibleSprite,B)}),$.clear()}const K=Q.getUpdatedSpriteTextureSlot();if(K.size){const J=this.attributeBuffers.getAttributeBuffer(S0);this.gl.bindBuffer(O.ARRAY_BUFFER,J.buffer),K?.forEach((B)=>{const V=Q.getSprite(B),Y=this.textureSlots[V?.imageId??-1];if(Y){const{buffer:Z}=Y;this.gl.bufferSubData(O.ARRAY_BUFFER,2*Float32Array.BYTES_PER_ELEMENT*B,Z),K.delete(B)}})}while(!Q.getSprite(this.topVisibleSprite))this.topVisibleSprite--;return this.topVisibleSprite+1}updateCameraMatrix(Q,$){this.gl.uniformMatrix4fv(this.cameraMatrixUniforms[Q],!1,$)}refresh(Q,$){const K=Q.getUpdateImageIds();if(K.size){const B=Array.from(K.keys());K.clear(),this.updateTextures(B,Q).then((V)=>{V.forEach((Y)=>{if(Y.isVideo)$.registerUpdate(Y,Y.schedule)})})}const J=this.updateSprites(Q);this.drawElementsInstanced(eK,J)}bindVertexArray(){return this.own(new w0(this.gl))}update(Q){if(this.world)this.refresh(this.world,Q)}}var aK=50;class n0{updateSchedule=new Map;time=0;loop(Q,$,K){this.registerUpdate(Q,{period:$?1000/$:1,expirationTime:K})}registerUpdate(Q,$={}){$.triggerTime=$.triggerTime??this.time,$.expirationTime=$.expirationTime??Infinity,$.period=$.period,this.updateSchedule.set(Q,$)}start(){let Q=0,$=0;const K=(J)=>{const B=Math.min(J-$,aK);Q=requestAnimationFrame(K),$=J,this.time=J,this.updateSchedule.forEach((V,Y)=>{if(J<V.triggerTime)return;if((Array.isArray(Y)?Y:[Y]).forEach((P)=>P.update(this,B)),V.period&&J<V.expirationTime)V.triggerTime=Math.max(V.triggerTime+V.period,J);else this.updateSchedule.delete(Y)})};requestAnimationFrame(K),this.stop=()=>{cancelAnimationFrame(Q),this.stop=()=>{}}}stop=()=>{}}class l0{motor;engine;constructor({motor:Q,canvas:$,engine:K,size:J}){this.motor=Q??new n0,this.engine=K??new a($??new OffscreenCanvas(J[0],J[1]))}start(Q){this.motor.loop(Q),this.motor.loop(this.engine),this.engine.setWorld(Q),this.motor.start()}}async function k8(){console.log("Hello World!")}async function _8(Q){Q.style.border="2px solid silver",Q.style.cursor="grab",Q.addEventListener("mouseenter",()=>{Q.style.borderColor="black"}),Q.addEventListener("mouseleave",()=>{Q.style.borderColor="silver"});const $=new l0({canvas:Q}),K=new L0($);return $.start(K),$}export{_8 as testCanvas,k8 as hello,L0 as World};

//# debugId=78A8754D4054F2E264756e2164756e21
