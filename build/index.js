var mQ=Object.defineProperty;var O0=(Q,$)=>{for(var K in $)mQ(Q,K,{get:$[K],enumerable:!0,configurable:!0,set:(J)=>$[K]=()=>J})};class t{Q;$;constructor(Q,$=Q.camera){this.core=Q;this.camera=$;this.getSprite=this.getSprite.bind(this),this.getMedia=this.getMedia.bind(this)}onUpdate(Q,$){console.warn("pass onUpdate to inform about changes in the world.",Q,$)}}class w{disposables;own(Q){if(!this.disposables)this.disposables=new Set;return this.disposables.add(Q),Q}addOnDestroy(Q){this.disposables?.add({destroy:Q})}destroy(){this.disposables?.forEach((Q)=>Q.destroy())}}var U=globalThis.WebGL2RenderingContext??{},u0="position",o0="index",U0="transform",E0="slotSize_and_number",a0="cam",t0="projection",QQ="maxTextureSize",$Q="uTextures";var dQ=function(Q,$,K){function J(X,P){function j(O){return O===Q?.VERTEX_SHADER?"vertex":O===Q?.FRAGMENT_SHADER?"fragment":void 0}if(P!==Q.VERTEX_SHADER&&P!==Q.FRAGMENT_SHADER)throw new Error(`Shader error in ${j(P)}`);const A=Q.createShader(P);if(!A)throw new Error(`Unable to generate ${j(P)} shader.`);if(Q.shaderSource(A,X),Q.compileShader(A),!Q.getShaderParameter(A,Q.COMPILE_STATUS))console.error(`Shader compile error in ${j(P)}:`+Q.getShaderInfoLog(A));return A}const B=Q.createProgram();if(!B)throw new Error("Unable to create program.");const Y=J($,Q.VERTEX_SHADER),Z=J(K,Q.FRAGMENT_SHADER),V=Q.getShaderInfoLog(Y),F=Q.getShaderInfoLog(Z);if(V)console.log("VERTEX",V);if(F)console.log("FRAGMENT",F);Q.attachShader(B,Y),Q.attachShader(B,Z),Q.linkProgram(B);const H=Q.getProgramInfoLog(B);if(H)console.log("PROGRAM",H);if(Q.detachShader(B,Y),Q.detachShader(B,Z),Q.deleteShader(Y),Q.deleteShader(Z),Q.validateProgram(B),Object.entries(U).forEach(([X,P])=>{if(P&&Q.getError()===P)console.log(`gl.${X}`)}),!Q.getProgramParameter(B,Q.LINK_STATUS))throw new Error("Unable to initialize the shader program:\n"+Q.getProgramInfoLog(B));return B},iQ=function(Q,$){Q.deleteProgram($)};class N0 extends w{gl;program;constructor(Q,$,K){super();this.gl=Q,this.program=dQ(Q,$.trim(),K.trim())}use(){this.gl.useProgram(this.program)}destroy(){super.destroy(),iQ(this.gl,this.program)}}class k0 extends w{activeProgramId="";gl;programs={};constructor(Q){super();this.gl=Q}addProgram(Q,$,K){if(this.programs[Q])this.removeProgram(Q);this.programs[Q]=this.own(new N0(this.gl,$,K))}useProgram(Q){if(this.activeProgramId!==Q)this.activeProgramId=Q,this.programs[Q].use()}removeProgram(Q){this.programs[Q].destroy(),delete this.programs[Q]}getProgram(Q){return this.programs[Q??this.activeProgramId]?.program}}class R0 extends w{gl;triangleArray;constructor(Q){super();this.gl=Q,this.triangleArray=Q.createVertexArray(),Q.bindVertexArray(this.triangleArray)}destroy(){this.gl.deleteVertexArray(this.triangleArray)}}class _0 extends w{bufferRecord={};gl;programs;constructor(Q,$){super();this.gl=Q,this.programs=$}getAttributeLocation(Q,$){const K=this.programs.getProgram($);return K?this.gl.getAttribLocation(K,Q)??-1:-1}createBuffer(Q){this.deleteBuffer(Q);const $=this.gl?.createBuffer();if(!$)throw new Error(`Unable to create buffer "${Q}"`);const K={buffer:$,location:this.getAttributeLocation(Q)};return this.bufferRecord[Q]=K,K}deleteBuffer(Q){if(this.bufferRecord[Q])this.gl.deleteBuffer(this.bufferRecord[Q].buffer),delete this.bufferRecord[Q]}getAttributeBuffer(Q){const $=this.bufferRecord[Q];if(!$)throw new Error(`Attribute "${Q}" not created. Make sure "createBuffer" is called.`);return $}destroy(){Object.keys(this.bufferRecord).forEach((Q)=>this.deleteBuffer(Q))}}class D0 extends w{gl;programs;constructor(Q,$){super();this.gl=Q,this.programs=$}getUniformLocation(Q,$){const K=this.programs.getProgram($);return this.gl.getUniformLocation(K,Q)}}function KQ(Q,$=(K)=>K.key){var K=[];return G0(Q,"",!0,(J)=>K.push(J),$),K.join("")}var G0=function(Q,$,K,J,B){if(Q){J(`${$}${K?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 "}${B(Q)}\n`);const Y=$+(K?"    ":"\u2502   ");if(Q.left)G0(Q.left,Y,!1,J,B);if(Q.right)G0(Q.right,Y,!0,J,B)}};function Q0(Q){if(Q===null)return!0;var $=$0(Q.left),K=$0(Q.right);if(Math.abs($-K)<=1&&Q0(Q.left)&&Q0(Q.right))return!0;return!1}var $0=function(Q){return Q?1+Math.max($0(Q.left),$0(Q.right)):0};function K0(Q,$,K,J,B){const Y=B-J;if(Y>0){const Z=J+Math.floor(Y/2),V=$[Z],F=K[Z],H={key:V,data:F,parent:Q};return H.left=K0(H,$,K,J,Z),H.right=K0(H,$,K,Z+1,B),H}return null}function J0(Q){if(Q===null)return 0;const $=J0(Q.left),K=J0(Q.right);return Q.balanceFactor=$-K,Math.max($,K)+1}function B0(Q,$,K,J,B){if(K>=J)return;const Y=Q[K+J>>1];let Z=K-1,V=J+1;while(!0){do Z++;while(B(Q[Z],Y)<0);do V--;while(B(Q[V],Y)>0);if(Z>=V)break;let F=Q[Z];Q[Z]=Q[V],Q[V]=F,F=$[Z],$[Z]=$[V],$[V]=F}B0(Q,$,K,V,B),B0(Q,$,V+1,J,B)}var sQ=function(Q,$){return Q>$?1:Q<$?-1:0},Y0=function(Q){var $=Q.right;if(Q.right=$.left,$.left)$.left.parent=Q;if($.parent=Q.parent,$.parent)if($.parent.left===Q)$.parent.left=$;else $.parent.right=$;if(Q.parent=$,$.left=Q,Q.balanceFactor+=1,$.balanceFactor<0)Q.balanceFactor-=$.balanceFactor;if($.balanceFactor+=1,Q.balanceFactor>0)$.balanceFactor+=Q.balanceFactor;return $},Z0=function(Q){var $=Q.left;if(Q.left=$.right,Q.left)Q.left.parent=Q;if($.parent=Q.parent,$.parent)if($.parent.left===Q)$.parent.left=$;else $.parent.right=$;if(Q.parent=$,$.right=Q,Q.balanceFactor-=1,$.balanceFactor>0)Q.balanceFactor-=$.balanceFactor;if($.balanceFactor-=1,Q.balanceFactor<0)$.balanceFactor+=Q.balanceFactor;return $};class d{constructor(Q,$=!1){this._comparator=Q||sQ,this._root=null,this._size=0,this._noDuplicates=!!$}destroy(){return this.clear()}clear(){return this._root=null,this._size=0,this}get size(){return this._size}contains(Q){if(this._root){var $=this._root,K=this._comparator;while($){var J=K(Q,$.key);if(J===0)return!0;else if(J<0)$=$.left;else $=$.right}}return!1}next(Q){var $=Q;if($)if($.right){$=$.right;while($.left)$=$.left}else{$=Q.parent;while($&&$.right===Q)Q=$,$=$.parent}return $}prev(Q){var $=Q;if($)if($.left){$=$.left;while($.right)$=$.right}else{$=Q.parent;while($&&$.left===Q)Q=$,$=$.parent}return $}forEach(Q){var $=this._root,K=[],J=!1,B=0;while(!J)if($)K.push($),$=$.left;else if(K.length>0)$=K.pop(),Q($,B++),$=$.right;else J=!0;return this}range(Q,$,K,J){const B=[],Y=this._comparator;let Z=this._root,V;while(B.length!==0||Z)if(Z)B.push(Z),Z=Z.left;else{if(Z=B.pop(),V=Y(Z.key,$),V>0)break;else if(Y(Z.key,Q)>=0){if(K.call(J,Z))return this}Z=Z.right}return this}keys(){var Q=this._root,$=[],K=[],J=!1;while(!J)if(Q)$.push(Q),Q=Q.left;else if($.length>0)Q=$.pop(),K.push(Q.key),Q=Q.right;else J=!0;return K}values(){var Q=this._root,$=[],K=[],J=!1;while(!J)if(Q)$.push(Q),Q=Q.left;else if($.length>0)Q=$.pop(),K.push(Q.data),Q=Q.right;else J=!0;return K}at(Q){var $=this._root,K=[],J=!1,B=0;while(!J)if($)K.push($),$=$.left;else if(K.length>0){if($=K.pop(),B===Q)return $;B++,$=$.right}else J=!0;return null}minNode(){var Q=this._root;if(!Q)return null;while(Q.left)Q=Q.left;return Q}maxNode(){var Q=this._root;if(!Q)return null;while(Q.right)Q=Q.right;return Q}min(){var Q=this._root;if(!Q)return null;while(Q.left)Q=Q.left;return Q.key}max(){var Q=this._root;if(!Q)return null;while(Q.right)Q=Q.right;return Q.key}isEmpty(){return!this._root}pop(){var Q=this._root,$=null;if(Q){while(Q.left)Q=Q.left;$={key:Q.key,data:Q.data},this.remove(Q.key)}return $}popMax(){var Q=this._root,$=null;if(Q){while(Q.right)Q=Q.right;$={key:Q.key,data:Q.data},this.remove(Q.key)}return $}find(Q){var $=this._root,K=$,J,B=this._comparator;while(K)if(J=B(Q,K.key),J===0)return K;else if(J<0)K=K.left;else K=K.right;return null}insert(Q,$){if(!this._root)return this._root={parent:null,left:null,right:null,balanceFactor:0,key:Q,data:$},this._size++,this._root;var K=this._comparator,J=this._root,B=null,Y=0;if(this._noDuplicates)while(J)if(Y=K(Q,J.key),B=J,Y===0)return null;else if(Y<0)J=J.left;else J=J.right;else while(J)if(Y=K(Q,J.key),B=J,Y<=0)J=J.left;else J=J.right;var Z={left:null,right:null,balanceFactor:0,parent:B,key:Q,data:$},V;if(Y<=0)B.left=Z;else B.right=Z;while(B){if(Y=K(B.key,Q),Y<0)B.balanceFactor-=1;else B.balanceFactor+=1;if(B.balanceFactor===0)break;else if(B.balanceFactor<-1){if(B.right.balanceFactor===1)Z0(B.right);if(V=Y0(B),B===this._root)this._root=V;break}else if(B.balanceFactor>1){if(B.left.balanceFactor===-1)Y0(B.left);if(V=Z0(B),B===this._root)this._root=V;break}B=B.parent}return this._size++,Z}remove(Q){if(!this._root)return null;var $=this._root,K=this._comparator,J=0;while($)if(J=K(Q,$.key),J===0)break;else if(J<0)$=$.left;else $=$.right;if(!$)return null;var B=$.key,Y,Z;if($.left){Y=$.left;while(Y.left||Y.right){while(Y.right)Y=Y.right;if($.key=Y.key,$.data=Y.data,Y.left)$=Y,Y=Y.left}$.key=Y.key,$.data=Y.data,$=Y}if($.right){Z=$.right;while(Z.left||Z.right){while(Z.left)Z=Z.left;if($.key=Z.key,$.data=Z.data,Z.right)$=Z,Z=Z.right}$.key=Z.key,$.data=Z.data,$=Z}var V=$.parent,F=$,H;while(V){if(V.left===F)V.balanceFactor-=1;else V.balanceFactor+=1;if(V.balanceFactor<-1){if(V.right.balanceFactor===1)Z0(V.right);if(H=Y0(V),V===this._root)this._root=H;V=H}else if(V.balanceFactor>1){if(V.left.balanceFactor===-1)Y0(V.left);if(H=Z0(V),V===this._root)this._root=H;V=H}if(V.balanceFactor===-1||V.balanceFactor===1)break;F=V,V=V.parent}if($.parent)if($.parent.left===$)$.parent.left=null;else $.parent.right=null;if($===this._root)this._root=null;return this._size--,B}load(Q=[],$=[],K){if(this._size!==0)throw new Error("bulk-load: tree is not empty");const J=Q.length;if(K)B0(Q,$,0,J-1,this._comparator);return this._root=K0(null,Q,$,0,J),J0(this._root),this._size=J,this}isBalanced(){return Q0(this._root)}toString(Q){return KQ(this._root,Q)}}d.default=d;class x{size;slotNumber;x;y;textureIndex;parent;sibbling;textureSizeLimits;constructor(Q,$,K,J){this.textureSizeLimits=K?.textureSizeLimits??J??{min:q0,max:M0},this.size=Q,this.slotNumber=$,this.parent=K,this.sibbling=void 0;const{x:B,y:Y,textureIndex:Z}=this.calculatePosition(Q,$);this.x=B,this.y=Y,this.textureIndex=Z}calculateTextureIndex(Q,$){const[K,J]=Q,B=this.textureSizeLimits.max/K*(this.textureSizeLimits.max/J);return Math.floor($/B)}calculatePosition(Q,$){const[K,J]=Q,B=this.textureSizeLimits.max/K,Y=this.textureSizeLimits.max/J,Z=$%B*K,V=Math.floor($/B)%Y*J;return{x:Z,y:V,textureIndex:this.calculateTextureIndex(Q,$)}}getTag(){return x.getTag(this)}static getTag(Q){return`${Q.size[0]}x${Q.size[1]}-#${Q.slotNumber}`}static positionToTextureSlot(Q,$,K,J,B){const[Y,Z]=K,V=B.textureSizeLimits.max/Y,H=B.textureSizeLimits.max/Y*(B.textureSizeLimits.max/Z)*J+$/Z*V+Q/Y;return new x(K,H,B)}getPosition(){return{x:this.x,y:this.y,size:this.size,textureIndex:this.textureIndex}}canSplitHorizontally(){const[,Q]=this.size;return Q>this.textureSizeLimits.min}canSplitVertically(){const[Q]=this.size;return Q>this.textureSizeLimits.min}splitHorizontally(){const{x:Q,y:$,size:K,textureIndex:J}=this,[B,Y]=K;if(!this.canSplitHorizontally())throw new Error(`Cannot split texture slot of size ${B} horizontally`);const Z=B/2,V=x.positionToTextureSlot(Q,$,[Z,Y],J,this),F=x.positionToTextureSlot(Q+Z,$,[Z,Y],J,this);return V.sibbling=F,F.sibbling=V,[V,F]}splitVertically(){const{x:Q,y:$,size:K,textureIndex:J}=this,[B,Y]=K;if(!this.canSplitVertically())throw new Error(`Cannot split texture slot of size ${Y} vertically`);const Z=Y/2,V=x.positionToTextureSlot(Q,$,[B,Z],J,this),F=x.positionToTextureSlot(Q,$+Z,[B,Z],J,this);return V.sibbling=F,F.sibbling=V,[V,F]}}function V0(Q,$){return Math.max($,Math.pow(2,Math.ceil(Math.log(Q)/Math.log(2))))}function JQ(Q,$,K,J){if(K<1)throw new Error("Invalid count");const B=V0(Q,J.min),Y=V0($,J.min),Z=new Map;let V=J.min;for(let F=1;F<=K;F++){V=V0(B*F,J.min);const H=V0(Y*Math.ceil(K/F),J.min);Z.set(V,H)}for(let F=V;F<=J.max;F*=2)if(!Z.has(F))Z.set(F,Y);return Z}var bQ=!1,q0=16,M0=4096,rQ=16;class F0{textureSlots=new d((Q,$)=>{const K=Q.size[0]*Q.size[1]-$.size[0]*$.size[1];if(K!==0)return K;return Q.slotNumber-$.slotNumber},!1);allocatedTextures={};minTextureSize;maxTextureSize;numTextureSheets;initialSlots=[];constructor({numTextureSheets:Q,minTextureSize:$,maxTextureSize:K,excludeTexture:J}={},B){if(this.numTextureSheets=Q??rQ,this.minTextureSize=$??q0,this.maxTextureSize=K??M0,B)this.numTextureSheets=Math.min(this.numTextureSheets,B.getParameter(WebGL2RenderingContext.MAX_TEXTURE_IMAGE_UNITS)),this.maxTextureSize=Math.min(this.maxTextureSize,B.getParameter(WebGL2RenderingContext.MAX_TEXTURE_SIZE)),this.minTextureSize=Math.min(this.minTextureSize,this.maxTextureSize);for(let Y=0;Y<this.numTextureSheets;Y++){if(J?.(Y))continue;this.initialSlots.push(new x([this.maxTextureSize,this.maxTextureSize],Y,void 0,{min:this.minTextureSize,max:this.maxTextureSize}))}this.initialSlots.forEach((Y)=>this.textureSlots.insert(Y))}allocate(Q,$,K=1){const{size:J,slotNumber:B,x:Y,y:Z,textureIndex:V}=this.allocateHelper(Q,$,K);return{size:J,slotNumber:B,x:Y,y:Z,textureIndex:V}}deallocate(Q){if(!this.isSlotUsed(Q))throw new Error("Slot is not allocated");const $=this.allocatedTextures[x.getTag(Q)];this.deallocateHelper($)}get countUsedTextureSheets(){return this.initialSlots.filter((Q)=>this.isSlotUsed(Q)).length}allocateHelper(Q,$,K=1){const J=JQ(Q,$,K,{min:this.minTextureSize,max:this.maxTextureSize}),B=this.findSlot(J);if(!B)throw new Error(`Could not find a slot for texture to fit ${K} sprites of size ${Q}x${$}`);this.textureSlots.remove(B);const[Y,Z]=this.bestFit(J,B);return this.fitSlot(B,Y,Z)}findSlot(Q){for(let $=0;$<this.textureSlots.size;$++){const J=this.textureSlots.at($).key,[B,Y]=J.size;if(Q.get(B)<=Y)return J}return null}calculateRatio(Q,$){return Math.max(Q/$,$/Q)}bestFit(Q,$){const[K,J]=$.size;let B=$.textureSizeLimits.max;return Q.forEach((Y,Z)=>{if(Z<=K&&Y<=J){const V=Z*Y,F=Q.get(B)*B;if(V<F)B=Z;else if(V===F){if(this.calculateRatio(Z,Y)<this.calculateRatio(B,Q.get(B)))B=Z}}}),[B,Q.get(B)]}isSlotUsed(Q){return!!this.allocatedTextures[x.getTag(Q)]}deallocateHelper(Q){if(Q.parent&&Q.sibbling&&!this.isSlotUsed(Q.sibbling)){const $=Q.sibbling;if(this.textureSlots.remove($),bQ&&this.textureSlots.find(Q))throw new Error("Slot is not expected to be in the tree");const K=Q.parent;this.deallocateHelper(K);return}this.textureSlots.insert(Q),delete this.allocatedTextures[Q.getTag()]}trySplitHorizontally(Q,$,K){if(Q.canSplitHorizontally()){const[J,B]=Q.splitHorizontally();if(J.size[0]>=$)return this.textureSlots.insert(B),this.fitSlot(J,$,K)}return null}trySplitVertically(Q,$,K){if(Q.canSplitVertically()){const[J,B]=Q.splitVertically();if(J.size[1]>=K)return this.textureSlots.insert(B),this.fitSlot(J,$,K)}return null}fitSlot(Q,$,K){if(this.allocatedTextures[Q.getTag()]=Q,Q.size[0]>Q.size[1]){const J=this.trySplitHorizontally(Q,$,K)??this.trySplitVertically(Q,$,K);if(J)return J}else{const J=this.trySplitVertically(Q,$,K)??this.trySplitHorizontally(Q,$,K);if(J)return J}return Q}listSlots(){this.textureSlots.forEach((Q)=>{console.log(Q.key?.getTag())})}}var H0=15;class L0 extends w{gl;uniforms;textureBuffers={};tempContext=new OffscreenCanvas(1,1).getContext("2d");textureSlotAllocator=new F0({excludeTexture:(Q)=>Q===H0});textureSlotAllocatorForVideo=new F0({excludeTexture:(Q)=>Q!==H0});constructor(Q,$){super();this.gl=Q,this.uniforms=$,this.tempContext.imageSmoothingEnabled=!0}initialize(){this.initTextureUniforms(),this.initMaxTexture()}getTexture(Q){if(!this.textureBuffers[Q]){const $=this.gl.createTexture();if(!$)return;this.gl.bindTexture(U.TEXTURE_2D,$),this.gl.texImage2D(U.TEXTURE_2D,0,U.RGBA,this.textureSlotAllocator.maxTextureSize,this.textureSlotAllocator.maxTextureSize,0,U.RGBA,U.UNSIGNED_BYTE,null),this.textureBuffers[Q]=$,this.addOnDestroy(()=>this.gl.deleteTexture($))}return this.textureBuffers[Q]}loadTexture(Q,$,K,J,B){this.gl.activeTexture(U[$]),this.gl.bindTexture(U.TEXTURE_2D,K),this.applyTexImage2d(Q,J,B),this.gl.texParameteri(U.TEXTURE_2D,U.TEXTURE_MIN_FILTER,U.LINEAR)}applyTexImage2d(Q,[$,K,J,B],[Y,Z,V,F]){if(J===V&&B===F&&!$&&!K)this.gl.texSubImage2D(U.TEXTURE_2D,0,Y,Z,V,F,U.RGBA,U.UNSIGNED_BYTE,Q.texImgSrc);else{const H=this.tempContext.canvas;if(Q.texImgSrc instanceof ImageData){if(H.width=V||Q.width,H.height=F||Q.height,this.tempContext.putImageData(Q.texImgSrc,0,0),$||K)console.warn("Offset not available when sending imageData")}else{const X=J||Q.width,P=B||Q.height;H.width=V||X,H.height=F||P,this.tempContext.drawImage(Q.texImgSrc,$,K,X,P,0,0,H.width,H.height)}this.gl.texSubImage2D(U.TEXTURE_2D,0,Y,Z,H.width,H.height,U.RGBA,U.UNSIGNED_BYTE,H)}}allocateSlotForImage(Q){const K=(Q.isVideo?this.textureSlotAllocatorForVideo:this.textureSlotAllocator).allocate(Q.width,Q.height),J=`TEXTURE${K.textureIndex}`,B=this.getTexture(J);if(!B)throw new Error(`Invalid texture Id ${J}`);const Y=this.assignImageToTexture(Q,J,B,[0,0,Q.width,Q.height],[K.x,K.y,...K.size]);return{slot:K,refreshCallback:Y}}assignImageToTexture(Q,$,K,J,B){const Y=J??[0,0,Q.width,Q.height],Z=B??[0,0,Y[2],Y[3]],V=()=>{this.gl.bindTexture(U.TEXTURE_2D,K),this.applyTexImage2d(Q,Y,Z)};if(Q.active)V();else this.loadTexture(Q,$,K,Y,Z),Q.active=!0;return V}setupTextureForVideo(Q){const $=this.getTexture(Q);if($)this.gl.activeTexture(U[Q]),this.gl.bindTexture(U.TEXTURE_2D,$),this.gl.texParameteri(U.TEXTURE_2D,U.TEXTURE_MIN_FILTER,U.LINEAR),this.gl.texParameteri(U.TEXTURE_2D,U.TEXTURE_MAG_FILTER,U.LINEAR)}generateMipMap(Q){const $=this.getTexture(Q);if($)this.gl.activeTexture(U[Q]),this.gl.bindTexture(U.TEXTURE_2D,$),this.gl.texParameteri(U.TEXTURE_2D,U.TEXTURE_MIN_FILTER,U.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(U.TEXTURE_2D,U.TEXTURE_MAG_FILTER,U.LINEAR),this.gl.generateMipmap(U.TEXTURE_2D)}initTextureUniforms(){const Q=this.gl.getParameter(U.MAX_TEXTURE_IMAGE_UNITS),$=new Array(Q).fill(null).map((J,B)=>B),K=this.uniforms.getUniformLocation($Q);this.gl.uniform1iv(K,$)}initMaxTexture(){const Q=this.uniforms.getUniformLocation(QQ);this.gl.uniform1f(Q,this.textureSlotAllocator.maxTextureSize)}}class c extends w{texImgSrc;active=!1;width;height;isVideo;schedule;constructor(Q,$){super();this.texImgSrc=Q;const K=Q;if(this.isVideo=!!(K.videoWidth||K.videoHeight),this.width=K.naturalWidth??K.videoWidth??K.displayWidth??K.width?.baseValue?.value??K.width,this.height=K.naturalHeight??K.videoHeight??K.displayHeight??K.height?.baseValue?.value??K.height,this.schedule=$?{period:1000/$}:void 0,!this.width||!this.height)throw new Error("Invalid image")}update(){this.refreshCallback?.()}static createFromCanvas(Q){return new c(Q)}static async loadImage(Q){const $=await new Promise((K,J)=>{const B=new Image,Y=(Z)=>J(Z.error);B.addEventListener("error",Y),B.addEventListener("load",()=>K(B),{once:!0}),B.src=Q});return new c($)}static async loadVideo(Q,$,K=30){const J=await new Promise((Y,Z)=>{const V=document.createElement("video");if(V.loop=!0,$!==void 0)V.volume=$;V.addEventListener("loadedmetadata",()=>{V.play(),Y(V)},{once:!0}),V.addEventListener("error",(F)=>Z(F.error)),V.src=Q}),B=new c(J,K);return B.addOnDestroy(()=>J.pause()),B}static async loadWebcam(Q){const $=await new Promise((B,Y)=>{const Z=document.createElement("video");Z.loop=!0,Z.addEventListener("loadedmetadata",()=>Z.play()),Z.addEventListener("playing",()=>B(Z),{once:!0}),Z.addEventListener("error",(V)=>Y(V.error))}),K=new c($);let J=!1;return navigator.mediaDevices.getUserMedia({video:{deviceId:Q}}).then((B)=>{if(!J)$.srcObject=B,K.addOnDestroy(()=>B.getTracks().forEach((Y)=>Y.stop()))}),K.addOnDestroy(()=>{J=!0,$.pause()}),K}}var r=function(Q){return Q};class T0 extends w{constructor(){super(...arguments)}images={};renderProcedures={image:r((Q,$)=>this.loadImage(Q,$.src)),video:r((Q,$)=>this.loadVideo(Q,$.src,$.volume,$.fps)),draw:r((Q,$)=>this.drawImage(Q,$.draw)),canvas:r((Q,$)=>this.loadCanvas(Q,$.canvas)),webcam:r((Q,$)=>this.loadWebCam(Q,$.deviceId))};hasImageId(Q){return!!this.getMedia(Q)}getMedia(Q){return this.images[Q]}setImage(Q,$){this.images[Q]=$}async renderMedia(Q,$){return this.renderProcedures[$.type](Q,$)}async drawImage(Q,$){const K=new OffscreenCanvas(1,1);$(K.getContext("2d"));const J=c.createFromCanvas(K);return this.images[Q]=this.own(J),J}async loadCanvas(Q,$){const K=c.createFromCanvas($);return $.getContext("2d"),this.images[Q]=this.own(K),K}async loadImage(Q,$){const K=await c.loadImage($);return this.images[Q]=this.own(K),K}async loadVideo(Q,$,K,J){const B=await c.loadVideo($,K,J);return this.images[Q]=this.own(B),B}async loadWebCam(Q,$){const K=await c.loadWebcam($);return this.images[Q]=this.own(K),K}}var BQ=`#version 300 es
//  ~{AUTHOR}

precision highp float;

//  IN
//  shape
layout(location = 0) in vec2 position;
layout(location = 1) in mat4 transform;
//  2, 3, 4 reserved for transform
//  animation
layout(location = 5) in vec2 slotSize_and_number;

//  UNIFORM
uniform float maxTextureSize;
uniform mat4 cam;
uniform mat4 projection;

//  OUT
out vec2 vTex;
out float textureIndex;

void main() {
  vec2 tex = position.xy * vec2(0.49, -0.49) + 0.5;
  vec2 slotSize = vec2(
    pow(2.0, floor(slotSize_and_number.x / 16.0)),
    pow(2.0, mod(slotSize_and_number.x, 16.0)));
  float slotNumber = slotSize_and_number.y;
  float maxCols = maxTextureSize / slotSize.x;
  float maxRows = maxTextureSize / slotSize.y;
  float slotX = mod(slotNumber, maxCols);
  float slotY = mod(floor(slotNumber / maxCols), maxRows);

  gl_Position = projection * cam * transform * vec4(position, 0.0, 1.0);
  vTex = (vec2(slotX, slotY) + tex) * slotSize / maxTextureSize;
  textureIndex = floor(slotNumber / (maxCols * maxRows));
}
`;var YQ=`#version 300 es
//  ~{AUTHOR}
precision highp float;

//  CONST
const int NUM_TEXTURES = 16;
const float threshold = 0.00001;

//  IN
//  texture
uniform sampler2D uTextures[NUM_TEXTURES];
in float textureIndex;
in vec2 vTex;
in float opacity;

//  OUT
out vec4 fragColor;

//  FUNCTIONS
vec4 getTextureColor(float textureSlot, vec2 vTexturePoint);

void main() {
  vec4 color = getTextureColor(textureIndex, vTex);
  if (color.a <= .0001) {
    discard;
  };
  fragColor = color;
}

vec4 getTextureColor(float textureSlot, vec2 vTexturePoint) {
  if (abs(0.0 - textureSlot) < threshold) {
    return texture(uTextures[0], vTexturePoint);
  }
  if (abs(1.0 - textureSlot) < threshold) {
    return texture(uTextures[1], vTexturePoint);
  }
  if (abs(2.0 - textureSlot) < threshold) {
    return texture(uTextures[2], vTexturePoint);
  }
  if (abs(3.0 - textureSlot) < threshold) {
    return texture(uTextures[3], vTexturePoint);
  }
  if (abs(4.0 - textureSlot) < threshold) {
    return texture(uTextures[4], vTexturePoint);
  }
  if (abs(5.0 - textureSlot) < threshold) {
    return texture(uTextures[5], vTexturePoint);
  }
  if (abs(6.0 - textureSlot) < threshold) {
    return texture(uTextures[6], vTexturePoint);
  }
  if (abs(7.0 - textureSlot) < threshold) {
    return texture(uTextures[7], vTexturePoint);
  }
  if (abs(8.0 - textureSlot) < threshold) {
    return texture(uTextures[8], vTexturePoint);
  }
  if (abs(9.0 - textureSlot) < threshold) {
    return texture(uTextures[9], vTexturePoint);
  }
  if (abs(10.0 - textureSlot) < threshold) {
    return texture(uTextures[10], vTexturePoint);
  }
  if (abs(11.0 - textureSlot) < threshold) {
    return texture(uTextures[11], vTexturePoint);
  }
  if (abs(12.0 - textureSlot) < threshold) {
    return texture(uTextures[12], vTexturePoint);
  }
  if (abs(13.0 - textureSlot) < threshold) {
    return texture(uTextures[13], vTexturePoint);
  }
  if (abs(14.0 - textureSlot) < threshold) {
    return texture(uTextures[14], vTexturePoint);
  }
  if (abs(15.0 - textureSlot) < threshold) {
    return texture(uTextures[15], vTexturePoint);
  }
  return texture(uTextures[0], vTexturePoint);
}
`;function S0(Q,$){return Q.replace(/~\{(\w+)\}/g,(K,J)=>{return $?.[J]||K})}var D=0.000001,T=typeof Float32Array!=="undefined"?Float32Array:Array,n=Math.random,nJ=Math.PI/180;if(!Math.hypot)Math.hypot=function(){var Q=0,$=arguments.length;while($--)Q+=arguments[$]*arguments[$];return Math.sqrt(Q)};function ZQ(){var Q=new T(9);if(T!=Float32Array)Q[1]=0,Q[2]=0,Q[3]=0,Q[5]=0,Q[6]=0,Q[7]=0;return Q[0]=1,Q[4]=1,Q[8]=1,Q}var M={};O0(M,{transpose:()=>{{return J$}},translate:()=>{{return V$}},targetTo:()=>{{return w$}},subtract:()=>{{return AQ}},sub:()=>{{return l$}},str:()=>{{return v$}},set:()=>{{return K$}},scale:()=>{{return F$}},rotateZ:()=>{{return W$}},rotateY:()=>{{return P$}},rotateX:()=>{{return X$}},rotate:()=>{{return H$}},perspectiveZO:()=>{{return L$}},perspectiveNO:()=>{{return PQ}},perspectiveFromFieldOfView:()=>{{return T$}},perspective:()=>{{return M$}},orthoZO:()=>{{return h$}},orthoNO:()=>{{return WQ}},ortho:()=>{{return S$}},multiplyScalarAndAdd:()=>{{return y$}},multiplyScalar:()=>{{return z$}},multiply:()=>{{return FQ}},mul:()=>{{return c$}},lookAt:()=>{{return I$}},invert:()=>{{return B$}},identity:()=>{{return VQ}},getTranslation:()=>{{return k$}},getScaling:()=>{{return XQ}},getRotation:()=>{{return R$}},frustum:()=>{{return q$}},fromZRotation:()=>{{return E$}},fromYRotation:()=>{{return U$}},fromXRotation:()=>{{return O$}},fromValues:()=>{{return $$}},fromTranslation:()=>{{return A$}},fromScaling:()=>{{return j$}},fromRotationTranslationScaleOrigin:()=>{{return D$}},fromRotationTranslationScale:()=>{{return _$}},fromRotationTranslation:()=>{{return HQ}},fromRotation:()=>{{return C$}},fromQuat2:()=>{{return N$}},fromQuat:()=>{{return G$}},frob:()=>{{return f$}},exactEquals:()=>{{return p$}},equals:()=>{{return x$}},determinant:()=>{{return Z$}},create:()=>{{return aQ}},copy:()=>{{return Q$}},clone:()=>{{return tQ}},adjoint:()=>{{return Y$}},add:()=>{{return g$}}});function aQ(){var Q=new T(16);if(T!=Float32Array)Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0;return Q[0]=1,Q[5]=1,Q[10]=1,Q[15]=1,Q}function tQ(Q){var $=new T(16);return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$[3]=Q[3],$[4]=Q[4],$[5]=Q[5],$[6]=Q[6],$[7]=Q[7],$[8]=Q[8],$[9]=Q[9],$[10]=Q[10],$[11]=Q[11],$[12]=Q[12],$[13]=Q[13],$[14]=Q[14],$[15]=Q[15],$}function Q$(Q,$){return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q[3]=$[3],Q[4]=$[4],Q[5]=$[5],Q[6]=$[6],Q[7]=$[7],Q[8]=$[8],Q[9]=$[9],Q[10]=$[10],Q[11]=$[11],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15],Q}function $$(Q,$,K,J,B,Y,Z,V,F,H,X,P,j,A,O,C){var W=new T(16);return W[0]=Q,W[1]=$,W[2]=K,W[3]=J,W[4]=B,W[5]=Y,W[6]=Z,W[7]=V,W[8]=F,W[9]=H,W[10]=X,W[11]=P,W[12]=j,W[13]=A,W[14]=O,W[15]=C,W}function K$(Q,$,K,J,B,Y,Z,V,F,H,X,P,j,A,O,C,W){return Q[0]=$,Q[1]=K,Q[2]=J,Q[3]=B,Q[4]=Y,Q[5]=Z,Q[6]=V,Q[7]=F,Q[8]=H,Q[9]=X,Q[10]=P,Q[11]=j,Q[12]=A,Q[13]=O,Q[14]=C,Q[15]=W,Q}function VQ(Q){return Q[0]=1,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=1,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=1,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function J$(Q,$){if(Q===$){var K=$[1],J=$[2],B=$[3],Y=$[6],Z=$[7],V=$[11];Q[1]=$[4],Q[2]=$[8],Q[3]=$[12],Q[4]=K,Q[6]=$[9],Q[7]=$[13],Q[8]=J,Q[9]=Y,Q[11]=$[14],Q[12]=B,Q[13]=Z,Q[14]=V}else Q[0]=$[0],Q[1]=$[4],Q[2]=$[8],Q[3]=$[12],Q[4]=$[1],Q[5]=$[5],Q[6]=$[9],Q[7]=$[13],Q[8]=$[2],Q[9]=$[6],Q[10]=$[10],Q[11]=$[14],Q[12]=$[3],Q[13]=$[7],Q[14]=$[11],Q[15]=$[15];return Q}function B$(Q,$){var K=$[0],J=$[1],B=$[2],Y=$[3],Z=$[4],V=$[5],F=$[6],H=$[7],X=$[8],P=$[9],j=$[10],A=$[11],O=$[12],C=$[13],W=$[14],E=$[15],G=K*V-J*Z,_=K*F-B*Z,R=K*H-Y*Z,N=J*F-B*V,k=J*H-Y*V,v=B*H-Y*F,S=X*C-P*O,h=X*W-j*O,I=X*E-A*O,f=P*W-j*C,g=P*E-A*C,z=j*E-A*W,q=G*z-_*g+R*f+N*I-k*h+v*S;if(!q)return null;return q=1/q,Q[0]=(V*z-F*g+H*f)*q,Q[1]=(B*g-J*z-Y*f)*q,Q[2]=(C*v-W*k+E*N)*q,Q[3]=(j*k-P*v-A*N)*q,Q[4]=(F*I-Z*z-H*h)*q,Q[5]=(K*z-B*I+Y*h)*q,Q[6]=(W*R-O*v-E*_)*q,Q[7]=(X*v-j*R+A*_)*q,Q[8]=(Z*g-V*I+H*S)*q,Q[9]=(J*I-K*g-Y*S)*q,Q[10]=(O*k-C*R+E*G)*q,Q[11]=(P*R-X*k-A*G)*q,Q[12]=(V*h-Z*f-F*S)*q,Q[13]=(K*f-J*h+B*S)*q,Q[14]=(C*_-O*N-W*G)*q,Q[15]=(X*N-P*_+j*G)*q,Q}function Y$(Q,$){var K=$[0],J=$[1],B=$[2],Y=$[3],Z=$[4],V=$[5],F=$[6],H=$[7],X=$[8],P=$[9],j=$[10],A=$[11],O=$[12],C=$[13],W=$[14],E=$[15];return Q[0]=V*(j*E-A*W)-P*(F*E-H*W)+C*(F*A-H*j),Q[1]=-(J*(j*E-A*W)-P*(B*E-Y*W)+C*(B*A-Y*j)),Q[2]=J*(F*E-H*W)-V*(B*E-Y*W)+C*(B*H-Y*F),Q[3]=-(J*(F*A-H*j)-V*(B*A-Y*j)+P*(B*H-Y*F)),Q[4]=-(Z*(j*E-A*W)-X*(F*E-H*W)+O*(F*A-H*j)),Q[5]=K*(j*E-A*W)-X*(B*E-Y*W)+O*(B*A-Y*j),Q[6]=-(K*(F*E-H*W)-Z*(B*E-Y*W)+O*(B*H-Y*F)),Q[7]=K*(F*A-H*j)-Z*(B*A-Y*j)+X*(B*H-Y*F),Q[8]=Z*(P*E-A*C)-X*(V*E-H*C)+O*(V*A-H*P),Q[9]=-(K*(P*E-A*C)-X*(J*E-Y*C)+O*(J*A-Y*P)),Q[10]=K*(V*E-H*C)-Z*(J*E-Y*C)+O*(J*H-Y*V),Q[11]=-(K*(V*A-H*P)-Z*(J*A-Y*P)+X*(J*H-Y*V)),Q[12]=-(Z*(P*W-j*C)-X*(V*W-F*C)+O*(V*j-F*P)),Q[13]=K*(P*W-j*C)-X*(J*W-B*C)+O*(J*j-B*P),Q[14]=-(K*(V*W-F*C)-Z*(J*W-B*C)+O*(J*F-B*V)),Q[15]=K*(V*j-F*P)-Z*(J*j-B*P)+X*(J*F-B*V),Q}function Z$(Q){var $=Q[0],K=Q[1],J=Q[2],B=Q[3],Y=Q[4],Z=Q[5],V=Q[6],F=Q[7],H=Q[8],X=Q[9],P=Q[10],j=Q[11],A=Q[12],O=Q[13],C=Q[14],W=Q[15],E=$*Z-K*Y,G=$*V-J*Y,_=$*F-B*Y,R=K*V-J*Z,N=K*F-B*Z,k=J*F-B*V,v=H*O-X*A,S=H*C-P*A,h=H*W-j*A,I=X*C-P*O,f=X*W-j*O,g=P*W-j*C;return E*g-G*f+_*I+R*h-N*S+k*v}function FQ(Q,$,K){var J=$[0],B=$[1],Y=$[2],Z=$[3],V=$[4],F=$[5],H=$[6],X=$[7],P=$[8],j=$[9],A=$[10],O=$[11],C=$[12],W=$[13],E=$[14],G=$[15],_=K[0],R=K[1],N=K[2],k=K[3];return Q[0]=_*J+R*V+N*P+k*C,Q[1]=_*B+R*F+N*j+k*W,Q[2]=_*Y+R*H+N*A+k*E,Q[3]=_*Z+R*X+N*O+k*G,_=K[4],R=K[5],N=K[6],k=K[7],Q[4]=_*J+R*V+N*P+k*C,Q[5]=_*B+R*F+N*j+k*W,Q[6]=_*Y+R*H+N*A+k*E,Q[7]=_*Z+R*X+N*O+k*G,_=K[8],R=K[9],N=K[10],k=K[11],Q[8]=_*J+R*V+N*P+k*C,Q[9]=_*B+R*F+N*j+k*W,Q[10]=_*Y+R*H+N*A+k*E,Q[11]=_*Z+R*X+N*O+k*G,_=K[12],R=K[13],N=K[14],k=K[15],Q[12]=_*J+R*V+N*P+k*C,Q[13]=_*B+R*F+N*j+k*W,Q[14]=_*Y+R*H+N*A+k*E,Q[15]=_*Z+R*X+N*O+k*G,Q}function V$(Q,$,K){var J=K[0],B=K[1],Y=K[2],Z,V,F,H,X,P,j,A,O,C,W,E;if($===Q)Q[12]=$[0]*J+$[4]*B+$[8]*Y+$[12],Q[13]=$[1]*J+$[5]*B+$[9]*Y+$[13],Q[14]=$[2]*J+$[6]*B+$[10]*Y+$[14],Q[15]=$[3]*J+$[7]*B+$[11]*Y+$[15];else Z=$[0],V=$[1],F=$[2],H=$[3],X=$[4],P=$[5],j=$[6],A=$[7],O=$[8],C=$[9],W=$[10],E=$[11],Q[0]=Z,Q[1]=V,Q[2]=F,Q[3]=H,Q[4]=X,Q[5]=P,Q[6]=j,Q[7]=A,Q[8]=O,Q[9]=C,Q[10]=W,Q[11]=E,Q[12]=Z*J+X*B+O*Y+$[12],Q[13]=V*J+P*B+C*Y+$[13],Q[14]=F*J+j*B+W*Y+$[14],Q[15]=H*J+A*B+E*Y+$[15];return Q}function F$(Q,$,K){var J=K[0],B=K[1],Y=K[2];return Q[0]=$[0]*J,Q[1]=$[1]*J,Q[2]=$[2]*J,Q[3]=$[3]*J,Q[4]=$[4]*B,Q[5]=$[5]*B,Q[6]=$[6]*B,Q[7]=$[7]*B,Q[8]=$[8]*Y,Q[9]=$[9]*Y,Q[10]=$[10]*Y,Q[11]=$[11]*Y,Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15],Q}function H$(Q,$,K,J){var B=J[0],Y=J[1],Z=J[2],V=Math.hypot(B,Y,Z),F,H,X,P,j,A,O,C,W,E,G,_,R,N,k,v,S,h,I,f,g,z,q,p;if(V<D)return null;if(V=1/V,B*=V,Y*=V,Z*=V,F=Math.sin(K),H=Math.cos(K),X=1-H,P=$[0],j=$[1],A=$[2],O=$[3],C=$[4],W=$[5],E=$[6],G=$[7],_=$[8],R=$[9],N=$[10],k=$[11],v=B*B*X+H,S=Y*B*X+Z*F,h=Z*B*X-Y*F,I=B*Y*X-Z*F,f=Y*Y*X+H,g=Z*Y*X+B*F,z=B*Z*X+Y*F,q=Y*Z*X-B*F,p=Z*Z*X+H,Q[0]=P*v+C*S+_*h,Q[1]=j*v+W*S+R*h,Q[2]=A*v+E*S+N*h,Q[3]=O*v+G*S+k*h,Q[4]=P*I+C*f+_*g,Q[5]=j*I+W*f+R*g,Q[6]=A*I+E*f+N*g,Q[7]=O*I+G*f+k*g,Q[8]=P*z+C*q+_*p,Q[9]=j*z+W*q+R*p,Q[10]=A*z+E*q+N*p,Q[11]=O*z+G*q+k*p,$!==Q)Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q}function X$(Q,$,K){var J=Math.sin(K),B=Math.cos(K),Y=$[4],Z=$[5],V=$[6],F=$[7],H=$[8],X=$[9],P=$[10],j=$[11];if($!==Q)Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q[3]=$[3],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q[4]=Y*B+H*J,Q[5]=Z*B+X*J,Q[6]=V*B+P*J,Q[7]=F*B+j*J,Q[8]=H*B-Y*J,Q[9]=X*B-Z*J,Q[10]=P*B-V*J,Q[11]=j*B-F*J,Q}function P$(Q,$,K){var J=Math.sin(K),B=Math.cos(K),Y=$[0],Z=$[1],V=$[2],F=$[3],H=$[8],X=$[9],P=$[10],j=$[11];if($!==Q)Q[4]=$[4],Q[5]=$[5],Q[6]=$[6],Q[7]=$[7],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q[0]=Y*B-H*J,Q[1]=Z*B-X*J,Q[2]=V*B-P*J,Q[3]=F*B-j*J,Q[8]=Y*J+H*B,Q[9]=Z*J+X*B,Q[10]=V*J+P*B,Q[11]=F*J+j*B,Q}function W$(Q,$,K){var J=Math.sin(K),B=Math.cos(K),Y=$[0],Z=$[1],V=$[2],F=$[3],H=$[4],X=$[5],P=$[6],j=$[7];if($!==Q)Q[8]=$[8],Q[9]=$[9],Q[10]=$[10],Q[11]=$[11],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q[0]=Y*B+H*J,Q[1]=Z*B+X*J,Q[2]=V*B+P*J,Q[3]=F*B+j*J,Q[4]=H*B-Y*J,Q[5]=X*B-Z*J,Q[6]=P*B-V*J,Q[7]=j*B-F*J,Q}function A$(Q,$){return Q[0]=1,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=1,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=1,Q[11]=0,Q[12]=$[0],Q[13]=$[1],Q[14]=$[2],Q[15]=1,Q}function j$(Q,$){return Q[0]=$[0],Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=$[1],Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=$[2],Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function C$(Q,$,K){var J=K[0],B=K[1],Y=K[2],Z=Math.hypot(J,B,Y),V,F,H;if(Z<D)return null;return Z=1/Z,J*=Z,B*=Z,Y*=Z,V=Math.sin($),F=Math.cos($),H=1-F,Q[0]=J*J*H+F,Q[1]=B*J*H+Y*V,Q[2]=Y*J*H-B*V,Q[3]=0,Q[4]=J*B*H-Y*V,Q[5]=B*B*H+F,Q[6]=Y*B*H+J*V,Q[7]=0,Q[8]=J*Y*H+B*V,Q[9]=B*Y*H-J*V,Q[10]=Y*Y*H+F,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function O$(Q,$){var K=Math.sin($),J=Math.cos($);return Q[0]=1,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=J,Q[6]=K,Q[7]=0,Q[8]=0,Q[9]=-K,Q[10]=J,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function U$(Q,$){var K=Math.sin($),J=Math.cos($);return Q[0]=J,Q[1]=0,Q[2]=-K,Q[3]=0,Q[4]=0,Q[5]=1,Q[6]=0,Q[7]=0,Q[8]=K,Q[9]=0,Q[10]=J,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function E$(Q,$){var K=Math.sin($),J=Math.cos($);return Q[0]=J,Q[1]=K,Q[2]=0,Q[3]=0,Q[4]=-K,Q[5]=J,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=1,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function HQ(Q,$,K){var J=$[0],B=$[1],Y=$[2],Z=$[3],V=J+J,F=B+B,H=Y+Y,X=J*V,P=J*F,j=J*H,A=B*F,O=B*H,C=Y*H,W=Z*V,E=Z*F,G=Z*H;return Q[0]=1-(A+C),Q[1]=P+G,Q[2]=j-E,Q[3]=0,Q[4]=P-G,Q[5]=1-(X+C),Q[6]=O+W,Q[7]=0,Q[8]=j+E,Q[9]=O-W,Q[10]=1-(X+A),Q[11]=0,Q[12]=K[0],Q[13]=K[1],Q[14]=K[2],Q[15]=1,Q}function N$(Q,$){var K=new T(3),J=-$[0],B=-$[1],Y=-$[2],Z=$[3],V=$[4],F=$[5],H=$[6],X=$[7],P=J*J+B*B+Y*Y+Z*Z;if(P>0)K[0]=(V*Z+X*J+F*Y-H*B)*2/P,K[1]=(F*Z+X*B+H*J-V*Y)*2/P,K[2]=(H*Z+X*Y+V*B-F*J)*2/P;else K[0]=(V*Z+X*J+F*Y-H*B)*2,K[1]=(F*Z+X*B+H*J-V*Y)*2,K[2]=(H*Z+X*Y+V*B-F*J)*2;return HQ(Q,$,K),Q}function k$(Q,$){return Q[0]=$[12],Q[1]=$[13],Q[2]=$[14],Q}function XQ(Q,$){var K=$[0],J=$[1],B=$[2],Y=$[4],Z=$[5],V=$[6],F=$[8],H=$[9],X=$[10];return Q[0]=Math.hypot(K,J,B),Q[1]=Math.hypot(Y,Z,V),Q[2]=Math.hypot(F,H,X),Q}function R$(Q,$){var K=new T(3);XQ(K,$);var J=1/K[0],B=1/K[1],Y=1/K[2],Z=$[0]*J,V=$[1]*B,F=$[2]*Y,H=$[4]*J,X=$[5]*B,P=$[6]*Y,j=$[8]*J,A=$[9]*B,O=$[10]*Y,C=Z+X+O,W=0;if(C>0)W=Math.sqrt(C+1)*2,Q[3]=0.25*W,Q[0]=(P-A)/W,Q[1]=(j-F)/W,Q[2]=(V-H)/W;else if(Z>X&&Z>O)W=Math.sqrt(1+Z-X-O)*2,Q[3]=(P-A)/W,Q[0]=0.25*W,Q[1]=(V+H)/W,Q[2]=(j+F)/W;else if(X>O)W=Math.sqrt(1+X-Z-O)*2,Q[3]=(j-F)/W,Q[0]=(V+H)/W,Q[1]=0.25*W,Q[2]=(P+A)/W;else W=Math.sqrt(1+O-Z-X)*2,Q[3]=(V-H)/W,Q[0]=(j+F)/W,Q[1]=(P+A)/W,Q[2]=0.25*W;return Q}function _$(Q,$,K,J){var B=$[0],Y=$[1],Z=$[2],V=$[3],F=B+B,H=Y+Y,X=Z+Z,P=B*F,j=B*H,A=B*X,O=Y*H,C=Y*X,W=Z*X,E=V*F,G=V*H,_=V*X,R=J[0],N=J[1],k=J[2];return Q[0]=(1-(O+W))*R,Q[1]=(j+_)*R,Q[2]=(A-G)*R,Q[3]=0,Q[4]=(j-_)*N,Q[5]=(1-(P+W))*N,Q[6]=(C+E)*N,Q[7]=0,Q[8]=(A+G)*k,Q[9]=(C-E)*k,Q[10]=(1-(P+O))*k,Q[11]=0,Q[12]=K[0],Q[13]=K[1],Q[14]=K[2],Q[15]=1,Q}function D$(Q,$,K,J,B){var Y=$[0],Z=$[1],V=$[2],F=$[3],H=Y+Y,X=Z+Z,P=V+V,j=Y*H,A=Y*X,O=Y*P,C=Z*X,W=Z*P,E=V*P,G=F*H,_=F*X,R=F*P,N=J[0],k=J[1],v=J[2],S=B[0],h=B[1],I=B[2],f=(1-(C+E))*N,g=(A+R)*N,z=(O-_)*N,q=(A-R)*k,p=(1-(j+E))*k,s=(W+G)*k,b=(O+_)*v,r0=(W-G)*v,e0=(1-(j+C))*v;return Q[0]=f,Q[1]=g,Q[2]=z,Q[3]=0,Q[4]=q,Q[5]=p,Q[6]=s,Q[7]=0,Q[8]=b,Q[9]=r0,Q[10]=e0,Q[11]=0,Q[12]=K[0]+S-(f*S+q*h+b*I),Q[13]=K[1]+h-(g*S+p*h+r0*I),Q[14]=K[2]+I-(z*S+s*h+e0*I),Q[15]=1,Q}function G$(Q,$){var K=$[0],J=$[1],B=$[2],Y=$[3],Z=K+K,V=J+J,F=B+B,H=K*Z,X=J*Z,P=J*V,j=B*Z,A=B*V,O=B*F,C=Y*Z,W=Y*V,E=Y*F;return Q[0]=1-P-O,Q[1]=X+E,Q[2]=j-W,Q[3]=0,Q[4]=X-E,Q[5]=1-H-O,Q[6]=A+C,Q[7]=0,Q[8]=j+W,Q[9]=A-C,Q[10]=1-H-P,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function q$(Q,$,K,J,B,Y,Z){var V=1/(K-$),F=1/(B-J),H=1/(Y-Z);return Q[0]=Y*2*V,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=Y*2*F,Q[6]=0,Q[7]=0,Q[8]=(K+$)*V,Q[9]=(B+J)*F,Q[10]=(Z+Y)*H,Q[11]=-1,Q[12]=0,Q[13]=0,Q[14]=Z*Y*2*H,Q[15]=0,Q}function PQ(Q,$,K,J,B){var Y=1/Math.tan($/2),Z;if(Q[0]=Y/K,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=Y,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[11]=-1,Q[12]=0,Q[13]=0,Q[15]=0,B!=null&&B!==Infinity)Z=1/(J-B),Q[10]=(B+J)*Z,Q[14]=2*B*J*Z;else Q[10]=-1,Q[14]=-2*J;return Q}function L$(Q,$,K,J,B){var Y=1/Math.tan($/2),Z;if(Q[0]=Y/K,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=Y,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[11]=-1,Q[12]=0,Q[13]=0,Q[15]=0,B!=null&&B!==Infinity)Z=1/(J-B),Q[10]=B*Z,Q[14]=B*J*Z;else Q[10]=-1,Q[14]=-J;return Q}function T$(Q,$,K,J){var B=Math.tan($.upDegrees*Math.PI/180),Y=Math.tan($.downDegrees*Math.PI/180),Z=Math.tan($.leftDegrees*Math.PI/180),V=Math.tan($.rightDegrees*Math.PI/180),F=2/(Z+V),H=2/(B+Y);return Q[0]=F,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=H,Q[6]=0,Q[7]=0,Q[8]=-((Z-V)*F*0.5),Q[9]=(B-Y)*H*0.5,Q[10]=J/(K-J),Q[11]=-1,Q[12]=0,Q[13]=0,Q[14]=J*K/(K-J),Q[15]=0,Q}function WQ(Q,$,K,J,B,Y,Z){var V=1/($-K),F=1/(J-B),H=1/(Y-Z);return Q[0]=-2*V,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=-2*F,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=2*H,Q[11]=0,Q[12]=($+K)*V,Q[13]=(B+J)*F,Q[14]=(Z+Y)*H,Q[15]=1,Q}function h$(Q,$,K,J,B,Y,Z){var V=1/($-K),F=1/(J-B),H=1/(Y-Z);return Q[0]=-2*V,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=-2*F,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=H,Q[11]=0,Q[12]=($+K)*V,Q[13]=(B+J)*F,Q[14]=Y*H,Q[15]=1,Q}function I$(Q,$,K,J){var B,Y,Z,V,F,H,X,P,j,A,O=$[0],C=$[1],W=$[2],E=J[0],G=J[1],_=J[2],R=K[0],N=K[1],k=K[2];if(Math.abs(O-R)<D&&Math.abs(C-N)<D&&Math.abs(W-k)<D)return VQ(Q);if(X=O-R,P=C-N,j=W-k,A=1/Math.hypot(X,P,j),X*=A,P*=A,j*=A,B=G*j-_*P,Y=_*X-E*j,Z=E*P-G*X,A=Math.hypot(B,Y,Z),!A)B=0,Y=0,Z=0;else A=1/A,B*=A,Y*=A,Z*=A;if(V=P*Z-j*Y,F=j*B-X*Z,H=X*Y-P*B,A=Math.hypot(V,F,H),!A)V=0,F=0,H=0;else A=1/A,V*=A,F*=A,H*=A;return Q[0]=B,Q[1]=V,Q[2]=X,Q[3]=0,Q[4]=Y,Q[5]=F,Q[6]=P,Q[7]=0,Q[8]=Z,Q[9]=H,Q[10]=j,Q[11]=0,Q[12]=-(B*O+Y*C+Z*W),Q[13]=-(V*O+F*C+H*W),Q[14]=-(X*O+P*C+j*W),Q[15]=1,Q}function w$(Q,$,K,J){var B=$[0],Y=$[1],Z=$[2],V=J[0],F=J[1],H=J[2],X=B-K[0],P=Y-K[1],j=Z-K[2],A=X*X+P*P+j*j;if(A>0)A=1/Math.sqrt(A),X*=A,P*=A,j*=A;var O=F*j-H*P,C=H*X-V*j,W=V*P-F*X;if(A=O*O+C*C+W*W,A>0)A=1/Math.sqrt(A),O*=A,C*=A,W*=A;return Q[0]=O,Q[1]=C,Q[2]=W,Q[3]=0,Q[4]=P*W-j*C,Q[5]=j*O-X*W,Q[6]=X*C-P*O,Q[7]=0,Q[8]=X,Q[9]=P,Q[10]=j,Q[11]=0,Q[12]=B,Q[13]=Y,Q[14]=Z,Q[15]=1,Q}function v$(Q){return"mat4("+Q[0]+", "+Q[1]+", "+Q[2]+", "+Q[3]+", "+Q[4]+", "+Q[5]+", "+Q[6]+", "+Q[7]+", "+Q[8]+", "+Q[9]+", "+Q[10]+", "+Q[11]+", "+Q[12]+", "+Q[13]+", "+Q[14]+", "+Q[15]+")"}function f$(Q){return Math.hypot(Q[0],Q[1],Q[2],Q[3],Q[4],Q[5],Q[6],Q[7],Q[8],Q[9],Q[10],Q[11],Q[12],Q[13],Q[14],Q[15])}function g$(Q,$,K){return Q[0]=$[0]+K[0],Q[1]=$[1]+K[1],Q[2]=$[2]+K[2],Q[3]=$[3]+K[3],Q[4]=$[4]+K[4],Q[5]=$[5]+K[5],Q[6]=$[6]+K[6],Q[7]=$[7]+K[7],Q[8]=$[8]+K[8],Q[9]=$[9]+K[9],Q[10]=$[10]+K[10],Q[11]=$[11]+K[11],Q[12]=$[12]+K[12],Q[13]=$[13]+K[13],Q[14]=$[14]+K[14],Q[15]=$[15]+K[15],Q}function AQ(Q,$,K){return Q[0]=$[0]-K[0],Q[1]=$[1]-K[1],Q[2]=$[2]-K[2],Q[3]=$[3]-K[3],Q[4]=$[4]-K[4],Q[5]=$[5]-K[5],Q[6]=$[6]-K[6],Q[7]=$[7]-K[7],Q[8]=$[8]-K[8],Q[9]=$[9]-K[9],Q[10]=$[10]-K[10],Q[11]=$[11]-K[11],Q[12]=$[12]-K[12],Q[13]=$[13]-K[13],Q[14]=$[14]-K[14],Q[15]=$[15]-K[15],Q}function z$(Q,$,K){return Q[0]=$[0]*K,Q[1]=$[1]*K,Q[2]=$[2]*K,Q[3]=$[3]*K,Q[4]=$[4]*K,Q[5]=$[5]*K,Q[6]=$[6]*K,Q[7]=$[7]*K,Q[8]=$[8]*K,Q[9]=$[9]*K,Q[10]=$[10]*K,Q[11]=$[11]*K,Q[12]=$[12]*K,Q[13]=$[13]*K,Q[14]=$[14]*K,Q[15]=$[15]*K,Q}function y$(Q,$,K,J){return Q[0]=$[0]+K[0]*J,Q[1]=$[1]+K[1]*J,Q[2]=$[2]+K[2]*J,Q[3]=$[3]+K[3]*J,Q[4]=$[4]+K[4]*J,Q[5]=$[5]+K[5]*J,Q[6]=$[6]+K[6]*J,Q[7]=$[7]+K[7]*J,Q[8]=$[8]+K[8]*J,Q[9]=$[9]+K[9]*J,Q[10]=$[10]+K[10]*J,Q[11]=$[11]+K[11]*J,Q[12]=$[12]+K[12]*J,Q[13]=$[13]+K[13]*J,Q[14]=$[14]+K[14]*J,Q[15]=$[15]+K[15]*J,Q}function p$(Q,$){return Q[0]===$[0]&&Q[1]===$[1]&&Q[2]===$[2]&&Q[3]===$[3]&&Q[4]===$[4]&&Q[5]===$[5]&&Q[6]===$[6]&&Q[7]===$[7]&&Q[8]===$[8]&&Q[9]===$[9]&&Q[10]===$[10]&&Q[11]===$[11]&&Q[12]===$[12]&&Q[13]===$[13]&&Q[14]===$[14]&&Q[15]===$[15]}function x$(Q,$){var K=Q[0],J=Q[1],B=Q[2],Y=Q[3],Z=Q[4],V=Q[5],F=Q[6],H=Q[7],X=Q[8],P=Q[9],j=Q[10],A=Q[11],O=Q[12],C=Q[13],W=Q[14],E=Q[15],G=$[0],_=$[1],R=$[2],N=$[3],k=$[4],v=$[5],S=$[6],h=$[7],I=$[8],f=$[9],g=$[10],z=$[11],q=$[12],p=$[13],s=$[14],b=$[15];return Math.abs(K-G)<=D*Math.max(1,Math.abs(K),Math.abs(G))&&Math.abs(J-_)<=D*Math.max(1,Math.abs(J),Math.abs(_))&&Math.abs(B-R)<=D*Math.max(1,Math.abs(B),Math.abs(R))&&Math.abs(Y-N)<=D*Math.max(1,Math.abs(Y),Math.abs(N))&&Math.abs(Z-k)<=D*Math.max(1,Math.abs(Z),Math.abs(k))&&Math.abs(V-v)<=D*Math.max(1,Math.abs(V),Math.abs(v))&&Math.abs(F-S)<=D*Math.max(1,Math.abs(F),Math.abs(S))&&Math.abs(H-h)<=D*Math.max(1,Math.abs(H),Math.abs(h))&&Math.abs(X-I)<=D*Math.max(1,Math.abs(X),Math.abs(I))&&Math.abs(P-f)<=D*Math.max(1,Math.abs(P),Math.abs(f))&&Math.abs(j-g)<=D*Math.max(1,Math.abs(j),Math.abs(g))&&Math.abs(A-z)<=D*Math.max(1,Math.abs(A),Math.abs(z))&&Math.abs(O-q)<=D*Math.max(1,Math.abs(O),Math.abs(q))&&Math.abs(C-p)<=D*Math.max(1,Math.abs(C),Math.abs(p))&&Math.abs(W-s)<=D*Math.max(1,Math.abs(W),Math.abs(s))&&Math.abs(E-b)<=D*Math.max(1,Math.abs(E),Math.abs(b))}var M$=PQ,S$=WQ,c$=FQ,l$=AQ;var o={};O0(o,{str:()=>{{return yK}},squaredLength:()=>{{return nQ}},sqrLen:()=>{{return sK}},sqlerp:()=>{{return uK}},slerp:()=>{{return A0}},setAxisAngle:()=>{{return fQ}},setAxes:()=>{{return oK}},set:()=>{{return lK}},scale:()=>{{return xQ}},rotationTo:()=>{{return eK}},rotateZ:()=>{{return hK}},rotateY:()=>{{return SK}},rotateX:()=>{{return TK}},random:()=>{{return vK}},pow:()=>{{return wK}},normalize:()=>{{return v0}},multiply:()=>{{return gQ}},mul:()=>{{return mK}},ln:()=>{{return yQ}},lerp:()=>{{return dK}},length:()=>{{return lQ}},len:()=>{{return iK}},invert:()=>{{return fK}},identity:()=>{{return qK}},getAxisAngle:()=>{{return MK}},getAngle:()=>{{return LK}},fromValues:()=>{{return xK}},fromMat3:()=>{{return pQ}},fromEuler:()=>{{return zK}},exp:()=>{{return zQ}},exactEquals:()=>{{return bK}},equals:()=>{{return rK}},dot:()=>{{return cQ}},create:()=>{{return w0}},copy:()=>{{return cK}},conjugate:()=>{{return gK}},clone:()=>{{return pK}},calculateW:()=>{{return IK}},add:()=>{{return nK}}});var i={};O0(i,{zero:()=>{{return WK}},transformQuat:()=>{{return VK}},transformMat4:()=>{{return YK}},transformMat3:()=>{{return ZK}},subtract:()=>{{return CQ}},sub:()=>{{return OK}},str:()=>{{return AK}},squaredLength:()=>{{return kQ}},squaredDistance:()=>{{return NQ}},sqrLen:()=>{{return RK}},sqrDist:()=>{{return kK}},set:()=>{{return d$}},scaleAndAdd:()=>{{return a$}},scale:()=>{{return o$}},round:()=>{{return u$}},rotateZ:()=>{{return XK}},rotateY:()=>{{return HK}},rotateX:()=>{{return FK}},random:()=>{{return BK}},normalize:()=>{{return h0}},negate:()=>{{return t$}},multiply:()=>{{return OQ}},mul:()=>{{return UK}},min:()=>{{return r$}},max:()=>{{return e$}},lerp:()=>{{return $K}},length:()=>{{return jQ}},len:()=>{{return I0}},inverse:()=>{{return QK}},hermite:()=>{{return KK}},fromValues:()=>{{return P0}},forEach:()=>{{return _K}},floor:()=>{{return b$}},exactEquals:()=>{{return jK}},equals:()=>{{return CK}},dot:()=>{{return W0}},divide:()=>{{return UQ}},div:()=>{{return EK}},distance:()=>{{return EQ}},dist:()=>{{return NK}},cross:()=>{{return u}},create:()=>{{return X0}},copy:()=>{{return m$}},clone:()=>{{return n$}},ceil:()=>{{return s$}},bezier:()=>{{return JK}},angle:()=>{{return PK}},add:()=>{{return i$}}});function X0(){var Q=new T(3);if(T!=Float32Array)Q[0]=0,Q[1]=0,Q[2]=0;return Q}function n$(Q){var $=new T(3);return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$}function jQ(Q){var $=Q[0],K=Q[1],J=Q[2];return Math.hypot($,K,J)}function P0(Q,$,K){var J=new T(3);return J[0]=Q,J[1]=$,J[2]=K,J}function m$(Q,$){return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q}function d$(Q,$,K,J){return Q[0]=$,Q[1]=K,Q[2]=J,Q}function i$(Q,$,K){return Q[0]=$[0]+K[0],Q[1]=$[1]+K[1],Q[2]=$[2]+K[2],Q}function CQ(Q,$,K){return Q[0]=$[0]-K[0],Q[1]=$[1]-K[1],Q[2]=$[2]-K[2],Q}function OQ(Q,$,K){return Q[0]=$[0]*K[0],Q[1]=$[1]*K[1],Q[2]=$[2]*K[2],Q}function UQ(Q,$,K){return Q[0]=$[0]/K[0],Q[1]=$[1]/K[1],Q[2]=$[2]/K[2],Q}function s$(Q,$){return Q[0]=Math.ceil($[0]),Q[1]=Math.ceil($[1]),Q[2]=Math.ceil($[2]),Q}function b$(Q,$){return Q[0]=Math.floor($[0]),Q[1]=Math.floor($[1]),Q[2]=Math.floor($[2]),Q}function r$(Q,$,K){return Q[0]=Math.min($[0],K[0]),Q[1]=Math.min($[1],K[1]),Q[2]=Math.min($[2],K[2]),Q}function e$(Q,$,K){return Q[0]=Math.max($[0],K[0]),Q[1]=Math.max($[1],K[1]),Q[2]=Math.max($[2],K[2]),Q}function u$(Q,$){return Q[0]=Math.round($[0]),Q[1]=Math.round($[1]),Q[2]=Math.round($[2]),Q}function o$(Q,$,K){return Q[0]=$[0]*K,Q[1]=$[1]*K,Q[2]=$[2]*K,Q}function a$(Q,$,K,J){return Q[0]=$[0]+K[0]*J,Q[1]=$[1]+K[1]*J,Q[2]=$[2]+K[2]*J,Q}function EQ(Q,$){var K=$[0]-Q[0],J=$[1]-Q[1],B=$[2]-Q[2];return Math.hypot(K,J,B)}function NQ(Q,$){var K=$[0]-Q[0],J=$[1]-Q[1],B=$[2]-Q[2];return K*K+J*J+B*B}function kQ(Q){var $=Q[0],K=Q[1],J=Q[2];return $*$+K*K+J*J}function t$(Q,$){return Q[0]=-$[0],Q[1]=-$[1],Q[2]=-$[2],Q}function QK(Q,$){return Q[0]=1/$[0],Q[1]=1/$[1],Q[2]=1/$[2],Q}function h0(Q,$){var K=$[0],J=$[1],B=$[2],Y=K*K+J*J+B*B;if(Y>0)Y=1/Math.sqrt(Y);return Q[0]=$[0]*Y,Q[1]=$[1]*Y,Q[2]=$[2]*Y,Q}function W0(Q,$){return Q[0]*$[0]+Q[1]*$[1]+Q[2]*$[2]}function u(Q,$,K){var J=$[0],B=$[1],Y=$[2],Z=K[0],V=K[1],F=K[2];return Q[0]=B*F-Y*V,Q[1]=Y*Z-J*F,Q[2]=J*V-B*Z,Q}function $K(Q,$,K,J){var B=$[0],Y=$[1],Z=$[2];return Q[0]=B+J*(K[0]-B),Q[1]=Y+J*(K[1]-Y),Q[2]=Z+J*(K[2]-Z),Q}function KK(Q,$,K,J,B,Y){var Z=Y*Y,V=Z*(2*Y-3)+1,F=Z*(Y-2)+Y,H=Z*(Y-1),X=Z*(3-2*Y);return Q[0]=$[0]*V+K[0]*F+J[0]*H+B[0]*X,Q[1]=$[1]*V+K[1]*F+J[1]*H+B[1]*X,Q[2]=$[2]*V+K[2]*F+J[2]*H+B[2]*X,Q}function JK(Q,$,K,J,B,Y){var Z=1-Y,V=Z*Z,F=Y*Y,H=V*Z,X=3*Y*V,P=3*F*Z,j=F*Y;return Q[0]=$[0]*H+K[0]*X+J[0]*P+B[0]*j,Q[1]=$[1]*H+K[1]*X+J[1]*P+B[1]*j,Q[2]=$[2]*H+K[2]*X+J[2]*P+B[2]*j,Q}function BK(Q,$){$=$||1;var K=n()*2*Math.PI,J=n()*2-1,B=Math.sqrt(1-J*J)*$;return Q[0]=Math.cos(K)*B,Q[1]=Math.sin(K)*B,Q[2]=J*$,Q}function YK(Q,$,K){var J=$[0],B=$[1],Y=$[2],Z=K[3]*J+K[7]*B+K[11]*Y+K[15];return Z=Z||1,Q[0]=(K[0]*J+K[4]*B+K[8]*Y+K[12])/Z,Q[1]=(K[1]*J+K[5]*B+K[9]*Y+K[13])/Z,Q[2]=(K[2]*J+K[6]*B+K[10]*Y+K[14])/Z,Q}function ZK(Q,$,K){var J=$[0],B=$[1],Y=$[2];return Q[0]=J*K[0]+B*K[3]+Y*K[6],Q[1]=J*K[1]+B*K[4]+Y*K[7],Q[2]=J*K[2]+B*K[5]+Y*K[8],Q}function VK(Q,$,K){var J=K[0],B=K[1],Y=K[2],Z=K[3],V=$[0],F=$[1],H=$[2],X=B*H-Y*F,P=Y*V-J*H,j=J*F-B*V,A=B*j-Y*P,O=Y*X-J*j,C=J*P-B*X,W=Z*2;return X*=W,P*=W,j*=W,A*=2,O*=2,C*=2,Q[0]=V+X+A,Q[1]=F+P+O,Q[2]=H+j+C,Q}function FK(Q,$,K,J){var B=[],Y=[];return B[0]=$[0]-K[0],B[1]=$[1]-K[1],B[2]=$[2]-K[2],Y[0]=B[0],Y[1]=B[1]*Math.cos(J)-B[2]*Math.sin(J),Y[2]=B[1]*Math.sin(J)+B[2]*Math.cos(J),Q[0]=Y[0]+K[0],Q[1]=Y[1]+K[1],Q[2]=Y[2]+K[2],Q}function HK(Q,$,K,J){var B=[],Y=[];return B[0]=$[0]-K[0],B[1]=$[1]-K[1],B[2]=$[2]-K[2],Y[0]=B[2]*Math.sin(J)+B[0]*Math.cos(J),Y[1]=B[1],Y[2]=B[2]*Math.cos(J)-B[0]*Math.sin(J),Q[0]=Y[0]+K[0],Q[1]=Y[1]+K[1],Q[2]=Y[2]+K[2],Q}function XK(Q,$,K,J){var B=[],Y=[];return B[0]=$[0]-K[0],B[1]=$[1]-K[1],B[2]=$[2]-K[2],Y[0]=B[0]*Math.cos(J)-B[1]*Math.sin(J),Y[1]=B[0]*Math.sin(J)+B[1]*Math.cos(J),Y[2]=B[2],Q[0]=Y[0]+K[0],Q[1]=Y[1]+K[1],Q[2]=Y[2]+K[2],Q}function PK(Q,$){var K=Q[0],J=Q[1],B=Q[2],Y=$[0],Z=$[1],V=$[2],F=Math.sqrt(K*K+J*J+B*B),H=Math.sqrt(Y*Y+Z*Z+V*V),X=F*H,P=X&&W0(Q,$)/X;return Math.acos(Math.min(Math.max(P,-1),1))}function WK(Q){return Q[0]=0,Q[1]=0,Q[2]=0,Q}function AK(Q){return"vec3("+Q[0]+", "+Q[1]+", "+Q[2]+")"}function jK(Q,$){return Q[0]===$[0]&&Q[1]===$[1]&&Q[2]===$[2]}function CK(Q,$){var K=Q[0],J=Q[1],B=Q[2],Y=$[0],Z=$[1],V=$[2];return Math.abs(K-Y)<=D*Math.max(1,Math.abs(K),Math.abs(Y))&&Math.abs(J-Z)<=D*Math.max(1,Math.abs(J),Math.abs(Z))&&Math.abs(B-V)<=D*Math.max(1,Math.abs(B),Math.abs(V))}var OK=CQ,UK=OQ,EK=UQ,NK=EQ,kK=NQ,I0=jQ,RK=kQ,_K=function(){var Q=X0();return function($,K,J,B,Y,Z){var V,F;if(!K)K=3;if(!J)J=0;if(B)F=Math.min(B*K+J,$.length);else F=$.length;for(V=J;V<F;V+=K)Q[0]=$[V],Q[1]=$[V+1],Q[2]=$[V+2],Y(Q,Q,Z),$[V]=Q[0],$[V+1]=Q[1],$[V+2]=Q[2];return $}}();function DK(){var Q=new T(4);if(T!=Float32Array)Q[0]=0,Q[1]=0,Q[2]=0,Q[3]=0;return Q}function RQ(Q){var $=new T(4);return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$[3]=Q[3],$}function _Q(Q,$,K,J){var B=new T(4);return B[0]=Q,B[1]=$,B[2]=K,B[3]=J,B}function DQ(Q,$){return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q[3]=$[3],Q}function GQ(Q,$,K,J,B){return Q[0]=$,Q[1]=K,Q[2]=J,Q[3]=B,Q}function qQ(Q,$,K){return Q[0]=$[0]+K[0],Q[1]=$[1]+K[1],Q[2]=$[2]+K[2],Q[3]=$[3]+K[3],Q}function MQ(Q,$,K){return Q[0]=$[0]*K,Q[1]=$[1]*K,Q[2]=$[2]*K,Q[3]=$[3]*K,Q}function LQ(Q){var $=Q[0],K=Q[1],J=Q[2],B=Q[3];return Math.hypot($,K,J,B)}function TQ(Q){var $=Q[0],K=Q[1],J=Q[2],B=Q[3];return $*$+K*K+J*J+B*B}function SQ(Q,$){var K=$[0],J=$[1],B=$[2],Y=$[3],Z=K*K+J*J+B*B+Y*Y;if(Z>0)Z=1/Math.sqrt(Z);return Q[0]=K*Z,Q[1]=J*Z,Q[2]=B*Z,Q[3]=Y*Z,Q}function hQ(Q,$){return Q[0]*$[0]+Q[1]*$[1]+Q[2]*$[2]+Q[3]*$[3]}function IQ(Q,$,K,J){var B=$[0],Y=$[1],Z=$[2],V=$[3];return Q[0]=B+J*(K[0]-B),Q[1]=Y+J*(K[1]-Y),Q[2]=Z+J*(K[2]-Z),Q[3]=V+J*(K[3]-V),Q}function wQ(Q,$){return Q[0]===$[0]&&Q[1]===$[1]&&Q[2]===$[2]&&Q[3]===$[3]}function vQ(Q,$){var K=Q[0],J=Q[1],B=Q[2],Y=Q[3],Z=$[0],V=$[1],F=$[2],H=$[3];return Math.abs(K-Z)<=D*Math.max(1,Math.abs(K),Math.abs(Z))&&Math.abs(J-V)<=D*Math.max(1,Math.abs(J),Math.abs(V))&&Math.abs(B-F)<=D*Math.max(1,Math.abs(B),Math.abs(F))&&Math.abs(Y-H)<=D*Math.max(1,Math.abs(Y),Math.abs(H))}var mJ=function(){var Q=DK();return function($,K,J,B,Y,Z){var V,F;if(!K)K=4;if(!J)J=0;if(B)F=Math.min(B*K+J,$.length);else F=$.length;for(V=J;V<F;V+=K)Q[0]=$[V],Q[1]=$[V+1],Q[2]=$[V+2],Q[3]=$[V+3],Y(Q,Q,Z),$[V]=Q[0],$[V+1]=Q[1],$[V+2]=Q[2],$[V+3]=Q[3];return $}}();function w0(){var Q=new T(4);if(T!=Float32Array)Q[0]=0,Q[1]=0,Q[2]=0;return Q[3]=1,Q}function qK(Q){return Q[0]=0,Q[1]=0,Q[2]=0,Q[3]=1,Q}function fQ(Q,$,K){K=K*0.5;var J=Math.sin(K);return Q[0]=J*$[0],Q[1]=J*$[1],Q[2]=J*$[2],Q[3]=Math.cos(K),Q}function MK(Q,$){var K=Math.acos($[3])*2,J=Math.sin(K/2);if(J>D)Q[0]=$[0]/J,Q[1]=$[1]/J,Q[2]=$[2]/J;else Q[0]=1,Q[1]=0,Q[2]=0;return K}function LK(Q,$){var K=cQ(Q,$);return Math.acos(2*K*K-1)}function gQ(Q,$,K){var J=$[0],B=$[1],Y=$[2],Z=$[3],V=K[0],F=K[1],H=K[2],X=K[3];return Q[0]=J*X+Z*V+B*H-Y*F,Q[1]=B*X+Z*F+Y*V-J*H,Q[2]=Y*X+Z*H+J*F-B*V,Q[3]=Z*X-J*V-B*F-Y*H,Q}function TK(Q,$,K){K*=0.5;var J=$[0],B=$[1],Y=$[2],Z=$[3],V=Math.sin(K),F=Math.cos(K);return Q[0]=J*F+Z*V,Q[1]=B*F+Y*V,Q[2]=Y*F-B*V,Q[3]=Z*F-J*V,Q}function SK(Q,$,K){K*=0.5;var J=$[0],B=$[1],Y=$[2],Z=$[3],V=Math.sin(K),F=Math.cos(K);return Q[0]=J*F-Y*V,Q[1]=B*F+Z*V,Q[2]=Y*F+J*V,Q[3]=Z*F-B*V,Q}function hK(Q,$,K){K*=0.5;var J=$[0],B=$[1],Y=$[2],Z=$[3],V=Math.sin(K),F=Math.cos(K);return Q[0]=J*F+B*V,Q[1]=B*F-J*V,Q[2]=Y*F+Z*V,Q[3]=Z*F-Y*V,Q}function IK(Q,$){var K=$[0],J=$[1],B=$[2];return Q[0]=K,Q[1]=J,Q[2]=B,Q[3]=Math.sqrt(Math.abs(1-K*K-J*J-B*B)),Q}function zQ(Q,$){var K=$[0],J=$[1],B=$[2],Y=$[3],Z=Math.sqrt(K*K+J*J+B*B),V=Math.exp(Y),F=Z>0?V*Math.sin(Z)/Z:0;return Q[0]=K*F,Q[1]=J*F,Q[2]=B*F,Q[3]=V*Math.cos(Z),Q}function yQ(Q,$){var K=$[0],J=$[1],B=$[2],Y=$[3],Z=Math.sqrt(K*K+J*J+B*B),V=Z>0?Math.atan2(Z,Y)/Z:0;return Q[0]=K*V,Q[1]=J*V,Q[2]=B*V,Q[3]=0.5*Math.log(K*K+J*J+B*B+Y*Y),Q}function wK(Q,$,K){return yQ(Q,$),xQ(Q,Q,K),zQ(Q,Q),Q}function A0(Q,$,K,J){var B=$[0],Y=$[1],Z=$[2],V=$[3],F=K[0],H=K[1],X=K[2],P=K[3],j,A,O,C,W;if(A=B*F+Y*H+Z*X+V*P,A<0)A=-A,F=-F,H=-H,X=-X,P=-P;if(1-A>D)j=Math.acos(A),O=Math.sin(j),C=Math.sin((1-J)*j)/O,W=Math.sin(J*j)/O;else C=1-J,W=J;return Q[0]=C*B+W*F,Q[1]=C*Y+W*H,Q[2]=C*Z+W*X,Q[3]=C*V+W*P,Q}function vK(Q){var $=n(),K=n(),J=n(),B=Math.sqrt(1-$),Y=Math.sqrt($);return Q[0]=B*Math.sin(2*Math.PI*K),Q[1]=B*Math.cos(2*Math.PI*K),Q[2]=Y*Math.sin(2*Math.PI*J),Q[3]=Y*Math.cos(2*Math.PI*J),Q}function fK(Q,$){var K=$[0],J=$[1],B=$[2],Y=$[3],Z=K*K+J*J+B*B+Y*Y,V=Z?1/Z:0;return Q[0]=-K*V,Q[1]=-J*V,Q[2]=-B*V,Q[3]=Y*V,Q}function gK(Q,$){return Q[0]=-$[0],Q[1]=-$[1],Q[2]=-$[2],Q[3]=$[3],Q}function pQ(Q,$){var K=$[0]+$[4]+$[8],J;if(K>0)J=Math.sqrt(K+1),Q[3]=0.5*J,J=0.5/J,Q[0]=($[5]-$[7])*J,Q[1]=($[6]-$[2])*J,Q[2]=($[1]-$[3])*J;else{var B=0;if($[4]>$[0])B=1;if($[8]>$[B*3+B])B=2;var Y=(B+1)%3,Z=(B+2)%3;J=Math.sqrt($[B*3+B]-$[Y*3+Y]-$[Z*3+Z]+1),Q[B]=0.5*J,J=0.5/J,Q[3]=($[Y*3+Z]-$[Z*3+Y])*J,Q[Y]=($[Y*3+B]+$[B*3+Y])*J,Q[Z]=($[Z*3+B]+$[B*3+Z])*J}return Q}function zK(Q,$,K,J){var B=0.5*Math.PI/180;$*=B,K*=B,J*=B;var Y=Math.sin($),Z=Math.cos($),V=Math.sin(K),F=Math.cos(K),H=Math.sin(J),X=Math.cos(J);return Q[0]=Y*F*X-Z*V*H,Q[1]=Z*V*X+Y*F*H,Q[2]=Z*F*H-Y*V*X,Q[3]=Z*F*X+Y*V*H,Q}function yK(Q){return"quat("+Q[0]+", "+Q[1]+", "+Q[2]+", "+Q[3]+")"}var pK=RQ,xK=_Q,cK=DQ,lK=GQ,nK=qQ,mK=gQ,xQ=MQ,cQ=hQ,dK=IQ,lQ=LQ,iK=lQ,nQ=TQ,sK=nQ,v0=SQ,bK=wQ,rK=vQ,eK=function(){var Q=X0(),$=P0(1,0,0),K=P0(0,1,0);return function(J,B,Y){var Z=W0(B,Y);if(Z<-0.999999){if(u(Q,$,B),I0(Q)<0.000001)u(Q,K,B);return h0(Q,Q),fQ(J,Q,Math.PI),J}else if(Z>0.999999)return J[0]=0,J[1]=0,J[2]=0,J[3]=1,J;else return u(Q,B,Y),J[0]=Q[0],J[1]=Q[1],J[2]=Q[2],J[3]=1+Z,v0(J,J)}}(),uK=function(){var Q=w0(),$=w0();return function(K,J,B,Y,Z,V){return A0(Q,J,Z,V),A0($,B,Y,V),A0(K,Q,$,2*V*(1-V)),K}}(),oK=function(){var Q=ZQ();return function($,K,J,B){return Q[0]=J[0],Q[3]=J[1],Q[6]=J[2],Q[1]=B[0],Q[4]=B[1],Q[7]=B[2],Q[2]=-K[0],Q[5]=-K[1],Q[8]=-K[2],v0($,pQ($,Q))}}();var aK=Math.PI/90;class l{m4=Float32Array.from(M.create());constructor(){this.identity()}static create(){return new l}identity(){return M.identity(this.m4),this}invert(Q){return M.invert(this.m4,Q.getMatrix()),this}multiply(Q){return M.multiply(this.m4,this.m4,Q.getMatrix()),this}multiply2(Q,$){return M.multiply(this.m4,Q.getMatrix(),$.getMatrix()),this}multiply3(Q,$,K){return this.multiply2(Q,$),this.multiply(K),this}translate(Q,$,K){return M.translate(this.m4,this.m4,[Q,$,K]),this}translateToMatrix(Q){const $=Q.getMatrix();return this.translate(-$[12],-$[13],-$[14])}rotateX(Q){return M.rotateX(this.m4,this.m4,Q),this}rotateY(Q){return M.rotateY(this.m4,this.m4,Q),this}rotateZ(Q){return M.rotateZ(this.m4,this.m4,Q),this}scale(Q,$,K){return M.scale(this.m4,this.m4,[Q,$,K]),this}perspective(Q,$,K,J){return M.perspective(this.m4,Q*aK,$,K,J),this}ortho(Q,$,K,J,B,Y){return M.ortho(this.m4,Q,$,K,J,B,Y),this}static aTemp=M.create();static bTemp=M.create();combine(Q,$,K=0.5){return M.multiplyScalar(l.aTemp,Q.getMatrix(),1-K),M.multiplyScalar(l.bTemp,$.getMatrix(),K),M.add(this.m4,l.aTemp,l.bTemp),this}static tempQuat=o.create();moveMatrix(Q,$,K,J){const B=i.fromValues(-Q,$,K);if(J)M.getRotation(l.tempQuat,J.getMatrix()),o.invert(l.tempQuat,l.tempQuat),i.transformQuat(B,B,l.tempQuat);return M.translate(this.m4,this.m4,B),this}getMatrix(){return this.m4}}var L=l;class f0 extends L{constructor(){super(...arguments)}perspectiveMatrix=L.create();orthoMatrix=L.create();perspectiveLevel=1;configPerspectiveMatrix(Q){this.perspectiveMatrix.perspective(45,Q,0.01,1000)}configOrthoMatrix(Q){this.orthoMatrix.ortho(-Q,Q,-1,1,-1000,1000)}configure(Q,$){const K=Q/$;this.configPerspectiveMatrix(K),this.configOrthoMatrix(K)}setPerspective(Q){this.perspectiveLevel=Q,this.combine(this.orthoMatrix,this.perspectiveMatrix,this.perspectiveLevel)}}var y;(function(K){K[K["PROJECTION"]=0]="PROJECTION";K[K["VIEW"]=1]="VIEW"})(y||(y={}));class g0{needsRefresh=!1;camPositionMatrix=L.create().translate(0,0,-1);projectionMatrix=new f0;camTiltMatrix=L.create();camTurnMatrix=L.create();camMatrix=L.create();hudMatrix=L.create();pespectiveLevel=1;cameraMatrices={[y.PROJECTION]:this.projectionMatrix,[y.VIEW]:this.camMatrix};configProjectionMatrix(Q,$){this.projectionMatrix.configure(Q,$),this.updatePerspective()}refresh(){if(!this.needsRefresh)return!1;return this.camMatrix.multiply3(this.camTiltMatrix,this.camTurnMatrix,this.camPositionMatrix),this.syncHud(this.hudMatrix),this.needsRefresh=!1,!0}updatePerspective(Q){this.projectionMatrix.setPerspective(Q??this.pespectiveLevel),this.needsRefresh=!0}getCameraMatrix(Q){return this.cameraMatrices[Q].getMatrix()}moveCam(Q,$,K){this.camPositionMatrix.moveMatrix(Q,$,K,this.camTurnMatrix),this.needsRefresh=!0}turnCam(Q){this.camTurnMatrix.rotateY(Q),this.needsRefresh=!0}tilt(Q){this.camTiltMatrix.rotateX(Q),this.needsRefresh=!0}getHudMatrix(){return this.hudMatrix}invertedCamTurnMatrix=L.create();invertedCamTiltMatrix=L.create();syncHud(Q){this.invertedCamTiltMatrix.invert(this.camTiltMatrix),this.invertedCamTurnMatrix.invert(this.camTurnMatrix),Q?.identity().translateToMatrix(this.camPositionMatrix).multiply(this.invertedCamTurnMatrix).multiply(this.invertedCamTiltMatrix).translate(0,0,-0.9)}}var KJ=function(Q){if(!$J)return Q;return new Proxy(Q,{get(K,J){const B=K,Y=B[J];if(typeof Y==="function")return(...V)=>{const F=Y.apply(B,V);return console.log(`gl.${String(J)}(`,V,") = ",F),F};else return console.log(`gl.${String(J)} = `,Y),Y}})},tK={alpha:!0,antialias:!1,depth:!0,desynchronized:!0,failIfMajorPerformanceCaveat:void 0,powerPreference:"default",premultipliedAlpha:!0,preserveDrawingBuffer:!1,stencil:!1},QJ=6,$J=!1;class j0 extends w{gl;programs;attributeBuffers;uniforms;canvas;textureManager;imageManager;textureSlots={};onResize=new Set;spriteCount=0;cameraMatrixUniforms={};constructor(Q,{attributes:$}={}){super();const K=Q.getContext("webgl2",{...tK,...$});this.gl=KJ(K),this.canvas=Q,this.programs=this.own(new k0(this.gl)),this.uniforms=this.own(new D0(this.gl,this.programs)),this.attributeBuffers=this.own(new _0(this.gl,this.programs)),this.textureManager=new L0(this.gl,this.uniforms),this.imageManager=new T0;const J=this.checkCanvasSize.bind(this);window.addEventListener("resize",J),this.addOnDestroy(()=>window.removeEventListener("resize",J)),this.initialize()}addResizeListener(Q){Q(this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.onResize.add(Q)}removeResizeListener(Q){this.onResize.delete(Q)}clearTextureSlots(){for(let Q in this.textureSlots)delete this.textureSlots[Q]}checkCanvasSize(){if(this.canvas instanceof HTMLCanvasElement)this.canvas.width=this.canvas.offsetWidth*2,this.canvas.height=this.canvas.offsetHeight*2;this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.onResize.forEach((Q)=>Q(this.gl.drawingBufferWidth,this.gl.drawingBufferHeight))}initialize(){const $={AUTHOR:"Jack le hamster"};this.programs.addProgram("main",S0(BQ,$),S0(YQ,$)),this.programs.useProgram("main"),this.cameraMatrixUniforms[y.PROJECTION]=this.uniforms.getUniformLocation(t0,"main"),this.cameraMatrixUniforms[y.VIEW]=this.uniforms.getUniformLocation(a0,"main"),this.gl.enable(U.DEPTH_TEST),this.gl.depthFunc(U.LESS),this.gl.clearDepth(1),this.gl.enable(U.BLEND),this.gl.blendFunc(U.SRC_ALPHA,U.ONE_MINUS_SRC_ALPHA),this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.gl.disable(this.gl.CULL_FACE),this.textureManager.initialize(),this.checkCanvasSize()}onCleanupBuffers=new Set;initializeBuffers(Q){if(this.onCleanupBuffers.forEach(($)=>$()),this.onCleanupBuffers.clear(),Q)[this.initializeIndexBuffer(o0),this.initializePositionBuffer(u0),this.initializeTransformBuffer(U0,Q),this.initializeSlotSizeBuffer(E0,Q)].forEach((K)=>this.onCleanupBuffers.add(K))}initializeIndexBuffer(Q){const $=this.attributeBuffers.createBuffer(Q);return this.gl.bindBuffer(U.ELEMENT_ARRAY_BUFFER,$.buffer),this.gl.bufferData(U.ELEMENT_ARRAY_BUFFER,Uint16Array.from([0,1,2,2,3,0]),U.STATIC_DRAW),()=>{this.attributeBuffers.deleteBuffer(Q)}}initializePositionBuffer(Q){const $=this.attributeBuffers.createBuffer(Q);return this.gl.bindBuffer(U.ARRAY_BUFFER,$.buffer),this.gl.vertexAttribPointer($.location,2,U.FLOAT,!1,0,0),this.gl.enableVertexAttribArray($.location),this.gl.bufferData(U.ARRAY_BUFFER,Float32Array.from([-1,-1,1,-1,1,1,-1,1]),U.STATIC_DRAW),()=>{this.gl.disableVertexAttribArray($.location),this.attributeBuffers.deleteBuffer(Q)}}initializeTransformBuffer(Q,$){const K=this.attributeBuffers.createBuffer(Q);this.gl.bindBuffer(U.ARRAY_BUFFER,K.buffer);for(let J=0;J<4;J++){const B=K.location+J;this.gl.vertexAttribPointer(B,4,U.FLOAT,!1,16*Float32Array.BYTES_PER_ELEMENT,J*4*Float32Array.BYTES_PER_ELEMENT),this.gl.enableVertexAttribArray(B),this.gl.vertexAttribDivisor(B,1)}return this.gl.bufferData(U.ARRAY_BUFFER,$*4*4*Float32Array.BYTES_PER_ELEMENT,U.DYNAMIC_DRAW),()=>{this.gl.disableVertexAttribArray(K.location),this.attributeBuffers.deleteBuffer(Q)}}initializeSlotSizeBuffer(Q,$){const K=this.attributeBuffers.createBuffer(Q);this.gl.bindBuffer(U.ARRAY_BUFFER,K.buffer);const J=K.location;return this.gl.vertexAttribPointer(J,2,U.FLOAT,!1,2*Float32Array.BYTES_PER_ELEMENT,0),this.gl.enableVertexAttribArray(J),this.gl.vertexAttribDivisor(J,1),this.gl.bufferData(U.ARRAY_BUFFER,$*2*Float32Array.BYTES_PER_ELEMENT,U.DYNAMIC_DRAW),()=>{this.gl.disableVertexAttribArray(K.location),this.attributeBuffers.deleteBuffer(Q)}}async updateTextures(Q,$){const K=(await Promise.all(Q.map(async(Y)=>{const Z=$(Y);if(!Z){console.warn(`No media for imageId ${Y}`);return}return{mediaData:await this.imageManager.renderMedia(Y,Z),imageId:Y}}))).filter((Y)=>!!Y),J=await Promise.all(K.map(async({mediaData:Y,imageId:Z})=>{const{slot:V,refreshCallback:F}=this.textureManager.allocateSlotForImage(Y),H=Math.log2(V.size[0]),X=Math.log2(V.size[1]),P=H*16+X;return this.textureSlots[Z]={buffer:Float32Array.from([P,V.slotNumber])},Y.refreshCallback=F,V.textureIndex}));return new Set(J).forEach((Y)=>{if(Y===H0)this.textureManager.setupTextureForVideo(`TEXTURE${Y}`);else this.textureManager.generateMipMap(`TEXTURE${Y}`)}),K.map(({mediaData:Y})=>Y)}drawElementsInstanced(Q,$){this.gl.drawElementsInstanced(U.TRIANGLES,Q,U.UNSIGNED_SHORT,0,$)}static spriteMatrix=L.create();updateSpriteTransforms(Q,$){const K=this.attributeBuffers.getAttributeBuffer(U0);this.gl.bindBuffer(U.ARRAY_BUFFER,K.buffer);let J=this.spriteCount-1;Q.forEach((B)=>{const Y=j0.spriteMatrix.identity().getMatrix(),Z=$(B);if(Z?.transforms.forEach((V)=>M.multiply(Y,Y,V)),this.gl.bufferSubData(U.ARRAY_BUFFER,16*Float32Array.BYTES_PER_ELEMENT*B,Y),Z)J=Math.max(J,B)}),Q.clear();while(J>=0&&!$(J))J--;this.spriteCount=Math.max(this.spriteCount,J+1)}updateSpriteAnims(Q,$){const K=this.attributeBuffers.getAttributeBuffer(E0);this.gl.bindBuffer(U.ARRAY_BUFFER,K.buffer),Q.forEach((J)=>{const B=$(J),Y=this.textureSlots[B?.imageId??-1];if(Y){const{buffer:Z}=Y;this.gl.bufferSubData(U.ARRAY_BUFFER,2*Float32Array.BYTES_PER_ELEMENT*J,Z),Q.delete(J)}})}updateCameraMatrix(Q,$){this.gl.uniformMatrix4fv(this.cameraMatrixUniforms[Q],!1,$)}bindVertexArray(){return this.own(new R0(this.gl))}update(){this.drawElementsInstanced(QJ,this.spriteCount)}}var JJ=50,a;(function(K){K[K["DEFAULT"]=0]="DEFAULT";K[K["LAST"]=1]="LAST"})(a||(a={}));class z0{updateSchedule=new Map;time=0;loop(Q,$,K,J){this.registerUpdate(Q,{period:$?1000/$:1,expirationTime:J,priority:K})}registerUpdate(Q,$={}){$.triggerTime=$.triggerTime??this.time,$.expirationTime=$.expirationTime??Infinity,$.period=$.period,$.priority=$.priority??a.DEFAULT,this.updateSchedule.set(Q,$)}start(){let Q=0,$=0;const K={deltaTime:0},J=[],B=[],Y=[J,B],Z=(V)=>{K.deltaTime=Math.min(V-$,JJ),Q=requestAnimationFrame(Z),$=V,this.time=V,J.length=0,B.length=0,this.updateSchedule.forEach((F,H)=>{if(V<F.triggerTime)return;if(Y[F.priority].push(H),F.period&&V<F.expirationTime)F.triggerTime=Math.max(F.triggerTime+F.period,V);else this.updateSchedule.delete(H)}),Y.forEach((F)=>F.forEach((H)=>H.update(K)))};requestAnimationFrame(Z),this.stop=()=>{cancelAnimationFrame(Q),this.stop=()=>{}}}stop=()=>{}}class C0{Q;$;K;constructor(Q,$,K){this.type=Q;this.camera=$;this.engine=K}update(){const{camera:Q,engine:$}=this;$.updateCameraMatrix(this.type,Q.getCameraMatrix(this.type))}}class y0{Q;$;K;updatedImageIds=new Set;constructor(Q,$,K){this.motor=Q;this.getMedia=$;this.engine=K}withImageId(Q){return this.updatedImageIds.add(Q),this}update(){const Q=Array.from(this.updatedImageIds);this.updatedImageIds.clear(),this.engine.updateTextures(Q,this.getMedia).then(($)=>{$.forEach((K)=>{if(K.isVideo)this.motor.registerUpdate(K,K.schedule)})})}}class p0{Q;$;updatedSpriteIds=new Set;constructor(Q,$){this.getSprite=Q;this.engine=$}withSpriteId(Q){return this.updatedSpriteIds.add(Q),this}update(){this.engine.updateSpriteTransforms(this.updatedSpriteIds,this.getSprite)}}class x0{Q;$;K;updatedSpriteIds=new Set;constructor(Q,$,K){this.motor=Q;this.getSprite=$;this.engine=K}withSpriteId(Q){return this.updatedSpriteIds.add(Q),this}update(){if(this.engine.updateSpriteAnims(this.updatedSpriteIds,this.getSprite),this.updatedSpriteIds.size)this.motor.registerUpdate(this)}}class c0 extends w{motor;engine;camera;cameraMatrixUpdates;onDeactivateWorld(){}constructor({motor:Q,canvas:$,engine:K,size:J,camera:B}){super();this.motor=Q??new z0,this.engine=K??new j0($??new OffscreenCanvas(J[0],J[1])),this.camera=B??new g0,this.cameraMatrixUpdates={[y.VIEW]:new C0(y.VIEW,this.camera,this.engine),[y.PROJECTION]:new C0(y.PROJECTION,this.camera,this.engine)},this.onResize=this.onResize.bind(this),this.initialize()}initialize(){const{engine:Q,motor:$}=this;$.loop(Q,void 0,a.LAST),Q.addResizeListener(this.onResize)}onResize(Q,$){this.camera.configProjectionMatrix(Q,$),this.motor.registerUpdate(this.cameraMatrixUpdates[y.PROJECTION])}start(Q){const{engine:$,motor:K}=this,J=new y0(K,Q.getMedia,$),B=new p0(Q.getSprite,$),Y=new x0(K,Q.getSprite,$),Z={["SpriteAnim"]:(V)=>K.registerUpdate(Y.withSpriteId(V)),["SpriteTransform"]:(V)=>K.registerUpdate(B.withSpriteId(V)),["Media"]:(V)=>K.registerUpdate(J.withImageId(V)),["Camera"]:(V)=>K.registerUpdate(this.cameraMatrixUpdates[V])};$.initializeBuffers(Q.getMaxSpriteCount()),$.clearTextureSlots(),this.onDeactivateWorld=Q?.activate({onUpdate(V,F){Z[V](F)}}),K.loop(Q),K.start()}destroy(){super.destroy(),this.engine.removeResizeListener(this.onResize),this.onDeactivateWorld()}}var l0=0,n0=1,m0=2,d0=3,i0=4,s0=5,m=512;class b0 extends t{sprites;hudSpriteId=0;medias={[i0]:{type:"video",src:"sample.mp4",volume:0,fps:30},[l0]:{type:"image",src:"dobuki.png"},[n0]:{type:"draw",draw:(Q)=>{const{canvas:$}=Q;$.width=m,$.height=m;const K=$.width/2,J=$.height/2,B=$.width/2;Q.imageSmoothingEnabled=!0,Q.fillStyle="#ddd",Q.lineWidth=$.width/50,Q.fillRect(0,0,$.width,$.height),Q.strokeStyle="black",Q.fillStyle="gold",Q.beginPath(),Q.arc(K,J,B*0.8,0,2*Math.PI),Q.fill(),Q.stroke(),Q.beginPath(),Q.arc(K,J,B*0.5,0,Math.PI),Q.stroke(),Q.beginPath(),Q.arc($.width/3,$.height/3,B*0.1,0,Math.PI,!0),Q.stroke(),Q.beginPath(),Q.arc($.width/3*2,$.height/3,B*0.1,0,Math.PI*2,!0),Q.stroke()}},[m0]:{type:"draw",draw:(Q)=>{const{canvas:$}=Q;$.width=m,$.height=m,Q.imageSmoothingEnabled=!0,Q.fillStyle="#ddd",Q.lineWidth=$.width/50,Q.fillRect(0,0,$.width,$.height),Q.strokeStyle="black",Q.fillStyle="silver",Q.beginPath(),Q.rect($.width*0.2,$.height*0.2,$.width*0.6,$.height*0.6),Q.fill(),Q.stroke()}},[d0]:{type:"draw",draw:(Q)=>{const{canvas:$}=Q;$.width=m,$.height=m,Q.lineWidth=$.width/50,Q.strokeStyle="black",Q.beginPath(),Q.rect(30,30,$.width-60,$.height-60),Q.stroke()}},[s0]:{type:"draw",draw:(Q)=>{const{canvas:$}=Q;$.width=m,$.height=m,Q.imageSmoothingEnabled=!0,Q.lineWidth=5,Q.strokeStyle="green",Q.beginPath(),Q.rect(10,10,$.width-20,$.height-20),Q.stroke()}}};constructor(Q,$){super(Q,$);this.sprites=[{imageId:d0,transforms:[this.camera.getHudMatrix().getMatrix()]},{imageId:l0,transforms:[L.create().translate(0,0,0).getMatrix()]},...[L.create().translate(-1,0,1).rotateY(Math.PI/2).scale(1,1,1).getMatrix(),L.create().translate(1,0,1).rotateY(-Math.PI/2).scale(1,1,1).getMatrix()].map((K)=>({imageId:n0,transforms:[K]})),...[L.create().translate(0,-1,1).rotateX(-Math.PI/2).scale(1,1,1).getMatrix(),L.create().translate(0,-1,3).rotateX(-Math.PI/2).scale(1,1,1).getMatrix(),L.create().translate(-2,-1,3).rotateX(-Math.PI/2).scale(1,1,1).getMatrix(),L.create().translate(2,-1,3).rotateX(-Math.PI/2).scale(1,1,1).getMatrix()].map((K)=>({imageId:m0,transforms:[K]})),{imageId:i0,transforms:[L.create().translate(0,5,-10).scale(9.6,5.4,1).getMatrix()]},...new Array(400).fill(0).map((K,J)=>L.create().translate(J%20-10,-1.5,Math.floor(J/20)-10).rotateX(-Math.PI/2).scale(1,1,1).getMatrix()).map((K)=>({imageId:s0,transforms:[K]}))]}getMedia(Q){return this.medias[Q]}getMaxSpriteCount(){return this.sprites.length}getSprite(Q){return this.sprites[Q]}update({deltaTime:Q}){const $=Q/80,K=Q/400;if(this.keys.KeyW||this.keys.ArrowUp&&!this.keys.ShiftRight)this.camera.moveCam(0,0,$);if(this.keys.KeyS||this.keys.ArrowDown&&!this.keys.ShiftRight)this.camera.moveCam(0,0,-$);if(this.keys.KeyA||this.keys.ArrowLeft&&!this.keys.ShiftRight)this.camera.moveCam(-$,0,0);if(this.keys.KeyD||this.keys.ArrowRight&&!this.keys.ShiftRight)this.camera.moveCam($,0,0);if(this.keys.KeyQ||this.keys.ArrowLeft&&this.keys.ShiftRight)this.camera.turnCam(-K);if(this.keys.KeyE||this.keys.ArrowRight&&this.keys.ShiftRight)this.camera.turnCam(K);if(this.keys.ArrowUp&&this.keys.ShiftRight)this.camera.tilt(-K);if(this.keys.ArrowDown&&this.keys.ShiftRight)this.camera.tilt(K);if(this.camera.refresh())this.onUpdate("Camera",y.VIEW),this.onUpdate("SpriteTransform",this.hudSpriteId)}keys={};activate({onUpdate:Q}){this.onUpdate=Q;const $=(J)=>this.keys[J.code]=!0,K=(J)=>this.keys[J.code]=!1;return document.addEventListener("keydown",$),document.addEventListener("keyup",K),this.onUpdate("Camera",y.PROJECTION),this.onUpdate("Camera",y.VIEW),this.onUpdate("SpriteTransform",this.hudSpriteId),[n0,m0,d0,l0,i0,s0].forEach((J)=>this.onUpdate("Media",J)),this.sprites.forEach((J,B)=>{this.onUpdate("SpriteTransform",B),this.onUpdate("SpriteAnim",B)}),()=>{document.removeEventListener("keydown",$),document.removeEventListener("keyup",K),this.onUpdate=()=>{}}}}async function p8(){console.log("Hello World!")}async function x8(Q){Q.style.border="2px solid silver",Q.style.cursor="grab",Q.addEventListener("mouseenter",()=>{Q.style.borderColor="black"}),Q.addEventListener("mouseleave",()=>{Q.style.borderColor="silver"});const $=new c0({canvas:Q}),K=new b0($);return $.start(K),$}export{x8 as testCanvas,p8 as hello,t as World};

//# debugId=49E885C937806BC464756e2164756e21
