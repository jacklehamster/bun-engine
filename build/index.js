var Y$=Object.defineProperty;var D0=(Q,$)=>{for(var J in $)Y$(Q,J,{get:$[J],enumerable:!0,configurable:!0,set:(K)=>$[J]=()=>K})};function JQ(Q,$){for(let J=0;J<Q.length;J++){const K=Q.at(J);if(K)$(K,J)}}class _0{Q;$;J;constructor(Q,$,J){this.array=Q;this.updateValue=$;this.notifier=J}at(Q){return this.array.at(Q)}get length(){return this.array.length}set(Q,$){this.updateValue(Q,$),this.notifier?.informUpdate(Q)}}class R0{Q;$;J;updatedImageIds=new Set;constructor(Q,$,J){this.motor=Q;this.getMedia=$;this.engine=J}withImageId(Q){return this.updatedImageIds.add(Q),this}informUpdate(Q){this.motor.registerUpdate(this.withImageId(Q))}refresh(){const Q=Array.from(this.updatedImageIds);this.updatedImageIds.clear(),this.engine.updateTextures(Q,this.getMedia).then(($)=>{$.forEach((J)=>{if(J.isVideo)this.motor.registerUpdate(J,J.schedule)})})}}class C0 extends _0{constructor(Q,$=[]){super($,(J,K)=>$[J]=K,new R0(Q.motor,$.at.bind($),Q.engine))}}class k0{Q;constructor(Q){this.auxiliaries=Q}refresh(Q){for(let $ of this.auxiliaries)$.refresh(Q)}addAuxiliary(...Q){this.auxiliaries.push(...Q)}}class J0 extends k0{Q;medias;constructor(Q,$){super($);this.core=Q;this.medias=new C0(Q)}informUpdate(Q,$){console.warn("pass onUpdate to inform about changes in the world.",Q,$)}activate(Q){const{updateCallback:$,core:J}=Q;this.informUpdate=$;const K=J.motor.loop(this);return JQ(this.sprites,(B,Y)=>{this.informUpdate("SpriteTransform",Y),this.informUpdate("SpriteAnim",Y)}),()=>{this.informUpdate=()=>{},K()}}addMedia(...Q){for(let $ of Q)this.medias.set($.id,$)}}class f{disposables;own(Q){if(!this.disposables)this.disposables=new Set;return this.disposables.add(Q),Q}addOnDestroy(Q){if(Q)this.disposables?.add({destroy:Q})}destroy(){this.disposables?.forEach((Q)=>Q.destroy())}}var E=globalThis.WebGL2RenderingContext??{},KQ="position",BQ="index",G0="transform",q0="slotSize_and_number",YQ="instance",ZQ="camPos",VQ="camTilt",FQ="camTurn",HQ="projection",XQ="maxTextureSize",WQ="uTextures";var Z$=function(Q,$,J){function K(X,W){function O(U){return U===Q?.VERTEX_SHADER?"vertex":U===Q?.FRAGMENT_SHADER?"fragment":void 0}if(W!==Q.VERTEX_SHADER&&W!==Q.FRAGMENT_SHADER)throw new Error(`Shader error in ${O(W)}`);const P=Q.createShader(W);if(!P)throw new Error(`Unable to generate ${O(W)} shader.`);if(Q.shaderSource(P,X),Q.compileShader(P),!Q.getShaderParameter(P,Q.COMPILE_STATUS))console.error(`Shader compile error in ${O(W)}:`+Q.getShaderInfoLog(P));return P}const B=Q.createProgram();if(!B)throw new Error("Unable to create program.");const Y=K($,Q.VERTEX_SHADER),Z=K(J,Q.FRAGMENT_SHADER),V=Q.getShaderInfoLog(Y),F=Q.getShaderInfoLog(Z);if(V)console.log("VERTEX",V);if(F)console.log("FRAGMENT",F);Q.attachShader(B,Y),Q.attachShader(B,Z),Q.linkProgram(B);const H=Q.getProgramInfoLog(B);if(H)console.log("PROGRAM",H);if(Q.detachShader(B,Y),Q.detachShader(B,Z),Q.deleteShader(Y),Q.deleteShader(Z),Q.validateProgram(B),Object.entries(E).forEach(([X,W])=>{if(W&&Q.getError()===W)console.log(`gl.${X}`)}),!Q.getProgramParameter(B,Q.LINK_STATUS))throw new Error("Unable to initialize the shader program:\n"+Q.getProgramInfoLog(B));return B},V$=function(Q,$){Q.deleteProgram($)};class M0 extends f{gl;program;constructor(Q,$,J){super();this.gl=Q,this.program=Z$(Q,$.trim(),J.trim())}use(){this.gl.useProgram(this.program)}destroy(){super.destroy(),V$(this.gl,this.program)}}class L0 extends f{activeProgramId="";gl;programs={};constructor(Q){super();this.gl=Q}addProgram(Q,$,J){if(this.programs[Q])this.removeProgram(Q);this.programs[Q]=this.own(new M0(this.gl,$,J))}useProgram(Q){if(this.activeProgramId!==Q)this.activeProgramId=Q,this.programs[Q].use()}removeProgram(Q){this.programs[Q].destroy(),delete this.programs[Q]}getProgram(Q){return this.programs[Q??this.activeProgramId]?.program}}class T0 extends f{gl;triangleArray;constructor(Q){super();this.gl=Q,this.triangleArray=Q.createVertexArray(),Q.bindVertexArray(this.triangleArray)}destroy(){this.gl.deleteVertexArray(this.triangleArray)}}class S0 extends f{bufferRecord={};gl;programs;constructor(Q,$){super();this.gl=Q,this.programs=$}getAttributeLocation(Q,$){const J=this.programs.getProgram($);return J?this.gl.getAttribLocation(J,Q)??-1:-1}createBuffer(Q){this.deleteBuffer(Q);const $=this.gl?.createBuffer();if(!$)throw new Error(`Unable to create buffer "${Q}"`);const J={buffer:$,location:this.getAttributeLocation(Q)};return this.bufferRecord[Q]=J,J}deleteBuffer(Q){if(this.bufferRecord[Q])this.gl.deleteBuffer(this.bufferRecord[Q].buffer),delete this.bufferRecord[Q]}getAttributeBuffer(Q){const $=this.bufferRecord[Q];if(!$)throw new Error(`Attribute "${Q}" not created. Make sure "createBuffer" is called.`);return $}destroy(){Object.keys(this.bufferRecord).forEach((Q)=>this.deleteBuffer(Q))}}class h0 extends f{gl;programs;constructor(Q,$){super();this.gl=Q,this.programs=$}getUniformLocation(Q,$){const J=this.programs.getProgram($);return this.gl.getUniformLocation(J,Q)}}function jQ(Q,$=(J)=>J.key){var J=[];return I0(Q,"",!0,(K)=>J.push(K),$),J.join("")}var I0=function(Q,$,J,K,B){if(Q){K(`${$}${J?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 "}${B(Q)}\n`);const Y=$+(J?"    ":"\u2502   ");if(Q.left)I0(Q.left,Y,!1,K,B);if(Q.right)I0(Q.right,Y,!0,K,B)}};function K0(Q){if(Q===null)return!0;var $=B0(Q.left),J=B0(Q.right);if(Math.abs($-J)<=1&&K0(Q.left)&&K0(Q.right))return!0;return!1}var B0=function(Q){return Q?1+Math.max(B0(Q.left),B0(Q.right)):0};function Y0(Q,$,J,K,B){const Y=B-K;if(Y>0){const Z=K+Math.floor(Y/2),V=$[Z],F=J[Z],H={key:V,data:F,parent:Q};return H.left=Y0(H,$,J,K,Z),H.right=Y0(H,$,J,Z+1,B),H}return null}function Z0(Q){if(Q===null)return 0;const $=Z0(Q.left),J=Z0(Q.right);return Q.balanceFactor=$-J,Math.max($,J)+1}function V0(Q,$,J,K,B){if(J>=K)return;const Y=Q[J+K>>1];let Z=J-1,V=K+1;while(!0){do Z++;while(B(Q[Z],Y)<0);do V--;while(B(Q[V],Y)>0);if(Z>=V)break;let F=Q[Z];Q[Z]=Q[V],Q[V]=F,F=$[Z],$[Z]=$[V],$[V]=F}V0(Q,$,J,V,B),V0(Q,$,V+1,K,B)}var F$=function(Q,$){return Q>$?1:Q<$?-1:0},F0=function(Q){var $=Q.right;if(Q.right=$.left,$.left)$.left.parent=Q;if($.parent=Q.parent,$.parent)if($.parent.left===Q)$.parent.left=$;else $.parent.right=$;if(Q.parent=$,$.left=Q,Q.balanceFactor+=1,$.balanceFactor<0)Q.balanceFactor-=$.balanceFactor;if($.balanceFactor+=1,Q.balanceFactor>0)$.balanceFactor+=Q.balanceFactor;return $},H0=function(Q){var $=Q.left;if(Q.left=$.right,Q.left)Q.left.parent=Q;if($.parent=Q.parent,$.parent)if($.parent.left===Q)$.parent.left=$;else $.parent.right=$;if(Q.parent=$,$.right=Q,Q.balanceFactor-=1,$.balanceFactor>0)Q.balanceFactor-=$.balanceFactor;if($.balanceFactor-=1,Q.balanceFactor<0)$.balanceFactor+=Q.balanceFactor;return $};class r{constructor(Q,$=!1){this._comparator=Q||F$,this._root=null,this._size=0,this._noDuplicates=!!$}destroy(){return this.clear()}clear(){return this._root=null,this._size=0,this}get size(){return this._size}contains(Q){if(this._root){var $=this._root,J=this._comparator;while($){var K=J(Q,$.key);if(K===0)return!0;else if(K<0)$=$.left;else $=$.right}}return!1}next(Q){var $=Q;if($)if($.right){$=$.right;while($.left)$=$.left}else{$=Q.parent;while($&&$.right===Q)Q=$,$=$.parent}return $}prev(Q){var $=Q;if($)if($.left){$=$.left;while($.right)$=$.right}else{$=Q.parent;while($&&$.left===Q)Q=$,$=$.parent}return $}forEach(Q){var $=this._root,J=[],K=!1,B=0;while(!K)if($)J.push($),$=$.left;else if(J.length>0)$=J.pop(),Q($,B++),$=$.right;else K=!0;return this}range(Q,$,J,K){const B=[],Y=this._comparator;let Z=this._root,V;while(B.length!==0||Z)if(Z)B.push(Z),Z=Z.left;else{if(Z=B.pop(),V=Y(Z.key,$),V>0)break;else if(Y(Z.key,Q)>=0){if(J.call(K,Z))return this}Z=Z.right}return this}keys(){var Q=this._root,$=[],J=[],K=!1;while(!K)if(Q)$.push(Q),Q=Q.left;else if($.length>0)Q=$.pop(),J.push(Q.key),Q=Q.right;else K=!0;return J}values(){var Q=this._root,$=[],J=[],K=!1;while(!K)if(Q)$.push(Q),Q=Q.left;else if($.length>0)Q=$.pop(),J.push(Q.data),Q=Q.right;else K=!0;return J}at(Q){var $=this._root,J=[],K=!1,B=0;while(!K)if($)J.push($),$=$.left;else if(J.length>0){if($=J.pop(),B===Q)return $;B++,$=$.right}else K=!0;return null}minNode(){var Q=this._root;if(!Q)return null;while(Q.left)Q=Q.left;return Q}maxNode(){var Q=this._root;if(!Q)return null;while(Q.right)Q=Q.right;return Q}min(){var Q=this._root;if(!Q)return null;while(Q.left)Q=Q.left;return Q.key}max(){var Q=this._root;if(!Q)return null;while(Q.right)Q=Q.right;return Q.key}isEmpty(){return!this._root}pop(){var Q=this._root,$=null;if(Q){while(Q.left)Q=Q.left;$={key:Q.key,data:Q.data},this.remove(Q.key)}return $}popMax(){var Q=this._root,$=null;if(Q){while(Q.right)Q=Q.right;$={key:Q.key,data:Q.data},this.remove(Q.key)}return $}find(Q){var $=this._root,J=$,K,B=this._comparator;while(J)if(K=B(Q,J.key),K===0)return J;else if(K<0)J=J.left;else J=J.right;return null}insert(Q,$){if(!this._root)return this._root={parent:null,left:null,right:null,balanceFactor:0,key:Q,data:$},this._size++,this._root;var J=this._comparator,K=this._root,B=null,Y=0;if(this._noDuplicates)while(K)if(Y=J(Q,K.key),B=K,Y===0)return null;else if(Y<0)K=K.left;else K=K.right;else while(K)if(Y=J(Q,K.key),B=K,Y<=0)K=K.left;else K=K.right;var Z={left:null,right:null,balanceFactor:0,parent:B,key:Q,data:$},V;if(Y<=0)B.left=Z;else B.right=Z;while(B){if(Y=J(B.key,Q),Y<0)B.balanceFactor-=1;else B.balanceFactor+=1;if(B.balanceFactor===0)break;else if(B.balanceFactor<-1){if(B.right.balanceFactor===1)H0(B.right);if(V=F0(B),B===this._root)this._root=V;break}else if(B.balanceFactor>1){if(B.left.balanceFactor===-1)F0(B.left);if(V=H0(B),B===this._root)this._root=V;break}B=B.parent}return this._size++,Z}remove(Q){if(!this._root)return null;var $=this._root,J=this._comparator,K=0;while($)if(K=J(Q,$.key),K===0)break;else if(K<0)$=$.left;else $=$.right;if(!$)return null;var B=$.key,Y,Z;if($.left){Y=$.left;while(Y.left||Y.right){while(Y.right)Y=Y.right;if($.key=Y.key,$.data=Y.data,Y.left)$=Y,Y=Y.left}$.key=Y.key,$.data=Y.data,$=Y}if($.right){Z=$.right;while(Z.left||Z.right){while(Z.left)Z=Z.left;if($.key=Z.key,$.data=Z.data,Z.right)$=Z,Z=Z.right}$.key=Z.key,$.data=Z.data,$=Z}var V=$.parent,F=$,H;while(V){if(V.left===F)V.balanceFactor-=1;else V.balanceFactor+=1;if(V.balanceFactor<-1){if(V.right.balanceFactor===1)H0(V.right);if(H=F0(V),V===this._root)this._root=H;V=H}else if(V.balanceFactor>1){if(V.left.balanceFactor===-1)F0(V.left);if(H=H0(V),V===this._root)this._root=H;V=H}if(V.balanceFactor===-1||V.balanceFactor===1)break;F=V,V=V.parent}if($.parent)if($.parent.left===$)$.parent.left=null;else $.parent.right=null;if($===this._root)this._root=null;return this._size--,B}load(Q=[],$=[],J){if(this._size!==0)throw new Error("bulk-load: tree is not empty");const K=Q.length;if(J)V0(Q,$,0,K-1,this._comparator);return this._root=Y0(null,Q,$,0,K),Z0(this._root),this._size=K,this}isBalanced(){return K0(this._root)}toString(Q){return jQ(this._root,Q)}}r.default=r;class c{size;slotNumber;x;y;textureIndex;parent;sibbling;textureSizeLimits;constructor(Q,$,J,K){this.textureSizeLimits=J?.textureSizeLimits??K??{min:w0,max:v0},this.size=Q,this.slotNumber=$,this.parent=J,this.sibbling=void 0;const{x:B,y:Y,textureIndex:Z}=this.calculatePosition(Q,$);this.x=B,this.y=Y,this.textureIndex=Z}calculateTextureIndex(Q,$){const[J,K]=Q,B=this.textureSizeLimits.max/J*(this.textureSizeLimits.max/K);return Math.floor($/B)}calculatePosition(Q,$){const[J,K]=Q,B=this.textureSizeLimits.max/J,Y=this.textureSizeLimits.max/K,Z=$%B*J,V=Math.floor($/B)%Y*K;return{x:Z,y:V,textureIndex:this.calculateTextureIndex(Q,$)}}getTag(){return c.getTag(this)}static getTag(Q){return`${Q.size[0]}x${Q.size[1]}-#${Q.slotNumber}`}static positionToTextureSlot(Q,$,J,K,B){const[Y,Z]=J,V=B.textureSizeLimits.max/Y,H=B.textureSizeLimits.max/Y*(B.textureSizeLimits.max/Z)*K+$/Z*V+Q/Y;return new c(J,H,B)}getPosition(){return{x:this.x,y:this.y,size:this.size,textureIndex:this.textureIndex}}canSplitHorizontally(){const[,Q]=this.size;return Q>this.textureSizeLimits.min}canSplitVertically(){const[Q]=this.size;return Q>this.textureSizeLimits.min}splitHorizontally(){const{x:Q,y:$,size:J,textureIndex:K}=this,[B,Y]=J;if(!this.canSplitHorizontally())throw new Error(`Cannot split texture slot of size ${B} horizontally`);const Z=B/2,V=c.positionToTextureSlot(Q,$,[Z,Y],K,this),F=c.positionToTextureSlot(Q+Z,$,[Z,Y],K,this);return V.sibbling=F,F.sibbling=V,[V,F]}splitVertically(){const{x:Q,y:$,size:J,textureIndex:K}=this,[B,Y]=J;if(!this.canSplitVertically())throw new Error(`Cannot split texture slot of size ${Y} vertically`);const Z=Y/2,V=c.positionToTextureSlot(Q,$,[B,Z],K,this),F=c.positionToTextureSlot(Q,$+Z,[B,Z],K,this);return V.sibbling=F,F.sibbling=V,[V,F]}}function X0(Q,$){return Math.max($,Math.pow(2,Math.ceil(Math.log(Q)/Math.log(2))))}function PQ(Q,$,J,K){if(J<1)throw new Error("Invalid count");const B=X0(Q,K.min),Y=X0($,K.min),Z=new Map;let V=K.min;for(let F=1;F<=J;F++){V=X0(B*F,K.min);const H=X0(Y*Math.ceil(J/F),K.min);Z.set(V,H)}for(let F=V;F<=K.max;F*=2)if(!Z.has(F))Z.set(F,Y);return Z}var H$=!1,w0=16,v0=4096,X$=16;class W0{textureSlots=new r((Q,$)=>{const J=Q.size[0]*Q.size[1]-$.size[0]*$.size[1];if(J!==0)return J;return Q.slotNumber-$.slotNumber},!1);allocatedTextures={};minTextureSize;maxTextureSize;numTextureSheets;initialSlots=[];constructor({numTextureSheets:Q,minTextureSize:$,maxTextureSize:J,excludeTexture:K}={},B){if(this.numTextureSheets=Q??X$,this.minTextureSize=$??w0,this.maxTextureSize=J??v0,B)this.numTextureSheets=Math.min(this.numTextureSheets,B.getParameter(WebGL2RenderingContext.MAX_TEXTURE_IMAGE_UNITS)),this.maxTextureSize=Math.min(this.maxTextureSize,B.getParameter(WebGL2RenderingContext.MAX_TEXTURE_SIZE)),this.minTextureSize=Math.min(this.minTextureSize,this.maxTextureSize);for(let Y=0;Y<this.numTextureSheets;Y++){if(K?.(Y))continue;this.initialSlots.push(new c([this.maxTextureSize,this.maxTextureSize],Y,void 0,{min:this.minTextureSize,max:this.maxTextureSize}))}this.initialSlots.forEach((Y)=>this.textureSlots.insert(Y))}allocate(Q,$,J=1){const{size:K,slotNumber:B,x:Y,y:Z,textureIndex:V}=this.allocateHelper(Q,$,J);return{size:K,slotNumber:B,x:Y,y:Z,textureIndex:V}}deallocate(Q){if(!this.isSlotUsed(Q))throw new Error("Slot is not allocated");const $=this.allocatedTextures[c.getTag(Q)];this.deallocateHelper($)}get countUsedTextureSheets(){return this.initialSlots.filter((Q)=>this.isSlotUsed(Q)).length}allocateHelper(Q,$,J=1){const K=PQ(Q,$,J,{min:this.minTextureSize,max:this.maxTextureSize}),B=this.findSlot(K);if(!B)throw new Error(`Could not find a slot for texture to fit ${J} sprites of size ${Q}x${$}`);this.textureSlots.remove(B);const[Y,Z]=this.bestFit(K,B);return this.fitSlot(B,Y,Z)}findSlot(Q){for(let $=0;$<this.textureSlots.size;$++){const K=this.textureSlots.at($).key,[B,Y]=K.size;if(Q.get(B)<=Y)return K}return null}calculateRatio(Q,$){return Math.max(Q/$,$/Q)}bestFit(Q,$){const[J,K]=$.size;let B=$.textureSizeLimits.max;return Q.forEach((Y,Z)=>{if(Z<=J&&Y<=K){const V=Z*Y,F=Q.get(B)*B;if(V<F)B=Z;else if(V===F){if(this.calculateRatio(Z,Y)<this.calculateRatio(B,Q.get(B)))B=Z}}}),[B,Q.get(B)]}isSlotUsed(Q){return!!this.allocatedTextures[c.getTag(Q)]}deallocateHelper(Q){if(Q.parent&&Q.sibbling&&!this.isSlotUsed(Q.sibbling)){const $=Q.sibbling;if(this.textureSlots.remove($),H$&&this.textureSlots.find(Q))throw new Error("Slot is not expected to be in the tree");const J=Q.parent;this.deallocateHelper(J);return}this.textureSlots.insert(Q),delete this.allocatedTextures[Q.getTag()]}trySplitHorizontally(Q,$,J){if(Q.canSplitHorizontally()){const[K,B]=Q.splitHorizontally();if(K.size[0]>=$)return this.textureSlots.insert(B),this.fitSlot(K,$,J)}return null}trySplitVertically(Q,$,J){if(Q.canSplitVertically()){const[K,B]=Q.splitVertically();if(K.size[1]>=J)return this.textureSlots.insert(B),this.fitSlot(K,$,J)}return null}fitSlot(Q,$,J){if(this.allocatedTextures[Q.getTag()]=Q,Q.size[0]>Q.size[1]){const K=this.trySplitHorizontally(Q,$,J)??this.trySplitVertically(Q,$,J);if(K)return K}else{const K=this.trySplitVertically(Q,$,J)??this.trySplitHorizontally(Q,$,J);if(K)return K}return Q}listSlots(){this.textureSlots.forEach((Q)=>{console.log(Q.key?.getTag())})}}var j0=15;class f0 extends f{gl;uniforms;textureBuffers={};tempContext=new OffscreenCanvas(1,1).getContext("2d");textureSlotAllocator=new W0({excludeTexture:(Q)=>Q===j0});textureSlotAllocatorForVideo=new W0({excludeTexture:(Q)=>Q!==j0});constructor(Q,$){super();this.gl=Q,this.uniforms=$,this.tempContext.imageSmoothingEnabled=!0}initialize(){this.initTextureUniforms(),this.initMaxTexture()}getTexture(Q){if(!this.textureBuffers[Q]){const $=this.gl.createTexture();if(!$)return;this.gl.bindTexture(E.TEXTURE_2D,$),this.gl.texImage2D(E.TEXTURE_2D,0,E.RGBA,this.textureSlotAllocator.maxTextureSize,this.textureSlotAllocator.maxTextureSize,0,E.RGBA,E.UNSIGNED_BYTE,null),this.textureBuffers[Q]=$,this.addOnDestroy(()=>this.gl.deleteTexture($))}return this.textureBuffers[Q]}loadTexture(Q,$,J,K,B){this.gl.activeTexture(E[$]),this.gl.bindTexture(E.TEXTURE_2D,J),this.applyTexImage2d(Q,K,B),this.gl.texParameteri(E.TEXTURE_2D,E.TEXTURE_MIN_FILTER,E.LINEAR)}applyTexImage2d(Q,[$,J,K,B],[Y,Z,V,F]){if(K===V&&B===F&&!$&&!J)this.gl.texSubImage2D(E.TEXTURE_2D,0,Y,Z,V,F,E.RGBA,E.UNSIGNED_BYTE,Q.texImgSrc);else{const H=this.tempContext.canvas;if(Q.texImgSrc instanceof ImageData){if(H.width=V||Q.width,H.height=F||Q.height,this.tempContext.putImageData(Q.texImgSrc,0,0),$||J)console.warn("Offset not available when sending imageData")}else{const X=K||Q.width,W=B||Q.height;H.width=V||X,H.height=F||W,this.tempContext.drawImage(Q.texImgSrc,$,J,X,W,0,0,H.width,H.height)}this.gl.texSubImage2D(E.TEXTURE_2D,0,Y,Z,H.width,H.height,E.RGBA,E.UNSIGNED_BYTE,H)}}allocateSlotForImage(Q){const J=(Q.isVideo?this.textureSlotAllocatorForVideo:this.textureSlotAllocator).allocate(Q.width,Q.height),K=`TEXTURE${J.textureIndex}`,B=this.getTexture(K);if(!B)throw new Error(`Invalid texture Id ${K}`);const Y=this.assignImageToTexture(Q,K,B,[0,0,Q.width,Q.height],[J.x,J.y,...J.size]);return{slot:J,refreshCallback:Y}}assignImageToTexture(Q,$,J,K,B){const Y=K??[0,0,Q.width,Q.height],Z=B??[0,0,Y[2],Y[3]],V=()=>{this.gl.bindTexture(E.TEXTURE_2D,J),this.applyTexImage2d(Q,Y,Z)};if(Q.active)V();else this.loadTexture(Q,$,J,Y,Z),Q.active=!0;return V}setupTextureForVideo(Q){const $=this.getTexture(Q);if($)this.gl.activeTexture(E[Q]),this.gl.bindTexture(E.TEXTURE_2D,$),this.gl.texParameteri(E.TEXTURE_2D,E.TEXTURE_MIN_FILTER,E.LINEAR),this.gl.texParameteri(E.TEXTURE_2D,E.TEXTURE_MAG_FILTER,E.LINEAR)}generateMipMap(Q){const $=this.getTexture(Q);if($)this.gl.activeTexture(E[Q]),this.gl.bindTexture(E.TEXTURE_2D,$),this.gl.texParameteri(E.TEXTURE_2D,E.TEXTURE_MIN_FILTER,E.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(E.TEXTURE_2D,E.TEXTURE_MAG_FILTER,E.LINEAR),this.gl.generateMipmap(E.TEXTURE_2D)}initTextureUniforms(){const Q=this.gl.getParameter(E.MAX_TEXTURE_IMAGE_UNITS),$=new Array(Q).fill(null).map((K,B)=>B),J=this.uniforms.getUniformLocation(WQ);this.gl.uniform1iv(J,$)}initMaxTexture(){const Q=this.uniforms.getUniformLocation(XQ);this.gl.uniform1f(Q,this.textureSlotAllocator.maxTextureSize)}}class m extends f{texImgSrc;active=!1;width;height;isVideo;schedule;constructor(Q,$){super();this.texImgSrc=Q;const J=Q;if(this.isVideo=!!(J.videoWidth||J.videoHeight),this.width=J.naturalWidth??J.videoWidth??J.displayWidth??J.width?.baseValue?.value??J.width,this.height=J.naturalHeight??J.videoHeight??J.displayHeight??J.height?.baseValue?.value??J.height,this.schedule=$?{period:1000/$}:void 0,!this.width||!this.height)throw new Error("Invalid image")}refresh(){this.refreshCallback?.()}static createFromCanvas(Q){return new m(Q)}static async loadImage(Q){const $=await new Promise((J,K)=>{const B=new Image;B.crossOrigin="anonymous";const Y=(Z)=>K(Z.error);B.addEventListener("error",Y),B.addEventListener("load",()=>J(B),{once:!0}),B.src=Q});return new m($)}static async loadVideo(Q,$,J=30){const K=await new Promise((Y,Z)=>{const V=document.createElement("video");if(V.loop=!0,$!==void 0)V.volume=$;V.addEventListener("loadedmetadata",()=>{V.play(),Y(V)},{once:!0}),V.addEventListener("error",(F)=>Z(F.error)),V.src=Q}),B=new m(K,J);return B.addOnDestroy(()=>K.pause()),B}static async loadWebcam(Q){const $=await new Promise((B,Y)=>{const Z=document.createElement("video");Z.loop=!0,Z.addEventListener("loadedmetadata",()=>Z.play()),Z.addEventListener("playing",()=>B(Z),{once:!0}),Z.addEventListener("error",(V)=>Y(V.error))}),J=new m($);let K=!1;return navigator.mediaDevices.getUserMedia({video:{deviceId:Q}}).then((B)=>{if(!K)$.srcObject=B,J.addOnDestroy(()=>B.getTracks().forEach((Y)=>Y.stop()))}),J.addOnDestroy(()=>{K=!0,$.pause()}),J}}var a=function(Q){return Q};class g0 extends f{constructor(){super(...arguments)}images={};renderProcedures={image:a((Q,$)=>this.loadImage(Q,$.src)),video:a((Q,$)=>this.loadVideo(Q,$.src,$.volume,$.fps)),draw:a((Q,$)=>this.drawImage(Q,$.draw)),canvas:a((Q,$)=>this.loadCanvas(Q,$.canvas)),webcam:a((Q,$)=>this.loadWebCam(Q,$.deviceId))};hasImageId(Q){return!!this.getMedia(Q)}getMedia(Q){return this.images[Q]}setImage(Q,$){this.images[Q]=$}async renderMedia(Q,$){return this.renderProcedures[$.type](Q,$)}async drawImage(Q,$){const J=new OffscreenCanvas(1,1);$(J.getContext("2d"));const K=m.createFromCanvas(J);return this.images[Q]=this.own(K),K}async loadCanvas(Q,$){const J=m.createFromCanvas($);return $.getContext("2d"),this.images[Q]=this.own(J),J}async loadImage(Q,$){const J=await m.loadImage($);return this.images[Q]=this.own(J),J}async loadVideo(Q,$,J,K){const B=await m.loadVideo($,J,K);return this.images[Q]=this.own(B),B}async loadWebCam(Q,$){const J=await m.loadWebcam($);return this.images[Q]=this.own(J),J}}var OQ=`#version 300 es
//  ~{AUTHOR}

precision highp float;

//  IN
//  shape
layout(location = 0) in vec2 position;
layout(location = 1) in mat4 transform;
//  2, 3, 4 reserved for transform
//  animation
layout(location = 5) in vec2 slotSize_and_number;
layout(location = 6) in float instance;

//  UNIFORM
uniform float maxTextureSize;
uniform mat4 camPos;
uniform mat4 camTurn;
uniform mat4 camTilt;
uniform mat4 projection;

//  OUT
out vec2 vTex;
out float vTextureIndex;
out vec3 vInstanceColor;

void main() {
  vec2 tex = position.xy * vec2(0.49, -0.49) + 0.5;
  vec2 slotSize = vec2(
    pow(2.0, floor(slotSize_and_number.x / 16.0)),
    pow(2.0, mod(slotSize_and_number.x, 16.0)));
  float slotNumber = slotSize_and_number.y;
  float maxCols = maxTextureSize / slotSize.x;
  float maxRows = maxTextureSize / slotSize.y;
  float slotX = mod(slotNumber, maxCols);
  float slotY = mod(floor(slotNumber / maxCols), maxRows);

  gl_Position = projection * camTilt * camTurn * camPos * transform * vec4(position, 0.0, 1.0);
  vTex = (vec2(slotX, slotY) + tex) * slotSize / maxTextureSize;
  vTextureIndex = floor(slotNumber / (maxCols * maxRows));

  //  instance
  float r = fract(instance / (256.0 * 256.0 * 255.0));
  float g = fract(instance / (256.0 * 255.0));
  float b = fract(instance / 255.0);
  vInstanceColor = vec3(r, g, b);
}
`;var AQ=`#version 300 es
//  ~{AUTHOR}
precision highp float;

//  CONST
const int NUM_TEXTURES = 16;
const float threshold = 0.00001;

//  IN
//  texture
uniform sampler2D uTextures[NUM_TEXTURES];
in float vTextureIndex;
in vec2 vTex;
in float opacity;
in vec3 vInstanceColor;

//  OUT
out vec4 fragColor;

//  FUNCTIONS
vec4 getTextureColor(float textureSlot, vec2 vTexturePoint);

void main() {
  vec4 color = getTextureColor(vTextureIndex, vTex);
  if (color.a <= .0001) {
    discard;
  };
  fragColor = color;
//  fragColor = vec4(vInstanceColor.rgb, 1.0);
}

vec4 getTextureColor(float textureSlot, vec2 vTexturePoint) {
  if (abs(0.0 - textureSlot) < threshold) {
    return texture(uTextures[0], vTexturePoint);
  }
  if (abs(1.0 - textureSlot) < threshold) {
    return texture(uTextures[1], vTexturePoint);
  }
  if (abs(2.0 - textureSlot) < threshold) {
    return texture(uTextures[2], vTexturePoint);
  }
  if (abs(3.0 - textureSlot) < threshold) {
    return texture(uTextures[3], vTexturePoint);
  }
  if (abs(4.0 - textureSlot) < threshold) {
    return texture(uTextures[4], vTexturePoint);
  }
  if (abs(5.0 - textureSlot) < threshold) {
    return texture(uTextures[5], vTexturePoint);
  }
  if (abs(6.0 - textureSlot) < threshold) {
    return texture(uTextures[6], vTexturePoint);
  }
  if (abs(7.0 - textureSlot) < threshold) {
    return texture(uTextures[7], vTexturePoint);
  }
  if (abs(8.0 - textureSlot) < threshold) {
    return texture(uTextures[8], vTexturePoint);
  }
  if (abs(9.0 - textureSlot) < threshold) {
    return texture(uTextures[9], vTexturePoint);
  }
  if (abs(10.0 - textureSlot) < threshold) {
    return texture(uTextures[10], vTexturePoint);
  }
  if (abs(11.0 - textureSlot) < threshold) {
    return texture(uTextures[11], vTexturePoint);
  }
  if (abs(12.0 - textureSlot) < threshold) {
    return texture(uTextures[12], vTexturePoint);
  }
  if (abs(13.0 - textureSlot) < threshold) {
    return texture(uTextures[13], vTexturePoint);
  }
  if (abs(14.0 - textureSlot) < threshold) {
    return texture(uTextures[14], vTexturePoint);
  }
  if (abs(15.0 - textureSlot) < threshold) {
    return texture(uTextures[15], vTexturePoint);
  }
  return texture(uTextures[0], vTexturePoint);
}
`;function z0(Q,$){return Q.replace(/~\{(\w+)\}/g,(J,K)=>{return $?.[K]||J})}var k=0.000001,S=typeof Float32Array!=="undefined"?Float32Array:Array,n=Math.random,A8=Math.PI/180;if(!Math.hypot)Math.hypot=function(){var Q=0,$=arguments.length;while($--)Q+=arguments[$]*arguments[$];return Math.sqrt(Q)};function UQ(){var Q=new S(9);if(S!=Float32Array)Q[1]=0,Q[2]=0,Q[3]=0,Q[5]=0,Q[6]=0,Q[7]=0;return Q[0]=1,Q[4]=1,Q[8]=1,Q}var M={};D0(M,{transpose:()=>{{return D$}},translate:()=>{{return k$}},targetTo:()=>{{return r$}},subtract:()=>{{return kQ}},sub:()=>{{return KJ}},str:()=>{{return e$}},set:()=>{{return N$}},scale:()=>{{return G$}},rotateZ:()=>{{return T$}},rotateY:()=>{{return L$}},rotateX:()=>{{return M$}},rotate:()=>{{return q$}},perspectiveZO:()=>{{return l$}},perspectiveNO:()=>{{return RQ}},perspectiveFromFieldOfView:()=>{{return d$}},perspective:()=>{{return n$}},orthoZO:()=>{{return s$}},orthoNO:()=>{{return CQ}},ortho:()=>{{return i$}},multiplyScalarAndAdd:()=>{{return t$}},multiplyScalar:()=>{{return a$}},multiply:()=>{{return NQ}},mul:()=>{{return JJ}},lookAt:()=>{{return b$}},invert:()=>{{return _$}},identity:()=>{{return EQ}},getTranslation:()=>{{return z$}},getScaling:()=>{{return _Q}},getRotation:()=>{{return y$}},frustum:()=>{{return m$}},fromZRotation:()=>{{return f$}},fromYRotation:()=>{{return v$}},fromXRotation:()=>{{return w$}},fromValues:()=>{{return E$}},fromTranslation:()=>{{return S$}},fromScaling:()=>{{return h$}},fromRotationTranslationScaleOrigin:()=>{{return x$}},fromRotationTranslationScale:()=>{{return p$}},fromRotationTranslation:()=>{{return DQ}},fromRotation:()=>{{return I$}},fromQuat2:()=>{{return g$}},fromQuat:()=>{{return c$}},frob:()=>{{return u$}},exactEquals:()=>{{return QJ}},equals:()=>{{return $J}},determinant:()=>{{return C$}},create:()=>{{return O$}},copy:()=>{{return U$}},clone:()=>{{return A$}},adjoint:()=>{{return R$}},add:()=>{{return o$}}});function O$(){var Q=new S(16);if(S!=Float32Array)Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0;return Q[0]=1,Q[5]=1,Q[10]=1,Q[15]=1,Q}function A$(Q){var $=new S(16);return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$[3]=Q[3],$[4]=Q[4],$[5]=Q[5],$[6]=Q[6],$[7]=Q[7],$[8]=Q[8],$[9]=Q[9],$[10]=Q[10],$[11]=Q[11],$[12]=Q[12],$[13]=Q[13],$[14]=Q[14],$[15]=Q[15],$}function U$(Q,$){return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q[3]=$[3],Q[4]=$[4],Q[5]=$[5],Q[6]=$[6],Q[7]=$[7],Q[8]=$[8],Q[9]=$[9],Q[10]=$[10],Q[11]=$[11],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15],Q}function E$(Q,$,J,K,B,Y,Z,V,F,H,X,W,O,P,U,A){var j=new S(16);return j[0]=Q,j[1]=$,j[2]=J,j[3]=K,j[4]=B,j[5]=Y,j[6]=Z,j[7]=V,j[8]=F,j[9]=H,j[10]=X,j[11]=W,j[12]=O,j[13]=P,j[14]=U,j[15]=A,j}function N$(Q,$,J,K,B,Y,Z,V,F,H,X,W,O,P,U,A,j){return Q[0]=$,Q[1]=J,Q[2]=K,Q[3]=B,Q[4]=Y,Q[5]=Z,Q[6]=V,Q[7]=F,Q[8]=H,Q[9]=X,Q[10]=W,Q[11]=O,Q[12]=P,Q[13]=U,Q[14]=A,Q[15]=j,Q}function EQ(Q){return Q[0]=1,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=1,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=1,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function D$(Q,$){if(Q===$){var J=$[1],K=$[2],B=$[3],Y=$[6],Z=$[7],V=$[11];Q[1]=$[4],Q[2]=$[8],Q[3]=$[12],Q[4]=J,Q[6]=$[9],Q[7]=$[13],Q[8]=K,Q[9]=Y,Q[11]=$[14],Q[12]=B,Q[13]=Z,Q[14]=V}else Q[0]=$[0],Q[1]=$[4],Q[2]=$[8],Q[3]=$[12],Q[4]=$[1],Q[5]=$[5],Q[6]=$[9],Q[7]=$[13],Q[8]=$[2],Q[9]=$[6],Q[10]=$[10],Q[11]=$[14],Q[12]=$[3],Q[13]=$[7],Q[14]=$[11],Q[15]=$[15];return Q}function _$(Q,$){var J=$[0],K=$[1],B=$[2],Y=$[3],Z=$[4],V=$[5],F=$[6],H=$[7],X=$[8],W=$[9],O=$[10],P=$[11],U=$[12],A=$[13],j=$[14],N=$[15],G=J*V-K*Z,C=J*F-B*Z,R=J*H-Y*Z,D=K*F-B*V,_=K*H-Y*V,h=B*H-Y*F,T=X*A-W*U,w=X*j-O*U,v=X*N-P*U,g=W*j-O*A,z=W*N-P*A,y=O*N-P*j,q=G*y-C*z+R*g+D*v-_*w+h*T;if(!q)return null;return q=1/q,Q[0]=(V*y-F*z+H*g)*q,Q[1]=(B*z-K*y-Y*g)*q,Q[2]=(A*h-j*_+N*D)*q,Q[3]=(O*_-W*h-P*D)*q,Q[4]=(F*v-Z*y-H*w)*q,Q[5]=(J*y-B*v+Y*w)*q,Q[6]=(j*R-U*h-N*C)*q,Q[7]=(X*h-O*R+P*C)*q,Q[8]=(Z*z-V*v+H*T)*q,Q[9]=(K*v-J*z-Y*T)*q,Q[10]=(U*_-A*R+N*G)*q,Q[11]=(W*R-X*_-P*G)*q,Q[12]=(V*w-Z*g-F*T)*q,Q[13]=(J*g-K*w+B*T)*q,Q[14]=(A*C-U*D-j*G)*q,Q[15]=(X*D-W*C+O*G)*q,Q}function R$(Q,$){var J=$[0],K=$[1],B=$[2],Y=$[3],Z=$[4],V=$[5],F=$[6],H=$[7],X=$[8],W=$[9],O=$[10],P=$[11],U=$[12],A=$[13],j=$[14],N=$[15];return Q[0]=V*(O*N-P*j)-W*(F*N-H*j)+A*(F*P-H*O),Q[1]=-(K*(O*N-P*j)-W*(B*N-Y*j)+A*(B*P-Y*O)),Q[2]=K*(F*N-H*j)-V*(B*N-Y*j)+A*(B*H-Y*F),Q[3]=-(K*(F*P-H*O)-V*(B*P-Y*O)+W*(B*H-Y*F)),Q[4]=-(Z*(O*N-P*j)-X*(F*N-H*j)+U*(F*P-H*O)),Q[5]=J*(O*N-P*j)-X*(B*N-Y*j)+U*(B*P-Y*O),Q[6]=-(J*(F*N-H*j)-Z*(B*N-Y*j)+U*(B*H-Y*F)),Q[7]=J*(F*P-H*O)-Z*(B*P-Y*O)+X*(B*H-Y*F),Q[8]=Z*(W*N-P*A)-X*(V*N-H*A)+U*(V*P-H*W),Q[9]=-(J*(W*N-P*A)-X*(K*N-Y*A)+U*(K*P-Y*W)),Q[10]=J*(V*N-H*A)-Z*(K*N-Y*A)+U*(K*H-Y*V),Q[11]=-(J*(V*P-H*W)-Z*(K*P-Y*W)+X*(K*H-Y*V)),Q[12]=-(Z*(W*j-O*A)-X*(V*j-F*A)+U*(V*O-F*W)),Q[13]=J*(W*j-O*A)-X*(K*j-B*A)+U*(K*O-B*W),Q[14]=-(J*(V*j-F*A)-Z*(K*j-B*A)+U*(K*F-B*V)),Q[15]=J*(V*O-F*W)-Z*(K*O-B*W)+X*(K*F-B*V),Q}function C$(Q){var $=Q[0],J=Q[1],K=Q[2],B=Q[3],Y=Q[4],Z=Q[5],V=Q[6],F=Q[7],H=Q[8],X=Q[9],W=Q[10],O=Q[11],P=Q[12],U=Q[13],A=Q[14],j=Q[15],N=$*Z-J*Y,G=$*V-K*Y,C=$*F-B*Y,R=J*V-K*Z,D=J*F-B*Z,_=K*F-B*V,h=H*U-X*P,T=H*A-W*P,w=H*j-O*P,v=X*A-W*U,g=X*j-O*U,z=W*j-O*A;return N*z-G*g+C*v+R*w-D*T+_*h}function NQ(Q,$,J){var K=$[0],B=$[1],Y=$[2],Z=$[3],V=$[4],F=$[5],H=$[6],X=$[7],W=$[8],O=$[9],P=$[10],U=$[11],A=$[12],j=$[13],N=$[14],G=$[15],C=J[0],R=J[1],D=J[2],_=J[3];return Q[0]=C*K+R*V+D*W+_*A,Q[1]=C*B+R*F+D*O+_*j,Q[2]=C*Y+R*H+D*P+_*N,Q[3]=C*Z+R*X+D*U+_*G,C=J[4],R=J[5],D=J[6],_=J[7],Q[4]=C*K+R*V+D*W+_*A,Q[5]=C*B+R*F+D*O+_*j,Q[6]=C*Y+R*H+D*P+_*N,Q[7]=C*Z+R*X+D*U+_*G,C=J[8],R=J[9],D=J[10],_=J[11],Q[8]=C*K+R*V+D*W+_*A,Q[9]=C*B+R*F+D*O+_*j,Q[10]=C*Y+R*H+D*P+_*N,Q[11]=C*Z+R*X+D*U+_*G,C=J[12],R=J[13],D=J[14],_=J[15],Q[12]=C*K+R*V+D*W+_*A,Q[13]=C*B+R*F+D*O+_*j,Q[14]=C*Y+R*H+D*P+_*N,Q[15]=C*Z+R*X+D*U+_*G,Q}function k$(Q,$,J){var K=J[0],B=J[1],Y=J[2],Z,V,F,H,X,W,O,P,U,A,j,N;if($===Q)Q[12]=$[0]*K+$[4]*B+$[8]*Y+$[12],Q[13]=$[1]*K+$[5]*B+$[9]*Y+$[13],Q[14]=$[2]*K+$[6]*B+$[10]*Y+$[14],Q[15]=$[3]*K+$[7]*B+$[11]*Y+$[15];else Z=$[0],V=$[1],F=$[2],H=$[3],X=$[4],W=$[5],O=$[6],P=$[7],U=$[8],A=$[9],j=$[10],N=$[11],Q[0]=Z,Q[1]=V,Q[2]=F,Q[3]=H,Q[4]=X,Q[5]=W,Q[6]=O,Q[7]=P,Q[8]=U,Q[9]=A,Q[10]=j,Q[11]=N,Q[12]=Z*K+X*B+U*Y+$[12],Q[13]=V*K+W*B+A*Y+$[13],Q[14]=F*K+O*B+j*Y+$[14],Q[15]=H*K+P*B+N*Y+$[15];return Q}function G$(Q,$,J){var K=J[0],B=J[1],Y=J[2];return Q[0]=$[0]*K,Q[1]=$[1]*K,Q[2]=$[2]*K,Q[3]=$[3]*K,Q[4]=$[4]*B,Q[5]=$[5]*B,Q[6]=$[6]*B,Q[7]=$[7]*B,Q[8]=$[8]*Y,Q[9]=$[9]*Y,Q[10]=$[10]*Y,Q[11]=$[11]*Y,Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15],Q}function q$(Q,$,J,K){var B=K[0],Y=K[1],Z=K[2],V=Math.hypot(B,Y,Z),F,H,X,W,O,P,U,A,j,N,G,C,R,D,_,h,T,w,v,g,z,y,q,x;if(V<k)return null;if(V=1/V,B*=V,Y*=V,Z*=V,F=Math.sin(J),H=Math.cos(J),X=1-H,W=$[0],O=$[1],P=$[2],U=$[3],A=$[4],j=$[5],N=$[6],G=$[7],C=$[8],R=$[9],D=$[10],_=$[11],h=B*B*X+H,T=Y*B*X+Z*F,w=Z*B*X-Y*F,v=B*Y*X-Z*F,g=Y*Y*X+H,z=Z*Y*X+B*F,y=B*Z*X+Y*F,q=Y*Z*X-B*F,x=Z*Z*X+H,Q[0]=W*h+A*T+C*w,Q[1]=O*h+j*T+R*w,Q[2]=P*h+N*T+D*w,Q[3]=U*h+G*T+_*w,Q[4]=W*v+A*g+C*z,Q[5]=O*v+j*g+R*z,Q[6]=P*v+N*g+D*z,Q[7]=U*v+G*g+_*z,Q[8]=W*y+A*q+C*x,Q[9]=O*y+j*q+R*x,Q[10]=P*y+N*q+D*x,Q[11]=U*y+G*q+_*x,$!==Q)Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q}function M$(Q,$,J){var K=Math.sin(J),B=Math.cos(J),Y=$[4],Z=$[5],V=$[6],F=$[7],H=$[8],X=$[9],W=$[10],O=$[11];if($!==Q)Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q[3]=$[3],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q[4]=Y*B+H*K,Q[5]=Z*B+X*K,Q[6]=V*B+W*K,Q[7]=F*B+O*K,Q[8]=H*B-Y*K,Q[9]=X*B-Z*K,Q[10]=W*B-V*K,Q[11]=O*B-F*K,Q}function L$(Q,$,J){var K=Math.sin(J),B=Math.cos(J),Y=$[0],Z=$[1],V=$[2],F=$[3],H=$[8],X=$[9],W=$[10],O=$[11];if($!==Q)Q[4]=$[4],Q[5]=$[5],Q[6]=$[6],Q[7]=$[7],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q[0]=Y*B-H*K,Q[1]=Z*B-X*K,Q[2]=V*B-W*K,Q[3]=F*B-O*K,Q[8]=Y*K+H*B,Q[9]=Z*K+X*B,Q[10]=V*K+W*B,Q[11]=F*K+O*B,Q}function T$(Q,$,J){var K=Math.sin(J),B=Math.cos(J),Y=$[0],Z=$[1],V=$[2],F=$[3],H=$[4],X=$[5],W=$[6],O=$[7];if($!==Q)Q[8]=$[8],Q[9]=$[9],Q[10]=$[10],Q[11]=$[11],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q[0]=Y*B+H*K,Q[1]=Z*B+X*K,Q[2]=V*B+W*K,Q[3]=F*B+O*K,Q[4]=H*B-Y*K,Q[5]=X*B-Z*K,Q[6]=W*B-V*K,Q[7]=O*B-F*K,Q}function S$(Q,$){return Q[0]=1,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=1,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=1,Q[11]=0,Q[12]=$[0],Q[13]=$[1],Q[14]=$[2],Q[15]=1,Q}function h$(Q,$){return Q[0]=$[0],Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=$[1],Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=$[2],Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function I$(Q,$,J){var K=J[0],B=J[1],Y=J[2],Z=Math.hypot(K,B,Y),V,F,H;if(Z<k)return null;return Z=1/Z,K*=Z,B*=Z,Y*=Z,V=Math.sin($),F=Math.cos($),H=1-F,Q[0]=K*K*H+F,Q[1]=B*K*H+Y*V,Q[2]=Y*K*H-B*V,Q[3]=0,Q[4]=K*B*H-Y*V,Q[5]=B*B*H+F,Q[6]=Y*B*H+K*V,Q[7]=0,Q[8]=K*Y*H+B*V,Q[9]=B*Y*H-K*V,Q[10]=Y*Y*H+F,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function w$(Q,$){var J=Math.sin($),K=Math.cos($);return Q[0]=1,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=K,Q[6]=J,Q[7]=0,Q[8]=0,Q[9]=-J,Q[10]=K,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function v$(Q,$){var J=Math.sin($),K=Math.cos($);return Q[0]=K,Q[1]=0,Q[2]=-J,Q[3]=0,Q[4]=0,Q[5]=1,Q[6]=0,Q[7]=0,Q[8]=J,Q[9]=0,Q[10]=K,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function f$(Q,$){var J=Math.sin($),K=Math.cos($);return Q[0]=K,Q[1]=J,Q[2]=0,Q[3]=0,Q[4]=-J,Q[5]=K,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=1,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function DQ(Q,$,J){var K=$[0],B=$[1],Y=$[2],Z=$[3],V=K+K,F=B+B,H=Y+Y,X=K*V,W=K*F,O=K*H,P=B*F,U=B*H,A=Y*H,j=Z*V,N=Z*F,G=Z*H;return Q[0]=1-(P+A),Q[1]=W+G,Q[2]=O-N,Q[3]=0,Q[4]=W-G,Q[5]=1-(X+A),Q[6]=U+j,Q[7]=0,Q[8]=O+N,Q[9]=U-j,Q[10]=1-(X+P),Q[11]=0,Q[12]=J[0],Q[13]=J[1],Q[14]=J[2],Q[15]=1,Q}function g$(Q,$){var J=new S(3),K=-$[0],B=-$[1],Y=-$[2],Z=$[3],V=$[4],F=$[5],H=$[6],X=$[7],W=K*K+B*B+Y*Y+Z*Z;if(W>0)J[0]=(V*Z+X*K+F*Y-H*B)*2/W,J[1]=(F*Z+X*B+H*K-V*Y)*2/W,J[2]=(H*Z+X*Y+V*B-F*K)*2/W;else J[0]=(V*Z+X*K+F*Y-H*B)*2,J[1]=(F*Z+X*B+H*K-V*Y)*2,J[2]=(H*Z+X*Y+V*B-F*K)*2;return DQ(Q,$,J),Q}function z$(Q,$){return Q[0]=$[12],Q[1]=$[13],Q[2]=$[14],Q}function _Q(Q,$){var J=$[0],K=$[1],B=$[2],Y=$[4],Z=$[5],V=$[6],F=$[8],H=$[9],X=$[10];return Q[0]=Math.hypot(J,K,B),Q[1]=Math.hypot(Y,Z,V),Q[2]=Math.hypot(F,H,X),Q}function y$(Q,$){var J=new S(3);_Q(J,$);var K=1/J[0],B=1/J[1],Y=1/J[2],Z=$[0]*K,V=$[1]*B,F=$[2]*Y,H=$[4]*K,X=$[5]*B,W=$[6]*Y,O=$[8]*K,P=$[9]*B,U=$[10]*Y,A=Z+X+U,j=0;if(A>0)j=Math.sqrt(A+1)*2,Q[3]=0.25*j,Q[0]=(W-P)/j,Q[1]=(O-F)/j,Q[2]=(V-H)/j;else if(Z>X&&Z>U)j=Math.sqrt(1+Z-X-U)*2,Q[3]=(W-P)/j,Q[0]=0.25*j,Q[1]=(V+H)/j,Q[2]=(O+F)/j;else if(X>U)j=Math.sqrt(1+X-Z-U)*2,Q[3]=(O-F)/j,Q[0]=(V+H)/j,Q[1]=0.25*j,Q[2]=(W+P)/j;else j=Math.sqrt(1+U-Z-X)*2,Q[3]=(V-H)/j,Q[0]=(O+F)/j,Q[1]=(W+P)/j,Q[2]=0.25*j;return Q}function p$(Q,$,J,K){var B=$[0],Y=$[1],Z=$[2],V=$[3],F=B+B,H=Y+Y,X=Z+Z,W=B*F,O=B*H,P=B*X,U=Y*H,A=Y*X,j=Z*X,N=V*F,G=V*H,C=V*X,R=K[0],D=K[1],_=K[2];return Q[0]=(1-(U+j))*R,Q[1]=(O+C)*R,Q[2]=(P-G)*R,Q[3]=0,Q[4]=(O-C)*D,Q[5]=(1-(W+j))*D,Q[6]=(A+N)*D,Q[7]=0,Q[8]=(P+G)*_,Q[9]=(A-N)*_,Q[10]=(1-(W+U))*_,Q[11]=0,Q[12]=J[0],Q[13]=J[1],Q[14]=J[2],Q[15]=1,Q}function x$(Q,$,J,K,B){var Y=$[0],Z=$[1],V=$[2],F=$[3],H=Y+Y,X=Z+Z,W=V+V,O=Y*H,P=Y*X,U=Y*W,A=Z*X,j=Z*W,N=V*W,G=F*H,C=F*X,R=F*W,D=K[0],_=K[1],h=K[2],T=B[0],w=B[1],v=B[2],g=(1-(A+N))*D,z=(P+R)*D,y=(U-C)*D,q=(P-R)*_,x=(1-(O+N))*_,u=(j+G)*_,o=(U+C)*h,QQ=(j-G)*h,$Q=(1-(O+A))*h;return Q[0]=g,Q[1]=z,Q[2]=y,Q[3]=0,Q[4]=q,Q[5]=x,Q[6]=u,Q[7]=0,Q[8]=o,Q[9]=QQ,Q[10]=$Q,Q[11]=0,Q[12]=J[0]+T-(g*T+q*w+o*v),Q[13]=J[1]+w-(z*T+x*w+QQ*v),Q[14]=J[2]+v-(y*T+u*w+$Q*v),Q[15]=1,Q}function c$(Q,$){var J=$[0],K=$[1],B=$[2],Y=$[3],Z=J+J,V=K+K,F=B+B,H=J*Z,X=K*Z,W=K*V,O=B*Z,P=B*V,U=B*F,A=Y*Z,j=Y*V,N=Y*F;return Q[0]=1-W-U,Q[1]=X+N,Q[2]=O-j,Q[3]=0,Q[4]=X-N,Q[5]=1-H-U,Q[6]=P+A,Q[7]=0,Q[8]=O+j,Q[9]=P-A,Q[10]=1-H-W,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function m$(Q,$,J,K,B,Y,Z){var V=1/(J-$),F=1/(B-K),H=1/(Y-Z);return Q[0]=Y*2*V,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=Y*2*F,Q[6]=0,Q[7]=0,Q[8]=(J+$)*V,Q[9]=(B+K)*F,Q[10]=(Z+Y)*H,Q[11]=-1,Q[12]=0,Q[13]=0,Q[14]=Z*Y*2*H,Q[15]=0,Q}function RQ(Q,$,J,K,B){var Y=1/Math.tan($/2),Z;if(Q[0]=Y/J,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=Y,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[11]=-1,Q[12]=0,Q[13]=0,Q[15]=0,B!=null&&B!==Infinity)Z=1/(K-B),Q[10]=(B+K)*Z,Q[14]=2*B*K*Z;else Q[10]=-1,Q[14]=-2*K;return Q}function l$(Q,$,J,K,B){var Y=1/Math.tan($/2),Z;if(Q[0]=Y/J,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=Y,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[11]=-1,Q[12]=0,Q[13]=0,Q[15]=0,B!=null&&B!==Infinity)Z=1/(K-B),Q[10]=B*Z,Q[14]=B*K*Z;else Q[10]=-1,Q[14]=-K;return Q}function d$(Q,$,J,K){var B=Math.tan($.upDegrees*Math.PI/180),Y=Math.tan($.downDegrees*Math.PI/180),Z=Math.tan($.leftDegrees*Math.PI/180),V=Math.tan($.rightDegrees*Math.PI/180),F=2/(Z+V),H=2/(B+Y);return Q[0]=F,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=H,Q[6]=0,Q[7]=0,Q[8]=-((Z-V)*F*0.5),Q[9]=(B-Y)*H*0.5,Q[10]=K/(J-K),Q[11]=-1,Q[12]=0,Q[13]=0,Q[14]=K*J/(J-K),Q[15]=0,Q}function CQ(Q,$,J,K,B,Y,Z){var V=1/($-J),F=1/(K-B),H=1/(Y-Z);return Q[0]=-2*V,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=-2*F,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=2*H,Q[11]=0,Q[12]=($+J)*V,Q[13]=(B+K)*F,Q[14]=(Z+Y)*H,Q[15]=1,Q}function s$(Q,$,J,K,B,Y,Z){var V=1/($-J),F=1/(K-B),H=1/(Y-Z);return Q[0]=-2*V,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=-2*F,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=H,Q[11]=0,Q[12]=($+J)*V,Q[13]=(B+K)*F,Q[14]=Y*H,Q[15]=1,Q}function b$(Q,$,J,K){var B,Y,Z,V,F,H,X,W,O,P,U=$[0],A=$[1],j=$[2],N=K[0],G=K[1],C=K[2],R=J[0],D=J[1],_=J[2];if(Math.abs(U-R)<k&&Math.abs(A-D)<k&&Math.abs(j-_)<k)return EQ(Q);if(X=U-R,W=A-D,O=j-_,P=1/Math.hypot(X,W,O),X*=P,W*=P,O*=P,B=G*O-C*W,Y=C*X-N*O,Z=N*W-G*X,P=Math.hypot(B,Y,Z),!P)B=0,Y=0,Z=0;else P=1/P,B*=P,Y*=P,Z*=P;if(V=W*Z-O*Y,F=O*B-X*Z,H=X*Y-W*B,P=Math.hypot(V,F,H),!P)V=0,F=0,H=0;else P=1/P,V*=P,F*=P,H*=P;return Q[0]=B,Q[1]=V,Q[2]=X,Q[3]=0,Q[4]=Y,Q[5]=F,Q[6]=W,Q[7]=0,Q[8]=Z,Q[9]=H,Q[10]=O,Q[11]=0,Q[12]=-(B*U+Y*A+Z*j),Q[13]=-(V*U+F*A+H*j),Q[14]=-(X*U+W*A+O*j),Q[15]=1,Q}function r$(Q,$,J,K){var B=$[0],Y=$[1],Z=$[2],V=K[0],F=K[1],H=K[2],X=B-J[0],W=Y-J[1],O=Z-J[2],P=X*X+W*W+O*O;if(P>0)P=1/Math.sqrt(P),X*=P,W*=P,O*=P;var U=F*O-H*W,A=H*X-V*O,j=V*W-F*X;if(P=U*U+A*A+j*j,P>0)P=1/Math.sqrt(P),U*=P,A*=P,j*=P;return Q[0]=U,Q[1]=A,Q[2]=j,Q[3]=0,Q[4]=W*j-O*A,Q[5]=O*U-X*j,Q[6]=X*A-W*U,Q[7]=0,Q[8]=X,Q[9]=W,Q[10]=O,Q[11]=0,Q[12]=B,Q[13]=Y,Q[14]=Z,Q[15]=1,Q}function e$(Q){return"mat4("+Q[0]+", "+Q[1]+", "+Q[2]+", "+Q[3]+", "+Q[4]+", "+Q[5]+", "+Q[6]+", "+Q[7]+", "+Q[8]+", "+Q[9]+", "+Q[10]+", "+Q[11]+", "+Q[12]+", "+Q[13]+", "+Q[14]+", "+Q[15]+")"}function u$(Q){return Math.hypot(Q[0],Q[1],Q[2],Q[3],Q[4],Q[5],Q[6],Q[7],Q[8],Q[9],Q[10],Q[11],Q[12],Q[13],Q[14],Q[15])}function o$(Q,$,J){return Q[0]=$[0]+J[0],Q[1]=$[1]+J[1],Q[2]=$[2]+J[2],Q[3]=$[3]+J[3],Q[4]=$[4]+J[4],Q[5]=$[5]+J[5],Q[6]=$[6]+J[6],Q[7]=$[7]+J[7],Q[8]=$[8]+J[8],Q[9]=$[9]+J[9],Q[10]=$[10]+J[10],Q[11]=$[11]+J[11],Q[12]=$[12]+J[12],Q[13]=$[13]+J[13],Q[14]=$[14]+J[14],Q[15]=$[15]+J[15],Q}function kQ(Q,$,J){return Q[0]=$[0]-J[0],Q[1]=$[1]-J[1],Q[2]=$[2]-J[2],Q[3]=$[3]-J[3],Q[4]=$[4]-J[4],Q[5]=$[5]-J[5],Q[6]=$[6]-J[6],Q[7]=$[7]-J[7],Q[8]=$[8]-J[8],Q[9]=$[9]-J[9],Q[10]=$[10]-J[10],Q[11]=$[11]-J[11],Q[12]=$[12]-J[12],Q[13]=$[13]-J[13],Q[14]=$[14]-J[14],Q[15]=$[15]-J[15],Q}function a$(Q,$,J){return Q[0]=$[0]*J,Q[1]=$[1]*J,Q[2]=$[2]*J,Q[3]=$[3]*J,Q[4]=$[4]*J,Q[5]=$[5]*J,Q[6]=$[6]*J,Q[7]=$[7]*J,Q[8]=$[8]*J,Q[9]=$[9]*J,Q[10]=$[10]*J,Q[11]=$[11]*J,Q[12]=$[12]*J,Q[13]=$[13]*J,Q[14]=$[14]*J,Q[15]=$[15]*J,Q}function t$(Q,$,J,K){return Q[0]=$[0]+J[0]*K,Q[1]=$[1]+J[1]*K,Q[2]=$[2]+J[2]*K,Q[3]=$[3]+J[3]*K,Q[4]=$[4]+J[4]*K,Q[5]=$[5]+J[5]*K,Q[6]=$[6]+J[6]*K,Q[7]=$[7]+J[7]*K,Q[8]=$[8]+J[8]*K,Q[9]=$[9]+J[9]*K,Q[10]=$[10]+J[10]*K,Q[11]=$[11]+J[11]*K,Q[12]=$[12]+J[12]*K,Q[13]=$[13]+J[13]*K,Q[14]=$[14]+J[14]*K,Q[15]=$[15]+J[15]*K,Q}function QJ(Q,$){return Q[0]===$[0]&&Q[1]===$[1]&&Q[2]===$[2]&&Q[3]===$[3]&&Q[4]===$[4]&&Q[5]===$[5]&&Q[6]===$[6]&&Q[7]===$[7]&&Q[8]===$[8]&&Q[9]===$[9]&&Q[10]===$[10]&&Q[11]===$[11]&&Q[12]===$[12]&&Q[13]===$[13]&&Q[14]===$[14]&&Q[15]===$[15]}function $J(Q,$){var J=Q[0],K=Q[1],B=Q[2],Y=Q[3],Z=Q[4],V=Q[5],F=Q[6],H=Q[7],X=Q[8],W=Q[9],O=Q[10],P=Q[11],U=Q[12],A=Q[13],j=Q[14],N=Q[15],G=$[0],C=$[1],R=$[2],D=$[3],_=$[4],h=$[5],T=$[6],w=$[7],v=$[8],g=$[9],z=$[10],y=$[11],q=$[12],x=$[13],u=$[14],o=$[15];return Math.abs(J-G)<=k*Math.max(1,Math.abs(J),Math.abs(G))&&Math.abs(K-C)<=k*Math.max(1,Math.abs(K),Math.abs(C))&&Math.abs(B-R)<=k*Math.max(1,Math.abs(B),Math.abs(R))&&Math.abs(Y-D)<=k*Math.max(1,Math.abs(Y),Math.abs(D))&&Math.abs(Z-_)<=k*Math.max(1,Math.abs(Z),Math.abs(_))&&Math.abs(V-h)<=k*Math.max(1,Math.abs(V),Math.abs(h))&&Math.abs(F-T)<=k*Math.max(1,Math.abs(F),Math.abs(T))&&Math.abs(H-w)<=k*Math.max(1,Math.abs(H),Math.abs(w))&&Math.abs(X-v)<=k*Math.max(1,Math.abs(X),Math.abs(v))&&Math.abs(W-g)<=k*Math.max(1,Math.abs(W),Math.abs(g))&&Math.abs(O-z)<=k*Math.max(1,Math.abs(O),Math.abs(z))&&Math.abs(P-y)<=k*Math.max(1,Math.abs(P),Math.abs(y))&&Math.abs(U-q)<=k*Math.max(1,Math.abs(U),Math.abs(q))&&Math.abs(A-x)<=k*Math.max(1,Math.abs(A),Math.abs(x))&&Math.abs(j-u)<=k*Math.max(1,Math.abs(j),Math.abs(u))&&Math.abs(N-o)<=k*Math.max(1,Math.abs(N),Math.abs(o))}var n$=RQ,i$=CQ,JJ=NQ,KJ=kQ;var d={};D0(d,{str:()=>{{return tJ}},squaredLength:()=>{{return aQ}},sqrLen:()=>{{return FK}},sqlerp:()=>{{return jK}},slerp:()=>{{return U0}},setAxisAngle:()=>{{return dQ}},setAxes:()=>{{return PK}},set:()=>{{return KK}},scale:()=>{{return eQ}},rotationTo:()=>{{return WK}},rotateZ:()=>{{return sJ}},rotateY:()=>{{return iJ}},rotateX:()=>{{return dJ}},random:()=>{{return eJ}},pow:()=>{{return rJ}},normalize:()=>{{return c0}},multiply:()=>{{return iQ}},mul:()=>{{return YK}},ln:()=>{{return bQ}},lerp:()=>{{return ZK}},length:()=>{{return oQ}},len:()=>{{return VK}},invert:()=>{{return uJ}},identity:()=>{{return mJ}},getAxisAngle:()=>{{return nJ}},getAngle:()=>{{return lJ}},fromValues:()=>{{return $K}},fromMat3:()=>{{return rQ}},fromEuler:()=>{{return aJ}},exp:()=>{{return sQ}},exactEquals:()=>{{return HK}},equals:()=>{{return XK}},dot:()=>{{return uQ}},create:()=>{{return x0}},copy:()=>{{return JK}},conjugate:()=>{{return oJ}},clone:()=>{{return QK}},calculateW:()=>{{return bJ}},add:()=>{{return BK}}});var e={};D0(e,{zero:()=>{{return TJ}},transformQuat:()=>{{return kJ}},transformMat4:()=>{{return RJ}},transformMat3:()=>{{return CJ}},subtract:()=>{{return qQ}},sub:()=>{{return wJ}},str:()=>{{return SJ}},squaredLength:()=>{{return hQ}},squaredDistance:()=>{{return SQ}},sqrLen:()=>{{return yJ}},sqrDist:()=>{{return zJ}},set:()=>{{return ZJ}},scaleAndAdd:()=>{{return OJ}},scale:()=>{{return PJ}},round:()=>{{return jJ}},rotateZ:()=>{{return MJ}},rotateY:()=>{{return qJ}},rotateX:()=>{{return GJ}},random:()=>{{return _J}},normalize:()=>{{return y0}},negate:()=>{{return AJ}},multiply:()=>{{return MQ}},mul:()=>{{return vJ}},min:()=>{{return XJ}},max:()=>{{return WJ}},lerp:()=>{{return EJ}},length:()=>{{return GQ}},len:()=>{{return p0}},inverse:()=>{{return UJ}},hermite:()=>{{return NJ}},fromValues:()=>{{return O0}},forEach:()=>{{return pJ}},floor:()=>{{return HJ}},exactEquals:()=>{{return hJ}},equals:()=>{{return IJ}},dot:()=>{{return A0}},divide:()=>{{return LQ}},div:()=>{{return fJ}},distance:()=>{{return TQ}},dist:()=>{{return gJ}},cross:()=>{{return Q0}},create:()=>{{return P0}},copy:()=>{{return YJ}},clone:()=>{{return BJ}},ceil:()=>{{return FJ}},bezier:()=>{{return DJ}},angle:()=>{{return LJ}},add:()=>{{return VJ}}});function P0(){var Q=new S(3);if(S!=Float32Array)Q[0]=0,Q[1]=0,Q[2]=0;return Q}function BJ(Q){var $=new S(3);return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$}function GQ(Q){var $=Q[0],J=Q[1],K=Q[2];return Math.hypot($,J,K)}function O0(Q,$,J){var K=new S(3);return K[0]=Q,K[1]=$,K[2]=J,K}function YJ(Q,$){return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q}function ZJ(Q,$,J,K){return Q[0]=$,Q[1]=J,Q[2]=K,Q}function VJ(Q,$,J){return Q[0]=$[0]+J[0],Q[1]=$[1]+J[1],Q[2]=$[2]+J[2],Q}function qQ(Q,$,J){return Q[0]=$[0]-J[0],Q[1]=$[1]-J[1],Q[2]=$[2]-J[2],Q}function MQ(Q,$,J){return Q[0]=$[0]*J[0],Q[1]=$[1]*J[1],Q[2]=$[2]*J[2],Q}function LQ(Q,$,J){return Q[0]=$[0]/J[0],Q[1]=$[1]/J[1],Q[2]=$[2]/J[2],Q}function FJ(Q,$){return Q[0]=Math.ceil($[0]),Q[1]=Math.ceil($[1]),Q[2]=Math.ceil($[2]),Q}function HJ(Q,$){return Q[0]=Math.floor($[0]),Q[1]=Math.floor($[1]),Q[2]=Math.floor($[2]),Q}function XJ(Q,$,J){return Q[0]=Math.min($[0],J[0]),Q[1]=Math.min($[1],J[1]),Q[2]=Math.min($[2],J[2]),Q}function WJ(Q,$,J){return Q[0]=Math.max($[0],J[0]),Q[1]=Math.max($[1],J[1]),Q[2]=Math.max($[2],J[2]),Q}function jJ(Q,$){return Q[0]=Math.round($[0]),Q[1]=Math.round($[1]),Q[2]=Math.round($[2]),Q}function PJ(Q,$,J){return Q[0]=$[0]*J,Q[1]=$[1]*J,Q[2]=$[2]*J,Q}function OJ(Q,$,J,K){return Q[0]=$[0]+J[0]*K,Q[1]=$[1]+J[1]*K,Q[2]=$[2]+J[2]*K,Q}function TQ(Q,$){var J=$[0]-Q[0],K=$[1]-Q[1],B=$[2]-Q[2];return Math.hypot(J,K,B)}function SQ(Q,$){var J=$[0]-Q[0],K=$[1]-Q[1],B=$[2]-Q[2];return J*J+K*K+B*B}function hQ(Q){var $=Q[0],J=Q[1],K=Q[2];return $*$+J*J+K*K}function AJ(Q,$){return Q[0]=-$[0],Q[1]=-$[1],Q[2]=-$[2],Q}function UJ(Q,$){return Q[0]=1/$[0],Q[1]=1/$[1],Q[2]=1/$[2],Q}function y0(Q,$){var J=$[0],K=$[1],B=$[2],Y=J*J+K*K+B*B;if(Y>0)Y=1/Math.sqrt(Y);return Q[0]=$[0]*Y,Q[1]=$[1]*Y,Q[2]=$[2]*Y,Q}function A0(Q,$){return Q[0]*$[0]+Q[1]*$[1]+Q[2]*$[2]}function Q0(Q,$,J){var K=$[0],B=$[1],Y=$[2],Z=J[0],V=J[1],F=J[2];return Q[0]=B*F-Y*V,Q[1]=Y*Z-K*F,Q[2]=K*V-B*Z,Q}function EJ(Q,$,J,K){var B=$[0],Y=$[1],Z=$[2];return Q[0]=B+K*(J[0]-B),Q[1]=Y+K*(J[1]-Y),Q[2]=Z+K*(J[2]-Z),Q}function NJ(Q,$,J,K,B,Y){var Z=Y*Y,V=Z*(2*Y-3)+1,F=Z*(Y-2)+Y,H=Z*(Y-1),X=Z*(3-2*Y);return Q[0]=$[0]*V+J[0]*F+K[0]*H+B[0]*X,Q[1]=$[1]*V+J[1]*F+K[1]*H+B[1]*X,Q[2]=$[2]*V+J[2]*F+K[2]*H+B[2]*X,Q}function DJ(Q,$,J,K,B,Y){var Z=1-Y,V=Z*Z,F=Y*Y,H=V*Z,X=3*Y*V,W=3*F*Z,O=F*Y;return Q[0]=$[0]*H+J[0]*X+K[0]*W+B[0]*O,Q[1]=$[1]*H+J[1]*X+K[1]*W+B[1]*O,Q[2]=$[2]*H+J[2]*X+K[2]*W+B[2]*O,Q}function _J(Q,$){$=$||1;var J=n()*2*Math.PI,K=n()*2-1,B=Math.sqrt(1-K*K)*$;return Q[0]=Math.cos(J)*B,Q[1]=Math.sin(J)*B,Q[2]=K*$,Q}function RJ(Q,$,J){var K=$[0],B=$[1],Y=$[2],Z=J[3]*K+J[7]*B+J[11]*Y+J[15];return Z=Z||1,Q[0]=(J[0]*K+J[4]*B+J[8]*Y+J[12])/Z,Q[1]=(J[1]*K+J[5]*B+J[9]*Y+J[13])/Z,Q[2]=(J[2]*K+J[6]*B+J[10]*Y+J[14])/Z,Q}function CJ(Q,$,J){var K=$[0],B=$[1],Y=$[2];return Q[0]=K*J[0]+B*J[3]+Y*J[6],Q[1]=K*J[1]+B*J[4]+Y*J[7],Q[2]=K*J[2]+B*J[5]+Y*J[8],Q}function kJ(Q,$,J){var K=J[0],B=J[1],Y=J[2],Z=J[3],V=$[0],F=$[1],H=$[2],X=B*H-Y*F,W=Y*V-K*H,O=K*F-B*V,P=B*O-Y*W,U=Y*X-K*O,A=K*W-B*X,j=Z*2;return X*=j,W*=j,O*=j,P*=2,U*=2,A*=2,Q[0]=V+X+P,Q[1]=F+W+U,Q[2]=H+O+A,Q}function GJ(Q,$,J,K){var B=[],Y=[];return B[0]=$[0]-J[0],B[1]=$[1]-J[1],B[2]=$[2]-J[2],Y[0]=B[0],Y[1]=B[1]*Math.cos(K)-B[2]*Math.sin(K),Y[2]=B[1]*Math.sin(K)+B[2]*Math.cos(K),Q[0]=Y[0]+J[0],Q[1]=Y[1]+J[1],Q[2]=Y[2]+J[2],Q}function qJ(Q,$,J,K){var B=[],Y=[];return B[0]=$[0]-J[0],B[1]=$[1]-J[1],B[2]=$[2]-J[2],Y[0]=B[2]*Math.sin(K)+B[0]*Math.cos(K),Y[1]=B[1],Y[2]=B[2]*Math.cos(K)-B[0]*Math.sin(K),Q[0]=Y[0]+J[0],Q[1]=Y[1]+J[1],Q[2]=Y[2]+J[2],Q}function MJ(Q,$,J,K){var B=[],Y=[];return B[0]=$[0]-J[0],B[1]=$[1]-J[1],B[2]=$[2]-J[2],Y[0]=B[0]*Math.cos(K)-B[1]*Math.sin(K),Y[1]=B[0]*Math.sin(K)+B[1]*Math.cos(K),Y[2]=B[2],Q[0]=Y[0]+J[0],Q[1]=Y[1]+J[1],Q[2]=Y[2]+J[2],Q}function LJ(Q,$){var J=Q[0],K=Q[1],B=Q[2],Y=$[0],Z=$[1],V=$[2],F=Math.sqrt(J*J+K*K+B*B),H=Math.sqrt(Y*Y+Z*Z+V*V),X=F*H,W=X&&A0(Q,$)/X;return Math.acos(Math.min(Math.max(W,-1),1))}function TJ(Q){return Q[0]=0,Q[1]=0,Q[2]=0,Q}function SJ(Q){return"vec3("+Q[0]+", "+Q[1]+", "+Q[2]+")"}function hJ(Q,$){return Q[0]===$[0]&&Q[1]===$[1]&&Q[2]===$[2]}function IJ(Q,$){var J=Q[0],K=Q[1],B=Q[2],Y=$[0],Z=$[1],V=$[2];return Math.abs(J-Y)<=k*Math.max(1,Math.abs(J),Math.abs(Y))&&Math.abs(K-Z)<=k*Math.max(1,Math.abs(K),Math.abs(Z))&&Math.abs(B-V)<=k*Math.max(1,Math.abs(B),Math.abs(V))}var wJ=qQ,vJ=MQ,fJ=LQ,gJ=TQ,zJ=SQ,p0=GQ,yJ=hQ,pJ=function(){var Q=P0();return function($,J,K,B,Y,Z){var V,F;if(!J)J=3;if(!K)K=0;if(B)F=Math.min(B*J+K,$.length);else F=$.length;for(V=K;V<F;V+=J)Q[0]=$[V],Q[1]=$[V+1],Q[2]=$[V+2],Y(Q,Q,Z),$[V]=Q[0],$[V+1]=Q[1],$[V+2]=Q[2];return $}}();function xJ(){var Q=new S(4);if(S!=Float32Array)Q[0]=0,Q[1]=0,Q[2]=0,Q[3]=0;return Q}function IQ(Q){var $=new S(4);return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$[3]=Q[3],$}function wQ(Q,$,J,K){var B=new S(4);return B[0]=Q,B[1]=$,B[2]=J,B[3]=K,B}function vQ(Q,$){return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q[3]=$[3],Q}function fQ(Q,$,J,K,B){return Q[0]=$,Q[1]=J,Q[2]=K,Q[3]=B,Q}function gQ(Q,$,J){return Q[0]=$[0]+J[0],Q[1]=$[1]+J[1],Q[2]=$[2]+J[2],Q[3]=$[3]+J[3],Q}function zQ(Q,$,J){return Q[0]=$[0]*J,Q[1]=$[1]*J,Q[2]=$[2]*J,Q[3]=$[3]*J,Q}function yQ(Q){var $=Q[0],J=Q[1],K=Q[2],B=Q[3];return Math.hypot($,J,K,B)}function pQ(Q){var $=Q[0],J=Q[1],K=Q[2],B=Q[3];return $*$+J*J+K*K+B*B}function xQ(Q,$){var J=$[0],K=$[1],B=$[2],Y=$[3],Z=J*J+K*K+B*B+Y*Y;if(Z>0)Z=1/Math.sqrt(Z);return Q[0]=J*Z,Q[1]=K*Z,Q[2]=B*Z,Q[3]=Y*Z,Q}function cQ(Q,$){return Q[0]*$[0]+Q[1]*$[1]+Q[2]*$[2]+Q[3]*$[3]}function mQ(Q,$,J,K){var B=$[0],Y=$[1],Z=$[2],V=$[3];return Q[0]=B+K*(J[0]-B),Q[1]=Y+K*(J[1]-Y),Q[2]=Z+K*(J[2]-Z),Q[3]=V+K*(J[3]-V),Q}function nQ(Q,$){return Q[0]===$[0]&&Q[1]===$[1]&&Q[2]===$[2]&&Q[3]===$[3]}function lQ(Q,$){var J=Q[0],K=Q[1],B=Q[2],Y=Q[3],Z=$[0],V=$[1],F=$[2],H=$[3];return Math.abs(J-Z)<=k*Math.max(1,Math.abs(J),Math.abs(Z))&&Math.abs(K-V)<=k*Math.max(1,Math.abs(K),Math.abs(V))&&Math.abs(B-F)<=k*Math.max(1,Math.abs(B),Math.abs(F))&&Math.abs(Y-H)<=k*Math.max(1,Math.abs(Y),Math.abs(H))}var U8=function(){var Q=xJ();return function($,J,K,B,Y,Z){var V,F;if(!J)J=4;if(!K)K=0;if(B)F=Math.min(B*J+K,$.length);else F=$.length;for(V=K;V<F;V+=J)Q[0]=$[V],Q[1]=$[V+1],Q[2]=$[V+2],Q[3]=$[V+3],Y(Q,Q,Z),$[V]=Q[0],$[V+1]=Q[1],$[V+2]=Q[2],$[V+3]=Q[3];return $}}();function x0(){var Q=new S(4);if(S!=Float32Array)Q[0]=0,Q[1]=0,Q[2]=0;return Q[3]=1,Q}function mJ(Q){return Q[0]=0,Q[1]=0,Q[2]=0,Q[3]=1,Q}function dQ(Q,$,J){J=J*0.5;var K=Math.sin(J);return Q[0]=K*$[0],Q[1]=K*$[1],Q[2]=K*$[2],Q[3]=Math.cos(J),Q}function nJ(Q,$){var J=Math.acos($[3])*2,K=Math.sin(J/2);if(K>k)Q[0]=$[0]/K,Q[1]=$[1]/K,Q[2]=$[2]/K;else Q[0]=1,Q[1]=0,Q[2]=0;return J}function lJ(Q,$){var J=uQ(Q,$);return Math.acos(2*J*J-1)}function iQ(Q,$,J){var K=$[0],B=$[1],Y=$[2],Z=$[3],V=J[0],F=J[1],H=J[2],X=J[3];return Q[0]=K*X+Z*V+B*H-Y*F,Q[1]=B*X+Z*F+Y*V-K*H,Q[2]=Y*X+Z*H+K*F-B*V,Q[3]=Z*X-K*V-B*F-Y*H,Q}function dJ(Q,$,J){J*=0.5;var K=$[0],B=$[1],Y=$[2],Z=$[3],V=Math.sin(J),F=Math.cos(J);return Q[0]=K*F+Z*V,Q[1]=B*F+Y*V,Q[2]=Y*F-B*V,Q[3]=Z*F-K*V,Q}function iJ(Q,$,J){J*=0.5;var K=$[0],B=$[1],Y=$[2],Z=$[3],V=Math.sin(J),F=Math.cos(J);return Q[0]=K*F-Y*V,Q[1]=B*F+Z*V,Q[2]=Y*F+K*V,Q[3]=Z*F-B*V,Q}function sJ(Q,$,J){J*=0.5;var K=$[0],B=$[1],Y=$[2],Z=$[3],V=Math.sin(J),F=Math.cos(J);return Q[0]=K*F+B*V,Q[1]=B*F-K*V,Q[2]=Y*F+Z*V,Q[3]=Z*F-Y*V,Q}function bJ(Q,$){var J=$[0],K=$[1],B=$[2];return Q[0]=J,Q[1]=K,Q[2]=B,Q[3]=Math.sqrt(Math.abs(1-J*J-K*K-B*B)),Q}function sQ(Q,$){var J=$[0],K=$[1],B=$[2],Y=$[3],Z=Math.sqrt(J*J+K*K+B*B),V=Math.exp(Y),F=Z>0?V*Math.sin(Z)/Z:0;return Q[0]=J*F,Q[1]=K*F,Q[2]=B*F,Q[3]=V*Math.cos(Z),Q}function bQ(Q,$){var J=$[0],K=$[1],B=$[2],Y=$[3],Z=Math.sqrt(J*J+K*K+B*B),V=Z>0?Math.atan2(Z,Y)/Z:0;return Q[0]=J*V,Q[1]=K*V,Q[2]=B*V,Q[3]=0.5*Math.log(J*J+K*K+B*B+Y*Y),Q}function rJ(Q,$,J){return bQ(Q,$),eQ(Q,Q,J),sQ(Q,Q),Q}function U0(Q,$,J,K){var B=$[0],Y=$[1],Z=$[2],V=$[3],F=J[0],H=J[1],X=J[2],W=J[3],O,P,U,A,j;if(P=B*F+Y*H+Z*X+V*W,P<0)P=-P,F=-F,H=-H,X=-X,W=-W;if(1-P>k)O=Math.acos(P),U=Math.sin(O),A=Math.sin((1-K)*O)/U,j=Math.sin(K*O)/U;else A=1-K,j=K;return Q[0]=A*B+j*F,Q[1]=A*Y+j*H,Q[2]=A*Z+j*X,Q[3]=A*V+j*W,Q}function eJ(Q){var $=n(),J=n(),K=n(),B=Math.sqrt(1-$),Y=Math.sqrt($);return Q[0]=B*Math.sin(2*Math.PI*J),Q[1]=B*Math.cos(2*Math.PI*J),Q[2]=Y*Math.sin(2*Math.PI*K),Q[3]=Y*Math.cos(2*Math.PI*K),Q}function uJ(Q,$){var J=$[0],K=$[1],B=$[2],Y=$[3],Z=J*J+K*K+B*B+Y*Y,V=Z?1/Z:0;return Q[0]=-J*V,Q[1]=-K*V,Q[2]=-B*V,Q[3]=Y*V,Q}function oJ(Q,$){return Q[0]=-$[0],Q[1]=-$[1],Q[2]=-$[2],Q[3]=$[3],Q}function rQ(Q,$){var J=$[0]+$[4]+$[8],K;if(J>0)K=Math.sqrt(J+1),Q[3]=0.5*K,K=0.5/K,Q[0]=($[5]-$[7])*K,Q[1]=($[6]-$[2])*K,Q[2]=($[1]-$[3])*K;else{var B=0;if($[4]>$[0])B=1;if($[8]>$[B*3+B])B=2;var Y=(B+1)%3,Z=(B+2)%3;K=Math.sqrt($[B*3+B]-$[Y*3+Y]-$[Z*3+Z]+1),Q[B]=0.5*K,K=0.5/K,Q[3]=($[Y*3+Z]-$[Z*3+Y])*K,Q[Y]=($[Y*3+B]+$[B*3+Y])*K,Q[Z]=($[Z*3+B]+$[B*3+Z])*K}return Q}function aJ(Q,$,J,K){var B=0.5*Math.PI/180;$*=B,J*=B,K*=B;var Y=Math.sin($),Z=Math.cos($),V=Math.sin(J),F=Math.cos(J),H=Math.sin(K),X=Math.cos(K);return Q[0]=Y*F*X-Z*V*H,Q[1]=Z*V*X+Y*F*H,Q[2]=Z*F*H-Y*V*X,Q[3]=Z*F*X+Y*V*H,Q}function tJ(Q){return"quat("+Q[0]+", "+Q[1]+", "+Q[2]+", "+Q[3]+")"}var QK=IQ,$K=wQ,JK=vQ,KK=fQ,BK=gQ,YK=iQ,eQ=zQ,uQ=cQ,ZK=mQ,oQ=yQ,VK=oQ,aQ=pQ,FK=aQ,c0=xQ,HK=nQ,XK=lQ,WK=function(){var Q=P0(),$=O0(1,0,0),J=O0(0,1,0);return function(K,B,Y){var Z=A0(B,Y);if(Z<-0.999999){if(Q0(Q,$,B),p0(Q)<0.000001)Q0(Q,J,B);return y0(Q,Q),dQ(K,Q,Math.PI),K}else if(Z>0.999999)return K[0]=0,K[1]=0,K[2]=0,K[3]=1,K;else return Q0(Q,B,Y),K[0]=Q[0],K[1]=Q[1],K[2]=Q[2],K[3]=1+Z,c0(K,K)}}(),jK=function(){var Q=x0(),$=x0();return function(J,K,B,Y,Z,V){return U0(Q,K,Z,V),U0($,B,Y,V),U0(J,Q,$,2*V*(1-V)),J}}(),PK=function(){var Q=UQ();return function($,J,K,B){return Q[0]=K[0],Q[3]=K[1],Q[6]=K[2],Q[1]=B[0],Q[4]=B[1],Q[7]=B[2],Q[2]=-J[0],Q[5]=-J[1],Q[8]=-J[2],c0($,rQ($,Q))}}();var OK=Math.PI/90;class p{m4=Float32Array.from(M.create());constructor(){this.identity()}static create(){return new p}set(Q){return M.copy(this.m4,Q.getMatrix()),this}identity(){return M.identity(this.m4),this}invert(Q){return M.invert(this.m4,Q?.getMatrix()??this.getMatrix()),this}multiply(Q){return M.multiply(this.m4,this.m4,Q.getMatrix()),this}multiply2(Q,$){return M.multiply(this.m4,Q.getMatrix(),$.getMatrix()),this}multiply3(Q,$,J){return this.multiply2(Q,$),this.multiply(J),this}translate(Q,$,J){return M.translate(this.m4,this.m4,[Q,$,J]),this}translateToMatrix(Q){const $=Q.getMatrix();return this.translate(-$[12],-$[13],-$[14])}rotateX(Q){return M.rotateX(this.m4,this.m4,Q),this}rotateY(Q){return M.rotateY(this.m4,this.m4,Q),this}rotateZ(Q){return M.rotateZ(this.m4,this.m4,Q),this}setXRotation(Q){return M.fromXRotation(this.getMatrix(),Q),this}setYRotation(Q){return M.fromYRotation(this.getMatrix(),Q),this}scale(Q,$,J){return M.scale(this.m4,this.m4,[Q,$??Q,J??Q]),this}perspective(Q,$,J,K){return M.perspective(this.m4,Q*OK,$,J,K),this}ortho(Q,$,J,K,B,Y){return M.ortho(this.m4,Q,$,J,K,B,Y),this}static aTemp=M.create();static bTemp=M.create();combine(Q,$,J=0.5){return M.multiplyScalar(p.aTemp,Q.getMatrix(),1-J),M.multiplyScalar(p.bTemp,$.getMatrix(),J),M.add(this.m4,p.aTemp,p.bTemp),this}static tempQuat=d.create();static tempVec=e.create();moveMatrix(Q,$,J,K){const B=p.tempVec;if(B[0]=Q,B[1]=$,B[2]=J,K)M.getRotation(p.tempQuat,K.getMatrix()),d.invert(p.tempQuat,p.tempQuat),e.transformQuat(B,B,p.tempQuat);return M.translate(this.m4,this.m4,B),this}getRotationAngle(){return M.getRotation(p.tempQuat,this.getMatrix()),d.getAngle(d.create(),p.tempQuat)}getMatrix(){return this.m4}}var L=p;class m0{baseMatrix=L.create();perspectiveMatrix=L.create();orthoMatrix=L.create();perspectiveLevel=1;configPerspectiveMatrix(Q){this.perspectiveMatrix.perspective(45,Q,0.01,1000)}configOrthoMatrix(Q){this.orthoMatrix.ortho(-Q,Q,-1,1,-1000,1000)}configure(Q,$){const J=Q/$;this.configPerspectiveMatrix(J),this.configOrthoMatrix(J)}setPerspective(Q){this.perspectiveLevel=Q,this.baseMatrix.combine(this.orthoMatrix,this.perspectiveMatrix,this.perspectiveLevel)}getMatrix(){return this.baseMatrix.getMatrix()}}function i(Q){return(Q+Math.PI)%(2*Math.PI)-Math.PI}function s(Q,$){return Math.round(Q/$)*$}class n0{Q;matrix=L.create();_tilt=0;constructor(Q){this.onChange=Q}get tilt(){return this._tilt}set tilt(Q){this._tilt=i(Q),this.matrix.setXRotation(this._tilt),this.onChange?.()}getMatrix(){return this.matrix.getMatrix()}}class l0{Q;matrix=L.create();_turn=0;constructor(Q){this.onChange=Q}get turn(){return this._turn}set turn(Q){this._turn=i(Q),this.matrix.setYRotation(this._turn),this.onChange?.()}getMatrix(){return this.matrix.getMatrix()}}class d0{Q;$;J;updatedTypes=new Set;constructor(Q,$,J){this.getCameraMatrix=Q;this.engine=$;this.motor=J}informUpdate(Q){this.motor.registerUpdate(this.withCameraType(Q))}withCameraType(Q){return this.updatedTypes.add(Q),this}refresh(){this.updatedTypes.forEach((Q)=>this.engine.updateCameraMatrix(Q,this.getCameraMatrix(Q)))}}var I;(function(B){B[B["PROJECTION"]=0]="PROJECTION";B[B["POS"]=1]="POS";B[B["TURN"]=2]="TURN";B[B["TILT"]=3]="TILT"})(I||(I={}));class b{positionMatrix=L.create().translate(0,0,0);projectionMatrix=new m0;tiltMatrix=new n0(()=>this.cameraUpdate.informUpdate(I.TILT));turnMatrix=new l0(()=>this.cameraUpdate.informUpdate(I.TURN));camMatrix=L.create();pespectiveLevel=1;cameraUpdate;constructor(Q){this.cameraUpdate=new d0(this.getCameraMatrix.bind(this),Q.engine,Q.motor)}initialize(){this.updatePerspective(),this.cameraUpdate.informUpdate(I.POS),this.cameraUpdate.informUpdate(I.TURN),this.cameraUpdate.informUpdate(I.TILT)}cameraMatrices={[I.PROJECTION]:this.projectionMatrix,[I.POS]:this.camMatrix,[I.TURN]:this.turnMatrix,[I.TILT]:this.tiltMatrix};configProjectionMatrix(Q,$){this.projectionMatrix.configure(Q,$),this.cameraUpdate.informUpdate(I.PROJECTION)}updatePerspective(Q){this.projectionMatrix.setPerspective(Q??this.pespectiveLevel),this.cameraUpdate.informUpdate(I.PROJECTION)}getCameraMatrix(Q){if(Q===I.POS)this.camMatrix.invert(this.positionMatrix);return this.cameraMatrices[Q].getMatrix()}gotoPos(Q,$,J,K=0.1){const B=this.getPosition(),Y=Q-B[0],Z=$-B[1],V=J-B[2],F=Math.sqrt(Y*Y+Z*Z+V*V);if(F){const H=Math.min(F,K);this.positionMatrix.translate(Y/F*H,Z/F*H,V/F*H),this.cameraUpdate.informUpdate(I.POS)}}moveCam(Q,$,J){this.positionMatrix.moveMatrix(Q,$,J,this.turnMatrix),this.cameraUpdate.informUpdate(I.POS)}turnCam(Q){this.turnMatrix.turn+=Q}tilt(Q){this.tiltMatrix.tilt+=Q}static _position=[0,0,0];getPosition(){const Q=this.positionMatrix.getMatrix();return b._position[0]=Q[12],b._position[1]=Q[13],b._position[2]=Q[14],b._position}setPosition(Q,$,J){const K=this.positionMatrix.getMatrix();K[12]=Q,K[13]=$,K[14]=J,this.cameraUpdate.informUpdate(I.POS)}}var NK=function(Q){if(!EK)return Q;return new Proxy(Q,{get(J,K){const B=J,Y=B[K];if(typeof Y==="function")return(...V)=>{const F=Y.apply(B,V);return console.log(`gl.${String(K)}(`,V,") = ",F),F};else return console.log(`gl.${String(K)} = `,Y),Y}})},AK={alpha:!0,antialias:!1,depth:!0,desynchronized:!0,failIfMajorPerformanceCaveat:void 0,powerPreference:"default",premultipliedAlpha:!0,preserveDrawingBuffer:!1,stencil:!1},UK=6,EK=!1;class E0 extends f{gl;programs;attributeBuffers;uniforms;canvas;textureManager;imageManager;textureSlots={};onResize=new Set;pixelListeners=new Set;spriteCount=0;cameraMatrixUniforms={};constructor(Q,{attributes:$}={}){super();const J=Q.getContext("webgl2",{...AK,...$});this.gl=NK(J),this.canvas=Q,this.programs=this.own(new L0(this.gl)),this.uniforms=this.own(new h0(this.gl,this.programs)),this.attributeBuffers=this.own(new S0(this.gl,this.programs)),this.textureManager=new f0(this.gl,this.uniforms),this.imageManager=new g0;const K=this.checkCanvasSize.bind(this);window.addEventListener("resize",K),this.addOnDestroy(()=>window.removeEventListener("resize",K)),this.initialize()}addResizeListener(Q){Q(this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.onResize.add(Q)}removeResizeListener(Q){this.onResize.delete(Q)}clearTextureSlots(){for(let Q in this.textureSlots)delete this.textureSlots[Q]}checkCanvasSize(){if(this.canvas instanceof HTMLCanvasElement)this.canvas.width=this.canvas.offsetWidth*2,this.canvas.height=this.canvas.offsetHeight*2;this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.onResize.forEach((Q)=>Q(this.gl.drawingBufferWidth,this.gl.drawingBufferHeight))}initialize(){const $={AUTHOR:"Jack le hamster"};this.programs.addProgram("main",z0(OQ,$),z0(AQ,$)),this.programs.useProgram("main"),this.cameraMatrixUniforms[I.PROJECTION]=this.uniforms.getUniformLocation(HQ,"main"),this.cameraMatrixUniforms[I.POS]=this.uniforms.getUniformLocation(ZQ,"main"),this.cameraMatrixUniforms[I.TURN]=this.uniforms.getUniformLocation(FQ,"main"),this.cameraMatrixUniforms[I.TILT]=this.uniforms.getUniformLocation(VQ,"main"),this.gl.enable(E.DEPTH_TEST),this.gl.depthFunc(E.LESS),this.gl.clearDepth(1),this.gl.enable(E.BLEND),this.gl.blendFunc(E.SRC_ALPHA,E.ONE_MINUS_SRC_ALPHA),this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.gl.disable(this.gl.CULL_FACE),this.textureManager.initialize(),this.checkCanvasSize()}onCleanupBuffers=new Set;initializeBuffers(Q){if(this.onCleanupBuffers.forEach(($)=>$()),this.onCleanupBuffers.clear(),Q)[this.initializeIndexBuffer(BQ),this.initializePositionBuffer(KQ),this.initializeTransformBuffer(G0,Q),this.initializeSlotSizeBuffer(q0,Q),this.initializeInstanceBuffer(YQ,Q)].forEach((J)=>this.onCleanupBuffers.add(J))}initializeIndexBuffer(Q){const $=this.attributeBuffers.createBuffer(Q);return this.gl.bindBuffer(E.ELEMENT_ARRAY_BUFFER,$.buffer),this.gl.bufferData(E.ELEMENT_ARRAY_BUFFER,Uint16Array.from([0,1,2,2,3,0]),E.STATIC_DRAW),()=>{this.attributeBuffers.deleteBuffer(Q)}}initializePositionBuffer(Q){const $=this.attributeBuffers.createBuffer(Q);return this.gl.bindBuffer(E.ARRAY_BUFFER,$.buffer),this.gl.vertexAttribPointer($.location,2,E.FLOAT,!1,0,0),this.gl.enableVertexAttribArray($.location),this.gl.bufferData(E.ARRAY_BUFFER,Float32Array.from([-1,-1,1,-1,1,1,-1,1]),E.STATIC_DRAW),()=>{this.gl.disableVertexAttribArray($.location),this.attributeBuffers.deleteBuffer(Q)}}initializeTransformBuffer(Q,$){const J=this.attributeBuffers.createBuffer(Q);this.gl.bindBuffer(E.ARRAY_BUFFER,J.buffer);const K=4;for(let B=0;B<4;B++){const Y=J.location+B;this.gl.vertexAttribPointer(Y,K,E.FLOAT,!1,K*4*Float32Array.BYTES_PER_ELEMENT,B*4*Float32Array.BYTES_PER_ELEMENT),this.gl.enableVertexAttribArray(Y),this.gl.vertexAttribDivisor(Y,1)}return this.gl.bufferData(E.ARRAY_BUFFER,$*K*4*Float32Array.BYTES_PER_ELEMENT,E.DYNAMIC_DRAW),()=>{this.gl.disableVertexAttribArray(J.location),this.attributeBuffers.deleteBuffer(Q)}}initializeSlotSizeBuffer(Q,$){const J=this.attributeBuffers.createBuffer(Q);this.gl.bindBuffer(E.ARRAY_BUFFER,J.buffer);const K=J.location,B=2;return this.gl.vertexAttribPointer(K,B,E.FLOAT,!1,B*Float32Array.BYTES_PER_ELEMENT,0),this.gl.enableVertexAttribArray(K),this.gl.vertexAttribDivisor(K,1),this.gl.bufferData(E.ARRAY_BUFFER,$*B*Float32Array.BYTES_PER_ELEMENT,E.DYNAMIC_DRAW),()=>{this.gl.disableVertexAttribArray(J.location),this.attributeBuffers.deleteBuffer(Q)}}initializeInstanceBuffer(Q,$){const J=this.attributeBuffers.createBuffer(Q);this.gl.bindBuffer(E.ARRAY_BUFFER,J.buffer);const K=J.location,B=1;return this.gl.vertexAttribPointer(K,B,E.FLOAT,!1,B*Float32Array.BYTES_PER_ELEMENT,0),this.gl.enableVertexAttribArray(K),this.gl.vertexAttribDivisor(K,1),this.gl.bufferData(E.ARRAY_BUFFER,Float32Array.from(new Array($).fill(null).map((Y,Z)=>Z)),E.STATIC_DRAW),()=>{this.gl.disableVertexAttribArray(J.location),this.attributeBuffers.deleteBuffer(Q)}}async updateTextures(Q,$){const J=(await Promise.all(Q.map(async(Y)=>{const Z=$(Y);if(!Z){console.warn(`No media for imageId ${Y}`);return}return{mediaData:await this.imageManager.renderMedia(Y,Z),imageId:Y}}))).filter((Y)=>!!Y),K=await Promise.all(J.map(async({mediaData:Y,imageId:Z})=>{const{slot:V,refreshCallback:F}=this.textureManager.allocateSlotForImage(Y),H=Math.log2(V.size[0]),X=Math.log2(V.size[1]),W=H*16+X;return this.textureSlots[Z]={buffer:Float32Array.from([W,V.slotNumber])},Y.refreshCallback=F,V.textureIndex}));return new Set(K).forEach((Y)=>{if(Y===j0)this.textureManager.setupTextureForVideo(`TEXTURE${Y}`);else this.textureManager.generateMipMap(`TEXTURE${Y}`)}),J.map(({mediaData:Y})=>Y)}drawElementsInstanced(Q,$){this.gl.drawElementsInstanced(E.TRIANGLES,Q,E.UNSIGNED_SHORT,0,$)}static spriteMatrix=L.create();updateSpriteTransforms(Q,$){const J=this.attributeBuffers.getAttributeBuffer(G0);this.gl.bindBuffer(E.ARRAY_BUFFER,J.buffer);let K=this.spriteCount-1;Q.forEach((B)=>{const Y=E0.spriteMatrix.identity().getMatrix(),Z=$(B);if(Z?.transforms.forEach((V)=>M.multiply(Y,Y,V)),this.gl.bufferSubData(E.ARRAY_BUFFER,16*Float32Array.BYTES_PER_ELEMENT*B,Y),Z)K=Math.max(K,B)}),Q.clear();while(K>=0&&!$(K))K--;this.spriteCount=Math.max(this.spriteCount,K+1)}updateSpriteAnims(Q,$){const J=this.attributeBuffers.getAttributeBuffer(q0);this.gl.bindBuffer(E.ARRAY_BUFFER,J.buffer),Q.forEach((K)=>{const B=$(K),Y=this.textureSlots[B?.imageId??-1];if(Y){const{buffer:Z}=Y;this.gl.bufferSubData(E.ARRAY_BUFFER,2*Float32Array.BYTES_PER_ELEMENT*K,Z),Q.delete(K)}})}updateCameraMatrix(Q,$){this.gl.uniformMatrix4fv(this.cameraMatrixUniforms[Q],!1,$)}bindVertexArray(){return this.own(new T0(this.gl))}addPixelListener(Q){return this.pixelListeners.add(Q),()=>{this.removePixelListener(Q)}}removePixelListener(Q){this.pixelListeners.delete(Q)}_pixel=new Uint8Array(4);getPixel(Q,$){this.gl.readPixels(Q,$,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this._pixel);const[J,K,B,Y]=this._pixel;return J*65536+K*256+B}refresh(){this.drawElementsInstanced(UK,this.spriteCount);for(let Q of this.pixelListeners)Q.pixel=this.getPixel(Q.x,Q.y)}}var DK=50,$0;(function(J){J[J["DEFAULT"]=0]="DEFAULT";J[J["LAST"]=1]="LAST"})($0||($0={}));class i0{updateSchedule=new Map;time=0;loop(Q,$,J,K){return this.registerUpdate(Q,{period:$?1000/$:1,expirationTime:K,priority:J})}registerUpdate(Q,$={}){return $.triggerTime=$.triggerTime??this.time,$.expirationTime=$.expirationTime??Infinity,$.period=$.period,$.priority=$.priority??$0.DEFAULT,this.updateSchedule.set(Q,$),()=>this.deregisterUpdate(Q)}deregisterUpdate(Q){this.updateSchedule.delete(Q)}start(){let Q=0;const $={time:0,deltaTime:0},J=[],K=[],B=[J,K],Y=(Z)=>{$.deltaTime=Math.min(Z-$.time,DK),$.time=Z,Q=requestAnimationFrame(Y),this.time=Z,J.length=0,K.length=0,this.updateSchedule.forEach((V,F)=>{if(Z<V.triggerTime)return;if(B[V.priority].push(F),V.period&&Z<V.expirationTime)V.triggerTime=Math.max(V.triggerTime+V.period,Z);else this.updateSchedule.delete(F)}),B.forEach((V)=>V.forEach((F)=>F.refresh($)))};return requestAnimationFrame(Y),()=>cancelAnimationFrame(Q)}}var _K=200;class s0{keys={};keysUp={};keyListener=new Set;activate(Q){const{core:$}=Q,J=(B)=>{if(!this.keys[B.code])this.keys[B.code]=$.motor.time,this.keyListener.forEach((Y)=>Y.onKeyDown?.(B.code))},K=(B)=>{if($.motor.time-this.keys[B.code]<_K)this.keysUp[B.code]=this.keysUp[B.code]?0:$.motor.time;else this.keysUp[B.code]=0;this.keys[B.code]=0,this.keyListener.forEach((Y)=>Y.onKeyUp?.(B.code))};return document.addEventListener("keydown",J),document.addEventListener("keyup",K),()=>{document.removeEventListener("keydown",J),document.removeEventListener("keyup",K)}}addListener(Q){return this.keyListener.add(Q),()=>{this.removeListener(Q)}}removeListener(Q){this.keyListener.delete(Q)}}class b0{Q;$;updatedSpriteIds=new Set;constructor(Q,$){this.getSprite=Q;this.engine=$}withSpriteId(Q){return this.updatedSpriteIds.add(Q),this}refresh(){this.engine.updateSpriteTransforms(this.updatedSpriteIds,this.getSprite)}}class r0{Q;$;J;updatedSpriteIds=new Set;constructor(Q,$,J){this.motor=Q;this.getSprite=$;this.engine=J}withSpriteId(Q){return this.updatedSpriteIds.add(Q),this}refresh(){if(this.engine.updateSpriteAnims(this.updatedSpriteIds,this.getSprite),this.updatedSpriteIds.size)this.motor.registerUpdate(this)}}class e0{onUpdates;constructor(Q,$,J){const K=new b0(J.sprites.at.bind(J.sprites),$),B=new r0(Q,J.sprites.at.bind(J.sprites),$);this.onUpdates={["SpriteAnim"]:(Y)=>Q.registerUpdate(B.withSpriteId(Y)),["SpriteTransform"]:(Y)=>Q.registerUpdate(K.withSpriteId(Y))}}informUpdate(Q,$){this.onUpdates[Q]($)}}class u0 extends f{motor;engine;keyboard;camera;constructor({motor:Q,canvas:$,engine:J,keyboard:K,size:B,camera:Y}){super();this.motor=Q??new i0,this.engine=J??new E0($??new OffscreenCanvas(B[0],B[1])),this.keyboard=K??new s0,this.camera=Y??new b(this),this.initialize()}initialize(){const{engine:Q,motor:$}=this,J=$.loop(Q,void 0,$0.LAST);this.addOnDestroy(()=>{J()})}start(Q){const{engine:$,motor:J}=this;$.initializeBuffers(Q.sprites.length),$.clearTextureSlots();const K=this.activate(Q,[Q,this.keyboard]),B=J.start();return()=>{B(),K()}}activate(Q,$){const{engine:J,motor:K}=this,B=new e0(K,J,Q),Y=new Set;Y.add(this.handleResize()),this.camera.initialize();const Z={updateCallback(V,F){B.informUpdate(V,F)},core:this};return $.forEach((V)=>{const F=V.activate(Z);Y.add(F)}),()=>{Y.forEach((V)=>V())}}handleResize(){const{engine:Q}=this,$=(J,K)=>{this.camera.configProjectionMatrix(J,K)};return Q.addResizeListener($),()=>{Q.removeResizeListener($)}}}class o0{keyboard;camera;goal;stepCount=0;turnCount=0;tiltCount=0;config;constructor(Q,$={}){this.keyboard=Q.keyboard,this.camera=Q.camera;const J=this.camera.getPosition();this.goal={turn:this.camera.turnMatrix.turn,tilt:this.camera.tiltMatrix.tilt,pos:[...J]},this.config={step:$.step??2,turnStep:$.turnStep??Math.PI/2,tiltStep:$.tiltStep??Math.PI/2}}prePos=[0,0,0];refresh(Q){const{keys:$}=this.keyboard,{deltaTime:J}=Q,K=this.camera.getPosition(),{step:B,turnStep:Y,tiltStep:Z}=this.config;this.prePos[0]=Math.round(K[0]/B)*B,this.prePos[1]=Math.round(K[1]/B)*B,this.prePos[2]=Math.round(K[2]/B)*B;let V=0,F=0;if($.KeyW||$.ArrowUp&&!$.ShiftRight)F--;if($.KeyS||$.ArrowDown&&!$.ShiftRight)F++;if($.KeyA||$.ArrowLeft&&!$.ShiftRight)V--;if($.KeyD||$.ArrowRight&&!$.ShiftRight)V++;if(V||F||this.stepCount>0){const D=V*Math.cos(this.goal.turn)-F*Math.sin(this.goal.turn),_=V*Math.sin(this.goal.turn)+F*Math.cos(this.goal.turn),h=Math.round(K[0]/B+D)*B,T=Math.round(K[2]/B+_)*B;this.goal.pos[0]=h,this.goal.pos[2]=T}if(!V&&!F)this.stepCount=0;const H=V||F?J/150:J/100;this.camera.gotoPos(this.goal.pos[0],K[1],this.goal.pos[2],H);const X=this.camera.getPosition();if(Math.round(X[0]/B)*B!==this.prePos[0]||Math.round(X[1]/B)*B!==this.prePos[1]||Math.round(X[2]/B)*B!==this.prePos[2])this.stepCount++;let W=0;if($.KeyQ||$.ArrowLeft&&$.ShiftRight)W--;if($.KeyE||$.ArrowRight&&$.ShiftRight)W++;const O=this.camera.turnMatrix.turn,P=s(O,Y);if(W||this.turnCount>0)this.goal.turn=s(O+Y*W,Y);if(!W)this.turnCount=0;const U=W?J/200:J/100;let A=i(this.goal.turn-O);if(A){const D=Math.abs(A);if(this.camera.turnMatrix.turn=D<0.01?this.goal.turn:O+Math.sign(A)*Math.min(U,D),s(this.camera.turnMatrix.turn,Y)!==P)this.turnCount++}let j=0;if($.ArrowUp&&$.ShiftRight)j--;if($.ArrowDown&&$.ShiftRight)j++;const N=this.camera.tiltMatrix.tilt,G=s(N,Z);if(j||this.tiltCount>0)this.goal.tilt=s(N+Z*j,Z);if(!j)this.tiltCount=0;const C=j?J/400:J/200;let R=i(this.goal.tilt-N);if(R){const D=Math.abs(R);if(this.camera.tiltMatrix.tilt=D<0.01?this.goal.tilt:N+Math.sign(R)*Math.min(C,D),s(this.camera.tiltMatrix.tilt,C)!==G)this.tiltCount++}}}class a0{keyboard;camera;constructor(Q){this.keyboard=Q.keyboard,this.camera=Q.camera}refresh(Q){const{deltaTime:$}=Q;this.spaceForRiseAndDrop($,this.keyboard)}spaceForRiseAndDrop(Q,$){const J=Q/80,{keys:K,keysUp:B}=$;if(K.Space)this.camera.moveCam(0,J,0);else if(B.Space){this.camera.moveCam(0,-J,0);const[Y,Z,V]=this.camera.getPosition();if(Z<0)this.camera.setPosition(Y,0,V),B.Space=0}}}var tQ=0,Q$=1,$$=2,J$=3,K$=4,N0=5,l=512;class t0 extends J0{sprites;hudSpriteId=0;constructor(Q){super(Q,[new o0(Q,{step:1,turnStep:Math.PI/4,tiltStep:Math.PI/8}),new a0(Q)]);this.addMedia({id:tQ,type:"image",src:"dobuki.png"},{id:Q$,type:"draw",draw:($)=>{const{canvas:J}=$;J.width=l,J.height=l;const K=J.width/2,B=J.height/2,Y=J.width/2;$.imageSmoothingEnabled=!0,$.fillStyle="#ddd",$.lineWidth=J.width/50,$.fillRect(0,0,J.width,J.height),$.strokeStyle="black",$.fillStyle="gold",$.beginPath(),$.arc(K,B,Y*0.8,0,2*Math.PI),$.fill(),$.stroke(),$.beginPath(),$.arc(K,B,Y*0.5,0,Math.PI),$.stroke(),$.beginPath(),$.arc(J.width/3,J.height/3,Y*0.1,0,Math.PI,!0),$.stroke(),$.beginPath(),$.arc(J.width/3*2,J.height/3,Y*0.1,0,Math.PI*2,!0),$.stroke()}},{id:$$,type:"draw",draw:($)=>{const{canvas:J}=$;J.width=l,J.height=l,$.imageSmoothingEnabled=!0,$.fillStyle="#ddd",$.lineWidth=J.width/50,$.fillRect(0,0,J.width,J.height),$.strokeStyle="black",$.fillStyle="silver",$.beginPath(),$.rect(J.width*0.2,J.height*0.2,J.width*0.6,J.height*0.6),$.fill(),$.stroke()}},{id:J$,type:"video",src:"sample.mp4",volume:0,fps:30},{id:K$,type:"draw",draw:($)=>{const{canvas:J}=$;J.width=l,J.height=l,$.imageSmoothingEnabled=!0,$.lineWidth=5,$.strokeStyle="green",$.beginPath(),$.rect(10,10,J.width-20,J.height-20),$.stroke()}},{id:N0,type:"draw",draw:($)=>{const{canvas:J}=$;J.width=l,J.height=l,$.imageSmoothingEnabled=!0,$.lineWidth=5,$.setLineDash([5,2]),$.strokeStyle="blue",$.beginPath(),$.rect(10,10,J.width-20,J.height-20),$.stroke()}}),this.sprites=[{imageId:tQ,transforms:[L.create().translate(0,0,-1).getMatrix()]},...[L.create().translate(-1,0,0).rotateY(Math.PI/2).scale(1).getMatrix(),L.create().translate(1,0,0).rotateY(-Math.PI/2).scale(1).getMatrix()].map(($)=>({imageId:Q$,transforms:[$]})),...[L.create().translate(0,-1,0).rotateX(-Math.PI/2).scale(1).getMatrix(),L.create().translate(0,-1,2).rotateX(-Math.PI/2).scale(1).getMatrix(),L.create().translate(-2,-1,2).rotateX(-Math.PI/2).scale(1).getMatrix(),L.create().translate(2,-1,2).rotateX(-Math.PI/2).scale(1).getMatrix()].map(($)=>({imageId:$$,transforms:[$]})),{imageId:J$,transforms:[L.create().translate(0,5,-10).scale(9.6,5.4,1).getMatrix()]},...new Array(400).fill(0).map(($,J)=>L.create().translate((J%20-10)*2,-1.5,(Math.floor(J/20)-10)*2).rotateX(-Math.PI/2).scale(1).getMatrix()).map(($)=>({imageId:K$,transforms:[$]})),...new Array(400).fill(0).map(($,J)=>L.create().translate((J%20-10)*2,-1,(Math.floor(J/20)-10)*2).rotateX(-Math.PI/2).scale(1).getMatrix()).map(($)=>({imageId:N0,transforms:[$]})),...new Array(400).fill(0).map(($,J)=>L.create().translate((J%20-10)*2,1,(Math.floor(J/20)-10)*2).rotateX(-Math.PI/2).scale(1).getMatrix()).map(($)=>({imageId:N0,transforms:[$]})),...new Array(400).fill(0).map(($,J)=>L.create().translate((J%20-10)*2,0,(Math.floor(J/20)-10)*2-1).getMatrix()).map(($)=>({imageId:N0,transforms:[$]}))]}}async function LB(){console.log("Hello World!")}async function TB(Q){Q.style.border="2px solid silver",Q.addEventListener("mouseenter",()=>{Q.style.borderColor="black"}),Q.addEventListener("mouseleave",()=>{Q.style.borderColor="silver"});const $={x:0,y:0,pixel:0};Q.addEventListener("mousemove",(B)=>{const Y=(B.pageX-Q.offsetLeft)*2,Z=(Q.offsetHeight-(B.pageY-Q.offsetTop))*2;$.x=Y,$.y=Z});const J=new u0({canvas:Q});J.engine.addPixelListener($);const K=new t0(J);return B$=J.start(K),{core:J,world:K}}function SB(){B$()}var B$;export{TB as testCanvas,SB as stop,LB as hello,J0 as World};

//# debugId=F6AE610B9CAB755664756e2164756e21
