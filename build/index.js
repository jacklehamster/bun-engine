var E$=Object.defineProperty;var G0=(Q,$)=>{for(var J in $)E$(Q,J,{get:$[J],enumerable:!0,configurable:!0,set:(B)=>$[J]=()=>B})};class C0{Q;$;J;constructor(Q,$,J){this.array=Q;this.updateValue=$;this.notifier=J}at(Q){return this.array.at(Q)}get length(){return this.array.length}set(Q,$){this.updateValue(Q,$),this.notifier?.informUpdate(Q)}remove(Q){this.updateValue(Q,void 0),this.notifier?.informUpdate(Q)}}class M0{Q;$;J;updatedImageIds=new Set;constructor(Q,$,J){this.motor=Q;this.getMedia=$;this.engine=J}withImageId(Q){return this.updatedImageIds.add(Q),this}informUpdate(Q){this.motor.registerUpdate(this.withImageId(Q))}refresh(){const Q=Array.from(this.updatedImageIds);this.updatedImageIds.clear(),this.engine.updateTextures(Q,this.getMedia).then(($)=>{$.forEach((J)=>{if(J.isVideo)this.motor.registerUpdate(J,J.schedule)})})}}class k0 extends C0{constructor({motor:Q,engine:$},J=[]){super(J,(B,Y)=>{J[B]=Y;while(!J[J.length-1])J.length--},new M0(Q,J.at.bind(J),$))}}class v{disposables;own(Q){if(!this.disposables)this.disposables=new Set;return this.disposables.add(Q),Q}addOnDestroy(Q){if(Q)this.disposables?.add({destroy:Q})}destroy(){this.disposables?.forEach((Q)=>Q.destroy())}}class t extends v{auxiliaries=[];refreshes=[];active=!1;constructor(){super()}activate(){if(this.active)return()=>{};const Q=new Set;for(let $ of this.auxiliaries){const J=$.activate?.();if(J)Q.add(J)}return()=>{Q.forEach(($)=>$())}}deactivate(){if(!this.active)return;for(let Q of this.auxiliaries)Q.deactivate?.()}refresh(Q){for(let $ of this.refreshes)$.refresh(Q)}addAuxiliary(...Q){this.auxiliaries.push(...Q),this.refreshes.push(...Q.filter((B)=>!!B.refresh));const $=new Set;if(this.active)for(let B of this.auxiliaries){const Y=B.activate?.();if(Y)$.add(Y)}const J=this.onAddAuxiliary?.(...Q);if(J)$.add(J);return()=>$.forEach((B)=>B())}removeAllAuxiliaries(){this.removeAuxiliary(...this.auxiliaries)}removeAuxiliary(...Q){const $=new Set(Q);let J=0;for(let B=0;B<this.auxiliaries.length;B++)if(!$.has(this.auxiliaries[B]))this.auxiliaries[J]=this.auxiliaries[B],J++;this.auxiliaries.length=J,this.refreshes=this.auxiliaries.filter((B)=>!!B.refresh)}}class L0{Q;$;J;updatedSpriteIds=new Set;constructor(Q,$,J){this.getSprite=Q;this.engine=$;this.motor=J}informUpdate(Q){this.motor.registerUpdate(this.withSpriteId(Q))}withSpriteId(Q){return this.updatedSpriteIds.add(Q),this}refresh(){if(this.engine.updateSpriteAnims(this.updatedSpriteIds,this.getSprite),this.updatedSpriteIds.size)this.motor.registerUpdate(this)}}class T0{Q;$;J;updatedSpriteIds=new Set;constructor(Q,$,J){this.getSprite=Q;this.engine=$;this.motor=J}informUpdate(Q){this.motor.registerUpdate(this.withSpriteId(Q))}withSpriteId(Q){return this.updatedSpriteIds.add(Q),this}refresh(){this.engine.updateSpriteTransforms(this.updatedSpriteIds,this.getSprite)}}var Q0;(function(Y){Y[Y["NONE"]=0]="NONE";Y[Y["TRANSFORM"]=1]="TRANSFORM";Y[Y["ANIM"]=2]="ANIM";Y[Y["ALL"]=3]="ALL"})(Q0||(Q0={}));class h0{spritesList=[];spritesIndices=[];spriteTransformUpdate;spriteAnimUpdate;constructor({engine:Q,motor:$}){this.spriteTransformUpdate=new T0(this.at.bind(this),Q,$),this.spriteAnimUpdate=new L0(this.at.bind(this),Q,$)}informUpdate(Q,$=Q0.ALL){if($&Q0.TRANSFORM)this.spriteTransformUpdate.informUpdate(Q);if($&Q0.ANIM)this.spriteAnimUpdate.informUpdate(Q)}at(Q){const $=this.spritesIndices[Q];return $?.sprites.at(Q-($?.baseIndex??0))}get length(){return this.spritesIndices.length}add(Q){if(this.spritesList.indexOf(Q)>=0)return;this.spritesList.push(Q);const $=this.spritesIndices.length;for(let J=0;J<Q.length;J++)this.informUpdate($+J),this.spritesIndices.push({sprites:Q,baseIndex:$})}}class Z0 extends t{medias;spritesAccumulator;constructor(Q){super();this.medias=new k0(Q),this.spritesAccumulator=new h0(Q)}get sprites(){return this.spritesAccumulator}addMedia(...Q){Q.forEach(($)=>{this.medias.set($.id,$)})}addSprites(...Q){Q.forEach(($)=>{this.spritesAccumulator.add($.length?$:[$])})}}var A=globalThis.WebGL2RenderingContext??{},UQ="position",NQ="index",S0="transform",w0="slotSize_and_number",I0="instance";var AQ="camPos",EQ="camTilt",_Q="camTurn",DQ="projection",RQ="curvature",qQ="maxTextureSize",GQ="uTextures";var _$=function(Q,$,J){function B(F,W){function O(N){return N===Q?.VERTEX_SHADER?"vertex":N===Q?.FRAGMENT_SHADER?"fragment":void 0}if(W!==Q.VERTEX_SHADER&&W!==Q.FRAGMENT_SHADER)throw new Error(`Shader error in ${O(W)}`);const P=Q.createShader(W);if(!P)throw new Error(`Unable to generate ${O(W)} shader.`);if(Q.shaderSource(P,F),Q.compileShader(P),!Q.getShaderParameter(P,Q.COMPILE_STATUS))console.error(`Shader compile error in ${O(W)}:`+Q.getShaderInfoLog(P));return P}const Y=Q.createProgram();if(!Y)throw new Error("Unable to create program.");const K=B($,Q.VERTEX_SHADER),Z=B(J,Q.FRAGMENT_SHADER),V=Q.getShaderInfoLog(K),H=Q.getShaderInfoLog(Z);if(V)console.log("VERTEX",V);if(H)console.log("FRAGMENT",H);Q.attachShader(Y,K),Q.attachShader(Y,Z),Q.linkProgram(Y);const X=Q.getProgramInfoLog(Y);if(X)console.log("PROGRAM",X);if(Q.detachShader(Y,K),Q.detachShader(Y,Z),Q.deleteShader(K),Q.deleteShader(Z),Q.validateProgram(Y),Object.entries(A).forEach(([F,W])=>{if(W&&Q.getError()===W)console.log(`gl.${F}`)}),!Q.getProgramParameter(Y,Q.LINK_STATUS))throw new Error("Unable to initialize the shader program:\n"+Q.getProgramInfoLog(Y));return Y},D$=function(Q,$){Q.deleteProgram($)};class v0 extends v{gl;program;constructor(Q,$,J){super();this.gl=Q,this.program=_$(Q,$.trim(),J.trim())}use(){this.gl.useProgram(this.program)}destroy(){super.destroy(),D$(this.gl,this.program)}}class z0 extends v{activeProgramId="";gl;programs={};constructor(Q){super();this.gl=Q}addProgram(Q,$,J){if(this.programs[Q])this.removeProgram(Q);this.programs[Q]=this.own(new v0(this.gl,$,J))}useProgram(Q){if(this.activeProgramId!==Q)this.activeProgramId=Q,this.programs[Q].use()}removeProgram(Q){this.programs[Q].destroy(),delete this.programs[Q]}getProgram(Q){return this.programs[Q??this.activeProgramId]?.program}}class f0 extends v{gl;triangleArray;constructor(Q){super();this.gl=Q,this.triangleArray=Q.createVertexArray(),Q.bindVertexArray(this.triangleArray)}destroy(){this.gl.deleteVertexArray(this.triangleArray)}}class g0 extends v{bufferRecord={};gl;programs;constructor(Q,$){super();this.gl=Q,this.programs=$}getAttributeLocation(Q,$){const J=this.programs.getProgram($);return J?this.gl.getAttribLocation(J,Q)??-1:-1}createBuffer(Q){this.deleteBuffer(Q);const $=this.gl?.createBuffer();if(!$)throw new Error(`Unable to create buffer "${Q}"`);const J={buffer:$,location:this.getAttributeLocation(Q)};return this.bufferRecord[Q]=J,J}deleteBuffer(Q){if(this.bufferRecord[Q])this.gl.deleteBuffer(this.bufferRecord[Q].buffer),delete this.bufferRecord[Q]}getAttributeBuffer(Q){const $=this.bufferRecord[Q];if(!$)throw new Error(`Attribute "${Q}" not created. Make sure "createBuffer" is called.`);return $}destroy(){Object.keys(this.bufferRecord).forEach((Q)=>this.deleteBuffer(Q))}}class y0 extends v{gl;programs;constructor(Q,$){super();this.gl=Q,this.programs=$}getUniformLocation(Q,$){const J=this.programs.getProgram($);return this.gl.getUniformLocation(J,Q)}}function CQ(Q,$=(J)=>J.key){var J=[];return p0(Q,"",!0,(B)=>J.push(B),$),J.join("")}var p0=function(Q,$,J,B,Y){if(Q){B(`${$}${J?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 "}${Y(Q)}\n`);const K=$+(J?"    ":"\u2502   ");if(Q.left)p0(Q.left,K,!1,B,Y);if(Q.right)p0(Q.right,K,!0,B,Y)}};function V0(Q){if(Q===null)return!0;var $=H0(Q.left),J=H0(Q.right);if(Math.abs($-J)<=1&&V0(Q.left)&&V0(Q.right))return!0;return!1}var H0=function(Q){return Q?1+Math.max(H0(Q.left),H0(Q.right)):0};function X0(Q,$,J,B,Y){const K=Y-B;if(K>0){const Z=B+Math.floor(K/2),V=$[Z],H=J[Z],X={key:V,data:H,parent:Q};return X.left=X0(X,$,J,B,Z),X.right=X0(X,$,J,Z+1,Y),X}return null}function F0(Q){if(Q===null)return 0;const $=F0(Q.left),J=F0(Q.right);return Q.balanceFactor=$-J,Math.max($,J)+1}function W0(Q,$,J,B,Y){if(J>=B)return;const K=Q[J+B>>1];let Z=J-1,V=B+1;while(!0){do Z++;while(Y(Q[Z],K)<0);do V--;while(Y(Q[V],K)>0);if(Z>=V)break;let H=Q[Z];Q[Z]=Q[V],Q[V]=H,H=$[Z],$[Z]=$[V],$[V]=H}W0(Q,$,J,V,Y),W0(Q,$,V+1,B,Y)}var R$=function(Q,$){return Q>$?1:Q<$?-1:0},j0=function(Q){var $=Q.right;if(Q.right=$.left,$.left)$.left.parent=Q;if($.parent=Q.parent,$.parent)if($.parent.left===Q)$.parent.left=$;else $.parent.right=$;if(Q.parent=$,$.left=Q,Q.balanceFactor+=1,$.balanceFactor<0)Q.balanceFactor-=$.balanceFactor;if($.balanceFactor+=1,Q.balanceFactor>0)$.balanceFactor+=Q.balanceFactor;return $},P0=function(Q){var $=Q.left;if(Q.left=$.right,Q.left)Q.left.parent=Q;if($.parent=Q.parent,$.parent)if($.parent.left===Q)$.parent.left=$;else $.parent.right=$;if(Q.parent=$,$.right=Q,Q.balanceFactor-=1,$.balanceFactor>0)Q.balanceFactor-=$.balanceFactor;if($.balanceFactor-=1,Q.balanceFactor<0)$.balanceFactor+=Q.balanceFactor;return $};class s{constructor(Q,$=!1){this._comparator=Q||R$,this._root=null,this._size=0,this._noDuplicates=!!$}destroy(){return this.clear()}clear(){return this._root=null,this._size=0,this}get size(){return this._size}contains(Q){if(this._root){var $=this._root,J=this._comparator;while($){var B=J(Q,$.key);if(B===0)return!0;else if(B<0)$=$.left;else $=$.right}}return!1}next(Q){var $=Q;if($)if($.right){$=$.right;while($.left)$=$.left}else{$=Q.parent;while($&&$.right===Q)Q=$,$=$.parent}return $}prev(Q){var $=Q;if($)if($.left){$=$.left;while($.right)$=$.right}else{$=Q.parent;while($&&$.left===Q)Q=$,$=$.parent}return $}forEach(Q){var $=this._root,J=[],B=!1,Y=0;while(!B)if($)J.push($),$=$.left;else if(J.length>0)$=J.pop(),Q($,Y++),$=$.right;else B=!0;return this}range(Q,$,J,B){const Y=[],K=this._comparator;let Z=this._root,V;while(Y.length!==0||Z)if(Z)Y.push(Z),Z=Z.left;else{if(Z=Y.pop(),V=K(Z.key,$),V>0)break;else if(K(Z.key,Q)>=0){if(J.call(B,Z))return this}Z=Z.right}return this}keys(){var Q=this._root,$=[],J=[],B=!1;while(!B)if(Q)$.push(Q),Q=Q.left;else if($.length>0)Q=$.pop(),J.push(Q.key),Q=Q.right;else B=!0;return J}values(){var Q=this._root,$=[],J=[],B=!1;while(!B)if(Q)$.push(Q),Q=Q.left;else if($.length>0)Q=$.pop(),J.push(Q.data),Q=Q.right;else B=!0;return J}at(Q){var $=this._root,J=[],B=!1,Y=0;while(!B)if($)J.push($),$=$.left;else if(J.length>0){if($=J.pop(),Y===Q)return $;Y++,$=$.right}else B=!0;return null}minNode(){var Q=this._root;if(!Q)return null;while(Q.left)Q=Q.left;return Q}maxNode(){var Q=this._root;if(!Q)return null;while(Q.right)Q=Q.right;return Q}min(){var Q=this._root;if(!Q)return null;while(Q.left)Q=Q.left;return Q.key}max(){var Q=this._root;if(!Q)return null;while(Q.right)Q=Q.right;return Q.key}isEmpty(){return!this._root}pop(){var Q=this._root,$=null;if(Q){while(Q.left)Q=Q.left;$={key:Q.key,data:Q.data},this.remove(Q.key)}return $}popMax(){var Q=this._root,$=null;if(Q){while(Q.right)Q=Q.right;$={key:Q.key,data:Q.data},this.remove(Q.key)}return $}find(Q){var $=this._root,J=$,B,Y=this._comparator;while(J)if(B=Y(Q,J.key),B===0)return J;else if(B<0)J=J.left;else J=J.right;return null}insert(Q,$){if(!this._root)return this._root={parent:null,left:null,right:null,balanceFactor:0,key:Q,data:$},this._size++,this._root;var J=this._comparator,B=this._root,Y=null,K=0;if(this._noDuplicates)while(B)if(K=J(Q,B.key),Y=B,K===0)return null;else if(K<0)B=B.left;else B=B.right;else while(B)if(K=J(Q,B.key),Y=B,K<=0)B=B.left;else B=B.right;var Z={left:null,right:null,balanceFactor:0,parent:Y,key:Q,data:$},V;if(K<=0)Y.left=Z;else Y.right=Z;while(Y){if(K=J(Y.key,Q),K<0)Y.balanceFactor-=1;else Y.balanceFactor+=1;if(Y.balanceFactor===0)break;else if(Y.balanceFactor<-1){if(Y.right.balanceFactor===1)P0(Y.right);if(V=j0(Y),Y===this._root)this._root=V;break}else if(Y.balanceFactor>1){if(Y.left.balanceFactor===-1)j0(Y.left);if(V=P0(Y),Y===this._root)this._root=V;break}Y=Y.parent}return this._size++,Z}remove(Q){if(!this._root)return null;var $=this._root,J=this._comparator,B=0;while($)if(B=J(Q,$.key),B===0)break;else if(B<0)$=$.left;else $=$.right;if(!$)return null;var Y=$.key,K,Z;if($.left){K=$.left;while(K.left||K.right){while(K.right)K=K.right;if($.key=K.key,$.data=K.data,K.left)$=K,K=K.left}$.key=K.key,$.data=K.data,$=K}if($.right){Z=$.right;while(Z.left||Z.right){while(Z.left)Z=Z.left;if($.key=Z.key,$.data=Z.data,Z.right)$=Z,Z=Z.right}$.key=Z.key,$.data=Z.data,$=Z}var V=$.parent,H=$,X;while(V){if(V.left===H)V.balanceFactor-=1;else V.balanceFactor+=1;if(V.balanceFactor<-1){if(V.right.balanceFactor===1)P0(V.right);if(X=j0(V),V===this._root)this._root=X;V=X}else if(V.balanceFactor>1){if(V.left.balanceFactor===-1)j0(V.left);if(X=P0(V),V===this._root)this._root=X;V=X}if(V.balanceFactor===-1||V.balanceFactor===1)break;H=V,V=V.parent}if($.parent)if($.parent.left===$)$.parent.left=null;else $.parent.right=null;if($===this._root)this._root=null;return this._size--,Y}load(Q=[],$=[],J){if(this._size!==0)throw new Error("bulk-load: tree is not empty");const B=Q.length;if(J)W0(Q,$,0,B-1,this._comparator);return this._root=X0(null,Q,$,0,B),F0(this._root),this._size=B,this}isBalanced(){return V0(this._root)}toString(Q){return CQ(this._root,Q)}}s.default=s;class m{size;slotNumber;x;y;textureIndex;parent;sibbling;textureSizeLimits;constructor(Q,$,J,B){this.textureSizeLimits=J?.textureSizeLimits??B??{min:x0,max:m0},this.size=Q,this.slotNumber=$,this.parent=J,this.sibbling=void 0;const{x:Y,y:K,textureIndex:Z}=this.calculatePosition(Q,$);this.x=Y,this.y=K,this.textureIndex=Z}calculateTextureIndex(Q,$){const[J,B]=Q,Y=this.textureSizeLimits.max/J*(this.textureSizeLimits.max/B);return Math.floor($/Y)}calculatePosition(Q,$){const[J,B]=Q,Y=this.textureSizeLimits.max/J,K=this.textureSizeLimits.max/B,Z=$%Y*J,V=Math.floor($/Y)%K*B;return{x:Z,y:V,textureIndex:this.calculateTextureIndex(Q,$)}}getTag(){return m.getTag(this)}static getTag(Q){return`${Q.size[0]}x${Q.size[1]}-#${Q.slotNumber}`}static positionToTextureSlot(Q,$,J,B,Y){const[K,Z]=J,V=Y.textureSizeLimits.max/K,X=Y.textureSizeLimits.max/K*(Y.textureSizeLimits.max/Z)*B+$/Z*V+Q/K;return new m(J,X,Y)}getPosition(){return{x:this.x,y:this.y,size:this.size,textureIndex:this.textureIndex}}canSplitHorizontally(){const[,Q]=this.size;return Q>this.textureSizeLimits.min}canSplitVertically(){const[Q]=this.size;return Q>this.textureSizeLimits.min}splitHorizontally(){const{x:Q,y:$,size:J,textureIndex:B}=this,[Y,K]=J;if(!this.canSplitHorizontally())throw new Error(`Cannot split texture slot of size ${Y} horizontally`);const Z=Y/2,V=m.positionToTextureSlot(Q,$,[Z,K],B,this),H=m.positionToTextureSlot(Q+Z,$,[Z,K],B,this);return V.sibbling=H,H.sibbling=V,[V,H]}splitVertically(){const{x:Q,y:$,size:J,textureIndex:B}=this,[Y,K]=J;if(!this.canSplitVertically())throw new Error(`Cannot split texture slot of size ${K} vertically`);const Z=K/2,V=m.positionToTextureSlot(Q,$,[Y,Z],B,this),H=m.positionToTextureSlot(Q,$+Z,[Y,Z],B,this);return V.sibbling=H,H.sibbling=V,[V,H]}}function O0(Q,$){return Math.max($,Math.pow(2,Math.ceil(Math.log(Q)/Math.log(2))))}function MQ(Q,$,J,B){if(J<1)throw new Error("Invalid count");const Y=O0(Q,B.min),K=O0($,B.min),Z=new Map;let V=B.min;for(let H=1;H<=J;H++){V=O0(Y*H,B.min);const X=O0(K*Math.ceil(J/H),B.min);Z.set(V,X)}for(let H=V;H<=B.max;H*=2)if(!Z.has(H))Z.set(H,K);return Z}var q$=!1,x0=16,m0=4096,G$=16;class U0{textureSlots=new s((Q,$)=>{const J=Q.size[0]*Q.size[1]-$.size[0]*$.size[1];if(J!==0)return J;return Q.slotNumber-$.slotNumber},!1);allocatedTextures={};minTextureSize;maxTextureSize;numTextureSheets;initialSlots=[];constructor({numTextureSheets:Q,minTextureSize:$,maxTextureSize:J,excludeTexture:B}={},Y){if(this.numTextureSheets=Q??G$,this.minTextureSize=$??x0,this.maxTextureSize=J??m0,Y)this.numTextureSheets=Math.min(this.numTextureSheets,Y.getParameter(WebGL2RenderingContext.MAX_TEXTURE_IMAGE_UNITS)),this.maxTextureSize=Math.min(this.maxTextureSize,Y.getParameter(WebGL2RenderingContext.MAX_TEXTURE_SIZE)),this.minTextureSize=Math.min(this.minTextureSize,this.maxTextureSize);for(let K=0;K<this.numTextureSheets;K++){if(B?.(K))continue;this.initialSlots.push(new m([this.maxTextureSize,this.maxTextureSize],K,void 0,{min:this.minTextureSize,max:this.maxTextureSize}))}this.initialSlots.forEach((K)=>this.textureSlots.insert(K))}allocate(Q,$,J=1){const{size:B,slotNumber:Y,x:K,y:Z,textureIndex:V}=this.allocateHelper(Q,$,J);return{size:B,slotNumber:Y,x:K,y:Z,textureIndex:V}}deallocate(Q){if(!this.isSlotUsed(Q))throw new Error("Slot is not allocated");const $=this.allocatedTextures[m.getTag(Q)];this.deallocateHelper($)}get countUsedTextureSheets(){return this.initialSlots.filter((Q)=>this.isSlotUsed(Q)).length}allocateHelper(Q,$,J=1){const B=MQ(Q,$,J,{min:this.minTextureSize,max:this.maxTextureSize}),Y=this.findSlot(B);if(!Y)throw new Error(`Could not find a slot for texture to fit ${J} sprites of size ${Q}x${$}`);this.textureSlots.remove(Y);const[K,Z]=this.bestFit(B,Y);return this.fitSlot(Y,K,Z)}findSlot(Q){for(let $=0;$<this.textureSlots.size;$++){const B=this.textureSlots.at($).key,[Y,K]=B.size;if(Q.get(Y)<=K)return B}return null}calculateRatio(Q,$){return Math.max(Q/$,$/Q)}bestFit(Q,$){const[J,B]=$.size;let Y=$.textureSizeLimits.max;return Q.forEach((K,Z)=>{if(Z<=J&&K<=B){const V=Z*K,H=Q.get(Y)*Y;if(V<H)Y=Z;else if(V===H){if(this.calculateRatio(Z,K)<this.calculateRatio(Y,Q.get(Y)))Y=Z}}}),[Y,Q.get(Y)]}isSlotUsed(Q){return!!this.allocatedTextures[m.getTag(Q)]}deallocateHelper(Q){if(Q.parent&&Q.sibbling&&!this.isSlotUsed(Q.sibbling)){const $=Q.sibbling;if(this.textureSlots.remove($),q$&&this.textureSlots.find(Q))throw new Error("Slot is not expected to be in the tree");const J=Q.parent;this.deallocateHelper(J);return}this.textureSlots.insert(Q),delete this.allocatedTextures[Q.getTag()]}trySplitHorizontally(Q,$,J){if(Q.canSplitHorizontally()){const[B,Y]=Q.splitHorizontally();if(B.size[0]>=$)return this.textureSlots.insert(Y),this.fitSlot(B,$,J)}return null}trySplitVertically(Q,$,J){if(Q.canSplitVertically()){const[B,Y]=Q.splitVertically();if(B.size[1]>=J)return this.textureSlots.insert(Y),this.fitSlot(B,$,J)}return null}fitSlot(Q,$,J){if(this.allocatedTextures[Q.getTag()]=Q,Q.size[0]>Q.size[1]){const B=this.trySplitHorizontally(Q,$,J)??this.trySplitVertically(Q,$,J);if(B)return B}else{const B=this.trySplitVertically(Q,$,J)??this.trySplitHorizontally(Q,$,J);if(B)return B}return Q}listSlots(){this.textureSlots.forEach((Q)=>{console.log(Q.key?.getTag())})}}var N0=15;class c0 extends v{gl;uniforms;textureBuffers={};tempContext=new OffscreenCanvas(1,1).getContext("2d");textureSlotAllocator=new U0({excludeTexture:(Q)=>Q===N0});textureSlotAllocatorForVideo=new U0({excludeTexture:(Q)=>Q!==N0});constructor(Q,$){super();this.gl=Q,this.uniforms=$,this.tempContext.imageSmoothingEnabled=!0}initialize(){this.initTextureUniforms(),this.initMaxTexture()}getTexture(Q){if(!this.textureBuffers[Q]){const $=this.gl.createTexture();if(!$)return;this.gl.bindTexture(A.TEXTURE_2D,$),this.gl.texImage2D(A.TEXTURE_2D,0,A.RGBA,this.textureSlotAllocator.maxTextureSize,this.textureSlotAllocator.maxTextureSize,0,A.RGBA,A.UNSIGNED_BYTE,null),this.textureBuffers[Q]=$,this.addOnDestroy(()=>this.gl.deleteTexture($))}return this.textureBuffers[Q]}loadTexture(Q,$,J,B,Y){this.gl.activeTexture(A[$]),this.gl.bindTexture(A.TEXTURE_2D,J),this.applyTexImage2d(Q,B,Y),this.gl.texParameteri(A.TEXTURE_2D,A.TEXTURE_MIN_FILTER,A.LINEAR)}applyTexImage2d(Q,[$,J,B,Y],[K,Z,V,H]){if(B===V&&Y===H&&!$&&!J)this.gl.texSubImage2D(A.TEXTURE_2D,0,K,Z,V,H,A.RGBA,A.UNSIGNED_BYTE,Q.texImgSrc);else{const X=this.tempContext.canvas;if(Q.texImgSrc instanceof ImageData){if(X.width=V||Q.width,X.height=H||Q.height,this.tempContext.putImageData(Q.texImgSrc,0,0),$||J)console.warn("Offset not available when sending imageData")}else{const F=B||Q.width,W=Y||Q.height;X.width=V||F,X.height=H||W,this.tempContext.drawImage(Q.texImgSrc,$,J,F,W,0,0,X.width,X.height)}this.gl.texSubImage2D(A.TEXTURE_2D,0,K,Z,X.width,X.height,A.RGBA,A.UNSIGNED_BYTE,X)}}allocateSlotForImage(Q){const J=(Q.isVideo?this.textureSlotAllocatorForVideo:this.textureSlotAllocator).allocate(Q.width,Q.height),B=`TEXTURE${J.textureIndex}`,Y=this.getTexture(B);if(!Y)throw new Error(`Invalid texture Id ${B}`);const K=this.assignImageToTexture(Q,B,Y,[0,0,Q.width,Q.height],[J.x,J.y,...J.size]);return{slot:J,refreshCallback:K}}assignImageToTexture(Q,$,J,B,Y){const K=B??[0,0,Q.width,Q.height],Z=Y??[0,0,K[2],K[3]],V=()=>{this.gl.bindTexture(A.TEXTURE_2D,J),this.applyTexImage2d(Q,K,Z)};if(Q.active)V();else this.loadTexture(Q,$,J,K,Z),Q.active=!0;return V}setupTextureForVideo(Q){const $=this.getTexture(Q);if($)this.gl.activeTexture(A[Q]),this.gl.bindTexture(A.TEXTURE_2D,$),this.gl.texParameteri(A.TEXTURE_2D,A.TEXTURE_MIN_FILTER,A.LINEAR),this.gl.texParameteri(A.TEXTURE_2D,A.TEXTURE_MAG_FILTER,A.LINEAR)}generateMipMap(Q){const $=this.getTexture(Q);if($)this.gl.activeTexture(A[Q]),this.gl.bindTexture(A.TEXTURE_2D,$),this.gl.texParameteri(A.TEXTURE_2D,A.TEXTURE_MIN_FILTER,A.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(A.TEXTURE_2D,A.TEXTURE_MAG_FILTER,A.LINEAR),this.gl.generateMipmap(A.TEXTURE_2D)}initTextureUniforms(){const Q=this.gl.getParameter(A.MAX_TEXTURE_IMAGE_UNITS),$=new Array(Q).fill(null).map((B,Y)=>Y),J=this.uniforms.getUniformLocation(GQ);this.gl.uniform1iv(J,$)}initMaxTexture(){const Q=this.uniforms.getUniformLocation(qQ);this.gl.uniform1f(Q,this.textureSlotAllocator.maxTextureSize)}}class c extends v{texImgSrc;active=!1;width;height;isVideo;schedule;constructor(Q,$){super();this.texImgSrc=Q;const J=Q;if(this.isVideo=!!(J.videoWidth||J.videoHeight),this.width=J.naturalWidth??J.videoWidth??J.displayWidth??J.width?.baseValue?.value??J.width,this.height=J.naturalHeight??J.videoHeight??J.displayHeight??J.height?.baseValue?.value??J.height,this.schedule=$?{period:1000/$}:void 0,!this.width||!this.height)throw new Error("Invalid image")}refresh(){this.refreshCallback?.()}static createFromCanvas(Q){return new c(Q)}static async loadImage(Q){const $=await new Promise((J,B)=>{const Y=new Image;Y.crossOrigin="anonymous";const K=(Z)=>B(Z.error);Y.addEventListener("error",K),Y.addEventListener("load",()=>J(Y),{once:!0}),Y.src=Q});return new c($)}static async loadVideo(Q,$,J=30,B=1){const Y=await new Promise((Z,V)=>{const H=document.createElement("video");if(H.loop=!0,$!==void 0)H.volume=$;H.addEventListener("loadedmetadata",()=>{H.play(),H.playbackRate=B,Z(H)},{once:!0}),H.addEventListener("error",(X)=>V(X.error)),H.src=Q}),K=new c(Y,J);return K.addOnDestroy(()=>Y.pause()),K}static async loadWebcam(Q){const $=await new Promise((Y,K)=>{const Z=document.createElement("video");Z.loop=!0,Z.addEventListener("loadedmetadata",()=>Z.play()),Z.addEventListener("playing",()=>Y(Z),{once:!0}),Z.addEventListener("error",(V)=>K(V.error))}),J=new c($);let B=!1;return navigator.mediaDevices.getUserMedia({video:{deviceId:Q}}).then((Y)=>{if(!B)$.srcObject=Y,J.addOnDestroy(()=>Y.getTracks().forEach((K)=>K.stop()))}),J.addOnDestroy(()=>{B=!0,$.pause()}),J}}var $0=function(Q){return Q};class n0 extends v{constructor(){super(...arguments)}images={};renderProcedures={image:$0((Q,$)=>this.loadImage(Q,$.src)),video:$0((Q,$)=>this.loadVideo(Q,$.src,$.volume,$.fps,$.playSpeed)),draw:$0((Q,$)=>this.drawImage(Q,$.draw)),canvas:$0((Q,$)=>this.loadCanvas(Q,$.canvas)),webcam:$0((Q,$)=>this.loadWebCam(Q,$.deviceId))};hasImageId(Q){return!!this.getMedia(Q)}getMedia(Q){return this.images[Q]}setImage(Q,$){this.images[Q]=$}async renderMedia(Q,$){return this.renderProcedures[$.type](Q,$)}async drawImage(Q,$){const J=new OffscreenCanvas(1,1);$(J.getContext("2d"));const B=c.createFromCanvas(J);return this.images[Q]=this.own(B),B}async loadCanvas(Q,$){const J=c.createFromCanvas($);return $.getContext("2d"),this.images[Q]=this.own(J),J}async loadImage(Q,$){const J=await c.loadImage($);return this.images[Q]=this.own(J),J}async loadVideo(Q,$,J,B,Y){const K=await c.loadVideo($,J,B,Y);return this.images[Q]=this.own(K),K}async loadWebCam(Q,$){const J=await c.loadWebcam($);return this.images[Q]=this.own(J),J}}var kQ=`#version 300 es
//  ~{AUTHOR}

precision highp float;

//  IN
//  shape
layout(location = 0) in vec2 position;
layout(location = 1) in mat4 transform;
//  1, 2, 3, 4 reserved for transform
//  animation
layout(location = 5) in vec2 slotSize_and_number;
//  instance
layout(location = 6) in float instance;

//  UNIFORM
uniform float maxTextureSize;
uniform mat4 camPos;
uniform mat4 camTurn;
uniform mat4 camTilt;
uniform mat4 projection;
uniform float curvature;

//  OUT
out vec2 vTex;
out float vTextureIndex;
out vec3 vInstanceColor;

void main() {
  vec2 tex = position.xy * vec2(0.49, -0.49) + 0.5;
  vec2 slotSize = vec2(
    pow(2.0, floor(slotSize_and_number.x / 16.0)),
    pow(2.0, mod(slotSize_and_number.x, 16.0)));
  float slotNumber = slotSize_and_number.y;
  float maxCols = maxTextureSize / slotSize.x;
  float maxRows = maxTextureSize / slotSize.y;
  float slotX = mod(slotNumber, maxCols);
  float slotY = mod(floor(slotNumber / maxCols), maxRows);

  vec4 elemPosition = transform * vec4(position, 0.0, 1.0);
  // elementPosition => relativePosition
  vec4 relativePosition = camTilt * camTurn * camPos * elemPosition;
  relativePosition.y -= curvature * ((relativePosition.z * relativePosition.z) + (relativePosition.x * relativePosition.x) / 4.) / 10.;
  // relativePosition => gl_Position
  gl_Position = projection * relativePosition;


  vTex = (vec2(slotX, slotY) + tex) * slotSize / maxTextureSize;
  vTextureIndex = floor(slotNumber / (maxCols * maxRows));

  //  instance
  float r = fract(instance / (256.0 * 256.0 * 255.0));
  float g = fract(instance / (256.0 * 255.0));
  float b = fract(instance / 255.0);
  vInstanceColor = vec3(r, g, b);
}
`;var LQ=`#version 300 es
//  ~{AUTHOR}
precision highp float;

//  CONST
const int NUM_TEXTURES = 16;
const float threshold = 0.00001;

//  IN
//  texture
uniform sampler2D uTextures[NUM_TEXTURES];
in float vTextureIndex;
in vec2 vTex;
in float opacity;
in vec3 vInstanceColor;

//  OUT
out vec4 fragColor;

//  FUNCTIONS
vec4 getTextureColor(float textureSlot, vec2 vTexturePoint);

void main() {
  vec4 color = getTextureColor(vTextureIndex, vTex);
  if (color.a <= .0001) {
    discard;
  };
  fragColor = color;
//  fragColor = vec4(vInstanceColor.rgb, 1.0);
}

vec4 getTextureColor(float textureSlot, vec2 vTexturePoint) {
  if (abs(0.0 - textureSlot) < threshold) {
    return texture(uTextures[0], vTexturePoint);
  }
  if (abs(1.0 - textureSlot) < threshold) {
    return texture(uTextures[1], vTexturePoint);
  }
  if (abs(2.0 - textureSlot) < threshold) {
    return texture(uTextures[2], vTexturePoint);
  }
  if (abs(3.0 - textureSlot) < threshold) {
    return texture(uTextures[3], vTexturePoint);
  }
  if (abs(4.0 - textureSlot) < threshold) {
    return texture(uTextures[4], vTexturePoint);
  }
  if (abs(5.0 - textureSlot) < threshold) {
    return texture(uTextures[5], vTexturePoint);
  }
  if (abs(6.0 - textureSlot) < threshold) {
    return texture(uTextures[6], vTexturePoint);
  }
  if (abs(7.0 - textureSlot) < threshold) {
    return texture(uTextures[7], vTexturePoint);
  }
  if (abs(8.0 - textureSlot) < threshold) {
    return texture(uTextures[8], vTexturePoint);
  }
  if (abs(9.0 - textureSlot) < threshold) {
    return texture(uTextures[9], vTexturePoint);
  }
  if (abs(10.0 - textureSlot) < threshold) {
    return texture(uTextures[10], vTexturePoint);
  }
  if (abs(11.0 - textureSlot) < threshold) {
    return texture(uTextures[11], vTexturePoint);
  }
  if (abs(12.0 - textureSlot) < threshold) {
    return texture(uTextures[12], vTexturePoint);
  }
  if (abs(13.0 - textureSlot) < threshold) {
    return texture(uTextures[13], vTexturePoint);
  }
  if (abs(14.0 - textureSlot) < threshold) {
    return texture(uTextures[14], vTexturePoint);
  }
  if (abs(15.0 - textureSlot) < threshold) {
    return texture(uTextures[15], vTexturePoint);
  }
  return texture(uTextures[0], vTexturePoint);
}
`;function l0(Q,$){return Q.replace(/~\{(\w+)\}/g,(J,B)=>{return $?.[B]||J})}var G=0.000001,T=typeof Float32Array!=="undefined"?Float32Array:Array,l=Math.random,vB=Math.PI/180;if(!Math.hypot)Math.hypot=function(){var Q=0,$=arguments.length;while($--)Q+=arguments[$]*arguments[$];return Math.sqrt(Q)};function TQ(){var Q=new T(9);if(T!=Float32Array)Q[1]=0,Q[2]=0,Q[3]=0,Q[5]=0,Q[6]=0,Q[7]=0;return Q[0]=1,Q[4]=1,Q[8]=1,Q}var k={};G0(k,{transpose:()=>{{return I$}},translate:()=>{{return g$}},targetTo:()=>{{return VJ}},subtract:()=>{{return fQ}},sub:()=>{{return NJ}},str:()=>{{return HJ}},set:()=>{{return w$}},scale:()=>{{return y$}},rotateZ:()=>{{return c$}},rotateY:()=>{{return m$}},rotateX:()=>{{return x$}},rotate:()=>{{return p$}},perspectiveZO:()=>{{return JJ}},perspectiveNO:()=>{{return vQ}},perspectiveFromFieldOfView:()=>{{return BJ}},perspective:()=>{{return $J}},orthoZO:()=>{{return KJ}},orthoNO:()=>{{return zQ}},ortho:()=>{{return YJ}},multiplyScalarAndAdd:()=>{{return jJ}},multiplyScalar:()=>{{return WJ}},multiply:()=>{{return SQ}},mul:()=>{{return UJ}},lookAt:()=>{{return ZJ}},invert:()=>{{return v$}},identity:()=>{{return hQ}},getTranslation:()=>{{return e$}},getScaling:()=>{{return IQ}},getRotation:()=>{{return u$}},frustum:()=>{{return QJ}},fromZRotation:()=>{{return s$}},fromYRotation:()=>{{return i$}},fromXRotation:()=>{{return b$}},fromValues:()=>{{return S$}},fromTranslation:()=>{{return n$}},fromScaling:()=>{{return l$}},fromRotationTranslationScaleOrigin:()=>{{return a$}},fromRotationTranslationScale:()=>{{return o$}},fromRotationTranslation:()=>{{return wQ}},fromRotation:()=>{{return d$}},fromQuat2:()=>{{return r$}},fromQuat:()=>{{return t$}},frob:()=>{{return XJ}},exactEquals:()=>{{return PJ}},equals:()=>{{return OJ}},determinant:()=>{{return f$}},create:()=>{{return L$}},copy:()=>{{return h$}},clone:()=>{{return T$}},adjoint:()=>{{return z$}},add:()=>{{return FJ}}});function L$(){var Q=new T(16);if(T!=Float32Array)Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0;return Q[0]=1,Q[5]=1,Q[10]=1,Q[15]=1,Q}function T$(Q){var $=new T(16);return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$[3]=Q[3],$[4]=Q[4],$[5]=Q[5],$[6]=Q[6],$[7]=Q[7],$[8]=Q[8],$[9]=Q[9],$[10]=Q[10],$[11]=Q[11],$[12]=Q[12],$[13]=Q[13],$[14]=Q[14],$[15]=Q[15],$}function h$(Q,$){return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q[3]=$[3],Q[4]=$[4],Q[5]=$[5],Q[6]=$[6],Q[7]=$[7],Q[8]=$[8],Q[9]=$[9],Q[10]=$[10],Q[11]=$[11],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15],Q}function S$(Q,$,J,B,Y,K,Z,V,H,X,F,W,O,P,N,U){var j=new T(16);return j[0]=Q,j[1]=$,j[2]=J,j[3]=B,j[4]=Y,j[5]=K,j[6]=Z,j[7]=V,j[8]=H,j[9]=X,j[10]=F,j[11]=W,j[12]=O,j[13]=P,j[14]=N,j[15]=U,j}function w$(Q,$,J,B,Y,K,Z,V,H,X,F,W,O,P,N,U,j){return Q[0]=$,Q[1]=J,Q[2]=B,Q[3]=Y,Q[4]=K,Q[5]=Z,Q[6]=V,Q[7]=H,Q[8]=X,Q[9]=F,Q[10]=W,Q[11]=O,Q[12]=P,Q[13]=N,Q[14]=U,Q[15]=j,Q}function hQ(Q){return Q[0]=1,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=1,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=1,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function I$(Q,$){if(Q===$){var J=$[1],B=$[2],Y=$[3],K=$[6],Z=$[7],V=$[11];Q[1]=$[4],Q[2]=$[8],Q[3]=$[12],Q[4]=J,Q[6]=$[9],Q[7]=$[13],Q[8]=B,Q[9]=K,Q[11]=$[14],Q[12]=Y,Q[13]=Z,Q[14]=V}else Q[0]=$[0],Q[1]=$[4],Q[2]=$[8],Q[3]=$[12],Q[4]=$[1],Q[5]=$[5],Q[6]=$[9],Q[7]=$[13],Q[8]=$[2],Q[9]=$[6],Q[10]=$[10],Q[11]=$[14],Q[12]=$[3],Q[13]=$[7],Q[14]=$[11],Q[15]=$[15];return Q}function v$(Q,$){var J=$[0],B=$[1],Y=$[2],K=$[3],Z=$[4],V=$[5],H=$[6],X=$[7],F=$[8],W=$[9],O=$[10],P=$[11],N=$[12],U=$[13],j=$[14],E=$[15],C=J*V-B*Z,_=J*H-Y*Z,D=J*X-K*Z,R=B*H-Y*V,q=B*X-K*V,z=Y*X-K*H,S=F*U-W*N,w=F*j-O*N,I=F*E-P*N,f=W*j-O*U,g=W*E-P*U,y=O*E-P*j,M=C*y-_*g+D*f+R*I-q*w+z*S;if(!M)return null;return M=1/M,Q[0]=(V*y-H*g+X*f)*M,Q[1]=(Y*g-B*y-K*f)*M,Q[2]=(U*z-j*q+E*R)*M,Q[3]=(O*q-W*z-P*R)*M,Q[4]=(H*I-Z*y-X*w)*M,Q[5]=(J*y-Y*I+K*w)*M,Q[6]=(j*D-N*z-E*_)*M,Q[7]=(F*z-O*D+P*_)*M,Q[8]=(Z*g-V*I+X*S)*M,Q[9]=(B*I-J*g-K*S)*M,Q[10]=(N*q-U*D+E*C)*M,Q[11]=(W*D-F*q-P*C)*M,Q[12]=(V*w-Z*f-H*S)*M,Q[13]=(J*f-B*w+Y*S)*M,Q[14]=(U*_-N*R-j*C)*M,Q[15]=(F*R-W*_+O*C)*M,Q}function z$(Q,$){var J=$[0],B=$[1],Y=$[2],K=$[3],Z=$[4],V=$[5],H=$[6],X=$[7],F=$[8],W=$[9],O=$[10],P=$[11],N=$[12],U=$[13],j=$[14],E=$[15];return Q[0]=V*(O*E-P*j)-W*(H*E-X*j)+U*(H*P-X*O),Q[1]=-(B*(O*E-P*j)-W*(Y*E-K*j)+U*(Y*P-K*O)),Q[2]=B*(H*E-X*j)-V*(Y*E-K*j)+U*(Y*X-K*H),Q[3]=-(B*(H*P-X*O)-V*(Y*P-K*O)+W*(Y*X-K*H)),Q[4]=-(Z*(O*E-P*j)-F*(H*E-X*j)+N*(H*P-X*O)),Q[5]=J*(O*E-P*j)-F*(Y*E-K*j)+N*(Y*P-K*O),Q[6]=-(J*(H*E-X*j)-Z*(Y*E-K*j)+N*(Y*X-K*H)),Q[7]=J*(H*P-X*O)-Z*(Y*P-K*O)+F*(Y*X-K*H),Q[8]=Z*(W*E-P*U)-F*(V*E-X*U)+N*(V*P-X*W),Q[9]=-(J*(W*E-P*U)-F*(B*E-K*U)+N*(B*P-K*W)),Q[10]=J*(V*E-X*U)-Z*(B*E-K*U)+N*(B*X-K*V),Q[11]=-(J*(V*P-X*W)-Z*(B*P-K*W)+F*(B*X-K*V)),Q[12]=-(Z*(W*j-O*U)-F*(V*j-H*U)+N*(V*O-H*W)),Q[13]=J*(W*j-O*U)-F*(B*j-Y*U)+N*(B*O-Y*W),Q[14]=-(J*(V*j-H*U)-Z*(B*j-Y*U)+N*(B*H-Y*V)),Q[15]=J*(V*O-H*W)-Z*(B*O-Y*W)+F*(B*H-Y*V),Q}function f$(Q){var $=Q[0],J=Q[1],B=Q[2],Y=Q[3],K=Q[4],Z=Q[5],V=Q[6],H=Q[7],X=Q[8],F=Q[9],W=Q[10],O=Q[11],P=Q[12],N=Q[13],U=Q[14],j=Q[15],E=$*Z-J*K,C=$*V-B*K,_=$*H-Y*K,D=J*V-B*Z,R=J*H-Y*Z,q=B*H-Y*V,z=X*N-F*P,S=X*U-W*P,w=X*j-O*P,I=F*U-W*N,f=F*j-O*N,g=W*j-O*U;return E*g-C*f+_*I+D*w-R*S+q*z}function SQ(Q,$,J){var B=$[0],Y=$[1],K=$[2],Z=$[3],V=$[4],H=$[5],X=$[6],F=$[7],W=$[8],O=$[9],P=$[10],N=$[11],U=$[12],j=$[13],E=$[14],C=$[15],_=J[0],D=J[1],R=J[2],q=J[3];return Q[0]=_*B+D*V+R*W+q*U,Q[1]=_*Y+D*H+R*O+q*j,Q[2]=_*K+D*X+R*P+q*E,Q[3]=_*Z+D*F+R*N+q*C,_=J[4],D=J[5],R=J[6],q=J[7],Q[4]=_*B+D*V+R*W+q*U,Q[5]=_*Y+D*H+R*O+q*j,Q[6]=_*K+D*X+R*P+q*E,Q[7]=_*Z+D*F+R*N+q*C,_=J[8],D=J[9],R=J[10],q=J[11],Q[8]=_*B+D*V+R*W+q*U,Q[9]=_*Y+D*H+R*O+q*j,Q[10]=_*K+D*X+R*P+q*E,Q[11]=_*Z+D*F+R*N+q*C,_=J[12],D=J[13],R=J[14],q=J[15],Q[12]=_*B+D*V+R*W+q*U,Q[13]=_*Y+D*H+R*O+q*j,Q[14]=_*K+D*X+R*P+q*E,Q[15]=_*Z+D*F+R*N+q*C,Q}function g$(Q,$,J){var B=J[0],Y=J[1],K=J[2],Z,V,H,X,F,W,O,P,N,U,j,E;if($===Q)Q[12]=$[0]*B+$[4]*Y+$[8]*K+$[12],Q[13]=$[1]*B+$[5]*Y+$[9]*K+$[13],Q[14]=$[2]*B+$[6]*Y+$[10]*K+$[14],Q[15]=$[3]*B+$[7]*Y+$[11]*K+$[15];else Z=$[0],V=$[1],H=$[2],X=$[3],F=$[4],W=$[5],O=$[6],P=$[7],N=$[8],U=$[9],j=$[10],E=$[11],Q[0]=Z,Q[1]=V,Q[2]=H,Q[3]=X,Q[4]=F,Q[5]=W,Q[6]=O,Q[7]=P,Q[8]=N,Q[9]=U,Q[10]=j,Q[11]=E,Q[12]=Z*B+F*Y+N*K+$[12],Q[13]=V*B+W*Y+U*K+$[13],Q[14]=H*B+O*Y+j*K+$[14],Q[15]=X*B+P*Y+E*K+$[15];return Q}function y$(Q,$,J){var B=J[0],Y=J[1],K=J[2];return Q[0]=$[0]*B,Q[1]=$[1]*B,Q[2]=$[2]*B,Q[3]=$[3]*B,Q[4]=$[4]*Y,Q[5]=$[5]*Y,Q[6]=$[6]*Y,Q[7]=$[7]*Y,Q[8]=$[8]*K,Q[9]=$[9]*K,Q[10]=$[10]*K,Q[11]=$[11]*K,Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15],Q}function p$(Q,$,J,B){var Y=B[0],K=B[1],Z=B[2],V=Math.hypot(Y,K,Z),H,X,F,W,O,P,N,U,j,E,C,_,D,R,q,z,S,w,I,f,g,y,M,x;if(V<G)return null;if(V=1/V,Y*=V,K*=V,Z*=V,H=Math.sin(J),X=Math.cos(J),F=1-X,W=$[0],O=$[1],P=$[2],N=$[3],U=$[4],j=$[5],E=$[6],C=$[7],_=$[8],D=$[9],R=$[10],q=$[11],z=Y*Y*F+X,S=K*Y*F+Z*H,w=Z*Y*F-K*H,I=Y*K*F-Z*H,f=K*K*F+X,g=Z*K*F+Y*H,y=Y*Z*F+K*H,M=K*Z*F-Y*H,x=Z*Z*F+X,Q[0]=W*z+U*S+_*w,Q[1]=O*z+j*S+D*w,Q[2]=P*z+E*S+R*w,Q[3]=N*z+C*S+q*w,Q[4]=W*I+U*f+_*g,Q[5]=O*I+j*f+D*g,Q[6]=P*I+E*f+R*g,Q[7]=N*I+C*f+q*g,Q[8]=W*y+U*M+_*x,Q[9]=O*y+j*M+D*x,Q[10]=P*y+E*M+R*x,Q[11]=N*y+C*M+q*x,$!==Q)Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q}function x$(Q,$,J){var B=Math.sin(J),Y=Math.cos(J),K=$[4],Z=$[5],V=$[6],H=$[7],X=$[8],F=$[9],W=$[10],O=$[11];if($!==Q)Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q[3]=$[3],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q[4]=K*Y+X*B,Q[5]=Z*Y+F*B,Q[6]=V*Y+W*B,Q[7]=H*Y+O*B,Q[8]=X*Y-K*B,Q[9]=F*Y-Z*B,Q[10]=W*Y-V*B,Q[11]=O*Y-H*B,Q}function m$(Q,$,J){var B=Math.sin(J),Y=Math.cos(J),K=$[0],Z=$[1],V=$[2],H=$[3],X=$[8],F=$[9],W=$[10],O=$[11];if($!==Q)Q[4]=$[4],Q[5]=$[5],Q[6]=$[6],Q[7]=$[7],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q[0]=K*Y-X*B,Q[1]=Z*Y-F*B,Q[2]=V*Y-W*B,Q[3]=H*Y-O*B,Q[8]=K*B+X*Y,Q[9]=Z*B+F*Y,Q[10]=V*B+W*Y,Q[11]=H*B+O*Y,Q}function c$(Q,$,J){var B=Math.sin(J),Y=Math.cos(J),K=$[0],Z=$[1],V=$[2],H=$[3],X=$[4],F=$[5],W=$[6],O=$[7];if($!==Q)Q[8]=$[8],Q[9]=$[9],Q[10]=$[10],Q[11]=$[11],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q[0]=K*Y+X*B,Q[1]=Z*Y+F*B,Q[2]=V*Y+W*B,Q[3]=H*Y+O*B,Q[4]=X*Y-K*B,Q[5]=F*Y-Z*B,Q[6]=W*Y-V*B,Q[7]=O*Y-H*B,Q}function n$(Q,$){return Q[0]=1,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=1,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=1,Q[11]=0,Q[12]=$[0],Q[13]=$[1],Q[14]=$[2],Q[15]=1,Q}function l$(Q,$){return Q[0]=$[0],Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=$[1],Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=$[2],Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function d$(Q,$,J){var B=J[0],Y=J[1],K=J[2],Z=Math.hypot(B,Y,K),V,H,X;if(Z<G)return null;return Z=1/Z,B*=Z,Y*=Z,K*=Z,V=Math.sin($),H=Math.cos($),X=1-H,Q[0]=B*B*X+H,Q[1]=Y*B*X+K*V,Q[2]=K*B*X-Y*V,Q[3]=0,Q[4]=B*Y*X-K*V,Q[5]=Y*Y*X+H,Q[6]=K*Y*X+B*V,Q[7]=0,Q[8]=B*K*X+Y*V,Q[9]=Y*K*X-B*V,Q[10]=K*K*X+H,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function b$(Q,$){var J=Math.sin($),B=Math.cos($);return Q[0]=1,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=B,Q[6]=J,Q[7]=0,Q[8]=0,Q[9]=-J,Q[10]=B,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function i$(Q,$){var J=Math.sin($),B=Math.cos($);return Q[0]=B,Q[1]=0,Q[2]=-J,Q[3]=0,Q[4]=0,Q[5]=1,Q[6]=0,Q[7]=0,Q[8]=J,Q[9]=0,Q[10]=B,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function s$(Q,$){var J=Math.sin($),B=Math.cos($);return Q[0]=B,Q[1]=J,Q[2]=0,Q[3]=0,Q[4]=-J,Q[5]=B,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=1,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function wQ(Q,$,J){var B=$[0],Y=$[1],K=$[2],Z=$[3],V=B+B,H=Y+Y,X=K+K,F=B*V,W=B*H,O=B*X,P=Y*H,N=Y*X,U=K*X,j=Z*V,E=Z*H,C=Z*X;return Q[0]=1-(P+U),Q[1]=W+C,Q[2]=O-E,Q[3]=0,Q[4]=W-C,Q[5]=1-(F+U),Q[6]=N+j,Q[7]=0,Q[8]=O+E,Q[9]=N-j,Q[10]=1-(F+P),Q[11]=0,Q[12]=J[0],Q[13]=J[1],Q[14]=J[2],Q[15]=1,Q}function r$(Q,$){var J=new T(3),B=-$[0],Y=-$[1],K=-$[2],Z=$[3],V=$[4],H=$[5],X=$[6],F=$[7],W=B*B+Y*Y+K*K+Z*Z;if(W>0)J[0]=(V*Z+F*B+H*K-X*Y)*2/W,J[1]=(H*Z+F*Y+X*B-V*K)*2/W,J[2]=(X*Z+F*K+V*Y-H*B)*2/W;else J[0]=(V*Z+F*B+H*K-X*Y)*2,J[1]=(H*Z+F*Y+X*B-V*K)*2,J[2]=(X*Z+F*K+V*Y-H*B)*2;return wQ(Q,$,J),Q}function e$(Q,$){return Q[0]=$[12],Q[1]=$[13],Q[2]=$[14],Q}function IQ(Q,$){var J=$[0],B=$[1],Y=$[2],K=$[4],Z=$[5],V=$[6],H=$[8],X=$[9],F=$[10];return Q[0]=Math.hypot(J,B,Y),Q[1]=Math.hypot(K,Z,V),Q[2]=Math.hypot(H,X,F),Q}function u$(Q,$){var J=new T(3);IQ(J,$);var B=1/J[0],Y=1/J[1],K=1/J[2],Z=$[0]*B,V=$[1]*Y,H=$[2]*K,X=$[4]*B,F=$[5]*Y,W=$[6]*K,O=$[8]*B,P=$[9]*Y,N=$[10]*K,U=Z+F+N,j=0;if(U>0)j=Math.sqrt(U+1)*2,Q[3]=0.25*j,Q[0]=(W-P)/j,Q[1]=(O-H)/j,Q[2]=(V-X)/j;else if(Z>F&&Z>N)j=Math.sqrt(1+Z-F-N)*2,Q[3]=(W-P)/j,Q[0]=0.25*j,Q[1]=(V+X)/j,Q[2]=(O+H)/j;else if(F>N)j=Math.sqrt(1+F-Z-N)*2,Q[3]=(O-H)/j,Q[0]=(V+X)/j,Q[1]=0.25*j,Q[2]=(W+P)/j;else j=Math.sqrt(1+N-Z-F)*2,Q[3]=(V-X)/j,Q[0]=(O+H)/j,Q[1]=(W+P)/j,Q[2]=0.25*j;return Q}function o$(Q,$,J,B){var Y=$[0],K=$[1],Z=$[2],V=$[3],H=Y+Y,X=K+K,F=Z+Z,W=Y*H,O=Y*X,P=Y*F,N=K*X,U=K*F,j=Z*F,E=V*H,C=V*X,_=V*F,D=B[0],R=B[1],q=B[2];return Q[0]=(1-(N+j))*D,Q[1]=(O+_)*D,Q[2]=(P-C)*D,Q[3]=0,Q[4]=(O-_)*R,Q[5]=(1-(W+j))*R,Q[6]=(U+E)*R,Q[7]=0,Q[8]=(P+C)*q,Q[9]=(U-E)*q,Q[10]=(1-(W+N))*q,Q[11]=0,Q[12]=J[0],Q[13]=J[1],Q[14]=J[2],Q[15]=1,Q}function a$(Q,$,J,B,Y){var K=$[0],Z=$[1],V=$[2],H=$[3],X=K+K,F=Z+Z,W=V+V,O=K*X,P=K*F,N=K*W,U=Z*F,j=Z*W,E=V*W,C=H*X,_=H*F,D=H*W,R=B[0],q=B[1],z=B[2],S=Y[0],w=Y[1],I=Y[2],f=(1-(U+E))*R,g=(P+D)*R,y=(N-_)*R,M=(P-D)*q,x=(1-(O+E))*q,o=(j+C)*q,a=(N+_)*z,PQ=(j-C)*z,OQ=(1-(O+U))*z;return Q[0]=f,Q[1]=g,Q[2]=y,Q[3]=0,Q[4]=M,Q[5]=x,Q[6]=o,Q[7]=0,Q[8]=a,Q[9]=PQ,Q[10]=OQ,Q[11]=0,Q[12]=J[0]+S-(f*S+M*w+a*I),Q[13]=J[1]+w-(g*S+x*w+PQ*I),Q[14]=J[2]+I-(y*S+o*w+OQ*I),Q[15]=1,Q}function t$(Q,$){var J=$[0],B=$[1],Y=$[2],K=$[3],Z=J+J,V=B+B,H=Y+Y,X=J*Z,F=B*Z,W=B*V,O=Y*Z,P=Y*V,N=Y*H,U=K*Z,j=K*V,E=K*H;return Q[0]=1-W-N,Q[1]=F+E,Q[2]=O-j,Q[3]=0,Q[4]=F-E,Q[5]=1-X-N,Q[6]=P+U,Q[7]=0,Q[8]=O+j,Q[9]=P-U,Q[10]=1-X-W,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function QJ(Q,$,J,B,Y,K,Z){var V=1/(J-$),H=1/(Y-B),X=1/(K-Z);return Q[0]=K*2*V,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=K*2*H,Q[6]=0,Q[7]=0,Q[8]=(J+$)*V,Q[9]=(Y+B)*H,Q[10]=(Z+K)*X,Q[11]=-1,Q[12]=0,Q[13]=0,Q[14]=Z*K*2*X,Q[15]=0,Q}function vQ(Q,$,J,B,Y){var K=1/Math.tan($/2),Z;if(Q[0]=K/J,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=K,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[11]=-1,Q[12]=0,Q[13]=0,Q[15]=0,Y!=null&&Y!==Infinity)Z=1/(B-Y),Q[10]=(Y+B)*Z,Q[14]=2*Y*B*Z;else Q[10]=-1,Q[14]=-2*B;return Q}function JJ(Q,$,J,B,Y){var K=1/Math.tan($/2),Z;if(Q[0]=K/J,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=K,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[11]=-1,Q[12]=0,Q[13]=0,Q[15]=0,Y!=null&&Y!==Infinity)Z=1/(B-Y),Q[10]=Y*Z,Q[14]=Y*B*Z;else Q[10]=-1,Q[14]=-B;return Q}function BJ(Q,$,J,B){var Y=Math.tan($.upDegrees*Math.PI/180),K=Math.tan($.downDegrees*Math.PI/180),Z=Math.tan($.leftDegrees*Math.PI/180),V=Math.tan($.rightDegrees*Math.PI/180),H=2/(Z+V),X=2/(Y+K);return Q[0]=H,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=X,Q[6]=0,Q[7]=0,Q[8]=-((Z-V)*H*0.5),Q[9]=(Y-K)*X*0.5,Q[10]=B/(J-B),Q[11]=-1,Q[12]=0,Q[13]=0,Q[14]=B*J/(J-B),Q[15]=0,Q}function zQ(Q,$,J,B,Y,K,Z){var V=1/($-J),H=1/(B-Y),X=1/(K-Z);return Q[0]=-2*V,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=-2*H,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=2*X,Q[11]=0,Q[12]=($+J)*V,Q[13]=(Y+B)*H,Q[14]=(Z+K)*X,Q[15]=1,Q}function KJ(Q,$,J,B,Y,K,Z){var V=1/($-J),H=1/(B-Y),X=1/(K-Z);return Q[0]=-2*V,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=-2*H,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=X,Q[11]=0,Q[12]=($+J)*V,Q[13]=(Y+B)*H,Q[14]=K*X,Q[15]=1,Q}function ZJ(Q,$,J,B){var Y,K,Z,V,H,X,F,W,O,P,N=$[0],U=$[1],j=$[2],E=B[0],C=B[1],_=B[2],D=J[0],R=J[1],q=J[2];if(Math.abs(N-D)<G&&Math.abs(U-R)<G&&Math.abs(j-q)<G)return hQ(Q);if(F=N-D,W=U-R,O=j-q,P=1/Math.hypot(F,W,O),F*=P,W*=P,O*=P,Y=C*O-_*W,K=_*F-E*O,Z=E*W-C*F,P=Math.hypot(Y,K,Z),!P)Y=0,K=0,Z=0;else P=1/P,Y*=P,K*=P,Z*=P;if(V=W*Z-O*K,H=O*Y-F*Z,X=F*K-W*Y,P=Math.hypot(V,H,X),!P)V=0,H=0,X=0;else P=1/P,V*=P,H*=P,X*=P;return Q[0]=Y,Q[1]=V,Q[2]=F,Q[3]=0,Q[4]=K,Q[5]=H,Q[6]=W,Q[7]=0,Q[8]=Z,Q[9]=X,Q[10]=O,Q[11]=0,Q[12]=-(Y*N+K*U+Z*j),Q[13]=-(V*N+H*U+X*j),Q[14]=-(F*N+W*U+O*j),Q[15]=1,Q}function VJ(Q,$,J,B){var Y=$[0],K=$[1],Z=$[2],V=B[0],H=B[1],X=B[2],F=Y-J[0],W=K-J[1],O=Z-J[2],P=F*F+W*W+O*O;if(P>0)P=1/Math.sqrt(P),F*=P,W*=P,O*=P;var N=H*O-X*W,U=X*F-V*O,j=V*W-H*F;if(P=N*N+U*U+j*j,P>0)P=1/Math.sqrt(P),N*=P,U*=P,j*=P;return Q[0]=N,Q[1]=U,Q[2]=j,Q[3]=0,Q[4]=W*j-O*U,Q[5]=O*N-F*j,Q[6]=F*U-W*N,Q[7]=0,Q[8]=F,Q[9]=W,Q[10]=O,Q[11]=0,Q[12]=Y,Q[13]=K,Q[14]=Z,Q[15]=1,Q}function HJ(Q){return"mat4("+Q[0]+", "+Q[1]+", "+Q[2]+", "+Q[3]+", "+Q[4]+", "+Q[5]+", "+Q[6]+", "+Q[7]+", "+Q[8]+", "+Q[9]+", "+Q[10]+", "+Q[11]+", "+Q[12]+", "+Q[13]+", "+Q[14]+", "+Q[15]+")"}function XJ(Q){return Math.hypot(Q[0],Q[1],Q[2],Q[3],Q[4],Q[5],Q[6],Q[7],Q[8],Q[9],Q[10],Q[11],Q[12],Q[13],Q[14],Q[15])}function FJ(Q,$,J){return Q[0]=$[0]+J[0],Q[1]=$[1]+J[1],Q[2]=$[2]+J[2],Q[3]=$[3]+J[3],Q[4]=$[4]+J[4],Q[5]=$[5]+J[5],Q[6]=$[6]+J[6],Q[7]=$[7]+J[7],Q[8]=$[8]+J[8],Q[9]=$[9]+J[9],Q[10]=$[10]+J[10],Q[11]=$[11]+J[11],Q[12]=$[12]+J[12],Q[13]=$[13]+J[13],Q[14]=$[14]+J[14],Q[15]=$[15]+J[15],Q}function fQ(Q,$,J){return Q[0]=$[0]-J[0],Q[1]=$[1]-J[1],Q[2]=$[2]-J[2],Q[3]=$[3]-J[3],Q[4]=$[4]-J[4],Q[5]=$[5]-J[5],Q[6]=$[6]-J[6],Q[7]=$[7]-J[7],Q[8]=$[8]-J[8],Q[9]=$[9]-J[9],Q[10]=$[10]-J[10],Q[11]=$[11]-J[11],Q[12]=$[12]-J[12],Q[13]=$[13]-J[13],Q[14]=$[14]-J[14],Q[15]=$[15]-J[15],Q}function WJ(Q,$,J){return Q[0]=$[0]*J,Q[1]=$[1]*J,Q[2]=$[2]*J,Q[3]=$[3]*J,Q[4]=$[4]*J,Q[5]=$[5]*J,Q[6]=$[6]*J,Q[7]=$[7]*J,Q[8]=$[8]*J,Q[9]=$[9]*J,Q[10]=$[10]*J,Q[11]=$[11]*J,Q[12]=$[12]*J,Q[13]=$[13]*J,Q[14]=$[14]*J,Q[15]=$[15]*J,Q}function jJ(Q,$,J,B){return Q[0]=$[0]+J[0]*B,Q[1]=$[1]+J[1]*B,Q[2]=$[2]+J[2]*B,Q[3]=$[3]+J[3]*B,Q[4]=$[4]+J[4]*B,Q[5]=$[5]+J[5]*B,Q[6]=$[6]+J[6]*B,Q[7]=$[7]+J[7]*B,Q[8]=$[8]+J[8]*B,Q[9]=$[9]+J[9]*B,Q[10]=$[10]+J[10]*B,Q[11]=$[11]+J[11]*B,Q[12]=$[12]+J[12]*B,Q[13]=$[13]+J[13]*B,Q[14]=$[14]+J[14]*B,Q[15]=$[15]+J[15]*B,Q}function PJ(Q,$){return Q[0]===$[0]&&Q[1]===$[1]&&Q[2]===$[2]&&Q[3]===$[3]&&Q[4]===$[4]&&Q[5]===$[5]&&Q[6]===$[6]&&Q[7]===$[7]&&Q[8]===$[8]&&Q[9]===$[9]&&Q[10]===$[10]&&Q[11]===$[11]&&Q[12]===$[12]&&Q[13]===$[13]&&Q[14]===$[14]&&Q[15]===$[15]}function OJ(Q,$){var J=Q[0],B=Q[1],Y=Q[2],K=Q[3],Z=Q[4],V=Q[5],H=Q[6],X=Q[7],F=Q[8],W=Q[9],O=Q[10],P=Q[11],N=Q[12],U=Q[13],j=Q[14],E=Q[15],C=$[0],_=$[1],D=$[2],R=$[3],q=$[4],z=$[5],S=$[6],w=$[7],I=$[8],f=$[9],g=$[10],y=$[11],M=$[12],x=$[13],o=$[14],a=$[15];return Math.abs(J-C)<=G*Math.max(1,Math.abs(J),Math.abs(C))&&Math.abs(B-_)<=G*Math.max(1,Math.abs(B),Math.abs(_))&&Math.abs(Y-D)<=G*Math.max(1,Math.abs(Y),Math.abs(D))&&Math.abs(K-R)<=G*Math.max(1,Math.abs(K),Math.abs(R))&&Math.abs(Z-q)<=G*Math.max(1,Math.abs(Z),Math.abs(q))&&Math.abs(V-z)<=G*Math.max(1,Math.abs(V),Math.abs(z))&&Math.abs(H-S)<=G*Math.max(1,Math.abs(H),Math.abs(S))&&Math.abs(X-w)<=G*Math.max(1,Math.abs(X),Math.abs(w))&&Math.abs(F-I)<=G*Math.max(1,Math.abs(F),Math.abs(I))&&Math.abs(W-f)<=G*Math.max(1,Math.abs(W),Math.abs(f))&&Math.abs(O-g)<=G*Math.max(1,Math.abs(O),Math.abs(g))&&Math.abs(P-y)<=G*Math.max(1,Math.abs(P),Math.abs(y))&&Math.abs(N-M)<=G*Math.max(1,Math.abs(N),Math.abs(M))&&Math.abs(U-x)<=G*Math.max(1,Math.abs(U),Math.abs(x))&&Math.abs(j-o)<=G*Math.max(1,Math.abs(j),Math.abs(o))&&Math.abs(E-a)<=G*Math.max(1,Math.abs(E),Math.abs(a))}var $J=vQ,YJ=zQ,UJ=SQ,NJ=fQ;var d={};G0(d,{str:()=>{{return j8}},squaredLength:()=>{{return F$}},sqrLen:()=>{{return R8}},sqlerp:()=>{{return M8}},slerp:()=>{{return D0}},setAxisAngle:()=>{{return J$}},setAxes:()=>{{return k8}},set:()=>{{return N8}},scale:()=>{{return V$}},rotationTo:()=>{{return C8}},rotateZ:()=>{{return K8}},rotateY:()=>{{return Y8}},rotateX:()=>{{return B8}},random:()=>{{return H8}},pow:()=>{{return V8}},normalize:()=>{{return s0}},multiply:()=>{{return B$}},mul:()=>{{return E8}},ln:()=>{{return K$}},lerp:()=>{{return _8}},length:()=>{{return X$}},len:()=>{{return D8}},invert:()=>{{return X8}},identity:()=>{{return Q8}},getAxisAngle:()=>{{return $8}},getAngle:()=>{{return J8}},fromValues:()=>{{return O8}},fromMat3:()=>{{return Z$}},fromEuler:()=>{{return W8}},exp:()=>{{return Y$}},exactEquals:()=>{{return q8}},equals:()=>{{return G8}},dot:()=>{{return H$}},create:()=>{{return i0}},copy:()=>{{return U8}},conjugate:()=>{{return F8}},clone:()=>{{return P8}},calculateW:()=>{{return Z8}},add:()=>{{return A8}}});var r={};G0(r,{zero:()=>{{return cJ}},transformQuat:()=>{{return gJ}},transformMat4:()=>{{return zJ}},transformMat3:()=>{{return fJ}},subtract:()=>{{return yQ}},sub:()=>{{return bJ}},str:()=>{{return nJ}},squaredLength:()=>{{return nQ}},squaredDistance:()=>{{return cQ}},sqrLen:()=>{{return uJ}},sqrDist:()=>{{return eJ}},set:()=>{{return _J}},scaleAndAdd:()=>{{return LJ}},scale:()=>{{return kJ}},round:()=>{{return MJ}},rotateZ:()=>{{return xJ}},rotateY:()=>{{return pJ}},rotateX:()=>{{return yJ}},random:()=>{{return vJ}},normalize:()=>{{return d0}},negate:()=>{{return TJ}},multiply:()=>{{return pQ}},mul:()=>{{return iJ}},min:()=>{{return GJ}},max:()=>{{return CJ}},lerp:()=>{{return SJ}},length:()=>{{return gQ}},len:()=>{{return b0}},inverse:()=>{{return hJ}},hermite:()=>{{return wJ}},fromValues:()=>{{return E0}},forEach:()=>{{return oJ}},floor:()=>{{return qJ}},exactEquals:()=>{{return lJ}},equals:()=>{{return dJ}},dot:()=>{{return _0}},divide:()=>{{return xQ}},div:()=>{{return sJ}},distance:()=>{{return mQ}},dist:()=>{{return rJ}},cross:()=>{{return B0}},create:()=>{{return A0}},copy:()=>{{return EJ}},clone:()=>{{return AJ}},ceil:()=>{{return RJ}},bezier:()=>{{return IJ}},angle:()=>{{return mJ}},add:()=>{{return DJ}}});function A0(){var Q=new T(3);if(T!=Float32Array)Q[0]=0,Q[1]=0,Q[2]=0;return Q}function AJ(Q){var $=new T(3);return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$}function gQ(Q){var $=Q[0],J=Q[1],B=Q[2];return Math.hypot($,J,B)}function E0(Q,$,J){var B=new T(3);return B[0]=Q,B[1]=$,B[2]=J,B}function EJ(Q,$){return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q}function _J(Q,$,J,B){return Q[0]=$,Q[1]=J,Q[2]=B,Q}function DJ(Q,$,J){return Q[0]=$[0]+J[0],Q[1]=$[1]+J[1],Q[2]=$[2]+J[2],Q}function yQ(Q,$,J){return Q[0]=$[0]-J[0],Q[1]=$[1]-J[1],Q[2]=$[2]-J[2],Q}function pQ(Q,$,J){return Q[0]=$[0]*J[0],Q[1]=$[1]*J[1],Q[2]=$[2]*J[2],Q}function xQ(Q,$,J){return Q[0]=$[0]/J[0],Q[1]=$[1]/J[1],Q[2]=$[2]/J[2],Q}function RJ(Q,$){return Q[0]=Math.ceil($[0]),Q[1]=Math.ceil($[1]),Q[2]=Math.ceil($[2]),Q}function qJ(Q,$){return Q[0]=Math.floor($[0]),Q[1]=Math.floor($[1]),Q[2]=Math.floor($[2]),Q}function GJ(Q,$,J){return Q[0]=Math.min($[0],J[0]),Q[1]=Math.min($[1],J[1]),Q[2]=Math.min($[2],J[2]),Q}function CJ(Q,$,J){return Q[0]=Math.max($[0],J[0]),Q[1]=Math.max($[1],J[1]),Q[2]=Math.max($[2],J[2]),Q}function MJ(Q,$){return Q[0]=Math.round($[0]),Q[1]=Math.round($[1]),Q[2]=Math.round($[2]),Q}function kJ(Q,$,J){return Q[0]=$[0]*J,Q[1]=$[1]*J,Q[2]=$[2]*J,Q}function LJ(Q,$,J,B){return Q[0]=$[0]+J[0]*B,Q[1]=$[1]+J[1]*B,Q[2]=$[2]+J[2]*B,Q}function mQ(Q,$){var J=$[0]-Q[0],B=$[1]-Q[1],Y=$[2]-Q[2];return Math.hypot(J,B,Y)}function cQ(Q,$){var J=$[0]-Q[0],B=$[1]-Q[1],Y=$[2]-Q[2];return J*J+B*B+Y*Y}function nQ(Q){var $=Q[0],J=Q[1],B=Q[2];return $*$+J*J+B*B}function TJ(Q,$){return Q[0]=-$[0],Q[1]=-$[1],Q[2]=-$[2],Q}function hJ(Q,$){return Q[0]=1/$[0],Q[1]=1/$[1],Q[2]=1/$[2],Q}function d0(Q,$){var J=$[0],B=$[1],Y=$[2],K=J*J+B*B+Y*Y;if(K>0)K=1/Math.sqrt(K);return Q[0]=$[0]*K,Q[1]=$[1]*K,Q[2]=$[2]*K,Q}function _0(Q,$){return Q[0]*$[0]+Q[1]*$[1]+Q[2]*$[2]}function B0(Q,$,J){var B=$[0],Y=$[1],K=$[2],Z=J[0],V=J[1],H=J[2];return Q[0]=Y*H-K*V,Q[1]=K*Z-B*H,Q[2]=B*V-Y*Z,Q}function SJ(Q,$,J,B){var Y=$[0],K=$[1],Z=$[2];return Q[0]=Y+B*(J[0]-Y),Q[1]=K+B*(J[1]-K),Q[2]=Z+B*(J[2]-Z),Q}function wJ(Q,$,J,B,Y,K){var Z=K*K,V=Z*(2*K-3)+1,H=Z*(K-2)+K,X=Z*(K-1),F=Z*(3-2*K);return Q[0]=$[0]*V+J[0]*H+B[0]*X+Y[0]*F,Q[1]=$[1]*V+J[1]*H+B[1]*X+Y[1]*F,Q[2]=$[2]*V+J[2]*H+B[2]*X+Y[2]*F,Q}function IJ(Q,$,J,B,Y,K){var Z=1-K,V=Z*Z,H=K*K,X=V*Z,F=3*K*V,W=3*H*Z,O=H*K;return Q[0]=$[0]*X+J[0]*F+B[0]*W+Y[0]*O,Q[1]=$[1]*X+J[1]*F+B[1]*W+Y[1]*O,Q[2]=$[2]*X+J[2]*F+B[2]*W+Y[2]*O,Q}function vJ(Q,$){$=$||1;var J=l()*2*Math.PI,B=l()*2-1,Y=Math.sqrt(1-B*B)*$;return Q[0]=Math.cos(J)*Y,Q[1]=Math.sin(J)*Y,Q[2]=B*$,Q}function zJ(Q,$,J){var B=$[0],Y=$[1],K=$[2],Z=J[3]*B+J[7]*Y+J[11]*K+J[15];return Z=Z||1,Q[0]=(J[0]*B+J[4]*Y+J[8]*K+J[12])/Z,Q[1]=(J[1]*B+J[5]*Y+J[9]*K+J[13])/Z,Q[2]=(J[2]*B+J[6]*Y+J[10]*K+J[14])/Z,Q}function fJ(Q,$,J){var B=$[0],Y=$[1],K=$[2];return Q[0]=B*J[0]+Y*J[3]+K*J[6],Q[1]=B*J[1]+Y*J[4]+K*J[7],Q[2]=B*J[2]+Y*J[5]+K*J[8],Q}function gJ(Q,$,J){var B=J[0],Y=J[1],K=J[2],Z=J[3],V=$[0],H=$[1],X=$[2],F=Y*X-K*H,W=K*V-B*X,O=B*H-Y*V,P=Y*O-K*W,N=K*F-B*O,U=B*W-Y*F,j=Z*2;return F*=j,W*=j,O*=j,P*=2,N*=2,U*=2,Q[0]=V+F+P,Q[1]=H+W+N,Q[2]=X+O+U,Q}function yJ(Q,$,J,B){var Y=[],K=[];return Y[0]=$[0]-J[0],Y[1]=$[1]-J[1],Y[2]=$[2]-J[2],K[0]=Y[0],K[1]=Y[1]*Math.cos(B)-Y[2]*Math.sin(B),K[2]=Y[1]*Math.sin(B)+Y[2]*Math.cos(B),Q[0]=K[0]+J[0],Q[1]=K[1]+J[1],Q[2]=K[2]+J[2],Q}function pJ(Q,$,J,B){var Y=[],K=[];return Y[0]=$[0]-J[0],Y[1]=$[1]-J[1],Y[2]=$[2]-J[2],K[0]=Y[2]*Math.sin(B)+Y[0]*Math.cos(B),K[1]=Y[1],K[2]=Y[2]*Math.cos(B)-Y[0]*Math.sin(B),Q[0]=K[0]+J[0],Q[1]=K[1]+J[1],Q[2]=K[2]+J[2],Q}function xJ(Q,$,J,B){var Y=[],K=[];return Y[0]=$[0]-J[0],Y[1]=$[1]-J[1],Y[2]=$[2]-J[2],K[0]=Y[0]*Math.cos(B)-Y[1]*Math.sin(B),K[1]=Y[0]*Math.sin(B)+Y[1]*Math.cos(B),K[2]=Y[2],Q[0]=K[0]+J[0],Q[1]=K[1]+J[1],Q[2]=K[2]+J[2],Q}function mJ(Q,$){var J=Q[0],B=Q[1],Y=Q[2],K=$[0],Z=$[1],V=$[2],H=Math.sqrt(J*J+B*B+Y*Y),X=Math.sqrt(K*K+Z*Z+V*V),F=H*X,W=F&&_0(Q,$)/F;return Math.acos(Math.min(Math.max(W,-1),1))}function cJ(Q){return Q[0]=0,Q[1]=0,Q[2]=0,Q}function nJ(Q){return"vec3("+Q[0]+", "+Q[1]+", "+Q[2]+")"}function lJ(Q,$){return Q[0]===$[0]&&Q[1]===$[1]&&Q[2]===$[2]}function dJ(Q,$){var J=Q[0],B=Q[1],Y=Q[2],K=$[0],Z=$[1],V=$[2];return Math.abs(J-K)<=G*Math.max(1,Math.abs(J),Math.abs(K))&&Math.abs(B-Z)<=G*Math.max(1,Math.abs(B),Math.abs(Z))&&Math.abs(Y-V)<=G*Math.max(1,Math.abs(Y),Math.abs(V))}var bJ=yQ,iJ=pQ,sJ=xQ,rJ=mQ,eJ=cQ,b0=gQ,uJ=nQ,oJ=function(){var Q=A0();return function($,J,B,Y,K,Z){var V,H;if(!J)J=3;if(!B)B=0;if(Y)H=Math.min(Y*J+B,$.length);else H=$.length;for(V=B;V<H;V+=J)Q[0]=$[V],Q[1]=$[V+1],Q[2]=$[V+2],K(Q,Q,Z),$[V]=Q[0],$[V+1]=Q[1],$[V+2]=Q[2];return $}}();function aJ(){var Q=new T(4);if(T!=Float32Array)Q[0]=0,Q[1]=0,Q[2]=0,Q[3]=0;return Q}function lQ(Q){var $=new T(4);return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$[3]=Q[3],$}function dQ(Q,$,J,B){var Y=new T(4);return Y[0]=Q,Y[1]=$,Y[2]=J,Y[3]=B,Y}function bQ(Q,$){return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q[3]=$[3],Q}function iQ(Q,$,J,B,Y){return Q[0]=$,Q[1]=J,Q[2]=B,Q[3]=Y,Q}function sQ(Q,$,J){return Q[0]=$[0]+J[0],Q[1]=$[1]+J[1],Q[2]=$[2]+J[2],Q[3]=$[3]+J[3],Q}function rQ(Q,$,J){return Q[0]=$[0]*J,Q[1]=$[1]*J,Q[2]=$[2]*J,Q[3]=$[3]*J,Q}function eQ(Q){var $=Q[0],J=Q[1],B=Q[2],Y=Q[3];return Math.hypot($,J,B,Y)}function uQ(Q){var $=Q[0],J=Q[1],B=Q[2],Y=Q[3];return $*$+J*J+B*B+Y*Y}function oQ(Q,$){var J=$[0],B=$[1],Y=$[2],K=$[3],Z=J*J+B*B+Y*Y+K*K;if(Z>0)Z=1/Math.sqrt(Z);return Q[0]=J*Z,Q[1]=B*Z,Q[2]=Y*Z,Q[3]=K*Z,Q}function aQ(Q,$){return Q[0]*$[0]+Q[1]*$[1]+Q[2]*$[2]+Q[3]*$[3]}function tQ(Q,$,J,B){var Y=$[0],K=$[1],Z=$[2],V=$[3];return Q[0]=Y+B*(J[0]-Y),Q[1]=K+B*(J[1]-K),Q[2]=Z+B*(J[2]-Z),Q[3]=V+B*(J[3]-V),Q}function Q$(Q,$){return Q[0]===$[0]&&Q[1]===$[1]&&Q[2]===$[2]&&Q[3]===$[3]}function $$(Q,$){var J=Q[0],B=Q[1],Y=Q[2],K=Q[3],Z=$[0],V=$[1],H=$[2],X=$[3];return Math.abs(J-Z)<=G*Math.max(1,Math.abs(J),Math.abs(Z))&&Math.abs(B-V)<=G*Math.max(1,Math.abs(B),Math.abs(V))&&Math.abs(Y-H)<=G*Math.max(1,Math.abs(Y),Math.abs(H))&&Math.abs(K-X)<=G*Math.max(1,Math.abs(K),Math.abs(X))}var zB=function(){var Q=aJ();return function($,J,B,Y,K,Z){var V,H;if(!J)J=4;if(!B)B=0;if(Y)H=Math.min(Y*J+B,$.length);else H=$.length;for(V=B;V<H;V+=J)Q[0]=$[V],Q[1]=$[V+1],Q[2]=$[V+2],Q[3]=$[V+3],K(Q,Q,Z),$[V]=Q[0],$[V+1]=Q[1],$[V+2]=Q[2],$[V+3]=Q[3];return $}}();function i0(){var Q=new T(4);if(T!=Float32Array)Q[0]=0,Q[1]=0,Q[2]=0;return Q[3]=1,Q}function Q8(Q){return Q[0]=0,Q[1]=0,Q[2]=0,Q[3]=1,Q}function J$(Q,$,J){J=J*0.5;var B=Math.sin(J);return Q[0]=B*$[0],Q[1]=B*$[1],Q[2]=B*$[2],Q[3]=Math.cos(J),Q}function $8(Q,$){var J=Math.acos($[3])*2,B=Math.sin(J/2);if(B>G)Q[0]=$[0]/B,Q[1]=$[1]/B,Q[2]=$[2]/B;else Q[0]=1,Q[1]=0,Q[2]=0;return J}function J8(Q,$){var J=H$(Q,$);return Math.acos(2*J*J-1)}function B$(Q,$,J){var B=$[0],Y=$[1],K=$[2],Z=$[3],V=J[0],H=J[1],X=J[2],F=J[3];return Q[0]=B*F+Z*V+Y*X-K*H,Q[1]=Y*F+Z*H+K*V-B*X,Q[2]=K*F+Z*X+B*H-Y*V,Q[3]=Z*F-B*V-Y*H-K*X,Q}function B8(Q,$,J){J*=0.5;var B=$[0],Y=$[1],K=$[2],Z=$[3],V=Math.sin(J),H=Math.cos(J);return Q[0]=B*H+Z*V,Q[1]=Y*H+K*V,Q[2]=K*H-Y*V,Q[3]=Z*H-B*V,Q}function Y8(Q,$,J){J*=0.5;var B=$[0],Y=$[1],K=$[2],Z=$[3],V=Math.sin(J),H=Math.cos(J);return Q[0]=B*H-K*V,Q[1]=Y*H+Z*V,Q[2]=K*H+B*V,Q[3]=Z*H-Y*V,Q}function K8(Q,$,J){J*=0.5;var B=$[0],Y=$[1],K=$[2],Z=$[3],V=Math.sin(J),H=Math.cos(J);return Q[0]=B*H+Y*V,Q[1]=Y*H-B*V,Q[2]=K*H+Z*V,Q[3]=Z*H-K*V,Q}function Z8(Q,$){var J=$[0],B=$[1],Y=$[2];return Q[0]=J,Q[1]=B,Q[2]=Y,Q[3]=Math.sqrt(Math.abs(1-J*J-B*B-Y*Y)),Q}function Y$(Q,$){var J=$[0],B=$[1],Y=$[2],K=$[3],Z=Math.sqrt(J*J+B*B+Y*Y),V=Math.exp(K),H=Z>0?V*Math.sin(Z)/Z:0;return Q[0]=J*H,Q[1]=B*H,Q[2]=Y*H,Q[3]=V*Math.cos(Z),Q}function K$(Q,$){var J=$[0],B=$[1],Y=$[2],K=$[3],Z=Math.sqrt(J*J+B*B+Y*Y),V=Z>0?Math.atan2(Z,K)/Z:0;return Q[0]=J*V,Q[1]=B*V,Q[2]=Y*V,Q[3]=0.5*Math.log(J*J+B*B+Y*Y+K*K),Q}function V8(Q,$,J){return K$(Q,$),V$(Q,Q,J),Y$(Q,Q),Q}function D0(Q,$,J,B){var Y=$[0],K=$[1],Z=$[2],V=$[3],H=J[0],X=J[1],F=J[2],W=J[3],O,P,N,U,j;if(P=Y*H+K*X+Z*F+V*W,P<0)P=-P,H=-H,X=-X,F=-F,W=-W;if(1-P>G)O=Math.acos(P),N=Math.sin(O),U=Math.sin((1-B)*O)/N,j=Math.sin(B*O)/N;else U=1-B,j=B;return Q[0]=U*Y+j*H,Q[1]=U*K+j*X,Q[2]=U*Z+j*F,Q[3]=U*V+j*W,Q}function H8(Q){var $=l(),J=l(),B=l(),Y=Math.sqrt(1-$),K=Math.sqrt($);return Q[0]=Y*Math.sin(2*Math.PI*J),Q[1]=Y*Math.cos(2*Math.PI*J),Q[2]=K*Math.sin(2*Math.PI*B),Q[3]=K*Math.cos(2*Math.PI*B),Q}function X8(Q,$){var J=$[0],B=$[1],Y=$[2],K=$[3],Z=J*J+B*B+Y*Y+K*K,V=Z?1/Z:0;return Q[0]=-J*V,Q[1]=-B*V,Q[2]=-Y*V,Q[3]=K*V,Q}function F8(Q,$){return Q[0]=-$[0],Q[1]=-$[1],Q[2]=-$[2],Q[3]=$[3],Q}function Z$(Q,$){var J=$[0]+$[4]+$[8],B;if(J>0)B=Math.sqrt(J+1),Q[3]=0.5*B,B=0.5/B,Q[0]=($[5]-$[7])*B,Q[1]=($[6]-$[2])*B,Q[2]=($[1]-$[3])*B;else{var Y=0;if($[4]>$[0])Y=1;if($[8]>$[Y*3+Y])Y=2;var K=(Y+1)%3,Z=(Y+2)%3;B=Math.sqrt($[Y*3+Y]-$[K*3+K]-$[Z*3+Z]+1),Q[Y]=0.5*B,B=0.5/B,Q[3]=($[K*3+Z]-$[Z*3+K])*B,Q[K]=($[K*3+Y]+$[Y*3+K])*B,Q[Z]=($[Z*3+Y]+$[Y*3+Z])*B}return Q}function W8(Q,$,J,B){var Y=0.5*Math.PI/180;$*=Y,J*=Y,B*=Y;var K=Math.sin($),Z=Math.cos($),V=Math.sin(J),H=Math.cos(J),X=Math.sin(B),F=Math.cos(B);return Q[0]=K*H*F-Z*V*X,Q[1]=Z*V*F+K*H*X,Q[2]=Z*H*X-K*V*F,Q[3]=Z*H*F+K*V*X,Q}function j8(Q){return"quat("+Q[0]+", "+Q[1]+", "+Q[2]+", "+Q[3]+")"}var P8=lQ,O8=dQ,U8=bQ,N8=iQ,A8=sQ,E8=B$,V$=rQ,H$=aQ,_8=tQ,X$=eQ,D8=X$,F$=uQ,R8=F$,s0=oQ,q8=Q$,G8=$$,C8=function(){var Q=A0(),$=E0(1,0,0),J=E0(0,1,0);return function(B,Y,K){var Z=_0(Y,K);if(Z<-0.999999){if(B0(Q,$,Y),b0(Q)<0.000001)B0(Q,J,Y);return d0(Q,Q),J$(B,Q,Math.PI),B}else if(Z>0.999999)return B[0]=0,B[1]=0,B[2]=0,B[3]=1,B;else return B0(Q,Y,K),B[0]=Q[0],B[1]=Q[1],B[2]=Q[2],B[3]=1+Z,s0(B,B)}}(),M8=function(){var Q=i0(),$=i0();return function(J,B,Y,K,Z,V){return D0(Q,B,Z,V),D0($,Y,K,V),D0(J,Q,$,2*V*(1-V)),J}}(),k8=function(){var Q=TQ();return function($,J,B,Y){return Q[0]=B[0],Q[3]=B[1],Q[6]=B[2],Q[1]=Y[0],Q[4]=Y[1],Q[7]=Y[2],Q[2]=-J[0],Q[5]=-J[1],Q[8]=-J[2],s0($,Z$($,Q))}}();var L8=Math.PI/90;class p{m4=Float32Array.from(k.create());constructor(){this.identity()}static create(){return new p}set(Q){return k.copy(this.m4,Q.getMatrix()),this}identity(){return k.identity(this.m4),this}invert(Q){return k.invert(this.m4,Q?.getMatrix()??this.getMatrix()),this}multiply(Q){return k.multiply(this.m4,this.m4,Q.getMatrix()),this}multiply2(Q,$){return k.multiply(this.m4,Q.getMatrix(),$.getMatrix()),this}multiply3(Q,$,J){return this.multiply2(Q,$),this.multiply(J),this}translate(Q,$,J){return k.translate(this.m4,this.m4,[Q,$,J]),this}translateToMatrix(Q){const $=Q.getMatrix();return this.translate(-$[12],-$[13],-$[14])}rotateX(Q){return k.rotateX(this.m4,this.m4,Q),this}rotateY(Q){return k.rotateY(this.m4,this.m4,Q),this}rotateZ(Q){return k.rotateZ(this.m4,this.m4,Q),this}setXRotation(Q){return k.fromXRotation(this.getMatrix(),Q),this}setYRotation(Q){return k.fromYRotation(this.getMatrix(),Q),this}scale(Q,$,J){return k.scale(this.m4,this.m4,[Q,$??Q,J??Q]),this}perspective(Q,$,J,B){return k.perspective(this.m4,Q*L8,$,J,B),this}ortho(Q,$,J,B,Y,K){return k.ortho(this.m4,Q,$,J,B,Y,K),this}static aTemp=k.create();static bTemp=k.create();combine(Q,$,J=0.5){return k.multiplyScalar(p.aTemp,Q.getMatrix(),1-J),k.multiplyScalar(p.bTemp,$.getMatrix(),J),k.add(this.m4,p.aTemp,p.bTemp),this}static tempQuat=d.create();static tempVec=r.create();moveMatrix(Q,$,J,B){const Y=p.tempVec;if(Y[0]=Q,Y[1]=$,Y[2]=J,B)k.getRotation(p.tempQuat,B.getMatrix()),d.invert(p.tempQuat,p.tempQuat),r.transformQuat(Y,Y,p.tempQuat);return k.translate(this.m4,this.m4,Y),this}getRotationAngle(){return k.getRotation(p.tempQuat,this.getMatrix()),d.getAngle(d.create(),p.tempQuat)}getMatrix(){return this.m4}}var L=p;class r0{baseMatrix=L.create();perspectiveMatrix=L.create();orthoMatrix=L.create();perspectiveLevel=1;configPerspectiveMatrix(Q){this.perspectiveMatrix.perspective(45,Q,0.01,1e5)}configOrthoMatrix(Q){this.orthoMatrix.ortho(-Q,Q,-1,1,-1e5,1e5)}configure(Q,$){const J=Q/$;this.configPerspectiveMatrix(J),this.configOrthoMatrix(J)}setPerspective(Q){this.perspectiveLevel=Q}getMatrix(){return this.baseMatrix.combine(this.orthoMatrix,this.perspectiveMatrix,this.perspectiveLevel),this.baseMatrix.getMatrix()}}function e(Q){return(Q+Math.PI)%(2*Math.PI)-Math.PI}function b(Q,$){return Math.round(Q/$)*$}class e0{Q;$;J;goal;active=!1;speed=0;locker;constructor(Q,$,J){this.element=Q;this.getValue=$;this.apply=J;this.goal=this.getValue(Q)}setGoal(Q,$,J){if(this.locker&&this.locker!==J)return;if(this.goal!==Q||this.speed!==$)this.speed=$,this.goal=Q,this.locker=J,this.active=!0}update(Q){if(this.active){const $=this.getValue(this.element),J=this.goal-$,B=Math.min(Math.abs(J),this.speed*Q);if(B<=0.01)this.apply(this.element,this.goal),this.active=!1,this.locker=void 0;else this.apply(this.element,$+B*Math.sign(J))}return this.active}}class u0{Q;matrix=L.create();_tilt=0;progressiveTilt;constructor(Q){this.onChange=Q;this.progressiveTilt=new e0(this,($)=>$.tilt,($,J)=>$.tilt=J)}get tilt(){return this._tilt}set tilt(Q){this._tilt=e(Q),this.matrix.setXRotation(this._tilt),this.onChange?.()}getMatrix(){return this.matrix.getMatrix()}}class o0{Q;matrix=L.create();_turn=0;constructor(Q){this.onChange=Q}get turn(){return this._turn}set turn(Q){this._turn=e(Q),this.matrix.setYRotation(this._turn),this.onChange?.()}getMatrix(){return this.matrix.getMatrix()}}class a0{Q;$;J;updatedTypes=new Set;constructor(Q,$,J){this.getCameraMatrix=Q;this.engine=$;this.motor=J}informUpdate(Q){this.motor.registerUpdate(this.withCameraType(Q))}withCameraType(Q){return this.updatedTypes.add(Q),this}refresh(){this.updatedTypes.forEach((Q)=>this.engine.updateCameraMatrix(Q,this.getCameraMatrix(Q)))}}class t0{Q;$;J;updatedTypes=new Set;constructor(Q,$,J){this.getCameraFloat=Q;this.engine=$;this.motor=J}informUpdate(Q){this.motor.registerUpdate(this.withCameraType(Q))}withCameraType(Q){return this.updatedTypes.add(Q),this}refresh(){this.updatedTypes.forEach((Q)=>this.engine.updateCameraFloat(Q,this.getCameraFloat(Q)))}}var h;(function(Y){Y[Y["PROJECTION"]=0]="PROJECTION";Y[Y["POS"]=1]="POS";Y[Y["TURN"]=2]="TURN";Y[Y["TILT"]=3]="TILT"})(h||(h={}));var u;(function($){$[$["CURVATURE"]=0]="CURVATURE"})(u||(u={}));class i{positionMatrix=L.create().translate(0,0,0);camMatrix=L.create();projectionMatrix=new r0;tiltMatrix=new u0(()=>this.updateInformer.informUpdate(h.TILT));turnMatrix=new o0(()=>this.updateInformer.informUpdate(h.TURN));pespectiveLevel=1;curvature=0;updateInformer;updateInformerFloat;constructor({engine:Q,motor:$}){this.updateInformer=new a0(this.getCameraMatrix.bind(this),Q,$),this.updateInformerFloat=new t0(this.getCameraFloat.bind(this),Q,$)}activate(){this.updatePerspective(),this.updateInformer.informUpdate(h.POS),this.updateInformer.informUpdate(h.TURN),this.updateInformer.informUpdate(h.TILT)}cameraMatrices={[h.PROJECTION]:this.projectionMatrix,[h.POS]:this.camMatrix,[h.TURN]:this.turnMatrix,[h.TILT]:this.tiltMatrix};configProjectionMatrix(Q,$){this.projectionMatrix.configure(Q,$),this.updateInformer.informUpdate(h.PROJECTION)}updatePerspective(Q){this.projectionMatrix.setPerspective(Q??this.pespectiveLevel),this.updateInformer.informUpdate(h.PROJECTION)}updateCurvature(Q){this.curvature=Q,this.updateInformerFloat.informUpdate(u.CURVATURE)}getCameraMatrix(Q){if(Q===h.POS)this.camMatrix.invert(this.positionMatrix);return this.cameraMatrices[Q].getMatrix()}getCameraFloat(Q){switch(Q){case u.CURVATURE:return this.curvature}}gotoPos(Q,$,J,B=0.1){const Y=this.getPosition(),K=Q-Y[0],Z=$-Y[1],V=J-Y[2],H=Math.sqrt(K*K+Z*Z+V*V);if(H){const X=Math.min(H,B);this.positionMatrix.translate(K/H*X,Z/H*X,V/H*X),this.updateInformer.informUpdate(h.POS)}}moveCam(Q,$,J){this.positionMatrix.moveMatrix(Q,$,J,this.turnMatrix),this.updateInformer.informUpdate(h.POS)}turn(Q){this.turnMatrix.turn+=Q}tilt(Q){this.tiltMatrix.tilt+=Q}static _position=[0,0,0];getPosition(){const Q=this.positionMatrix.getMatrix();return i._position[0]=Q[12],i._position[1]=Q[13],i._position[2]=Q[14],i._position}setPosition(Q,$,J){const B=this.positionMatrix.getMatrix();B[12]=Q,B[13]=$,B[14]=J,this.updateInformer.informUpdate(h.POS)}}var w8=function(Q){if(!S8)return Q;return new Proxy(Q,{get(J,B){const Y=J,K=Y[B];if(typeof K==="function")return(...V)=>{const H=K.apply(Y,V);return console.log(`gl.${String(B)}(`,V,") = ",H),H};else return console.log(`gl.${String(B)} = `,K),K}})},T8={alpha:!0,antialias:!1,depth:!0,desynchronized:!0,failIfMajorPerformanceCaveat:void 0,powerPreference:"default",premultipliedAlpha:!0,preserveDrawingBuffer:!1,stencil:!1},h8=6,S8=!1;class R0 extends v{gl;programs;attributeBuffers;uniforms;canvas;textureManager;imageManager;textureSlots={};onResize=new Set;pixelListeners=new Set;spriteCount=0;cameraMatrixUniforms={};cameraFloatUniforms={};constructor(Q,{attributes:$}={}){super();const J=Q.getContext("webgl2",{...T8,...$});this.gl=w8(J),this.canvas=Q,this.programs=this.own(new z0(this.gl)),this.uniforms=this.own(new y0(this.gl,this.programs)),this.attributeBuffers=this.own(new g0(this.gl,this.programs)),this.textureManager=new c0(this.gl,this.uniforms),this.imageManager=new n0;const B=this.checkCanvasSize.bind(this);window.addEventListener("resize",B),this.addOnDestroy(()=>window.removeEventListener("resize",B)),this.initialize()}addResizeListener(Q){return Q(this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.onResize.add(Q),()=>this.removeResizeListener(Q)}removeResizeListener(Q){this.onResize.delete(Q)}clearTextureSlots(){for(let Q in this.textureSlots)delete this.textureSlots[Q]}checkCanvasSize(){if(this.canvas instanceof HTMLCanvasElement)this.canvas.width=this.canvas.offsetWidth*2,this.canvas.height=this.canvas.offsetHeight*2;this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.onResize.forEach((Q)=>Q(this.gl.drawingBufferWidth,this.gl.drawingBufferHeight))}initialize(){const $={AUTHOR:"Jack le hamster"};this.programs.addProgram("main",l0(kQ,$),l0(LQ,$)),this.programs.useProgram("main"),this.cameraMatrixUniforms[h.PROJECTION]=this.uniforms.getUniformLocation(DQ,"main"),this.cameraMatrixUniforms[h.POS]=this.uniforms.getUniformLocation(AQ,"main"),this.cameraMatrixUniforms[h.TURN]=this.uniforms.getUniformLocation(_Q,"main"),this.cameraMatrixUniforms[h.TILT]=this.uniforms.getUniformLocation(EQ,"main"),this.cameraFloatUniforms[u.CURVATURE]=this.uniforms.getUniformLocation(RQ,"main"),this.gl.enable(A.DEPTH_TEST),this.gl.depthFunc(A.LESS),this.gl.clearDepth(1),this.gl.enable(A.BLEND),this.gl.blendFunc(A.SRC_ALPHA,A.ONE_MINUS_SRC_ALPHA),this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.gl.disable(this.gl.CULL_FACE),this.gl.clearColor(0,0,0,1),this.textureManager.initialize(),this.checkCanvasSize()}activate(){this.clearTextureSlots()}setMaxSpriteCount(Q){this.initializeBuffers(Q)}onCleanupBuffers=new Set;initializeBuffers(Q){if(this.onCleanupBuffers.forEach(($)=>$()),this.onCleanupBuffers.clear(),Q)[this.initializeIndexBuffer(NQ),this.initializePositionBuffer(UQ),this.initializeTransformBuffer(S0,Q),this.initializeSlotSizeBuffer(w0,Q),this.initializeInstanceBuffer(I0,Q),this.initializeFlagBuffer(I0,Q)].forEach((J)=>this.onCleanupBuffers.add(J))}initializeIndexBuffer(Q){const $=this.attributeBuffers.createBuffer(Q);return this.gl.bindBuffer(A.ELEMENT_ARRAY_BUFFER,$.buffer),this.gl.bufferData(A.ELEMENT_ARRAY_BUFFER,Uint16Array.from([0,1,2,2,3,0]),A.STATIC_DRAW),()=>{this.attributeBuffers.deleteBuffer(Q)}}initializePositionBuffer(Q){const $=this.attributeBuffers.createBuffer(Q);return this.gl.bindBuffer(A.ARRAY_BUFFER,$.buffer),this.gl.vertexAttribPointer($.location,2,A.FLOAT,!1,0,0),this.gl.enableVertexAttribArray($.location),this.gl.bufferData(A.ARRAY_BUFFER,Float32Array.from([-1,-1,1,-1,1,1,-1,1]),A.STATIC_DRAW),()=>{this.gl.disableVertexAttribArray($.location),this.attributeBuffers.deleteBuffer(Q)}}initializeTransformBuffer(Q,$){const J=this.attributeBuffers.createBuffer(Q);this.gl.bindBuffer(A.ARRAY_BUFFER,J.buffer);const B=4,Y=B*Float32Array.BYTES_PER_ELEMENT,K=4*Y;for(let Z=0;Z<4;Z++){const V=J.location+Z;this.gl.vertexAttribPointer(V,B,A.FLOAT,!1,K,Z*Y),this.gl.enableVertexAttribArray(V),this.gl.vertexAttribDivisor(V,1)}return this.gl.bufferData(A.ARRAY_BUFFER,$*K,A.DYNAMIC_DRAW),()=>{this.gl.disableVertexAttribArray(J.location),this.attributeBuffers.deleteBuffer(Q)}}initializeSlotSizeBuffer(Q,$){const J=this.attributeBuffers.createBuffer(Q);this.gl.bindBuffer(A.ARRAY_BUFFER,J.buffer);const B=J.location,Y=2,K=Y*Float32Array.BYTES_PER_ELEMENT;return this.gl.vertexAttribPointer(B,Y,A.FLOAT,!1,K,0),this.gl.enableVertexAttribArray(B),this.gl.vertexAttribDivisor(B,1),this.gl.bufferData(A.ARRAY_BUFFER,$*K,A.DYNAMIC_DRAW),()=>{this.gl.disableVertexAttribArray(J.location),this.attributeBuffers.deleteBuffer(Q)}}initializeInstanceBuffer(Q,$){const J=this.attributeBuffers.createBuffer(Q);this.gl.bindBuffer(A.ARRAY_BUFFER,J.buffer);const B=J.location,Y=1;return this.gl.vertexAttribPointer(B,Y,A.FLOAT,!1,Y*Float32Array.BYTES_PER_ELEMENT,0),this.gl.enableVertexAttribArray(B),this.gl.vertexAttribDivisor(B,1),this.gl.bufferData(A.ARRAY_BUFFER,Float32Array.from(new Array($).fill(null).map((K,Z)=>Z)),A.STATIC_DRAW),()=>{this.gl.disableVertexAttribArray(J.location),this.attributeBuffers.deleteBuffer(Q)}}initializeFlagBuffer(Q,$){const J=this.attributeBuffers.createBuffer(Q);this.gl.bindBuffer(A.ARRAY_BUFFER,J.buffer);const B=J.location,Y=1,K=Y*Float32Array.BYTES_PER_ELEMENT;return this.gl.vertexAttribPointer(B,Y,A.FLOAT,!1,K,0),this.gl.enableVertexAttribArray(B),this.gl.vertexAttribDivisor(B,1),this.gl.bufferData(A.ARRAY_BUFFER,$*K,A.STATIC_DRAW),()=>{this.gl.disableVertexAttribArray(J.location),this.attributeBuffers.deleteBuffer(Q)}}async updateTextures(Q,$){const J=(await Promise.all(Q.map(async(K)=>{const Z=$(K);if(!Z){console.warn(`No media for imageId ${K}`);return}return{mediaData:await this.imageManager.renderMedia(K,Z),imageId:K}}))).filter((K)=>!!K),B=await Promise.all(J.map(async({mediaData:K,imageId:Z})=>{const{slot:V,refreshCallback:H}=this.textureManager.allocateSlotForImage(K),X=Math.log2(V.size[0]),F=Math.log2(V.size[1]),W=X*16+F;return this.textureSlots[Z]={buffer:Float32Array.from([W,V.slotNumber])},K.refreshCallback=H,V.textureIndex}));return new Set(B).forEach((K)=>{if(K===N0)this.textureManager.setupTextureForVideo(`TEXTURE${K}`);else this.textureManager.generateMipMap(`TEXTURE${K}`)}),J.map(({mediaData:K})=>K)}drawElementsInstanced(Q,$){this.gl.drawElementsInstanced(A.TRIANGLES,Q,A.UNSIGNED_SHORT,0,$)}static spriteMatrix=L.create();updateSpriteTransforms(Q,$){const J=this.attributeBuffers.getAttributeBuffer(S0);this.gl.bindBuffer(A.ARRAY_BUFFER,J.buffer);let B=this.spriteCount-1;Q.forEach((Y)=>{const K=R0.spriteMatrix.identity().getMatrix(),Z=$(Y);if(Z?.transforms.forEach((V)=>k.multiply(K,K,V)),this.gl.bufferSubData(A.ARRAY_BUFFER,16*Float32Array.BYTES_PER_ELEMENT*Y,K),Z)B=Math.max(B,Y)}),Q.clear();while(B>=0&&!$(B))B--;this.spriteCount=Math.max(this.spriteCount,B+1)}updateSpriteAnims(Q,$){const J=this.attributeBuffers.getAttributeBuffer(w0);this.gl.bindBuffer(A.ARRAY_BUFFER,J.buffer),Q.forEach((B)=>{const Y=$(B),K=this.textureSlots[Y?.imageId??-1];if(K){const{buffer:Z}=K;this.gl.bufferSubData(A.ARRAY_BUFFER,2*Float32Array.BYTES_PER_ELEMENT*B,Z),Q.delete(B)}})}updateCameraMatrix(Q,$){this.gl.uniformMatrix4fv(this.cameraMatrixUniforms[Q],!1,$)}updateCameraFloat(Q,$){this.gl.uniform1f(this.cameraFloatUniforms[Q],$)}bindVertexArray(){return this.own(new f0(this.gl))}addPixelListener(Q){return this.pixelListeners.add(Q),()=>{this.removePixelListener(Q)}}removePixelListener(Q){this.pixelListeners.delete(Q)}_pixel=new Uint8Array(4);getPixel(Q,$){this.gl.readPixels(Q,$,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this._pixel);const[J,B,Y,K]=this._pixel;return J*65536+B*256+Y}refresh(){this.gl.clear(A.COLOR_BUFFER_BIT),this.drawElementsInstanced(h8,this.spriteCount);for(let Q of this.pixelListeners)Q.pixel=this.getPixel(Q.x,Q.y)}}var I8=50,QQ;(function(J){J[J["DEFAULT"]=0]="DEFAULT";J[J["LAST"]=1]="LAST"})(QQ||(QQ={}));class $Q{updateSchedule=new Map;time=0;loop(Q,$,J,B){return this.registerUpdate(Q,{period:$?1000/$:1,expirationTime:B,priority:J})}registerUpdate(Q,$={}){return $.triggerTime=$.triggerTime??this.time,$.expirationTime=$.expirationTime??Infinity,$.period=$.period,$.priority=$.priority??QQ.DEFAULT,this.updateSchedule.set(Q,$),()=>this.deregisterUpdate(Q)}deregisterUpdate(Q){this.updateSchedule.delete(Q)}activate(){let Q=0;const $={time:0,deltaTime:0},J=[],B=[],Y=[J,B],K=(Z)=>{$.deltaTime=Math.min(Z-$.time,I8),$.time=Z,Q=requestAnimationFrame(K),this.time=Z,J.length=0,B.length=0,this.updateSchedule.forEach((V,H)=>{if(Z<V.triggerTime)return;if(Y[V.priority].push(H),V.period&&Z<V.expirationTime)V.triggerTime=Math.max(V.triggerTime+V.period,Z);else this.updateSchedule.delete(H)}),Y.forEach((V)=>V.forEach((H)=>H.refresh($)))};return requestAnimationFrame(K),()=>cancelAnimationFrame(Q)}}var v8=200;class JQ{Q;keys={};keysUp={};keyListener=new Set;isActive=!1;constructor(Q){this.timeProvider=Q;this.keyDown=this.keyDown.bind(this),this.keyUp=this.keyUp.bind(this)}keyDown(Q){if(!this.keys[Q.code])this.keys[Q.code]=this.timeProvider.time,this.keyListener.forEach(($)=>$.onKeyDown?.(Q.code,this.timeProvider.time));Q.preventDefault()}keyUp(Q){const $=this.timeProvider.time-this.keys[Q.code]<v8;if(this.keysUp[Q.code]=this.timeProvider.time,this.keys[Q.code]=0,this.keyListener.forEach((J)=>J.onKeyUp?.(Q.code,this.timeProvider.time)),$)this.keyListener.forEach((J)=>J.onQuickTap?.(Q.code,this.timeProvider.time))}activate(){return this.setActive(!0),()=>this.setActive(!1)}setActive(Q){if(this.isActive!==Q){if(this.isActive=Q,document.removeEventListener("keydown",this.keyDown),document.removeEventListener("keyup",this.keyUp),this.isActive)document.addEventListener("keydown",this.keyDown),document.addEventListener("keyup",this.keyUp)}}addListener(Q){return this.keyListener.add(Q),()=>{this.removeListener(Q)}}removeListener(Q){this.keyListener.delete(Q)}}class BQ{engine;camera;constructor({engine:Q,camera:$}){this.engine=Q,this.camera=$}activate(){return this.handleResize()}handleResize(){const{engine:Q}=this,$=(J,B)=>{this.camera.configProjectionMatrix(J,B)};return Q.addResizeListener($)}}class YQ extends t{motor;engine;keyboard;camera;constructor({motor:Q,canvas:$,engine:J,keyboard:B,size:Y,camera:K}){super();this.motor=Q??new $Q,this.engine=J??new R0($??new OffscreenCanvas(Y[0],Y[1])),this.keyboard=B??new JQ(this.motor),this.camera=K??new i(this)}start(Q){const{motor:$,engine:J,keyboard:B,camera:Y}=this,K=$.loop(this);J.setMaxSpriteCount(Q.sprites.length),this.addAuxiliary(Q,$,J,B,Y,new BQ(this));const Z=this.activate();return()=>{K(),Z(),this.deactivate(),this.removeAllAuxiliaries()}}}function KQ(Q,$){for(let J=0;J<Q.length;J++){const B=Q.at(J);if(B)$(B,J)}}function Y0(Q,$){const J=[];for(let B=0;B<Q.length;B++){const Y=Q.at(B);J.push(Y?$(Y,B):void 0)}return J}class K0{Q;active=!1;constructor(Q){this.auxiliaries=Q}static from(...Q){return new K0(Q)}get length(){return this.auxiliaries.length}at(Q){return this.auxiliaries.at(Q)}refresh(Q){KQ(this.auxiliaries,($)=>$.refresh?.(Q))}activate(){if(!this.active){this.active=!0;const Q=Y0(this.auxiliaries,($)=>$.activate?.());return()=>Q.forEach(($)=>$?.())}}deactivate(){if(this.active)this.active=!1,KQ(this.auxiliaries,(Q)=>Q.deactivate?.())}}class ZQ{keyboard;camera;constructor(Q){this.keyboard=Q.keyboard,this.camera=Q.camera}refresh(Q){const{keys:$}=this.keyboard,{deltaTime:J}=Q,B=J/80,Y=J/400;if($.KeyW||$.ArrowUp&&!$.ShiftRight)this.camera.moveCam(0,0,-B);if($.KeyS||$.ArrowDown&&!$.ShiftRight)this.camera.moveCam(0,0,B);if($.KeyA||$.ArrowLeft&&!$.ShiftRight)this.camera.moveCam(-B,0,0);if($.KeyD||$.ArrowRight&&!$.ShiftRight)this.camera.moveCam(B,0,0);if($.KeyQ||$.ArrowLeft&&$.ShiftRight)this.camera.turn(-Y);if($.KeyE||$.ArrowRight&&$.ShiftRight)this.camera.turn(Y);if($.ArrowUp&&$.ShiftRight)this.camera.tilt(-Y);if($.ArrowDown&&$.ShiftRight)this.camera.tilt(Y)}}class VQ{keyboard;camera;goal;stepCount=0;turnCount=0;tiltCount=0;config;constructor({keyboard:Q,camera:$},J={}){this.keyboard=Q,this.camera=$;const B=this.camera.getPosition();this.goal={turn:this.camera.turnMatrix.turn,pos:[...B]},this.config={step:J.step??2,turnStep:J.turnStep??Math.PI/2,tiltStep:J.tiltStep??Math.PI/2}}prePos=[0,0,0];refresh(Q){const{keys:$}=this.keyboard,{deltaTime:J}=Q,B=this.camera.getPosition(),{step:Y,turnStep:K,tiltStep:Z}=this.config;this.prePos[0]=Math.round(B[0]/Y)*Y,this.prePos[1]=Math.round(B[1]/Y)*Y,this.prePos[2]=Math.round(B[2]/Y)*Y;let V=0,H=0;if($.KeyW||$.ArrowUp&&!$.ShiftRight)H--;if($.KeyS||$.ArrowDown&&!$.ShiftRight)H++;if($.KeyA||$.ArrowLeft&&!$.ShiftRight)V--;if($.KeyD||$.ArrowRight&&!$.ShiftRight)V++;if(V||H||this.stepCount>0){const _=V*Math.cos(this.goal.turn)-H*Math.sin(this.goal.turn),D=V*Math.sin(this.goal.turn)+H*Math.cos(this.goal.turn),R=Math.round(B[0]/Y+_)*Y,q=Math.round(B[2]/Y+D)*Y;this.goal.pos[0]=R,this.goal.pos[2]=q}if(!V&&!H)this.stepCount=0;const X=V||H?J/150:J/100;this.camera.gotoPos(this.goal.pos[0],B[1],this.goal.pos[2],X);const F=this.camera.getPosition();if(Math.round(F[0]/Y)*Y!==this.prePos[0]||Math.round(F[1]/Y)*Y!==this.prePos[1]||Math.round(F[2]/Y)*Y!==this.prePos[2])this.stepCount++;let W=0;if($.KeyQ||$.ArrowLeft&&$.ShiftRight)W--;if($.KeyE||$.ArrowRight&&$.ShiftRight)W++;const O=this.camera.turnMatrix.turn,P=b(O,K);if(W||this.turnCount>0)this.goal.turn=b(O+K*W,K);if(!W)this.turnCount=0;const N=W?J/200:J/100;let U=e(this.goal.turn-O);if(U){const _=Math.abs(U);if(this.camera.turnMatrix.turn=_<0.01?this.goal.turn:O+Math.sign(U)*Math.min(N,_),b(this.camera.turnMatrix.turn,K)!==P)this.turnCount++}let j=0;if($.ArrowUp&&$.ShiftRight)j--;if($.ArrowDown&&$.ShiftRight)j++;const E=this.camera.tiltMatrix.tilt,C=b(E,Z);if(j||this.tiltCount>0)this.camera.tiltMatrix.progressiveTilt.setGoal(b(E+Z*j,Z),j?0.0025:0.005,this);if(!j)this.tiltCount=0;if(this.camera.tiltMatrix.progressiveTilt.update(J)){if(b(this.camera.tiltMatrix.tilt,Z)!==C)this.tiltCount++}}}class q0{keyboard;camera;key;resetting=!1;constructor(Q,$){this.keyboard=Q.keyboard,this.camera=Q.camera,this.key=$.key}activate(){const Q=this.keyboard.addListener({onQuickTap:($)=>{if($===this.key)this.resetting=!0,this.camera.tiltMatrix.progressiveTilt.setGoal(0,0.0033333333333333335,this)}});return()=>Q()}refresh(Q){if(this.resetting){const{deltaTime:$}=Q;if(!this.camera.tiltMatrix.progressiveTilt.update($))this.resetting=!1}}}class HQ{keyboard;camera;key;gravity;dy;jumpStrength=0;plane=1;constructor({keyboard:Q,camera:$},J={}){this.keyboard=Q,this.camera=$,this.key=J.key??"Space",this.gravity=J.gravity??-1,this.jumpStrength=J.jump??2,this.plane=J.plane??10,this.dy=0}refresh(Q){const{deltaTime:$}=Q;this.jump($,this.keyboard)}jump(Q,$){const J=Q/80,B=Q/80,{keys:Y}=$,[K,Z,V]=this.camera.getPosition();if(Z===0){if(Y[this.key])this.dy=this.jumpStrength,this.camera.moveCam(0,J*this.dy,0)}else{this.camera.moveCam(0,J*this.dy,0);const[H,X,F]=this.camera.getPosition();if(X>0){const W=this.dy<0?1/this.plane:1;this.dy+=this.gravity*B*W}else this.camera.setPosition(H,0,F),this.dy=0}}}class XQ{keyboard;camera;key;dropping=!1;constructor({keyboard:Q,camera:$},J={key:"Space"}){this.keyboard=Q,this.camera=$,this.key=J.key}activate(){const Q=this.keyboard.addListener({onQuickTap:($)=>{if($===this.key)this.dropping=!0}});return()=>Q()}refresh(Q){const{deltaTime:$}=Q;this.riseAndDrop($,this.keyboard)}riseAndDrop(Q,$){const J=Q/80,{keys:B}=$;if(B[this.key])this.camera.moveCam(0,J,0);else if(this.dropping){this.camera.moveCam(0,-J,0);const[Y,K,Z]=this.camera.getPosition();if(K<0)this.camera.setPosition(Y,0,Z),this.dropping=!1}}}class FQ{keyboard;active=!1;toggleIndex=0;pendingDeactivate;keys;auxiliaries;constructor({keyboard:Q},$){this.keyboard=Q,this.keys=Y0($.auxiliariesMapping,({key:J})=>J),this.keyboard.addListener({onKeyDown:(J)=>{if(this.keys.indexOf(J)>=0){const B=this.active;if(this.deactivate(),this.toggle(J),B)this.activate()}}}),this.auxiliaries=Y0($.auxiliariesMapping,({aux:J})=>J)}get auxiliary(){return this.auxiliaries.at(this.toggleIndex)}toggle(Q){if(this.keys[this.toggleIndex]!==Q)this.toggleIndex=this.keys.indexOf(Q);else{const $=this.keys.length?(this.toggleIndex+1)%this.keys.length:0;if(this.keys[$]===Q)this.toggleIndex=$}}refresh(Q){this.auxiliary?.refresh?.(Q)}activate(){if(!this.active)this.active=!0,this.pendingDeactivate=this.auxiliary?.activate?.()}deactivate(){if(this.active)this.active=!1,this.pendingDeactivate?.(),this.auxiliary?.deactivate?.()}}var W$=0,j$=1,P$=2,O$=3,U$=4,WQ=5,N$=6,n=512;class jQ extends Z0{Q;hudSpriteId=0;constructor(Q){super(Q);this.core=Q;this.addMedia({id:W$,type:"image",src:"dobuki.png"},{id:j$,type:"draw",draw:($)=>{const{canvas:J}=$;J.width=n,J.height=n;const B=J.width/2,Y=J.height/2,K=J.width/2;$.imageSmoothingEnabled=!0,$.fillStyle="#ddd",$.lineWidth=J.width/50,$.fillRect(0,0,J.width,J.height),$.strokeStyle="black",$.fillStyle="gold",$.beginPath(),$.arc(B,Y,K*0.8,0,2*Math.PI),$.fill(),$.stroke(),$.beginPath(),$.arc(B,Y,K*0.5,0,Math.PI),$.stroke(),$.beginPath(),$.arc(J.width/3,J.height/3,K*0.1,0,Math.PI,!0),$.stroke(),$.beginPath(),$.arc(J.width/3*2,J.height/3,K*0.1,0,Math.PI*2,!0),$.stroke()}},{id:P$,type:"draw",draw:($)=>{const{canvas:J}=$;J.width=n,J.height=n,$.imageSmoothingEnabled=!0,$.fillStyle="#ddd",$.lineWidth=J.width/50,$.fillRect(0,0,J.width,J.height),$.strokeStyle="black",$.fillStyle="silver",$.beginPath(),$.rect(J.width*0.2,J.height*0.2,J.width*0.6,J.height*0.6),$.fill(),$.stroke()}},{id:O$,type:"video",src:"sample.mp4",volume:0,fps:30,playSpeed:0.1},{id:U$,type:"draw",draw:($)=>{const{canvas:J}=$;J.width=n,J.height=n,$.imageSmoothingEnabled=!0,$.lineWidth=5,$.strokeStyle="green",$.beginPath(),$.rect(10,10,J.width-20,J.height-20),$.stroke()}},{id:WQ,type:"draw",draw:($)=>{const{canvas:J}=$;J.width=n,J.height=n,$.imageSmoothingEnabled=!0,$.lineWidth=5,$.setLineDash([5,2]),$.strokeStyle="blue",$.beginPath(),$.rect(10,10,J.width-20,J.height-20),$.stroke()}},{id:N$,type:"draw",draw:($)=>{const{canvas:J}=$;J.width=n,J.height=n,$.imageSmoothingEnabled=!0,$.fillStyle="green",$.lineWidth=J.width/50,$.fillRect(0,0,J.width,J.height),$.strokeStyle="black",$.fillStyle="#4f8",$.beginPath(),$.rect(J.width*0.2,J.height*0.2,J.width*0.6,J.height*0.6),$.fill(),$.stroke()}}),this.addSprites({imageId:W$,transforms:[L.create().translate(0,0,-1).getMatrix()]},...[L.create().translate(-1,0,0).rotateY(Math.PI/2).scale(1).getMatrix(),L.create().translate(1,0,0).rotateY(-Math.PI/2).scale(1).getMatrix()].map(($)=>({imageId:j$,transforms:[$]})),...[L.create().translate(0,-1,0).rotateX(-Math.PI/2).scale(1).getMatrix(),L.create().translate(0,-1,2).rotateX(-Math.PI/2).scale(1).getMatrix(),L.create().translate(-2,-1,2).rotateX(-Math.PI/2).scale(1).getMatrix(),L.create().translate(2,-1,2).rotateX(-Math.PI/2).scale(1).getMatrix()].map(($)=>({imageId:P$,transforms:[$]})),{imageId:O$,transforms:[L.create().translate(0,1e4,-50000).scale(9600,5400,1).getMatrix()]},...new Array(400).fill(0).map(($,J)=>L.create().translate((J%20-10)*2,-1.5,(Math.floor(J/20)-10)*2).rotateX(-Math.PI/2).scale(1).getMatrix()).map(($)=>({imageId:U$,transforms:[$]})),...new Array(400).fill(0).map(($,J)=>L.create().translate((J%20-10)*2,-1,(Math.floor(J/20)-10)*2).rotateX(-Math.PI/2).scale(1).getMatrix()).map(($)=>({imageId:N$,transforms:[$]})),...new Array(400).fill(0).map(($,J)=>L.create().translate((J%20-10)*2,1,(Math.floor(J/20)-10)*2).rotateX(-Math.PI/2).scale(1).getMatrix()).map(($)=>({imageId:WQ,transforms:[$]})),...new Array(400).fill(0).map(($,J)=>L.create().translate((J%20-10)*2,0,(Math.floor(J/20)-10)*2-1).getMatrix()).map(($)=>({imageId:WQ,transforms:[$]})))}activate(){const Q=super.activate(),$=this.core.addAuxiliary(new FQ(this.core,{auxiliariesMapping:[{key:"Tab",aux:K0.from(new VQ(this.core,{step:2,turnStep:Math.PI/2,tiltStep:Math.PI/4}),new HQ(this.core),new q0(this.core,{key:"ShiftRight"}))},{key:"Tab",aux:K0.from(new ZQ(this.core),new XQ(this.core),new q0(this.core,{key:"ShiftRight"}))}]}));return()=>{Q(),$()}}}async function ZK(){console.log("Hello World!")}async function VK(Q){Q.style.border="2px solid silver",Q.addEventListener("mouseenter",()=>{Q.style.borderColor="black"}),Q.addEventListener("mouseleave",()=>{Q.style.borderColor="silver"});const $={x:0,y:0,pixel:0};Q.addEventListener("mousemove",(Y)=>{const K=(Y.pageX-Q.offsetLeft)*2,Z=(Q.offsetHeight-(Y.pageY-Q.offsetTop))*2;$.x=K,$.y=Z});const J=new YQ({canvas:Q});J.engine.addPixelListener($);const B=new jQ(J);return A$=J.start(B),{core:J,world:B}}function HK(){A$()}var A$;export{VK as testCanvas,HK as stop,ZK as hello,Z0 as World};

//# debugId=CFF7B26BE5A7DA1164756e2164756e21
