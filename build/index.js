var DQ=Object.defineProperty;var C0=($,Q)=>{for(var J in Q)DQ($,J,{get:Q[J],enumerable:!0,configurable:!0,set:(B)=>Q[J]=()=>B})};class k0{$;Q;J;constructor($,Q,J){this.array=$;this.updateValue=Q;this.notifier=J}at($){return this.array.at($)}get length(){return this.array.length}set($,Q){this.updateValue($,Q),this.notifier?.informUpdate($)}remove($){this.updateValue($,void 0),this.notifier?.informUpdate($)}}class M0{$;Q;J;updatedImageIds=new Set;constructor($,Q,J){this.motor=$;this.getMedia=Q;this.engine=J}withImageId($){return this.updatedImageIds.add($),this}informUpdate($){this.motor.registerUpdate(this.withImageId($))}refresh(){const $=Array.from(this.updatedImageIds);this.updatedImageIds.clear(),this.engine.updateTextures($,this.getMedia).then((Q)=>{Q.forEach((J)=>{if(J.isVideo)this.motor.registerUpdate(J,J.schedule)})})}}class L0 extends k0{constructor({motor:$,engine:Q},J=[]){super(J,(B,K)=>{J[B]=K;while(!J[J.length-1])J.length--},new M0($,J.at.bind(J),Q))}}class v{disposables;own($){if(!this.disposables)this.disposables=new Set;return this.disposables.add($),$}addOnDestroy($){if($)this.disposables?.add({destroy:$})}destroy(){this.disposables?.forEach(($)=>$.destroy())}}class u extends v{auxiliaries=[];refreshes=[];active=!1;constructor(){super()}activate(){if(this.active)return()=>{};const $=new Set;for(let Q of this.auxiliaries){const J=Q.activate?.();if(J)$.add(J)}return()=>{$.forEach((Q)=>Q())}}deactivate(){if(!this.active)return;for(let $ of this.auxiliaries)$.deactivate?.()}refresh($){for(let Q of this.refreshes)Q.refresh($)}addAuxiliary(...$){this.auxiliaries.push(...$),this.refreshes.push(...$.filter((B)=>!!B.refresh));const Q=new Set;if(this.active)for(let B of this.auxiliaries){const K=B.activate?.();if(K)Q.add(K)}const J=this.onAddAuxiliary?.(...$);if(J)Q.add(J);return()=>Q.forEach((B)=>B())}removeAllAuxiliaries(){this.removeAuxiliary(...this.auxiliaries)}removeAuxiliary(...$){const Q=new Set($);let J=0;for(let B=0;B<this.auxiliaries.length;B++)if(!Q.has(this.auxiliaries[B]))this.auxiliaries[J]=this.auxiliaries[B],J++;this.auxiliaries.length=J,this.refreshes=this.auxiliaries.filter((B)=>!!B.refresh)}}class T0{$;Q;J;updatedSpriteIds=new Set;constructor($,Q,J){this.getSprite=$;this.engine=Q;this.motor=J}informUpdate($){this.motor.registerUpdate(this.withSpriteId($))}withSpriteId($){return this.updatedSpriteIds.add($),this}refresh(){if(this.engine.updateSpriteAnims(this.updatedSpriteIds,this.getSprite),this.updatedSpriteIds.size)this.motor.registerUpdate(this)}}class S0{$;Q;J;updatedSpriteIds=new Set;constructor($,Q,J){this.getSprite=$;this.engine=Q;this.motor=J}informUpdate($){this.motor.registerUpdate(this.withSpriteId($))}withSpriteId($){return this.updatedSpriteIds.add($),this}refresh(){this.engine.updateSpriteTransforms(this.updatedSpriteIds,this.getSprite)}}var o;(function(K){K[K["NONE"]=0]="NONE";K[K["TRANSFORM"]=1]="TRANSFORM";K[K["ANIM"]=2]="ANIM";K[K["ALL"]=3]="ALL"})(o||(o={}));class h0{spritesList=[];spritesIndices=[];spriteTransformUpdate;spriteAnimUpdate;constructor({engine:$,motor:Q}){this.spriteTransformUpdate=new S0(this.at.bind(this),$,Q),this.spriteAnimUpdate=new T0(this.at.bind(this),$,Q)}informUpdate($,Q=o.ALL){if(Q&o.TRANSFORM)this.spriteTransformUpdate.informUpdate($);if(Q&o.ANIM)this.spriteAnimUpdate.informUpdate($)}at($){const Q=this.spritesIndices[$];return Q?.sprites.at($-(Q?.baseIndex??0))}get length(){return this.spritesIndices.length}add($){if(this.spritesList.indexOf($)>=0)return;this.spritesList.push($);const Q=this.spritesIndices.length;for(let J=0;J<$.length;J++)this.informUpdate(Q+J),this.spritesIndices.push({sprites:$,baseIndex:Q})}}class Y0 extends u{medias;spritesAccumulator;constructor($){super();this.medias=new L0($),this.spritesAccumulator=new h0($)}get sprites(){return this.spritesAccumulator}addMedia(...$){$.forEach((Q)=>{this.medias.set(Q.id,Q)})}addSprites(...$){$.forEach((Q)=>{this.spritesAccumulator.add(Q.length?Q:[Q])})}}var A=globalThis.WebGL2RenderingContext??{},U$="position",N$="index",w0="transform",I0="slotSize_and_number",v0="instance";var A$="camPos",E$="camTilt",D$="camTurn",_$="projection",q$="curvature",R$="maxTextureSize",G$="uTextures";var _Q=function($,Q,J){function B(F,W){function P(U){return U===$?.VERTEX_SHADER?"vertex":U===$?.FRAGMENT_SHADER?"fragment":void 0}if(W!==$.VERTEX_SHADER&&W!==$.FRAGMENT_SHADER)throw new Error(`Shader error in ${P(W)}`);const O=$.createShader(W);if(!O)throw new Error(`Unable to generate ${P(W)} shader.`);if($.shaderSource(O,F),$.compileShader(O),!$.getShaderParameter(O,$.COMPILE_STATUS))console.error(`Shader compile error in ${P(W)}:`+$.getShaderInfoLog(O));return O}const K=$.createProgram();if(!K)throw new Error("Unable to create program.");const Y=B(Q,$.VERTEX_SHADER),Z=B(J,$.FRAGMENT_SHADER),V=$.getShaderInfoLog(Y),H=$.getShaderInfoLog(Z);if(V)console.log("VERTEX",V);if(H)console.log("FRAGMENT",H);$.attachShader(K,Y),$.attachShader(K,Z),$.linkProgram(K);const X=$.getProgramInfoLog(K);if(X)console.log("PROGRAM",X);if($.detachShader(K,Y),$.detachShader(K,Z),$.deleteShader(Y),$.deleteShader(Z),$.validateProgram(K),Object.entries(A).forEach(([F,W])=>{if(W&&$.getError()===W)console.log(`gl.${F}`)}),!$.getProgramParameter(K,$.LINK_STATUS))throw new Error("Unable to initialize the shader program:\n"+$.getProgramInfoLog(K));return K},qQ=function($,Q){$.deleteProgram(Q)};class z0 extends v{gl;program;constructor($,Q,J){super();this.gl=$,this.program=_Q($,Q.trim(),J.trim())}use(){this.gl.useProgram(this.program)}destroy(){super.destroy(),qQ(this.gl,this.program)}}class f0 extends v{activeProgramId="";gl;programs={};constructor($){super();this.gl=$}addProgram($,Q,J){if(this.programs[$])this.removeProgram($);this.programs[$]=this.own(new z0(this.gl,Q,J))}useProgram($){if(this.activeProgramId!==$)this.activeProgramId=$,this.programs[$].use()}removeProgram($){this.programs[$].destroy(),delete this.programs[$]}getProgram($){return this.programs[$??this.activeProgramId]?.program}}class g0 extends v{gl;triangleArray;constructor($){super();this.gl=$,this.triangleArray=$.createVertexArray(),$.bindVertexArray(this.triangleArray)}destroy(){this.gl.deleteVertexArray(this.triangleArray)}}class y0 extends v{bufferRecord={};gl;programs;constructor($,Q){super();this.gl=$,this.programs=Q}getAttributeLocation($,Q){const J=this.programs.getProgram(Q);return J?this.gl.getAttribLocation(J,$)??-1:-1}createBuffer($){this.deleteBuffer($);const Q=this.gl?.createBuffer();if(!Q)throw new Error(`Unable to create buffer "${$}"`);const J={buffer:Q,location:this.getAttributeLocation($)};return this.bufferRecord[$]=J,J}deleteBuffer($){if(this.bufferRecord[$])this.gl.deleteBuffer(this.bufferRecord[$].buffer),delete this.bufferRecord[$]}getAttributeBuffer($){const Q=this.bufferRecord[$];if(!Q)throw new Error(`Attribute "${$}" not created. Make sure "createBuffer" is called.`);return Q}destroy(){Object.keys(this.bufferRecord).forEach(($)=>this.deleteBuffer($))}}class p0 extends v{gl;programs;constructor($,Q){super();this.gl=$,this.programs=Q}getUniformLocation($,Q){const J=this.programs.getProgram(Q);return this.gl.getUniformLocation(J,$)}}function C$($,Q=(J)=>J.key){var J=[];return x0($,"",!0,(B)=>J.push(B),Q),J.join("")}var x0=function($,Q,J,B,K){if($){B(`${Q}${J?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 "}${K($)}\n`);const Y=Q+(J?"    ":"\u2502   ");if($.left)x0($.left,Y,!1,B,K);if($.right)x0($.right,Y,!0,B,K)}};function Z0($){if($===null)return!0;var Q=V0($.left),J=V0($.right);if(Math.abs(Q-J)<=1&&Z0($.left)&&Z0($.right))return!0;return!1}var V0=function($){return $?1+Math.max(V0($.left),V0($.right)):0};function H0($,Q,J,B,K){const Y=K-B;if(Y>0){const Z=B+Math.floor(Y/2),V=Q[Z],H=J[Z],X={key:V,data:H,parent:$};return X.left=H0(X,Q,J,B,Z),X.right=H0(X,Q,J,Z+1,K),X}return null}function X0($){if($===null)return 0;const Q=X0($.left),J=X0($.right);return $.balanceFactor=Q-J,Math.max(Q,J)+1}function F0($,Q,J,B,K){if(J>=B)return;const Y=$[J+B>>1];let Z=J-1,V=B+1;while(!0){do Z++;while(K($[Z],Y)<0);do V--;while(K($[V],Y)>0);if(Z>=V)break;let H=$[Z];$[Z]=$[V],$[V]=H,H=Q[Z],Q[Z]=Q[V],Q[V]=H}F0($,Q,J,V,K),F0($,Q,V+1,B,K)}var RQ=function($,Q){return $>Q?1:$<Q?-1:0},W0=function($){var Q=$.right;if($.right=Q.left,Q.left)Q.left.parent=$;if(Q.parent=$.parent,Q.parent)if(Q.parent.left===$)Q.parent.left=Q;else Q.parent.right=Q;if($.parent=Q,Q.left=$,$.balanceFactor+=1,Q.balanceFactor<0)$.balanceFactor-=Q.balanceFactor;if(Q.balanceFactor+=1,$.balanceFactor>0)Q.balanceFactor+=$.balanceFactor;return Q},j0=function($){var Q=$.left;if($.left=Q.right,$.left)$.left.parent=$;if(Q.parent=$.parent,Q.parent)if(Q.parent.left===$)Q.parent.left=Q;else Q.parent.right=Q;if($.parent=Q,Q.right=$,$.balanceFactor-=1,Q.balanceFactor>0)$.balanceFactor-=Q.balanceFactor;if(Q.balanceFactor-=1,$.balanceFactor<0)Q.balanceFactor+=$.balanceFactor;return Q};class b{constructor($,Q=!1){this._comparator=$||RQ,this._root=null,this._size=0,this._noDuplicates=!!Q}destroy(){return this.clear()}clear(){return this._root=null,this._size=0,this}get size(){return this._size}contains($){if(this._root){var Q=this._root,J=this._comparator;while(Q){var B=J($,Q.key);if(B===0)return!0;else if(B<0)Q=Q.left;else Q=Q.right}}return!1}next($){var Q=$;if(Q)if(Q.right){Q=Q.right;while(Q.left)Q=Q.left}else{Q=$.parent;while(Q&&Q.right===$)$=Q,Q=Q.parent}return Q}prev($){var Q=$;if(Q)if(Q.left){Q=Q.left;while(Q.right)Q=Q.right}else{Q=$.parent;while(Q&&Q.left===$)$=Q,Q=Q.parent}return Q}forEach($){var Q=this._root,J=[],B=!1,K=0;while(!B)if(Q)J.push(Q),Q=Q.left;else if(J.length>0)Q=J.pop(),$(Q,K++),Q=Q.right;else B=!0;return this}range($,Q,J,B){const K=[],Y=this._comparator;let Z=this._root,V;while(K.length!==0||Z)if(Z)K.push(Z),Z=Z.left;else{if(Z=K.pop(),V=Y(Z.key,Q),V>0)break;else if(Y(Z.key,$)>=0){if(J.call(B,Z))return this}Z=Z.right}return this}keys(){var $=this._root,Q=[],J=[],B=!1;while(!B)if($)Q.push($),$=$.left;else if(Q.length>0)$=Q.pop(),J.push($.key),$=$.right;else B=!0;return J}values(){var $=this._root,Q=[],J=[],B=!1;while(!B)if($)Q.push($),$=$.left;else if(Q.length>0)$=Q.pop(),J.push($.data),$=$.right;else B=!0;return J}at($){var Q=this._root,J=[],B=!1,K=0;while(!B)if(Q)J.push(Q),Q=Q.left;else if(J.length>0){if(Q=J.pop(),K===$)return Q;K++,Q=Q.right}else B=!0;return null}minNode(){var $=this._root;if(!$)return null;while($.left)$=$.left;return $}maxNode(){var $=this._root;if(!$)return null;while($.right)$=$.right;return $}min(){var $=this._root;if(!$)return null;while($.left)$=$.left;return $.key}max(){var $=this._root;if(!$)return null;while($.right)$=$.right;return $.key}isEmpty(){return!this._root}pop(){var $=this._root,Q=null;if($){while($.left)$=$.left;Q={key:$.key,data:$.data},this.remove($.key)}return Q}popMax(){var $=this._root,Q=null;if($){while($.right)$=$.right;Q={key:$.key,data:$.data},this.remove($.key)}return Q}find($){var Q=this._root,J=Q,B,K=this._comparator;while(J)if(B=K($,J.key),B===0)return J;else if(B<0)J=J.left;else J=J.right;return null}insert($,Q){if(!this._root)return this._root={parent:null,left:null,right:null,balanceFactor:0,key:$,data:Q},this._size++,this._root;var J=this._comparator,B=this._root,K=null,Y=0;if(this._noDuplicates)while(B)if(Y=J($,B.key),K=B,Y===0)return null;else if(Y<0)B=B.left;else B=B.right;else while(B)if(Y=J($,B.key),K=B,Y<=0)B=B.left;else B=B.right;var Z={left:null,right:null,balanceFactor:0,parent:K,key:$,data:Q},V;if(Y<=0)K.left=Z;else K.right=Z;while(K){if(Y=J(K.key,$),Y<0)K.balanceFactor-=1;else K.balanceFactor+=1;if(K.balanceFactor===0)break;else if(K.balanceFactor<-1){if(K.right.balanceFactor===1)j0(K.right);if(V=W0(K),K===this._root)this._root=V;break}else if(K.balanceFactor>1){if(K.left.balanceFactor===-1)W0(K.left);if(V=j0(K),K===this._root)this._root=V;break}K=K.parent}return this._size++,Z}remove($){if(!this._root)return null;var Q=this._root,J=this._comparator,B=0;while(Q)if(B=J($,Q.key),B===0)break;else if(B<0)Q=Q.left;else Q=Q.right;if(!Q)return null;var K=Q.key,Y,Z;if(Q.left){Y=Q.left;while(Y.left||Y.right){while(Y.right)Y=Y.right;if(Q.key=Y.key,Q.data=Y.data,Y.left)Q=Y,Y=Y.left}Q.key=Y.key,Q.data=Y.data,Q=Y}if(Q.right){Z=Q.right;while(Z.left||Z.right){while(Z.left)Z=Z.left;if(Q.key=Z.key,Q.data=Z.data,Z.right)Q=Z,Z=Z.right}Q.key=Z.key,Q.data=Z.data,Q=Z}var V=Q.parent,H=Q,X;while(V){if(V.left===H)V.balanceFactor-=1;else V.balanceFactor+=1;if(V.balanceFactor<-1){if(V.right.balanceFactor===1)j0(V.right);if(X=W0(V),V===this._root)this._root=X;V=X}else if(V.balanceFactor>1){if(V.left.balanceFactor===-1)W0(V.left);if(X=j0(V),V===this._root)this._root=X;V=X}if(V.balanceFactor===-1||V.balanceFactor===1)break;H=V,V=V.parent}if(Q.parent)if(Q.parent.left===Q)Q.parent.left=null;else Q.parent.right=null;if(Q===this._root)this._root=null;return this._size--,K}load($=[],Q=[],J){if(this._size!==0)throw new Error("bulk-load: tree is not empty");const B=$.length;if(J)F0($,Q,0,B-1,this._comparator);return this._root=H0(null,$,Q,0,B),X0(this._root),this._size=B,this}isBalanced(){return Z0(this._root)}toString($){return C$(this._root,$)}}b.default=b;class c{size;slotNumber;x;y;textureIndex;parent;sibbling;textureSizeLimits;constructor($,Q,J,B){this.textureSizeLimits=J?.textureSizeLimits??B??{min:c0,max:m0},this.size=$,this.slotNumber=Q,this.parent=J,this.sibbling=void 0;const{x:K,y:Y,textureIndex:Z}=this.calculatePosition($,Q);this.x=K,this.y=Y,this.textureIndex=Z}calculateTextureIndex($,Q){const[J,B]=$,K=this.textureSizeLimits.max/J*(this.textureSizeLimits.max/B);return Math.floor(Q/K)}calculatePosition($,Q){const[J,B]=$,K=this.textureSizeLimits.max/J,Y=this.textureSizeLimits.max/B,Z=Q%K*J,V=Math.floor(Q/K)%Y*B;return{x:Z,y:V,textureIndex:this.calculateTextureIndex($,Q)}}getTag(){return c.getTag(this)}static getTag($){return`${$.size[0]}x${$.size[1]}-#${$.slotNumber}`}static positionToTextureSlot($,Q,J,B,K){const[Y,Z]=J,V=K.textureSizeLimits.max/Y,X=K.textureSizeLimits.max/Y*(K.textureSizeLimits.max/Z)*B+Q/Z*V+$/Y;return new c(J,X,K)}getPosition(){return{x:this.x,y:this.y,size:this.size,textureIndex:this.textureIndex}}canSplitHorizontally(){const[,$]=this.size;return $>this.textureSizeLimits.min}canSplitVertically(){const[$]=this.size;return $>this.textureSizeLimits.min}splitHorizontally(){const{x:$,y:Q,size:J,textureIndex:B}=this,[K,Y]=J;if(!this.canSplitHorizontally())throw new Error(`Cannot split texture slot of size ${K} horizontally`);const Z=K/2,V=c.positionToTextureSlot($,Q,[Z,Y],B,this),H=c.positionToTextureSlot($+Z,Q,[Z,Y],B,this);return V.sibbling=H,H.sibbling=V,[V,H]}splitVertically(){const{x:$,y:Q,size:J,textureIndex:B}=this,[K,Y]=J;if(!this.canSplitVertically())throw new Error(`Cannot split texture slot of size ${Y} vertically`);const Z=Y/2,V=c.positionToTextureSlot($,Q,[K,Z],B,this),H=c.positionToTextureSlot($,Q+Z,[K,Z],B,this);return V.sibbling=H,H.sibbling=V,[V,H]}}function P0($,Q){return Math.max(Q,Math.pow(2,Math.ceil(Math.log($)/Math.log(2))))}function k$($,Q,J,B){if(J<1)throw new Error("Invalid count");const K=P0($,B.min),Y=P0(Q,B.min),Z=new Map;let V=B.min;for(let H=1;H<=J;H++){V=P0(K*H,B.min);const X=P0(Y*Math.ceil(J/H),B.min);Z.set(V,X)}for(let H=V;H<=B.max;H*=2)if(!Z.has(H))Z.set(H,Y);return Z}var GQ=!1,c0=16,m0=4096,CQ=16;class O0{textureSlots=new b(($,Q)=>{const J=$.size[0]*$.size[1]-Q.size[0]*Q.size[1];if(J!==0)return J;return $.slotNumber-Q.slotNumber},!1);allocatedTextures={};minTextureSize;maxTextureSize;numTextureSheets;initialSlots=[];constructor({numTextureSheets:$,minTextureSize:Q,maxTextureSize:J,excludeTexture:B}={},K){if(this.numTextureSheets=$??CQ,this.minTextureSize=Q??c0,this.maxTextureSize=J??m0,K)this.numTextureSheets=Math.min(this.numTextureSheets,K.getParameter(WebGL2RenderingContext.MAX_TEXTURE_IMAGE_UNITS)),this.maxTextureSize=Math.min(this.maxTextureSize,K.getParameter(WebGL2RenderingContext.MAX_TEXTURE_SIZE)),this.minTextureSize=Math.min(this.minTextureSize,this.maxTextureSize);for(let Y=0;Y<this.numTextureSheets;Y++){if(B?.(Y))continue;this.initialSlots.push(new c([this.maxTextureSize,this.maxTextureSize],Y,void 0,{min:this.minTextureSize,max:this.maxTextureSize}))}this.initialSlots.forEach((Y)=>this.textureSlots.insert(Y))}allocate($,Q,J=1){const{size:B,slotNumber:K,x:Y,y:Z,textureIndex:V}=this.allocateHelper($,Q,J);return{size:B,slotNumber:K,x:Y,y:Z,textureIndex:V}}deallocate($){if(!this.isSlotUsed($))throw new Error("Slot is not allocated");const Q=this.allocatedTextures[c.getTag($)];this.deallocateHelper(Q)}get countUsedTextureSheets(){return this.initialSlots.filter(($)=>this.isSlotUsed($)).length}allocateHelper($,Q,J=1){const B=k$($,Q,J,{min:this.minTextureSize,max:this.maxTextureSize}),K=this.findSlot(B);if(!K)throw new Error(`Could not find a slot for texture to fit ${J} sprites of size ${$}x${Q}`);this.textureSlots.remove(K);const[Y,Z]=this.bestFit(B,K);return this.fitSlot(K,Y,Z)}findSlot($){for(let Q=0;Q<this.textureSlots.size;Q++){const B=this.textureSlots.at(Q).key,[K,Y]=B.size;if($.get(K)<=Y)return B}return null}calculateRatio($,Q){return Math.max($/Q,Q/$)}bestFit($,Q){const[J,B]=Q.size;let K=Q.textureSizeLimits.max;return $.forEach((Y,Z)=>{if(Z<=J&&Y<=B){const V=Z*Y,H=$.get(K)*K;if(V<H)K=Z;else if(V===H){if(this.calculateRatio(Z,Y)<this.calculateRatio(K,$.get(K)))K=Z}}}),[K,$.get(K)]}isSlotUsed($){return!!this.allocatedTextures[c.getTag($)]}deallocateHelper($){if($.parent&&$.sibbling&&!this.isSlotUsed($.sibbling)){const Q=$.sibbling;if(this.textureSlots.remove(Q),GQ&&this.textureSlots.find($))throw new Error("Slot is not expected to be in the tree");const J=$.parent;this.deallocateHelper(J);return}this.textureSlots.insert($),delete this.allocatedTextures[$.getTag()]}trySplitHorizontally($,Q,J){if($.canSplitHorizontally()){const[B,K]=$.splitHorizontally();if(B.size[0]>=Q)return this.textureSlots.insert(K),this.fitSlot(B,Q,J)}return null}trySplitVertically($,Q,J){if($.canSplitVertically()){const[B,K]=$.splitVertically();if(B.size[1]>=J)return this.textureSlots.insert(K),this.fitSlot(B,Q,J)}return null}fitSlot($,Q,J){if(this.allocatedTextures[$.getTag()]=$,$.size[0]>$.size[1]){const B=this.trySplitHorizontally($,Q,J)??this.trySplitVertically($,Q,J);if(B)return B}else{const B=this.trySplitVertically($,Q,J)??this.trySplitHorizontally($,Q,J);if(B)return B}return $}listSlots(){this.textureSlots.forEach(($)=>{console.log($.key?.getTag())})}}var U0=15;class n0 extends v{gl;uniforms;textureBuffers={};tempContext=new OffscreenCanvas(1,1).getContext("2d");textureSlotAllocator=new O0({excludeTexture:($)=>$===U0});textureSlotAllocatorForVideo=new O0({excludeTexture:($)=>$!==U0});constructor($,Q){super();this.gl=$,this.uniforms=Q,this.tempContext.imageSmoothingEnabled=!0}initialize(){this.initTextureUniforms(),this.initMaxTexture()}getTexture($){if(!this.textureBuffers[$]){const Q=this.gl.createTexture();if(!Q)return;this.gl.bindTexture(A.TEXTURE_2D,Q),this.gl.texImage2D(A.TEXTURE_2D,0,A.RGBA,this.textureSlotAllocator.maxTextureSize,this.textureSlotAllocator.maxTextureSize,0,A.RGBA,A.UNSIGNED_BYTE,null),this.textureBuffers[$]=Q,this.addOnDestroy(()=>this.gl.deleteTexture(Q))}return this.textureBuffers[$]}loadTexture($,Q,J,B,K){this.gl.activeTexture(A[Q]),this.gl.bindTexture(A.TEXTURE_2D,J),this.applyTexImage2d($,B,K),this.gl.texParameteri(A.TEXTURE_2D,A.TEXTURE_MIN_FILTER,A.LINEAR)}applyTexImage2d($,[Q,J,B,K],[Y,Z,V,H]){if(B===V&&K===H&&!Q&&!J)this.gl.texSubImage2D(A.TEXTURE_2D,0,Y,Z,V,H,A.RGBA,A.UNSIGNED_BYTE,$.texImgSrc);else{const X=this.tempContext.canvas;if($.texImgSrc instanceof ImageData){if(X.width=V||$.width,X.height=H||$.height,this.tempContext.putImageData($.texImgSrc,0,0),Q||J)console.warn("Offset not available when sending imageData")}else{const F=B||$.width,W=K||$.height;X.width=V||F,X.height=H||W,this.tempContext.drawImage($.texImgSrc,Q,J,F,W,0,0,X.width,X.height)}this.gl.texSubImage2D(A.TEXTURE_2D,0,Y,Z,X.width,X.height,A.RGBA,A.UNSIGNED_BYTE,X)}}allocateSlotForImage($){const J=($.isVideo?this.textureSlotAllocatorForVideo:this.textureSlotAllocator).allocate($.width,$.height),B=`TEXTURE${J.textureIndex}`,K=this.getTexture(B);if(!K)throw new Error(`Invalid texture Id ${B}`);const Y=this.assignImageToTexture($,B,K,[0,0,$.width,$.height],[J.x,J.y,...J.size]);return{slot:J,refreshCallback:Y}}assignImageToTexture($,Q,J,B,K){const Y=B??[0,0,$.width,$.height],Z=K??[0,0,Y[2],Y[3]],V=()=>{this.gl.bindTexture(A.TEXTURE_2D,J),this.applyTexImage2d($,Y,Z)};if($.active)V();else this.loadTexture($,Q,J,Y,Z),$.active=!0;return V}setupTextureForVideo($){const Q=this.getTexture($);if(Q)this.gl.activeTexture(A[$]),this.gl.bindTexture(A.TEXTURE_2D,Q),this.gl.texParameteri(A.TEXTURE_2D,A.TEXTURE_MIN_FILTER,A.LINEAR),this.gl.texParameteri(A.TEXTURE_2D,A.TEXTURE_MAG_FILTER,A.LINEAR)}generateMipMap($){const Q=this.getTexture($);if(Q)this.gl.activeTexture(A[$]),this.gl.bindTexture(A.TEXTURE_2D,Q),this.gl.texParameteri(A.TEXTURE_2D,A.TEXTURE_MIN_FILTER,A.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(A.TEXTURE_2D,A.TEXTURE_MAG_FILTER,A.LINEAR),this.gl.generateMipmap(A.TEXTURE_2D)}initTextureUniforms(){const $=this.gl.getParameter(A.MAX_TEXTURE_IMAGE_UNITS),Q=new Array($).fill(null).map((B,K)=>K),J=this.uniforms.getUniformLocation(G$);this.gl.uniform1iv(J,Q)}initMaxTexture(){const $=this.uniforms.getUniformLocation(R$);this.gl.uniform1f($,this.textureSlotAllocator.maxTextureSize)}}class m extends v{texImgSrc;active=!1;width;height;isVideo;schedule;constructor($,Q){super();this.texImgSrc=$;const J=$;if(this.isVideo=!!(J.videoWidth||J.videoHeight),this.width=J.naturalWidth??J.videoWidth??J.displayWidth??J.width?.baseValue?.value??J.width,this.height=J.naturalHeight??J.videoHeight??J.displayHeight??J.height?.baseValue?.value??J.height,this.schedule=Q?{period:1000/Q}:void 0,!this.width||!this.height)throw new Error("Invalid image")}refresh(){this.refreshCallback?.()}static createFromCanvas($){return new m($)}static async loadImage($){const Q=await new Promise((J,B)=>{const K=new Image;K.crossOrigin="anonymous";const Y=(Z)=>B(Z.error);K.addEventListener("error",Y),K.addEventListener("load",()=>J(K),{once:!0}),K.src=$});return new m(Q)}static async loadVideo($,Q,J=30,B=1,K=Number.MAX_SAFE_INTEGER){const Y=await new Promise((V,H)=>{const X=document.createElement("video");if(X.loop=!0,Q!==void 0)X.volume=Q;X.addEventListener("loadedmetadata",()=>{X.play(),X.playbackRate=B,V(X)},{once:!0}),document.addEventListener("focus",()=>X.play()),X.addEventListener("error",(F)=>H(F.error)),X.src=$}),Z=new m(Y,Math.min(J*B,K));return Z.addOnDestroy(()=>Y.pause()),Z}static async loadWebcam($){const Q=await new Promise((K,Y)=>{const Z=document.createElement("video");Z.loop=!0,Z.addEventListener("loadedmetadata",()=>Z.play()),Z.addEventListener("playing",()=>K(Z),{once:!0}),Z.addEventListener("error",(V)=>Y(V.error))}),J=new m(Q);let B=!1;return navigator.mediaDevices.getUserMedia({video:{deviceId:$}}).then((K)=>{if(!B)Q.srcObject=K,J.addOnDestroy(()=>K.getTracks().forEach((Y)=>Y.stop()))}),J.addOnDestroy(()=>{B=!0,Q.pause()}),J}}var a=function($){return $};class l0 extends v{constructor(){super(...arguments)}images={};renderProcedures={image:a(($,Q)=>this.loadImage($,Q.src)),video:a(($,Q)=>this.loadVideo($,Q.src,Q.volume,Q.fps,Q.playSpeed)),draw:a(($,Q)=>this.drawImage($,Q.draw)),canvas:a(($,Q)=>this.loadCanvas($,Q.canvas)),webcam:a(($,Q)=>this.loadWebCam($,Q.deviceId))};hasImageId($){return!!this.getMedia($)}getMedia($){return this.images[$]}setImage($,Q){this.images[$]=Q}async renderMedia($,Q){return this.renderProcedures[Q.type]($,Q)}async drawImage($,Q){const J=new OffscreenCanvas(1,1);Q(J.getContext("2d"));const B=m.createFromCanvas(J);return this.images[$]=this.own(B),B}async loadCanvas($,Q){const J=m.createFromCanvas(Q);return Q.getContext("2d"),this.images[$]=this.own(J),J}async loadImage($,Q){const J=await m.loadImage(Q);return this.images[$]=this.own(J),J}async loadVideo($,Q,J,B,K,Y){const Z=await m.loadVideo(Q,J,B,K,Y);return this.images[$]=this.own(Z),Z}async loadWebCam($,Q){const J=await m.loadWebcam(Q);return this.images[$]=this.own(J),J}}var M$=`#version 300 es
//  ~{AUTHOR}

precision highp float;

//  IN
//  shape
layout(location = 0) in vec2 position;
layout(location = 1) in mat4 transform;
//  1, 2, 3, 4 reserved for transform
//  animation
layout(location = 5) in vec2 slotSize_and_number;
//  instance
layout(location = 6) in float instance;

//  UNIFORM
uniform float maxTextureSize;
uniform mat4 camPos;
uniform mat4 camTurn;
uniform mat4 camTilt;
uniform mat4 projection;
uniform float curvature;

//  OUT
out vec2 vTex;
out float vTextureIndex;
out vec3 vInstanceColor;

void main() {
  vec2 tex = position.xy * vec2(0.49, -0.49) + 0.5;
  vec2 slotSize = vec2(
    pow(2.0, floor(slotSize_and_number.x / 16.0)),
    pow(2.0, mod(slotSize_and_number.x, 16.0)));
  float slotNumber = slotSize_and_number.y;
  float maxCols = maxTextureSize / slotSize.x;
  float maxRows = maxTextureSize / slotSize.y;
  float slotX = mod(slotNumber, maxCols);
  float slotY = mod(floor(slotNumber / maxCols), maxRows);

  vec4 elemPosition = transform * vec4(position, 0.0, 1.0);
  // elementPosition => relativePosition
  vec4 relativePosition = camTilt * camTurn * camPos * elemPosition;
  relativePosition.y -= curvature * ((relativePosition.z * relativePosition.z) + (relativePosition.x * relativePosition.x) / 4.) / 10.;
  // relativePosition => gl_Position
  gl_Position = projection * relativePosition;


  vTex = (vec2(slotX, slotY) + tex) * slotSize / maxTextureSize;
  vTextureIndex = floor(slotNumber / (maxCols * maxRows));

  //  instance
  float r = fract(instance / (256.0 * 256.0 * 255.0));
  float g = fract(instance / (256.0 * 255.0));
  float b = fract(instance / 255.0);
  vInstanceColor = vec3(r, g, b);
}
`;var L$=`#version 300 es
//  ~{AUTHOR}
precision highp float;

//  CONST
const int NUM_TEXTURES = 16;
const float threshold = 0.00001;

//  IN
//  texture
uniform sampler2D uTextures[NUM_TEXTURES];
in float vTextureIndex;
in vec2 vTex;
in float opacity;
in vec3 vInstanceColor;

//  OUT
out vec4 fragColor;

//  FUNCTIONS
vec4 getTextureColor(float textureSlot, vec2 vTexturePoint);

void main() {
  vec4 color = getTextureColor(vTextureIndex, vTex);
  if (color.a <= .0001) {
    discard;
  };
  fragColor = color;
//  fragColor = vec4(vInstanceColor.rgb, 1.0);
}

vec4 getTextureColor(float textureSlot, vec2 vTexturePoint) {
  if (abs(0.0 - textureSlot) < threshold) {
    return texture(uTextures[0], vTexturePoint);
  }
  if (abs(1.0 - textureSlot) < threshold) {
    return texture(uTextures[1], vTexturePoint);
  }
  if (abs(2.0 - textureSlot) < threshold) {
    return texture(uTextures[2], vTexturePoint);
  }
  if (abs(3.0 - textureSlot) < threshold) {
    return texture(uTextures[3], vTexturePoint);
  }
  if (abs(4.0 - textureSlot) < threshold) {
    return texture(uTextures[4], vTexturePoint);
  }
  if (abs(5.0 - textureSlot) < threshold) {
    return texture(uTextures[5], vTexturePoint);
  }
  if (abs(6.0 - textureSlot) < threshold) {
    return texture(uTextures[6], vTexturePoint);
  }
  if (abs(7.0 - textureSlot) < threshold) {
    return texture(uTextures[7], vTexturePoint);
  }
  if (abs(8.0 - textureSlot) < threshold) {
    return texture(uTextures[8], vTexturePoint);
  }
  if (abs(9.0 - textureSlot) < threshold) {
    return texture(uTextures[9], vTexturePoint);
  }
  if (abs(10.0 - textureSlot) < threshold) {
    return texture(uTextures[10], vTexturePoint);
  }
  if (abs(11.0 - textureSlot) < threshold) {
    return texture(uTextures[11], vTexturePoint);
  }
  if (abs(12.0 - textureSlot) < threshold) {
    return texture(uTextures[12], vTexturePoint);
  }
  if (abs(13.0 - textureSlot) < threshold) {
    return texture(uTextures[13], vTexturePoint);
  }
  if (abs(14.0 - textureSlot) < threshold) {
    return texture(uTextures[14], vTexturePoint);
  }
  if (abs(15.0 - textureSlot) < threshold) {
    return texture(uTextures[15], vTexturePoint);
  }
  return texture(uTextures[0], vTexturePoint);
}
`;function d0($,Q){return $.replace(/~\{(\w+)\}/g,(J,B)=>{return Q?.[B]||J})}var G=0.000001,T=typeof Float32Array!=="undefined"?Float32Array:Array,l=Math.random,zB=Math.PI/180;if(!Math.hypot)Math.hypot=function(){var $=0,Q=arguments.length;while(Q--)$+=arguments[Q]*arguments[Q];return Math.sqrt($)};function T$(){var $=new T(9);if(T!=Float32Array)$[1]=0,$[2]=0,$[3]=0,$[5]=0,$[6]=0,$[7]=0;return $[0]=1,$[4]=1,$[8]=1,$}var L={};C0(L,{transpose:()=>{{return vQ}},translate:()=>{{return yQ}},targetTo:()=>{{return HJ}},subtract:()=>{{return f$}},sub:()=>{{return AJ}},str:()=>{{return XJ}},set:()=>{{return IQ}},scale:()=>{{return pQ}},rotateZ:()=>{{return nQ}},rotateY:()=>{{return mQ}},rotateX:()=>{{return cQ}},rotate:()=>{{return xQ}},perspectiveZO:()=>{{return BJ}},perspectiveNO:()=>{{return v$}},perspectiveFromFieldOfView:()=>{{return KJ}},perspective:()=>{{return JJ}},orthoZO:()=>{{return ZJ}},orthoNO:()=>{{return z$}},ortho:()=>{{return YJ}},multiplyScalarAndAdd:()=>{{return PJ}},multiplyScalar:()=>{{return jJ}},multiply:()=>{{return h$}},mul:()=>{{return NJ}},lookAt:()=>{{return VJ}},invert:()=>{{return zQ}},identity:()=>{{return S$}},getTranslation:()=>{{return uQ}},getScaling:()=>{{return I$}},getRotation:()=>{{return oQ}},frustum:()=>{{return QJ}},fromZRotation:()=>{{return rQ}},fromYRotation:()=>{{return sQ}},fromXRotation:()=>{{return iQ}},fromValues:()=>{{return wQ}},fromTranslation:()=>{{return lQ}},fromScaling:()=>{{return dQ}},fromRotationTranslationScaleOrigin:()=>{{return tQ}},fromRotationTranslationScale:()=>{{return aQ}},fromRotationTranslation:()=>{{return w$}},fromRotation:()=>{{return bQ}},fromQuat2:()=>{{return eQ}},fromQuat:()=>{{return $J}},frob:()=>{{return FJ}},exactEquals:()=>{{return OJ}},equals:()=>{{return UJ}},determinant:()=>{{return gQ}},create:()=>{{return TQ}},copy:()=>{{return hQ}},clone:()=>{{return SQ}},adjoint:()=>{{return fQ}},add:()=>{{return WJ}}});function TQ(){var $=new T(16);if(T!=Float32Array)$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[6]=0,$[7]=0,$[8]=0,$[9]=0,$[11]=0,$[12]=0,$[13]=0,$[14]=0;return $[0]=1,$[5]=1,$[10]=1,$[15]=1,$}function SQ($){var Q=new T(16);return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q[3]=$[3],Q[4]=$[4],Q[5]=$[5],Q[6]=$[6],Q[7]=$[7],Q[8]=$[8],Q[9]=$[9],Q[10]=$[10],Q[11]=$[11],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15],Q}function hQ($,Q){return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$[3]=Q[3],$[4]=Q[4],$[5]=Q[5],$[6]=Q[6],$[7]=Q[7],$[8]=Q[8],$[9]=Q[9],$[10]=Q[10],$[11]=Q[11],$[12]=Q[12],$[13]=Q[13],$[14]=Q[14],$[15]=Q[15],$}function wQ($,Q,J,B,K,Y,Z,V,H,X,F,W,P,O,U,N){var j=new T(16);return j[0]=$,j[1]=Q,j[2]=J,j[3]=B,j[4]=K,j[5]=Y,j[6]=Z,j[7]=V,j[8]=H,j[9]=X,j[10]=F,j[11]=W,j[12]=P,j[13]=O,j[14]=U,j[15]=N,j}function IQ($,Q,J,B,K,Y,Z,V,H,X,F,W,P,O,U,N,j){return $[0]=Q,$[1]=J,$[2]=B,$[3]=K,$[4]=Y,$[5]=Z,$[6]=V,$[7]=H,$[8]=X,$[9]=F,$[10]=W,$[11]=P,$[12]=O,$[13]=U,$[14]=N,$[15]=j,$}function S$($){return $[0]=1,$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=1,$[6]=0,$[7]=0,$[8]=0,$[9]=0,$[10]=1,$[11]=0,$[12]=0,$[13]=0,$[14]=0,$[15]=1,$}function vQ($,Q){if($===Q){var J=Q[1],B=Q[2],K=Q[3],Y=Q[6],Z=Q[7],V=Q[11];$[1]=Q[4],$[2]=Q[8],$[3]=Q[12],$[4]=J,$[6]=Q[9],$[7]=Q[13],$[8]=B,$[9]=Y,$[11]=Q[14],$[12]=K,$[13]=Z,$[14]=V}else $[0]=Q[0],$[1]=Q[4],$[2]=Q[8],$[3]=Q[12],$[4]=Q[1],$[5]=Q[5],$[6]=Q[9],$[7]=Q[13],$[8]=Q[2],$[9]=Q[6],$[10]=Q[10],$[11]=Q[14],$[12]=Q[3],$[13]=Q[7],$[14]=Q[11],$[15]=Q[15];return $}function zQ($,Q){var J=Q[0],B=Q[1],K=Q[2],Y=Q[3],Z=Q[4],V=Q[5],H=Q[6],X=Q[7],F=Q[8],W=Q[9],P=Q[10],O=Q[11],U=Q[12],N=Q[13],j=Q[14],E=Q[15],C=J*V-B*Z,D=J*H-K*Z,R=J*X-Y*Z,_=B*H-K*V,q=B*X-Y*V,z=K*X-Y*H,h=F*N-W*U,w=F*j-P*U,I=F*E-O*U,f=W*j-P*N,g=W*E-O*N,y=P*E-O*j,k=C*y-D*g+R*f+_*I-q*w+z*h;if(!k)return null;return k=1/k,$[0]=(V*y-H*g+X*f)*k,$[1]=(K*g-B*y-Y*f)*k,$[2]=(N*z-j*q+E*_)*k,$[3]=(P*q-W*z-O*_)*k,$[4]=(H*I-Z*y-X*w)*k,$[5]=(J*y-K*I+Y*w)*k,$[6]=(j*R-U*z-E*D)*k,$[7]=(F*z-P*R+O*D)*k,$[8]=(Z*g-V*I+X*h)*k,$[9]=(B*I-J*g-Y*h)*k,$[10]=(U*q-N*R+E*C)*k,$[11]=(W*R-F*q-O*C)*k,$[12]=(V*w-Z*f-H*h)*k,$[13]=(J*f-B*w+K*h)*k,$[14]=(N*D-U*_-j*C)*k,$[15]=(F*_-W*D+P*C)*k,$}function fQ($,Q){var J=Q[0],B=Q[1],K=Q[2],Y=Q[3],Z=Q[4],V=Q[5],H=Q[6],X=Q[7],F=Q[8],W=Q[9],P=Q[10],O=Q[11],U=Q[12],N=Q[13],j=Q[14],E=Q[15];return $[0]=V*(P*E-O*j)-W*(H*E-X*j)+N*(H*O-X*P),$[1]=-(B*(P*E-O*j)-W*(K*E-Y*j)+N*(K*O-Y*P)),$[2]=B*(H*E-X*j)-V*(K*E-Y*j)+N*(K*X-Y*H),$[3]=-(B*(H*O-X*P)-V*(K*O-Y*P)+W*(K*X-Y*H)),$[4]=-(Z*(P*E-O*j)-F*(H*E-X*j)+U*(H*O-X*P)),$[5]=J*(P*E-O*j)-F*(K*E-Y*j)+U*(K*O-Y*P),$[6]=-(J*(H*E-X*j)-Z*(K*E-Y*j)+U*(K*X-Y*H)),$[7]=J*(H*O-X*P)-Z*(K*O-Y*P)+F*(K*X-Y*H),$[8]=Z*(W*E-O*N)-F*(V*E-X*N)+U*(V*O-X*W),$[9]=-(J*(W*E-O*N)-F*(B*E-Y*N)+U*(B*O-Y*W)),$[10]=J*(V*E-X*N)-Z*(B*E-Y*N)+U*(B*X-Y*V),$[11]=-(J*(V*O-X*W)-Z*(B*O-Y*W)+F*(B*X-Y*V)),$[12]=-(Z*(W*j-P*N)-F*(V*j-H*N)+U*(V*P-H*W)),$[13]=J*(W*j-P*N)-F*(B*j-K*N)+U*(B*P-K*W),$[14]=-(J*(V*j-H*N)-Z*(B*j-K*N)+U*(B*H-K*V)),$[15]=J*(V*P-H*W)-Z*(B*P-K*W)+F*(B*H-K*V),$}function gQ($){var Q=$[0],J=$[1],B=$[2],K=$[3],Y=$[4],Z=$[5],V=$[6],H=$[7],X=$[8],F=$[9],W=$[10],P=$[11],O=$[12],U=$[13],N=$[14],j=$[15],E=Q*Z-J*Y,C=Q*V-B*Y,D=Q*H-K*Y,R=J*V-B*Z,_=J*H-K*Z,q=B*H-K*V,z=X*U-F*O,h=X*N-W*O,w=X*j-P*O,I=F*N-W*U,f=F*j-P*U,g=W*j-P*N;return E*g-C*f+D*I+R*w-_*h+q*z}function h$($,Q,J){var B=Q[0],K=Q[1],Y=Q[2],Z=Q[3],V=Q[4],H=Q[5],X=Q[6],F=Q[7],W=Q[8],P=Q[9],O=Q[10],U=Q[11],N=Q[12],j=Q[13],E=Q[14],C=Q[15],D=J[0],R=J[1],_=J[2],q=J[3];return $[0]=D*B+R*V+_*W+q*N,$[1]=D*K+R*H+_*P+q*j,$[2]=D*Y+R*X+_*O+q*E,$[3]=D*Z+R*F+_*U+q*C,D=J[4],R=J[5],_=J[6],q=J[7],$[4]=D*B+R*V+_*W+q*N,$[5]=D*K+R*H+_*P+q*j,$[6]=D*Y+R*X+_*O+q*E,$[7]=D*Z+R*F+_*U+q*C,D=J[8],R=J[9],_=J[10],q=J[11],$[8]=D*B+R*V+_*W+q*N,$[9]=D*K+R*H+_*P+q*j,$[10]=D*Y+R*X+_*O+q*E,$[11]=D*Z+R*F+_*U+q*C,D=J[12],R=J[13],_=J[14],q=J[15],$[12]=D*B+R*V+_*W+q*N,$[13]=D*K+R*H+_*P+q*j,$[14]=D*Y+R*X+_*O+q*E,$[15]=D*Z+R*F+_*U+q*C,$}function yQ($,Q,J){var B=J[0],K=J[1],Y=J[2],Z,V,H,X,F,W,P,O,U,N,j,E;if(Q===$)$[12]=Q[0]*B+Q[4]*K+Q[8]*Y+Q[12],$[13]=Q[1]*B+Q[5]*K+Q[9]*Y+Q[13],$[14]=Q[2]*B+Q[6]*K+Q[10]*Y+Q[14],$[15]=Q[3]*B+Q[7]*K+Q[11]*Y+Q[15];else Z=Q[0],V=Q[1],H=Q[2],X=Q[3],F=Q[4],W=Q[5],P=Q[6],O=Q[7],U=Q[8],N=Q[9],j=Q[10],E=Q[11],$[0]=Z,$[1]=V,$[2]=H,$[3]=X,$[4]=F,$[5]=W,$[6]=P,$[7]=O,$[8]=U,$[9]=N,$[10]=j,$[11]=E,$[12]=Z*B+F*K+U*Y+Q[12],$[13]=V*B+W*K+N*Y+Q[13],$[14]=H*B+P*K+j*Y+Q[14],$[15]=X*B+O*K+E*Y+Q[15];return $}function pQ($,Q,J){var B=J[0],K=J[1],Y=J[2];return $[0]=Q[0]*B,$[1]=Q[1]*B,$[2]=Q[2]*B,$[3]=Q[3]*B,$[4]=Q[4]*K,$[5]=Q[5]*K,$[6]=Q[6]*K,$[7]=Q[7]*K,$[8]=Q[8]*Y,$[9]=Q[9]*Y,$[10]=Q[10]*Y,$[11]=Q[11]*Y,$[12]=Q[12],$[13]=Q[13],$[14]=Q[14],$[15]=Q[15],$}function xQ($,Q,J,B){var K=B[0],Y=B[1],Z=B[2],V=Math.hypot(K,Y,Z),H,X,F,W,P,O,U,N,j,E,C,D,R,_,q,z,h,w,I,f,g,y,k,x;if(V<G)return null;if(V=1/V,K*=V,Y*=V,Z*=V,H=Math.sin(J),X=Math.cos(J),F=1-X,W=Q[0],P=Q[1],O=Q[2],U=Q[3],N=Q[4],j=Q[5],E=Q[6],C=Q[7],D=Q[8],R=Q[9],_=Q[10],q=Q[11],z=K*K*F+X,h=Y*K*F+Z*H,w=Z*K*F-Y*H,I=K*Y*F-Z*H,f=Y*Y*F+X,g=Z*Y*F+K*H,y=K*Z*F+Y*H,k=Y*Z*F-K*H,x=Z*Z*F+X,$[0]=W*z+N*h+D*w,$[1]=P*z+j*h+R*w,$[2]=O*z+E*h+_*w,$[3]=U*z+C*h+q*w,$[4]=W*I+N*f+D*g,$[5]=P*I+j*f+R*g,$[6]=O*I+E*f+_*g,$[7]=U*I+C*f+q*g,$[8]=W*y+N*k+D*x,$[9]=P*y+j*k+R*x,$[10]=O*y+E*k+_*x,$[11]=U*y+C*k+q*x,Q!==$)$[12]=Q[12],$[13]=Q[13],$[14]=Q[14],$[15]=Q[15];return $}function cQ($,Q,J){var B=Math.sin(J),K=Math.cos(J),Y=Q[4],Z=Q[5],V=Q[6],H=Q[7],X=Q[8],F=Q[9],W=Q[10],P=Q[11];if(Q!==$)$[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$[3]=Q[3],$[12]=Q[12],$[13]=Q[13],$[14]=Q[14],$[15]=Q[15];return $[4]=Y*K+X*B,$[5]=Z*K+F*B,$[6]=V*K+W*B,$[7]=H*K+P*B,$[8]=X*K-Y*B,$[9]=F*K-Z*B,$[10]=W*K-V*B,$[11]=P*K-H*B,$}function mQ($,Q,J){var B=Math.sin(J),K=Math.cos(J),Y=Q[0],Z=Q[1],V=Q[2],H=Q[3],X=Q[8],F=Q[9],W=Q[10],P=Q[11];if(Q!==$)$[4]=Q[4],$[5]=Q[5],$[6]=Q[6],$[7]=Q[7],$[12]=Q[12],$[13]=Q[13],$[14]=Q[14],$[15]=Q[15];return $[0]=Y*K-X*B,$[1]=Z*K-F*B,$[2]=V*K-W*B,$[3]=H*K-P*B,$[8]=Y*B+X*K,$[9]=Z*B+F*K,$[10]=V*B+W*K,$[11]=H*B+P*K,$}function nQ($,Q,J){var B=Math.sin(J),K=Math.cos(J),Y=Q[0],Z=Q[1],V=Q[2],H=Q[3],X=Q[4],F=Q[5],W=Q[6],P=Q[7];if(Q!==$)$[8]=Q[8],$[9]=Q[9],$[10]=Q[10],$[11]=Q[11],$[12]=Q[12],$[13]=Q[13],$[14]=Q[14],$[15]=Q[15];return $[0]=Y*K+X*B,$[1]=Z*K+F*B,$[2]=V*K+W*B,$[3]=H*K+P*B,$[4]=X*K-Y*B,$[5]=F*K-Z*B,$[6]=W*K-V*B,$[7]=P*K-H*B,$}function lQ($,Q){return $[0]=1,$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=1,$[6]=0,$[7]=0,$[8]=0,$[9]=0,$[10]=1,$[11]=0,$[12]=Q[0],$[13]=Q[1],$[14]=Q[2],$[15]=1,$}function dQ($,Q){return $[0]=Q[0],$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=Q[1],$[6]=0,$[7]=0,$[8]=0,$[9]=0,$[10]=Q[2],$[11]=0,$[12]=0,$[13]=0,$[14]=0,$[15]=1,$}function bQ($,Q,J){var B=J[0],K=J[1],Y=J[2],Z=Math.hypot(B,K,Y),V,H,X;if(Z<G)return null;return Z=1/Z,B*=Z,K*=Z,Y*=Z,V=Math.sin(Q),H=Math.cos(Q),X=1-H,$[0]=B*B*X+H,$[1]=K*B*X+Y*V,$[2]=Y*B*X-K*V,$[3]=0,$[4]=B*K*X-Y*V,$[5]=K*K*X+H,$[6]=Y*K*X+B*V,$[7]=0,$[8]=B*Y*X+K*V,$[9]=K*Y*X-B*V,$[10]=Y*Y*X+H,$[11]=0,$[12]=0,$[13]=0,$[14]=0,$[15]=1,$}function iQ($,Q){var J=Math.sin(Q),B=Math.cos(Q);return $[0]=1,$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=B,$[6]=J,$[7]=0,$[8]=0,$[9]=-J,$[10]=B,$[11]=0,$[12]=0,$[13]=0,$[14]=0,$[15]=1,$}function sQ($,Q){var J=Math.sin(Q),B=Math.cos(Q);return $[0]=B,$[1]=0,$[2]=-J,$[3]=0,$[4]=0,$[5]=1,$[6]=0,$[7]=0,$[8]=J,$[9]=0,$[10]=B,$[11]=0,$[12]=0,$[13]=0,$[14]=0,$[15]=1,$}function rQ($,Q){var J=Math.sin(Q),B=Math.cos(Q);return $[0]=B,$[1]=J,$[2]=0,$[3]=0,$[4]=-J,$[5]=B,$[6]=0,$[7]=0,$[8]=0,$[9]=0,$[10]=1,$[11]=0,$[12]=0,$[13]=0,$[14]=0,$[15]=1,$}function w$($,Q,J){var B=Q[0],K=Q[1],Y=Q[2],Z=Q[3],V=B+B,H=K+K,X=Y+Y,F=B*V,W=B*H,P=B*X,O=K*H,U=K*X,N=Y*X,j=Z*V,E=Z*H,C=Z*X;return $[0]=1-(O+N),$[1]=W+C,$[2]=P-E,$[3]=0,$[4]=W-C,$[5]=1-(F+N),$[6]=U+j,$[7]=0,$[8]=P+E,$[9]=U-j,$[10]=1-(F+O),$[11]=0,$[12]=J[0],$[13]=J[1],$[14]=J[2],$[15]=1,$}function eQ($,Q){var J=new T(3),B=-Q[0],K=-Q[1],Y=-Q[2],Z=Q[3],V=Q[4],H=Q[5],X=Q[6],F=Q[7],W=B*B+K*K+Y*Y+Z*Z;if(W>0)J[0]=(V*Z+F*B+H*Y-X*K)*2/W,J[1]=(H*Z+F*K+X*B-V*Y)*2/W,J[2]=(X*Z+F*Y+V*K-H*B)*2/W;else J[0]=(V*Z+F*B+H*Y-X*K)*2,J[1]=(H*Z+F*K+X*B-V*Y)*2,J[2]=(X*Z+F*Y+V*K-H*B)*2;return w$($,Q,J),$}function uQ($,Q){return $[0]=Q[12],$[1]=Q[13],$[2]=Q[14],$}function I$($,Q){var J=Q[0],B=Q[1],K=Q[2],Y=Q[4],Z=Q[5],V=Q[6],H=Q[8],X=Q[9],F=Q[10];return $[0]=Math.hypot(J,B,K),$[1]=Math.hypot(Y,Z,V),$[2]=Math.hypot(H,X,F),$}function oQ($,Q){var J=new T(3);I$(J,Q);var B=1/J[0],K=1/J[1],Y=1/J[2],Z=Q[0]*B,V=Q[1]*K,H=Q[2]*Y,X=Q[4]*B,F=Q[5]*K,W=Q[6]*Y,P=Q[8]*B,O=Q[9]*K,U=Q[10]*Y,N=Z+F+U,j=0;if(N>0)j=Math.sqrt(N+1)*2,$[3]=0.25*j,$[0]=(W-O)/j,$[1]=(P-H)/j,$[2]=(V-X)/j;else if(Z>F&&Z>U)j=Math.sqrt(1+Z-F-U)*2,$[3]=(W-O)/j,$[0]=0.25*j,$[1]=(V+X)/j,$[2]=(P+H)/j;else if(F>U)j=Math.sqrt(1+F-Z-U)*2,$[3]=(P-H)/j,$[0]=(V+X)/j,$[1]=0.25*j,$[2]=(W+O)/j;else j=Math.sqrt(1+U-Z-F)*2,$[3]=(V-X)/j,$[0]=(P+H)/j,$[1]=(W+O)/j,$[2]=0.25*j;return $}function aQ($,Q,J,B){var K=Q[0],Y=Q[1],Z=Q[2],V=Q[3],H=K+K,X=Y+Y,F=Z+Z,W=K*H,P=K*X,O=K*F,U=Y*X,N=Y*F,j=Z*F,E=V*H,C=V*X,D=V*F,R=B[0],_=B[1],q=B[2];return $[0]=(1-(U+j))*R,$[1]=(P+D)*R,$[2]=(O-C)*R,$[3]=0,$[4]=(P-D)*_,$[5]=(1-(W+j))*_,$[6]=(N+E)*_,$[7]=0,$[8]=(O+C)*q,$[9]=(N-E)*q,$[10]=(1-(W+U))*q,$[11]=0,$[12]=J[0],$[13]=J[1],$[14]=J[2],$[15]=1,$}function tQ($,Q,J,B,K){var Y=Q[0],Z=Q[1],V=Q[2],H=Q[3],X=Y+Y,F=Z+Z,W=V+V,P=Y*X,O=Y*F,U=Y*W,N=Z*F,j=Z*W,E=V*W,C=H*X,D=H*F,R=H*W,_=B[0],q=B[1],z=B[2],h=K[0],w=K[1],I=K[2],f=(1-(N+E))*_,g=(O+R)*_,y=(U-D)*_,k=(O-R)*q,x=(1-(P+E))*q,r=(j+C)*q,e=(U+D)*z,P$=(j-C)*z,O$=(1-(P+N))*z;return $[0]=f,$[1]=g,$[2]=y,$[3]=0,$[4]=k,$[5]=x,$[6]=r,$[7]=0,$[8]=e,$[9]=P$,$[10]=O$,$[11]=0,$[12]=J[0]+h-(f*h+k*w+e*I),$[13]=J[1]+w-(g*h+x*w+P$*I),$[14]=J[2]+I-(y*h+r*w+O$*I),$[15]=1,$}function $J($,Q){var J=Q[0],B=Q[1],K=Q[2],Y=Q[3],Z=J+J,V=B+B,H=K+K,X=J*Z,F=B*Z,W=B*V,P=K*Z,O=K*V,U=K*H,N=Y*Z,j=Y*V,E=Y*H;return $[0]=1-W-U,$[1]=F+E,$[2]=P-j,$[3]=0,$[4]=F-E,$[5]=1-X-U,$[6]=O+N,$[7]=0,$[8]=P+j,$[9]=O-N,$[10]=1-X-W,$[11]=0,$[12]=0,$[13]=0,$[14]=0,$[15]=1,$}function QJ($,Q,J,B,K,Y,Z){var V=1/(J-Q),H=1/(K-B),X=1/(Y-Z);return $[0]=Y*2*V,$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=Y*2*H,$[6]=0,$[7]=0,$[8]=(J+Q)*V,$[9]=(K+B)*H,$[10]=(Z+Y)*X,$[11]=-1,$[12]=0,$[13]=0,$[14]=Z*Y*2*X,$[15]=0,$}function v$($,Q,J,B,K){var Y=1/Math.tan(Q/2),Z;if($[0]=Y/J,$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=Y,$[6]=0,$[7]=0,$[8]=0,$[9]=0,$[11]=-1,$[12]=0,$[13]=0,$[15]=0,K!=null&&K!==Infinity)Z=1/(B-K),$[10]=(K+B)*Z,$[14]=2*K*B*Z;else $[10]=-1,$[14]=-2*B;return $}function BJ($,Q,J,B,K){var Y=1/Math.tan(Q/2),Z;if($[0]=Y/J,$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=Y,$[6]=0,$[7]=0,$[8]=0,$[9]=0,$[11]=-1,$[12]=0,$[13]=0,$[15]=0,K!=null&&K!==Infinity)Z=1/(B-K),$[10]=K*Z,$[14]=K*B*Z;else $[10]=-1,$[14]=-B;return $}function KJ($,Q,J,B){var K=Math.tan(Q.upDegrees*Math.PI/180),Y=Math.tan(Q.downDegrees*Math.PI/180),Z=Math.tan(Q.leftDegrees*Math.PI/180),V=Math.tan(Q.rightDegrees*Math.PI/180),H=2/(Z+V),X=2/(K+Y);return $[0]=H,$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=X,$[6]=0,$[7]=0,$[8]=-((Z-V)*H*0.5),$[9]=(K-Y)*X*0.5,$[10]=B/(J-B),$[11]=-1,$[12]=0,$[13]=0,$[14]=B*J/(J-B),$[15]=0,$}function z$($,Q,J,B,K,Y,Z){var V=1/(Q-J),H=1/(B-K),X=1/(Y-Z);return $[0]=-2*V,$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=-2*H,$[6]=0,$[7]=0,$[8]=0,$[9]=0,$[10]=2*X,$[11]=0,$[12]=(Q+J)*V,$[13]=(K+B)*H,$[14]=(Z+Y)*X,$[15]=1,$}function ZJ($,Q,J,B,K,Y,Z){var V=1/(Q-J),H=1/(B-K),X=1/(Y-Z);return $[0]=-2*V,$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=-2*H,$[6]=0,$[7]=0,$[8]=0,$[9]=0,$[10]=X,$[11]=0,$[12]=(Q+J)*V,$[13]=(K+B)*H,$[14]=Y*X,$[15]=1,$}function VJ($,Q,J,B){var K,Y,Z,V,H,X,F,W,P,O,U=Q[0],N=Q[1],j=Q[2],E=B[0],C=B[1],D=B[2],R=J[0],_=J[1],q=J[2];if(Math.abs(U-R)<G&&Math.abs(N-_)<G&&Math.abs(j-q)<G)return S$($);if(F=U-R,W=N-_,P=j-q,O=1/Math.hypot(F,W,P),F*=O,W*=O,P*=O,K=C*P-D*W,Y=D*F-E*P,Z=E*W-C*F,O=Math.hypot(K,Y,Z),!O)K=0,Y=0,Z=0;else O=1/O,K*=O,Y*=O,Z*=O;if(V=W*Z-P*Y,H=P*K-F*Z,X=F*Y-W*K,O=Math.hypot(V,H,X),!O)V=0,H=0,X=0;else O=1/O,V*=O,H*=O,X*=O;return $[0]=K,$[1]=V,$[2]=F,$[3]=0,$[4]=Y,$[5]=H,$[6]=W,$[7]=0,$[8]=Z,$[9]=X,$[10]=P,$[11]=0,$[12]=-(K*U+Y*N+Z*j),$[13]=-(V*U+H*N+X*j),$[14]=-(F*U+W*N+P*j),$[15]=1,$}function HJ($,Q,J,B){var K=Q[0],Y=Q[1],Z=Q[2],V=B[0],H=B[1],X=B[2],F=K-J[0],W=Y-J[1],P=Z-J[2],O=F*F+W*W+P*P;if(O>0)O=1/Math.sqrt(O),F*=O,W*=O,P*=O;var U=H*P-X*W,N=X*F-V*P,j=V*W-H*F;if(O=U*U+N*N+j*j,O>0)O=1/Math.sqrt(O),U*=O,N*=O,j*=O;return $[0]=U,$[1]=N,$[2]=j,$[3]=0,$[4]=W*j-P*N,$[5]=P*U-F*j,$[6]=F*N-W*U,$[7]=0,$[8]=F,$[9]=W,$[10]=P,$[11]=0,$[12]=K,$[13]=Y,$[14]=Z,$[15]=1,$}function XJ($){return"mat4("+$[0]+", "+$[1]+", "+$[2]+", "+$[3]+", "+$[4]+", "+$[5]+", "+$[6]+", "+$[7]+", "+$[8]+", "+$[9]+", "+$[10]+", "+$[11]+", "+$[12]+", "+$[13]+", "+$[14]+", "+$[15]+")"}function FJ($){return Math.hypot($[0],$[1],$[2],$[3],$[4],$[5],$[6],$[7],$[8],$[9],$[10],$[11],$[12],$[13],$[14],$[15])}function WJ($,Q,J){return $[0]=Q[0]+J[0],$[1]=Q[1]+J[1],$[2]=Q[2]+J[2],$[3]=Q[3]+J[3],$[4]=Q[4]+J[4],$[5]=Q[5]+J[5],$[6]=Q[6]+J[6],$[7]=Q[7]+J[7],$[8]=Q[8]+J[8],$[9]=Q[9]+J[9],$[10]=Q[10]+J[10],$[11]=Q[11]+J[11],$[12]=Q[12]+J[12],$[13]=Q[13]+J[13],$[14]=Q[14]+J[14],$[15]=Q[15]+J[15],$}function f$($,Q,J){return $[0]=Q[0]-J[0],$[1]=Q[1]-J[1],$[2]=Q[2]-J[2],$[3]=Q[3]-J[3],$[4]=Q[4]-J[4],$[5]=Q[5]-J[5],$[6]=Q[6]-J[6],$[7]=Q[7]-J[7],$[8]=Q[8]-J[8],$[9]=Q[9]-J[9],$[10]=Q[10]-J[10],$[11]=Q[11]-J[11],$[12]=Q[12]-J[12],$[13]=Q[13]-J[13],$[14]=Q[14]-J[14],$[15]=Q[15]-J[15],$}function jJ($,Q,J){return $[0]=Q[0]*J,$[1]=Q[1]*J,$[2]=Q[2]*J,$[3]=Q[3]*J,$[4]=Q[4]*J,$[5]=Q[5]*J,$[6]=Q[6]*J,$[7]=Q[7]*J,$[8]=Q[8]*J,$[9]=Q[9]*J,$[10]=Q[10]*J,$[11]=Q[11]*J,$[12]=Q[12]*J,$[13]=Q[13]*J,$[14]=Q[14]*J,$[15]=Q[15]*J,$}function PJ($,Q,J,B){return $[0]=Q[0]+J[0]*B,$[1]=Q[1]+J[1]*B,$[2]=Q[2]+J[2]*B,$[3]=Q[3]+J[3]*B,$[4]=Q[4]+J[4]*B,$[5]=Q[5]+J[5]*B,$[6]=Q[6]+J[6]*B,$[7]=Q[7]+J[7]*B,$[8]=Q[8]+J[8]*B,$[9]=Q[9]+J[9]*B,$[10]=Q[10]+J[10]*B,$[11]=Q[11]+J[11]*B,$[12]=Q[12]+J[12]*B,$[13]=Q[13]+J[13]*B,$[14]=Q[14]+J[14]*B,$[15]=Q[15]+J[15]*B,$}function OJ($,Q){return $[0]===Q[0]&&$[1]===Q[1]&&$[2]===Q[2]&&$[3]===Q[3]&&$[4]===Q[4]&&$[5]===Q[5]&&$[6]===Q[6]&&$[7]===Q[7]&&$[8]===Q[8]&&$[9]===Q[9]&&$[10]===Q[10]&&$[11]===Q[11]&&$[12]===Q[12]&&$[13]===Q[13]&&$[14]===Q[14]&&$[15]===Q[15]}function UJ($,Q){var J=$[0],B=$[1],K=$[2],Y=$[3],Z=$[4],V=$[5],H=$[6],X=$[7],F=$[8],W=$[9],P=$[10],O=$[11],U=$[12],N=$[13],j=$[14],E=$[15],C=Q[0],D=Q[1],R=Q[2],_=Q[3],q=Q[4],z=Q[5],h=Q[6],w=Q[7],I=Q[8],f=Q[9],g=Q[10],y=Q[11],k=Q[12],x=Q[13],r=Q[14],e=Q[15];return Math.abs(J-C)<=G*Math.max(1,Math.abs(J),Math.abs(C))&&Math.abs(B-D)<=G*Math.max(1,Math.abs(B),Math.abs(D))&&Math.abs(K-R)<=G*Math.max(1,Math.abs(K),Math.abs(R))&&Math.abs(Y-_)<=G*Math.max(1,Math.abs(Y),Math.abs(_))&&Math.abs(Z-q)<=G*Math.max(1,Math.abs(Z),Math.abs(q))&&Math.abs(V-z)<=G*Math.max(1,Math.abs(V),Math.abs(z))&&Math.abs(H-h)<=G*Math.max(1,Math.abs(H),Math.abs(h))&&Math.abs(X-w)<=G*Math.max(1,Math.abs(X),Math.abs(w))&&Math.abs(F-I)<=G*Math.max(1,Math.abs(F),Math.abs(I))&&Math.abs(W-f)<=G*Math.max(1,Math.abs(W),Math.abs(f))&&Math.abs(P-g)<=G*Math.max(1,Math.abs(P),Math.abs(g))&&Math.abs(O-y)<=G*Math.max(1,Math.abs(O),Math.abs(y))&&Math.abs(U-k)<=G*Math.max(1,Math.abs(U),Math.abs(k))&&Math.abs(N-x)<=G*Math.max(1,Math.abs(N),Math.abs(x))&&Math.abs(j-r)<=G*Math.max(1,Math.abs(j),Math.abs(r))&&Math.abs(E-e)<=G*Math.max(1,Math.abs(E),Math.abs(e))}var JJ=v$,YJ=z$,NJ=h$,AJ=f$;var Q0={};C0(Q0,{str:()=>{{return P8}},squaredLength:()=>{{return FQ}},sqrLen:()=>{{return R8}},sqlerp:()=>{{return M8}},slerp:()=>{{return D0}},setAxisAngle:()=>{{return JQ}},setAxes:()=>{{return L8}},set:()=>{{return A8}},scale:()=>{{return VQ}},rotationTo:()=>{{return k8}},rotateZ:()=>{{return Z8}},rotateY:()=>{{return Y8}},rotateX:()=>{{return K8}},random:()=>{{return X8}},pow:()=>{{return H8}},normalize:()=>{{return r0}},multiply:()=>{{return BQ}},mul:()=>{{return D8}},ln:()=>{{return YQ}},lerp:()=>{{return _8}},length:()=>{{return XQ}},len:()=>{{return q8}},invert:()=>{{return F8}},identity:()=>{{return Q8}},getAxisAngle:()=>{{return J8}},getAngle:()=>{{return B8}},fromValues:()=>{{return U8}},fromMat3:()=>{{return ZQ}},fromEuler:()=>{{return j8}},exp:()=>{{return KQ}},exactEquals:()=>{{return G8}},equals:()=>{{return C8}},dot:()=>{{return HQ}},create:()=>{{return s0}},copy:()=>{{return N8}},conjugate:()=>{{return W8}},clone:()=>{{return O8}},calculateW:()=>{{return V8}},add:()=>{{return E8}}});var i={};C0(i,{zero:()=>{{return nJ}},transformQuat:()=>{{return yJ}},transformMat4:()=>{{return fJ}},transformMat3:()=>{{return gJ}},subtract:()=>{{return y$}},sub:()=>{{return iJ}},str:()=>{{return lJ}},squaredLength:()=>{{return n$}},squaredDistance:()=>{{return m$}},sqrLen:()=>{{return oJ}},sqrDist:()=>{{return uJ}},set:()=>{{return _J}},scaleAndAdd:()=>{{return TJ}},scale:()=>{{return LJ}},round:()=>{{return MJ}},rotateZ:()=>{{return cJ}},rotateY:()=>{{return xJ}},rotateX:()=>{{return pJ}},random:()=>{{return zJ}},normalize:()=>{{return b0}},negate:()=>{{return SJ}},multiply:()=>{{return p$}},mul:()=>{{return sJ}},min:()=>{{return CJ}},max:()=>{{return kJ}},lerp:()=>{{return wJ}},length:()=>{{return g$}},len:()=>{{return i0}},inverse:()=>{{return hJ}},hermite:()=>{{return IJ}},fromValues:()=>{{return A0}},forEach:()=>{{return aJ}},floor:()=>{{return GJ}},exactEquals:()=>{{return dJ}},equals:()=>{{return bJ}},dot:()=>{{return E0}},divide:()=>{{return x$}},div:()=>{{return rJ}},distance:()=>{{return c$}},dist:()=>{{return eJ}},cross:()=>{{return $0}},create:()=>{{return N0}},copy:()=>{{return DJ}},clone:()=>{{return EJ}},ceil:()=>{{return RJ}},bezier:()=>{{return vJ}},angle:()=>{{return mJ}},add:()=>{{return qJ}}});function N0(){var $=new T(3);if(T!=Float32Array)$[0]=0,$[1]=0,$[2]=0;return $}function EJ($){var Q=new T(3);return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q}function g$($){var Q=$[0],J=$[1],B=$[2];return Math.hypot(Q,J,B)}function A0($,Q,J){var B=new T(3);return B[0]=$,B[1]=Q,B[2]=J,B}function DJ($,Q){return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$}function _J($,Q,J,B){return $[0]=Q,$[1]=J,$[2]=B,$}function qJ($,Q,J){return $[0]=Q[0]+J[0],$[1]=Q[1]+J[1],$[2]=Q[2]+J[2],$}function y$($,Q,J){return $[0]=Q[0]-J[0],$[1]=Q[1]-J[1],$[2]=Q[2]-J[2],$}function p$($,Q,J){return $[0]=Q[0]*J[0],$[1]=Q[1]*J[1],$[2]=Q[2]*J[2],$}function x$($,Q,J){return $[0]=Q[0]/J[0],$[1]=Q[1]/J[1],$[2]=Q[2]/J[2],$}function RJ($,Q){return $[0]=Math.ceil(Q[0]),$[1]=Math.ceil(Q[1]),$[2]=Math.ceil(Q[2]),$}function GJ($,Q){return $[0]=Math.floor(Q[0]),$[1]=Math.floor(Q[1]),$[2]=Math.floor(Q[2]),$}function CJ($,Q,J){return $[0]=Math.min(Q[0],J[0]),$[1]=Math.min(Q[1],J[1]),$[2]=Math.min(Q[2],J[2]),$}function kJ($,Q,J){return $[0]=Math.max(Q[0],J[0]),$[1]=Math.max(Q[1],J[1]),$[2]=Math.max(Q[2],J[2]),$}function MJ($,Q){return $[0]=Math.round(Q[0]),$[1]=Math.round(Q[1]),$[2]=Math.round(Q[2]),$}function LJ($,Q,J){return $[0]=Q[0]*J,$[1]=Q[1]*J,$[2]=Q[2]*J,$}function TJ($,Q,J,B){return $[0]=Q[0]+J[0]*B,$[1]=Q[1]+J[1]*B,$[2]=Q[2]+J[2]*B,$}function c$($,Q){var J=Q[0]-$[0],B=Q[1]-$[1],K=Q[2]-$[2];return Math.hypot(J,B,K)}function m$($,Q){var J=Q[0]-$[0],B=Q[1]-$[1],K=Q[2]-$[2];return J*J+B*B+K*K}function n$($){var Q=$[0],J=$[1],B=$[2];return Q*Q+J*J+B*B}function SJ($,Q){return $[0]=-Q[0],$[1]=-Q[1],$[2]=-Q[2],$}function hJ($,Q){return $[0]=1/Q[0],$[1]=1/Q[1],$[2]=1/Q[2],$}function b0($,Q){var J=Q[0],B=Q[1],K=Q[2],Y=J*J+B*B+K*K;if(Y>0)Y=1/Math.sqrt(Y);return $[0]=Q[0]*Y,$[1]=Q[1]*Y,$[2]=Q[2]*Y,$}function E0($,Q){return $[0]*Q[0]+$[1]*Q[1]+$[2]*Q[2]}function $0($,Q,J){var B=Q[0],K=Q[1],Y=Q[2],Z=J[0],V=J[1],H=J[2];return $[0]=K*H-Y*V,$[1]=Y*Z-B*H,$[2]=B*V-K*Z,$}function wJ($,Q,J,B){var K=Q[0],Y=Q[1],Z=Q[2];return $[0]=K+B*(J[0]-K),$[1]=Y+B*(J[1]-Y),$[2]=Z+B*(J[2]-Z),$}function IJ($,Q,J,B,K,Y){var Z=Y*Y,V=Z*(2*Y-3)+1,H=Z*(Y-2)+Y,X=Z*(Y-1),F=Z*(3-2*Y);return $[0]=Q[0]*V+J[0]*H+B[0]*X+K[0]*F,$[1]=Q[1]*V+J[1]*H+B[1]*X+K[1]*F,$[2]=Q[2]*V+J[2]*H+B[2]*X+K[2]*F,$}function vJ($,Q,J,B,K,Y){var Z=1-Y,V=Z*Z,H=Y*Y,X=V*Z,F=3*Y*V,W=3*H*Z,P=H*Y;return $[0]=Q[0]*X+J[0]*F+B[0]*W+K[0]*P,$[1]=Q[1]*X+J[1]*F+B[1]*W+K[1]*P,$[2]=Q[2]*X+J[2]*F+B[2]*W+K[2]*P,$}function zJ($,Q){Q=Q||1;var J=l()*2*Math.PI,B=l()*2-1,K=Math.sqrt(1-B*B)*Q;return $[0]=Math.cos(J)*K,$[1]=Math.sin(J)*K,$[2]=B*Q,$}function fJ($,Q,J){var B=Q[0],K=Q[1],Y=Q[2],Z=J[3]*B+J[7]*K+J[11]*Y+J[15];return Z=Z||1,$[0]=(J[0]*B+J[4]*K+J[8]*Y+J[12])/Z,$[1]=(J[1]*B+J[5]*K+J[9]*Y+J[13])/Z,$[2]=(J[2]*B+J[6]*K+J[10]*Y+J[14])/Z,$}function gJ($,Q,J){var B=Q[0],K=Q[1],Y=Q[2];return $[0]=B*J[0]+K*J[3]+Y*J[6],$[1]=B*J[1]+K*J[4]+Y*J[7],$[2]=B*J[2]+K*J[5]+Y*J[8],$}function yJ($,Q,J){var B=J[0],K=J[1],Y=J[2],Z=J[3],V=Q[0],H=Q[1],X=Q[2],F=K*X-Y*H,W=Y*V-B*X,P=B*H-K*V,O=K*P-Y*W,U=Y*F-B*P,N=B*W-K*F,j=Z*2;return F*=j,W*=j,P*=j,O*=2,U*=2,N*=2,$[0]=V+F+O,$[1]=H+W+U,$[2]=X+P+N,$}function pJ($,Q,J,B){var K=[],Y=[];return K[0]=Q[0]-J[0],K[1]=Q[1]-J[1],K[2]=Q[2]-J[2],Y[0]=K[0],Y[1]=K[1]*Math.cos(B)-K[2]*Math.sin(B),Y[2]=K[1]*Math.sin(B)+K[2]*Math.cos(B),$[0]=Y[0]+J[0],$[1]=Y[1]+J[1],$[2]=Y[2]+J[2],$}function xJ($,Q,J,B){var K=[],Y=[];return K[0]=Q[0]-J[0],K[1]=Q[1]-J[1],K[2]=Q[2]-J[2],Y[0]=K[2]*Math.sin(B)+K[0]*Math.cos(B),Y[1]=K[1],Y[2]=K[2]*Math.cos(B)-K[0]*Math.sin(B),$[0]=Y[0]+J[0],$[1]=Y[1]+J[1],$[2]=Y[2]+J[2],$}function cJ($,Q,J,B){var K=[],Y=[];return K[0]=Q[0]-J[0],K[1]=Q[1]-J[1],K[2]=Q[2]-J[2],Y[0]=K[0]*Math.cos(B)-K[1]*Math.sin(B),Y[1]=K[0]*Math.sin(B)+K[1]*Math.cos(B),Y[2]=K[2],$[0]=Y[0]+J[0],$[1]=Y[1]+J[1],$[2]=Y[2]+J[2],$}function mJ($,Q){var J=$[0],B=$[1],K=$[2],Y=Q[0],Z=Q[1],V=Q[2],H=Math.sqrt(J*J+B*B+K*K),X=Math.sqrt(Y*Y+Z*Z+V*V),F=H*X,W=F&&E0($,Q)/F;return Math.acos(Math.min(Math.max(W,-1),1))}function nJ($){return $[0]=0,$[1]=0,$[2]=0,$}function lJ($){return"vec3("+$[0]+", "+$[1]+", "+$[2]+")"}function dJ($,Q){return $[0]===Q[0]&&$[1]===Q[1]&&$[2]===Q[2]}function bJ($,Q){var J=$[0],B=$[1],K=$[2],Y=Q[0],Z=Q[1],V=Q[2];return Math.abs(J-Y)<=G*Math.max(1,Math.abs(J),Math.abs(Y))&&Math.abs(B-Z)<=G*Math.max(1,Math.abs(B),Math.abs(Z))&&Math.abs(K-V)<=G*Math.max(1,Math.abs(K),Math.abs(V))}var iJ=y$,sJ=p$,rJ=x$,eJ=c$,uJ=m$,i0=g$,oJ=n$,aJ=function(){var $=N0();return function(Q,J,B,K,Y,Z){var V,H;if(!J)J=3;if(!B)B=0;if(K)H=Math.min(K*J+B,Q.length);else H=Q.length;for(V=B;V<H;V+=J)$[0]=Q[V],$[1]=Q[V+1],$[2]=Q[V+2],Y($,$,Z),Q[V]=$[0],Q[V+1]=$[1],Q[V+2]=$[2];return Q}}();function tJ(){var $=new T(4);if(T!=Float32Array)$[0]=0,$[1]=0,$[2]=0,$[3]=0;return $}function l$($){var Q=new T(4);return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q[3]=$[3],Q}function d$($,Q,J,B){var K=new T(4);return K[0]=$,K[1]=Q,K[2]=J,K[3]=B,K}function b$($,Q){return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$[3]=Q[3],$}function i$($,Q,J,B,K){return $[0]=Q,$[1]=J,$[2]=B,$[3]=K,$}function s$($,Q,J){return $[0]=Q[0]+J[0],$[1]=Q[1]+J[1],$[2]=Q[2]+J[2],$[3]=Q[3]+J[3],$}function r$($,Q,J){return $[0]=Q[0]*J,$[1]=Q[1]*J,$[2]=Q[2]*J,$[3]=Q[3]*J,$}function e$($){var Q=$[0],J=$[1],B=$[2],K=$[3];return Math.hypot(Q,J,B,K)}function u$($){var Q=$[0],J=$[1],B=$[2],K=$[3];return Q*Q+J*J+B*B+K*K}function o$($,Q){var J=Q[0],B=Q[1],K=Q[2],Y=Q[3],Z=J*J+B*B+K*K+Y*Y;if(Z>0)Z=1/Math.sqrt(Z);return $[0]=J*Z,$[1]=B*Z,$[2]=K*Z,$[3]=Y*Z,$}function a$($,Q){return $[0]*Q[0]+$[1]*Q[1]+$[2]*Q[2]+$[3]*Q[3]}function t$($,Q,J,B){var K=Q[0],Y=Q[1],Z=Q[2],V=Q[3];return $[0]=K+B*(J[0]-K),$[1]=Y+B*(J[1]-Y),$[2]=Z+B*(J[2]-Z),$[3]=V+B*(J[3]-V),$}function $Q($,Q){return $[0]===Q[0]&&$[1]===Q[1]&&$[2]===Q[2]&&$[3]===Q[3]}function QQ($,Q){var J=$[0],B=$[1],K=$[2],Y=$[3],Z=Q[0],V=Q[1],H=Q[2],X=Q[3];return Math.abs(J-Z)<=G*Math.max(1,Math.abs(J),Math.abs(Z))&&Math.abs(B-V)<=G*Math.max(1,Math.abs(B),Math.abs(V))&&Math.abs(K-H)<=G*Math.max(1,Math.abs(K),Math.abs(H))&&Math.abs(Y-X)<=G*Math.max(1,Math.abs(Y),Math.abs(X))}var fB=function(){var $=tJ();return function(Q,J,B,K,Y,Z){var V,H;if(!J)J=4;if(!B)B=0;if(K)H=Math.min(K*J+B,Q.length);else H=Q.length;for(V=B;V<H;V+=J)$[0]=Q[V],$[1]=Q[V+1],$[2]=Q[V+2],$[3]=Q[V+3],Y($,$,Z),Q[V]=$[0],Q[V+1]=$[1],Q[V+2]=$[2],Q[V+3]=$[3];return Q}}();function s0(){var $=new T(4);if(T!=Float32Array)$[0]=0,$[1]=0,$[2]=0;return $[3]=1,$}function Q8($){return $[0]=0,$[1]=0,$[2]=0,$[3]=1,$}function JQ($,Q,J){J=J*0.5;var B=Math.sin(J);return $[0]=B*Q[0],$[1]=B*Q[1],$[2]=B*Q[2],$[3]=Math.cos(J),$}function J8($,Q){var J=Math.acos(Q[3])*2,B=Math.sin(J/2);if(B>G)$[0]=Q[0]/B,$[1]=Q[1]/B,$[2]=Q[2]/B;else $[0]=1,$[1]=0,$[2]=0;return J}function B8($,Q){var J=HQ($,Q);return Math.acos(2*J*J-1)}function BQ($,Q,J){var B=Q[0],K=Q[1],Y=Q[2],Z=Q[3],V=J[0],H=J[1],X=J[2],F=J[3];return $[0]=B*F+Z*V+K*X-Y*H,$[1]=K*F+Z*H+Y*V-B*X,$[2]=Y*F+Z*X+B*H-K*V,$[3]=Z*F-B*V-K*H-Y*X,$}function K8($,Q,J){J*=0.5;var B=Q[0],K=Q[1],Y=Q[2],Z=Q[3],V=Math.sin(J),H=Math.cos(J);return $[0]=B*H+Z*V,$[1]=K*H+Y*V,$[2]=Y*H-K*V,$[3]=Z*H-B*V,$}function Y8($,Q,J){J*=0.5;var B=Q[0],K=Q[1],Y=Q[2],Z=Q[3],V=Math.sin(J),H=Math.cos(J);return $[0]=B*H-Y*V,$[1]=K*H+Z*V,$[2]=Y*H+B*V,$[3]=Z*H-K*V,$}function Z8($,Q,J){J*=0.5;var B=Q[0],K=Q[1],Y=Q[2],Z=Q[3],V=Math.sin(J),H=Math.cos(J);return $[0]=B*H+K*V,$[1]=K*H-B*V,$[2]=Y*H+Z*V,$[3]=Z*H-Y*V,$}function V8($,Q){var J=Q[0],B=Q[1],K=Q[2];return $[0]=J,$[1]=B,$[2]=K,$[3]=Math.sqrt(Math.abs(1-J*J-B*B-K*K)),$}function KQ($,Q){var J=Q[0],B=Q[1],K=Q[2],Y=Q[3],Z=Math.sqrt(J*J+B*B+K*K),V=Math.exp(Y),H=Z>0?V*Math.sin(Z)/Z:0;return $[0]=J*H,$[1]=B*H,$[2]=K*H,$[3]=V*Math.cos(Z),$}function YQ($,Q){var J=Q[0],B=Q[1],K=Q[2],Y=Q[3],Z=Math.sqrt(J*J+B*B+K*K),V=Z>0?Math.atan2(Z,Y)/Z:0;return $[0]=J*V,$[1]=B*V,$[2]=K*V,$[3]=0.5*Math.log(J*J+B*B+K*K+Y*Y),$}function H8($,Q,J){return YQ($,Q),VQ($,$,J),KQ($,$),$}function D0($,Q,J,B){var K=Q[0],Y=Q[1],Z=Q[2],V=Q[3],H=J[0],X=J[1],F=J[2],W=J[3],P,O,U,N,j;if(O=K*H+Y*X+Z*F+V*W,O<0)O=-O,H=-H,X=-X,F=-F,W=-W;if(1-O>G)P=Math.acos(O),U=Math.sin(P),N=Math.sin((1-B)*P)/U,j=Math.sin(B*P)/U;else N=1-B,j=B;return $[0]=N*K+j*H,$[1]=N*Y+j*X,$[2]=N*Z+j*F,$[3]=N*V+j*W,$}function X8($){var Q=l(),J=l(),B=l(),K=Math.sqrt(1-Q),Y=Math.sqrt(Q);return $[0]=K*Math.sin(2*Math.PI*J),$[1]=K*Math.cos(2*Math.PI*J),$[2]=Y*Math.sin(2*Math.PI*B),$[3]=Y*Math.cos(2*Math.PI*B),$}function F8($,Q){var J=Q[0],B=Q[1],K=Q[2],Y=Q[3],Z=J*J+B*B+K*K+Y*Y,V=Z?1/Z:0;return $[0]=-J*V,$[1]=-B*V,$[2]=-K*V,$[3]=Y*V,$}function W8($,Q){return $[0]=-Q[0],$[1]=-Q[1],$[2]=-Q[2],$[3]=Q[3],$}function ZQ($,Q){var J=Q[0]+Q[4]+Q[8],B;if(J>0)B=Math.sqrt(J+1),$[3]=0.5*B,B=0.5/B,$[0]=(Q[5]-Q[7])*B,$[1]=(Q[6]-Q[2])*B,$[2]=(Q[1]-Q[3])*B;else{var K=0;if(Q[4]>Q[0])K=1;if(Q[8]>Q[K*3+K])K=2;var Y=(K+1)%3,Z=(K+2)%3;B=Math.sqrt(Q[K*3+K]-Q[Y*3+Y]-Q[Z*3+Z]+1),$[K]=0.5*B,B=0.5/B,$[3]=(Q[Y*3+Z]-Q[Z*3+Y])*B,$[Y]=(Q[Y*3+K]+Q[K*3+Y])*B,$[Z]=(Q[Z*3+K]+Q[K*3+Z])*B}return $}function j8($,Q,J,B){var K=0.5*Math.PI/180;Q*=K,J*=K,B*=K;var Y=Math.sin(Q),Z=Math.cos(Q),V=Math.sin(J),H=Math.cos(J),X=Math.sin(B),F=Math.cos(B);return $[0]=Y*H*F-Z*V*X,$[1]=Z*V*F+Y*H*X,$[2]=Z*H*X-Y*V*F,$[3]=Z*H*F+Y*V*X,$}function P8($){return"quat("+$[0]+", "+$[1]+", "+$[2]+", "+$[3]+")"}var O8=l$,U8=d$,N8=b$,A8=i$,E8=s$,D8=BQ,VQ=r$,HQ=a$,_8=t$,XQ=e$,q8=XQ,FQ=u$,R8=FQ,r0=o$,G8=$Q,C8=QQ,k8=function(){var $=N0(),Q=A0(1,0,0),J=A0(0,1,0);return function(B,K,Y){var Z=E0(K,Y);if(Z<-0.999999){if($0($,Q,K),i0($)<0.000001)$0($,J,K);return b0($,$),JQ(B,$,Math.PI),B}else if(Z>0.999999)return B[0]=0,B[1]=0,B[2]=0,B[3]=1,B;else return $0($,K,Y),B[0]=$[0],B[1]=$[1],B[2]=$[2],B[3]=1+Z,r0(B,B)}}(),M8=function(){var $=s0(),Q=s0();return function(J,B,K,Y,Z,V){return D0($,B,Z,V),D0(Q,K,Y,V),D0(J,$,Q,2*V*(1-V)),J}}(),L8=function(){var $=T$();return function(Q,J,B,K){return $[0]=B[0],$[3]=B[1],$[6]=B[2],$[1]=K[0],$[4]=K[1],$[7]=K[2],$[2]=-J[0],$[5]=-J[1],$[8]=-J[2],r0(Q,ZQ(Q,$))}}();var T8=Math.PI/90;class p{m4=Float32Array.from(L.create());static EMPTY=p.create();static IDENTITY=p.create();constructor(){this.identity()}static create(){return new p}set($){return L.copy(this.m4,$.getMatrix()),this}identity(){return L.identity(this.m4),this}invert($){return L.invert(this.m4,$?.getMatrix()??this.getMatrix()),this}multiply($){return L.multiply(this.m4,this.m4,$.getMatrix()),this}multiply2($,Q){return L.multiply(this.m4,$.getMatrix(),Q.getMatrix()),this}multiply3($,Q,J){return this.multiply2($,Q),this.multiply(J),this}translate($,Q,J){return L.translate(this.m4,this.m4,[$,Q,J]),this}translateToMatrix($){const Q=$.getMatrix();return this.translate(-Q[12],-Q[13],-Q[14])}rotateX($){return L.rotateX(this.m4,this.m4,$),this}rotateY($){return L.rotateY(this.m4,this.m4,$),this}rotateZ($){return L.rotateZ(this.m4,this.m4,$),this}setXRotation($){return L.fromXRotation(this.getMatrix(),$),this}setYRotation($){return L.fromYRotation(this.getMatrix(),$),this}scale($,Q,J){return L.scale(this.m4,this.m4,[$,Q??$,J??$]),this}perspective($,Q,J,B){return L.perspective(this.m4,$*T8,Q,J,B),this}ortho($,Q,J,B,K,Y){return L.ortho(this.m4,$,Q,J,B,K,Y),this}static aTemp=L.create();static bTemp=L.create();combine($,Q,J=0.5){return L.multiplyScalar(p.aTemp,$.getMatrix(),1-J),L.multiplyScalar(p.bTemp,Q.getMatrix(),J),L.add(this.m4,p.aTemp,p.bTemp),this}static tempQuat=Q0.create();static tempVec=i.create();moveMatrix($,Q,J,B){const K=p.tempVec;if(K[0]=$,K[1]=Q,K[2]=J,B)L.getRotation(p.tempQuat,B.getMatrix()),Q0.invert(p.tempQuat,p.tempQuat),i.transformQuat(K,K,p.tempQuat);return L.translate(this.m4,this.m4,K),this}setPosition($,Q,J){this.m4[12]=$,this.m4[13]=Q,this.m4[14]=J}getMatrix(){return this.m4}}var M=p;class e0{baseMatrix=M.create();perspectiveMatrix=M.create();orthoMatrix=M.create();perspectiveLevel=1;configPerspectiveMatrix($){this.perspectiveMatrix.perspective(45,$,0.01,1e5)}configOrthoMatrix($){this.orthoMatrix.ortho(-$,$,-1,1,-1e5,1e5)}configure($,Q){const J=$/Q;this.configPerspectiveMatrix(J),this.configOrthoMatrix(J)}setPerspective($){this.perspectiveLevel=$}getMatrix(){return this.baseMatrix.combine(this.orthoMatrix,this.perspectiveMatrix,this.perspectiveLevel),this.baseMatrix.getMatrix()}}function _0($){return($+Math.PI)%(2*Math.PI)-Math.PI}function d($,Q){return Math.round($/Q)*Q}class J0{$;Q;J;_goal;active=!1;speed=0;locker;constructor($,Q,J){this.element=$;this.getValue=Q;this.apply=J;this._goal=this.getValue($)}setGoal($,Q,J){if(this.locker&&this.locker!==J)return;if(this._goal!==$||this.speed!==Q)this.speed=Q,this._goal=$,this.locker=J,this.active=!0}get goal(){return this._goal}update($){if(this.active){const Q=this.getValue(this.element),J=this.goal-Q,B=Math.min(Math.abs(J),this.speed*$);if(B<=0.01)this.apply(this.element,this.goal),this.active=!1,this.locker=void 0;else this.apply(this.element,Q+B*Math.sign(J))}return this.active}}class u0{$;matrix=M.create();_tilt=0;progressive;constructor($){this.onChange=$;this.progressive=new J0(this,(Q)=>Q.tilt,(Q,J)=>Q.tilt=J)}get tilt(){return this._tilt}set tilt($){this._tilt=_0($),this.matrix.setXRotation(this._tilt),this.onChange?.()}getMatrix(){return this.matrix.getMatrix()}}class o0{$;matrix=M.create();_turn=0;progressive;constructor($){this.onChange=$;this.progressive=new J0(this,(Q)=>Q.turn,(Q,J)=>Q.turn=J)}get turn(){return this._turn}set turn($){this._turn=_0($),this.matrix.setYRotation(this._turn),this.onChange?.()}getMatrix(){return this.matrix.getMatrix()}}class a0{$;Q;J;updatedTypes=new Set;constructor($,Q,J){this.getCameraMatrix=$;this.engine=Q;this.motor=J}informUpdate($){this.motor.registerUpdate(this.withCameraType($))}withCameraType($){return this.updatedTypes.add($),this}refresh(){this.updatedTypes.forEach(($)=>this.engine.updateCameraMatrix($,this.getCameraMatrix($)))}}class t0{$;Q;J;updatedTypes=new Set;constructor($,Q,J){this.getCameraFloat=$;this.engine=Q;this.motor=J}informUpdate($){this.motor.registerUpdate(this.withCameraType($))}withCameraType($){return this.updatedTypes.add($),this}refresh(){this.updatedTypes.forEach(($)=>this.engine.updateCameraFloat($,this.getCameraFloat($)))}}function q0($,Q){if($)for(let J=0;J<$.length;J++){const B=$.at(J);if(B)Q(B,J)}}function B0($,Q){const J=[];for(let B=0;B<$.length;B++){const K=$.at(B);J.push(K?Q(K,B):void 0)}return J}function WQ($){const Q=$.getMatrix();return R0[0]=Q[12],R0[1]=Q[13],R0[2]=Q[14],R0}var R0=[0,0,0],YK=M.create();var S;(function(K){K[K["PROJECTION"]=0]="PROJECTION";K[K["POS"]=1]="POS";K[K["TURN"]=2]="TURN";K[K["TILT"]=3]="TILT"})(S||(S={}));var s;(function(Q){Q[Q["CURVATURE"]=0]="CURVATURE"})(s||(s={}));class $${positionMatrix=M.create().translate(0,0,0);camMatrix=M.create();projectionMatrix=new e0;tiltMatrix=new u0(()=>this.updateInformer.informUpdate(S.TILT));turnMatrix=new o0(()=>this.updateInformer.informUpdate(S.TURN));pespectiveLevel=1;curvature=0;updateInformer;updateInformerFloat;constructor({engine:$,motor:Q}){this.updateInformer=new a0(this.getCameraMatrix.bind(this),$,Q),this.updateInformerFloat=new t0(this.getCameraFloat.bind(this),$,Q)}activate(){this.updatePerspective(),this.updateInformer.informUpdate(S.POS),this.updateInformer.informUpdate(S.TURN),this.updateInformer.informUpdate(S.TILT)}cameraMatrices={[S.PROJECTION]:this.projectionMatrix,[S.POS]:this.camMatrix,[S.TURN]:this.turnMatrix,[S.TILT]:this.tiltMatrix};configProjectionMatrix($,Q){this.projectionMatrix.configure($,Q),this.updateInformer.informUpdate(S.PROJECTION)}updatePerspective($){this.projectionMatrix.setPerspective($??this.pespectiveLevel),this.updateInformer.informUpdate(S.PROJECTION)}updateCurvature($){this.curvature=$,this.updateInformerFloat.informUpdate(s.CURVATURE)}getCameraMatrix($){if($===S.POS)this.camMatrix.invert(this.positionMatrix);return this.cameraMatrices[$].getMatrix()}getCameraFloat($){switch($){case s.CURVATURE:return this.curvature}}gotoPos($,Q,J,B=0.1){const K=this.getPosition(),Y=$-K[0],Z=Q-K[1],V=J-K[2],H=Math.sqrt(Y*Y+Z*Z+V*V);if(H){const X=Math.min(H,B);this.positionMatrix.translate(Y/H*X,Z/H*X,V/H*X),this.updateInformer.informUpdate(S.POS)}}moveCam($,Q,J){this.positionMatrix.moveMatrix($,Q,J,this.turnMatrix),this.updateInformer.informUpdate(S.POS)}turn($){this.turnMatrix.turn+=$}tilt($){this.tiltMatrix.tilt+=$}getPosition(){return WQ(this.positionMatrix)}setPosition($,Q,J){this.positionMatrix.setPosition($,Q,J),this.updateInformer.informUpdate(S.POS)}}var I8=function($){if(!w8)return $;return new Proxy($,{get(J,B){const K=J,Y=K[B];if(typeof Y==="function")return(...V)=>{const H=Y.apply(K,V);return console.log(`gl.${String(B)}(`,V,") = ",H),H};else return console.log(`gl.${String(B)} = `,Y),Y}})},S8={alpha:!0,antialias:!1,depth:!0,desynchronized:!0,failIfMajorPerformanceCaveat:void 0,powerPreference:"default",premultipliedAlpha:!0,preserveDrawingBuffer:!1,stencil:!1},h8=6,w8=!1;class Q$ extends v{gl;programs;attributeBuffers;uniforms;canvas;textureManager;imageManager;textureSlots={};onResize=new Set;pixelListeners=new Set;spriteCount=0;cameraMatrixUniforms={};cameraFloatUniforms={};constructor($,{attributes:Q}={}){super();const J=$.getContext("webgl2",{...S8,...Q});this.gl=I8(J),this.canvas=$,this.programs=this.own(new f0(this.gl)),this.uniforms=this.own(new p0(this.gl,this.programs)),this.attributeBuffers=this.own(new y0(this.gl,this.programs)),this.textureManager=new n0(this.gl,this.uniforms),this.imageManager=new l0;const B=this.checkCanvasSize.bind(this);window.addEventListener("resize",B),this.addOnDestroy(()=>window.removeEventListener("resize",B)),this.initialize()}addResizeListener($){return $(this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.onResize.add($),()=>this.removeResizeListener($)}removeResizeListener($){this.onResize.delete($)}clearTextureSlots(){for(let $ in this.textureSlots)delete this.textureSlots[$]}checkCanvasSize(){if(this.canvas instanceof HTMLCanvasElement)this.canvas.width=this.canvas.offsetWidth*2,this.canvas.height=this.canvas.offsetHeight*2;this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.onResize.forEach(($)=>$(this.gl.drawingBufferWidth,this.gl.drawingBufferHeight))}initialize(){const Q={AUTHOR:"Jack le hamster"};this.programs.addProgram("main",d0(M$,Q),d0(L$,Q)),this.programs.useProgram("main"),this.cameraMatrixUniforms[S.PROJECTION]=this.uniforms.getUniformLocation(_$,"main"),this.cameraMatrixUniforms[S.POS]=this.uniforms.getUniformLocation(A$,"main"),this.cameraMatrixUniforms[S.TURN]=this.uniforms.getUniformLocation(D$,"main"),this.cameraMatrixUniforms[S.TILT]=this.uniforms.getUniformLocation(E$,"main"),this.cameraFloatUniforms[s.CURVATURE]=this.uniforms.getUniformLocation(q$,"main"),this.gl.enable(A.DEPTH_TEST),this.gl.depthFunc(A.LESS),this.gl.clearDepth(1),this.gl.enable(A.BLEND),this.gl.blendFunc(A.SRC_ALPHA,A.ONE_MINUS_SRC_ALPHA),this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.gl.disable(this.gl.CULL_FACE),this.gl.clearColor(0,0,0,1),this.textureManager.initialize(),this.checkCanvasSize()}activate(){this.clearTextureSlots()}setMaxSpriteCount($){this.initializeBuffers($)}onCleanupBuffers=new Set;initializeBuffers($){if(this.onCleanupBuffers.forEach((Q)=>Q()),this.onCleanupBuffers.clear(),$)[this.initializeIndexBuffer(N$),this.initializePositionBuffer(U$),this.initializeTransformBuffer(w0,$),this.initializeSlotSizeBuffer(I0,$),this.initializeInstanceBuffer(v0,$),this.initializeFlagBuffer(v0,$)].forEach((J)=>this.onCleanupBuffers.add(J))}initializeIndexBuffer($){const Q=this.attributeBuffers.createBuffer($);return this.gl.bindBuffer(A.ELEMENT_ARRAY_BUFFER,Q.buffer),this.gl.bufferData(A.ELEMENT_ARRAY_BUFFER,Uint16Array.from([0,1,2,2,3,0]),A.STATIC_DRAW),()=>{this.attributeBuffers.deleteBuffer($)}}initializePositionBuffer($){const Q=this.attributeBuffers.createBuffer($);return this.gl.bindBuffer(A.ARRAY_BUFFER,Q.buffer),this.gl.vertexAttribPointer(Q.location,2,A.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(Q.location),this.gl.bufferData(A.ARRAY_BUFFER,Float32Array.from([-1,-1,1,-1,1,1,-1,1]),A.STATIC_DRAW),()=>{this.gl.disableVertexAttribArray(Q.location),this.attributeBuffers.deleteBuffer($)}}initializeTransformBuffer($,Q){const J=this.attributeBuffers.createBuffer($);this.gl.bindBuffer(A.ARRAY_BUFFER,J.buffer);const B=4,K=B*Float32Array.BYTES_PER_ELEMENT,Y=4*K;for(let Z=0;Z<4;Z++){const V=J.location+Z;this.gl.vertexAttribPointer(V,B,A.FLOAT,!1,Y,Z*K),this.gl.enableVertexAttribArray(V),this.gl.vertexAttribDivisor(V,1)}return this.gl.bufferData(A.ARRAY_BUFFER,Q*Y,A.DYNAMIC_DRAW),()=>{this.gl.disableVertexAttribArray(J.location),this.attributeBuffers.deleteBuffer($)}}initializeSlotSizeBuffer($,Q){const J=this.attributeBuffers.createBuffer($);this.gl.bindBuffer(A.ARRAY_BUFFER,J.buffer);const B=J.location,K=2,Y=K*Float32Array.BYTES_PER_ELEMENT;return this.gl.vertexAttribPointer(B,K,A.FLOAT,!1,Y,0),this.gl.enableVertexAttribArray(B),this.gl.vertexAttribDivisor(B,1),this.gl.bufferData(A.ARRAY_BUFFER,Q*Y,A.DYNAMIC_DRAW),()=>{this.gl.disableVertexAttribArray(J.location),this.attributeBuffers.deleteBuffer($)}}initializeInstanceBuffer($,Q){const J=this.attributeBuffers.createBuffer($);this.gl.bindBuffer(A.ARRAY_BUFFER,J.buffer);const B=J.location,K=1;return this.gl.vertexAttribPointer(B,K,A.FLOAT,!1,K*Float32Array.BYTES_PER_ELEMENT,0),this.gl.enableVertexAttribArray(B),this.gl.vertexAttribDivisor(B,1),this.gl.bufferData(A.ARRAY_BUFFER,Float32Array.from(new Array(Q).fill(null).map((Y,Z)=>Z)),A.STATIC_DRAW),()=>{this.gl.disableVertexAttribArray(J.location),this.attributeBuffers.deleteBuffer($)}}initializeFlagBuffer($,Q){const J=this.attributeBuffers.createBuffer($);this.gl.bindBuffer(A.ARRAY_BUFFER,J.buffer);const B=J.location,K=1,Y=K*Float32Array.BYTES_PER_ELEMENT;return this.gl.vertexAttribPointer(B,K,A.FLOAT,!1,Y,0),this.gl.enableVertexAttribArray(B),this.gl.vertexAttribDivisor(B,1),this.gl.bufferData(A.ARRAY_BUFFER,Q*Y,A.STATIC_DRAW),()=>{this.gl.disableVertexAttribArray(J.location),this.attributeBuffers.deleteBuffer($)}}async updateTextures($,Q){const J=(await Promise.all($.map(async(Y)=>{const Z=Q(Y);if(!Z){console.warn(`No media for imageId ${Y}`);return}return{mediaData:await this.imageManager.renderMedia(Y,Z),imageId:Y}}))).filter((Y)=>!!Y),B=await Promise.all(J.map(async({mediaData:Y,imageId:Z})=>{const{slot:V,refreshCallback:H}=this.textureManager.allocateSlotForImage(Y),X=Math.log2(V.size[0]),F=Math.log2(V.size[1]),W=X*16+F;return this.textureSlots[Z]={buffer:Float32Array.from([W,V.slotNumber])},Y.refreshCallback=H,V.textureIndex}));return new Set(B).forEach((Y)=>{if(Y===U0)this.textureManager.setupTextureForVideo(`TEXTURE${Y}`);else this.textureManager.generateMipMap(`TEXTURE${Y}`)}),J.map(({mediaData:Y})=>Y)}drawElementsInstanced($,Q){this.gl.drawElementsInstanced(A.TRIANGLES,$,A.UNSIGNED_SHORT,0,Q)}updateSpriteTransforms($,Q){const J=this.attributeBuffers.getAttributeBuffer(w0);this.gl.bindBuffer(A.ARRAY_BUFFER,J.buffer);let B=this.spriteCount-1;$.forEach((K)=>{const Y=Q(K);if(this.gl.bufferSubData(A.ARRAY_BUFFER,16*Float32Array.BYTES_PER_ELEMENT*K,(Y?.transform??M.EMPTY).getMatrix()),Y)B=Math.max(B,K)}),$.clear();while(B>=0&&!Q(B))B--;this.spriteCount=Math.max(this.spriteCount,B+1)}updateSpriteAnims($,Q){const J=this.attributeBuffers.getAttributeBuffer(I0);this.gl.bindBuffer(A.ARRAY_BUFFER,J.buffer),$.forEach((B)=>{const K=Q(B),Y=this.textureSlots[K?.imageId??-1];if(Y){const{buffer:Z}=Y;this.gl.bufferSubData(A.ARRAY_BUFFER,2*Float32Array.BYTES_PER_ELEMENT*B,Z),$.delete(B)}})}updateCameraMatrix($,Q){this.gl.uniformMatrix4fv(this.cameraMatrixUniforms[$],!1,Q)}updateCameraFloat($,Q){this.gl.uniform1f(this.cameraFloatUniforms[$],Q)}bindVertexArray(){return this.own(new g0(this.gl))}addPixelListener($){return this.pixelListeners.add($),()=>{this.removePixelListener($)}}removePixelListener($){this.pixelListeners.delete($)}_pixel=new Uint8Array(4);getPixel($,Q){this.gl.readPixels($,Q,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this._pixel);const[J,B,K,Y]=this._pixel;return J*65536+B*256+K}refresh(){this.gl.clear(A.COLOR_BUFFER_BIT),this.drawElementsInstanced(h8,this.spriteCount);for(let $ of this.pixelListeners)$.pixel=this.getPixel($.x,$.y)}}var v8=50,J$;(function(J){J[J["DEFAULT"]=0]="DEFAULT";J[J["LAST"]=1]="LAST"})(J$||(J$={}));class B${updateSchedule=new Map;time=0;loop($,Q,J,B){return this.registerUpdate($,{period:Q?1000/Q:1,expirationTime:B,priority:J})}registerUpdate($,Q={}){return Q.triggerTime=Q.triggerTime??this.time,Q.expirationTime=Q.expirationTime??Infinity,Q.period=Q.period,Q.priority=Q.priority??J$.DEFAULT,this.updateSchedule.set($,Q),()=>this.deregisterUpdate($)}deregisterUpdate($){this.updateSchedule.delete($)}activate(){let $=0;const Q={time:0,deltaTime:0},J=[],B=[],K=[J,B],Y=(Z)=>{Q.deltaTime=Math.min(Z-Q.time,v8),Q.time=Z,$=requestAnimationFrame(Y),this.time=Z,J.length=0,B.length=0,this.updateSchedule.forEach((V,H)=>{if(Z<V.triggerTime)return;if(K[V.priority].push(H),V.period&&Z<V.expirationTime)V.triggerTime=Math.max(V.triggerTime+V.period,Z);else this.updateSchedule.delete(H)}),K.forEach((V)=>V.forEach((H)=>H.refresh(Q)))};return requestAnimationFrame(Y),()=>cancelAnimationFrame($)}}var z8=200;class K${$;keys={};keysUp={};keyDownListener=new Set;keyUpListener=new Set;quickTapListener=new Set;isActive=!1;constructor($){this.timeProvider=$;this.keyDown=this.keyDown.bind(this),this.keyUp=this.keyUp.bind(this)}keyDown($){if(!this.keys[$.code]){const Q=this.timeProvider.time;this.keys[$.code]=Q,this.keyDownListener.forEach((J)=>J.onKeyDown?.($.code,Q))}$.preventDefault()}keyUp($){const Q=this.timeProvider.time-this.keys[$.code]<z8;if(this.keysUp[$.code]=this.timeProvider.time,this.keys[$.code]=0,this.keyUpListener.forEach((J)=>J.onKeyUp?.($.code,this.timeProvider.time)),Q)this.quickTapListener.forEach((J)=>J.onQuickTap?.($.code,this.timeProvider.time))}activate(){return this.setActive(!0),()=>this.setActive(!1)}setActive($){if(this.isActive!==$){if(this.isActive=$,document.removeEventListener("keydown",this.keyDown),document.removeEventListener("keyup",this.keyUp),this.isActive)document.addEventListener("keydown",this.keyDown),document.addEventListener("keyup",this.keyUp)}}addListener($){if($.onKeyDown)this.keyDownListener.add($);if($.onKeyUp)this.keyUpListener.add($);if($.onQuickTap)this.quickTapListener.add($);return()=>{this.removeListener($)}}removeListener($){this.keyDownListener.delete($),this.keyUpListener.delete($),this.quickTapListener.delete($)}}class Y${engine;camera;constructor({engine:$,camera:Q}){this.engine=$,this.camera=Q}activate(){return this.handleResize()}handleResize(){const{engine:$}=this,Q=(J,B)=>{this.camera.configProjectionMatrix(J,B)};return $.addResizeListener(Q)}}class Z$ extends u{motor;engine;keyboard;camera;constructor({motor:$,canvas:Q,engine:J,keyboard:B,size:K,camera:Y}){super();this.motor=$??new B$,this.engine=J??new Q$(Q??new OffscreenCanvas(K[0],K[1])),this.keyboard=B??new K$(this.motor),this.camera=Y??new $$(this)}start($){const{motor:Q,engine:J,keyboard:B,camera:K}=this,Y=Q.loop(this);J.setMaxSpriteCount($.sprites.length),this.addAuxiliary($,Q,J,B,K,new Y$(this));const Z=this.activate();return()=>{Y(),Z(),this.deactivate(),this.removeAllAuxiliaries()}}}class K0{$;active=!1;constructor($){this.auxiliaries=$}static from(...$){return new K0($)}get length(){return this.auxiliaries.length}at($){return this.auxiliaries.at($)}refresh($){q0(this.auxiliaries,(Q)=>Q.refresh?.($))}activate(){if(!this.active){this.active=!0;const $=B0(this.auxiliaries,(Q)=>Q.activate?.());return()=>$.forEach((Q)=>Q?.())}}deactivate(){if(this.active)this.active=!1,q0(this.auxiliaries,($)=>$.deactivate?.())}}class V${keyboard;camera;constructor($){this.keyboard=$.keyboard,this.camera=$.camera}refresh($){const{keys:Q}=this.keyboard,{deltaTime:J}=$,B=J/80,K=J/400;if(Q.KeyW||Q.ArrowUp&&!Q.ShiftRight)this.camera.moveCam(0,0,-B);if(Q.KeyS||Q.ArrowDown&&!Q.ShiftRight)this.camera.moveCam(0,0,B);if(Q.KeyA||Q.ArrowLeft&&!Q.ShiftRight)this.camera.moveCam(-B,0,0);if(Q.KeyD||Q.ArrowRight&&!Q.ShiftRight)this.camera.moveCam(B,0,0);if(Q.KeyQ||Q.ArrowLeft&&Q.ShiftRight)this.camera.turn(-K);if(Q.KeyE||Q.ArrowRight&&Q.ShiftRight)this.camera.turn(K);if(Q.ArrowUp&&Q.ShiftRight)this.camera.tilt(-K);if(Q.ArrowDown&&Q.ShiftRight)this.camera.tilt(K)}}class H${keyboard;camera;goalPos;stepCount=0;turnCount=0;tiltCount=0;config;constructor({keyboard:$,camera:Q},J={}){this.keyboard=$,this.camera=Q;const B=this.camera.getPosition();this.goalPos=[...B],this.config={step:J.step??2,turnStep:J.turnStep??Math.PI/2,tiltStep:J.tiltStep??Math.PI/2}}prePos=[0,0,0];refresh($){const{keys:Q}=this.keyboard,{deltaTime:J}=$,B=this.camera.getPosition(),{step:K,turnStep:Y,tiltStep:Z}=this.config;this.prePos[0]=Math.round(B[0]/K)*K,this.prePos[1]=Math.round(B[1]/K)*K,this.prePos[2]=Math.round(B[2]/K)*K;let V=0,H=0;if(Q.KeyW||Q.ArrowUp&&!Q.ShiftRight)H--;if(Q.KeyS||Q.ArrowDown&&!Q.ShiftRight)H++;if(Q.KeyA||Q.ArrowLeft&&!Q.ShiftRight)V--;if(Q.KeyD||Q.ArrowRight&&!Q.ShiftRight)V++;const X=this.camera.turnMatrix.progressive.goal;if(V||H||this.stepCount>0){const j=V*Math.cos(X)-H*Math.sin(X),E=V*Math.sin(X)+H*Math.cos(X),C=Math.round(B[0]/K+j)*K,D=Math.round(B[2]/K+E)*K;this.goalPos[0]=C,this.goalPos[2]=D}if(!V&&!H)this.stepCount=0;const F=V||H?J/150:J/100;this.camera.gotoPos(this.goalPos[0],B[1],this.goalPos[2],F);const W=this.camera.getPosition();if(Math.round(W[0]/K)*K!==this.prePos[0]||Math.round(W[1]/K)*K!==this.prePos[1]||Math.round(W[2]/K)*K!==this.prePos[2])this.stepCount++;let P=0;if(Q.KeyQ||Q.ArrowLeft&&Q.ShiftRight)P--;if(Q.KeyE||Q.ArrowRight&&Q.ShiftRight)P++;const O=d(this.camera.turnMatrix.turn,Y);if(P||this.turnCount>0)this.camera.turnMatrix.progressive.setGoal(d(O+Y*P,Y),P?0.005:0.01,this);if(!P)this.turnCount=0;if(this.camera.turnMatrix.progressive.update(J)){if(d(this.camera.turnMatrix.turn,Y)!==O)this.turnCount++}let U=0;if(Q.ArrowUp&&Q.ShiftRight)U--;if(Q.ArrowDown&&Q.ShiftRight)U++;const N=d(this.camera.tiltMatrix.tilt,Z);if(U||this.tiltCount>0)this.camera.tiltMatrix.progressive.setGoal(d(N+Z*U,Z),U?0.0025:0.005,this);if(!U)this.tiltCount=0;if(this.camera.tiltMatrix.progressive.update(J)){if(d(this.camera.tiltMatrix.tilt,Z)!==N)this.tiltCount++}}}class G0{keyboard;camera;key;resetting=!1;constructor($,Q){this.keyboard=$.keyboard,this.camera=$.camera,this.key=Q.key}activate(){const $=this.keyboard.addListener({onQuickTap:(Q)=>{if(Q===this.key)this.resetting=!0,this.camera.tiltMatrix.progressive.setGoal(0,0.0033333333333333335,this)}});return()=>$()}refresh($){if(this.resetting){const{deltaTime:Q}=$;if(!this.camera.tiltMatrix.progressive.update(Q))this.resetting=!1}}}class X${keyboard;camera;key;dropping=!1;constructor({keyboard:$,camera:Q},J={key:"Space"}){this.keyboard=$,this.camera=Q,this.key=J.key}activate(){const $=this.keyboard.addListener({onQuickTap:(Q)=>{if(Q===this.key)this.dropping=!0}});return()=>$()}refresh($){const{deltaTime:Q}=$;this.riseAndDrop(Q,this.keyboard)}riseAndDrop($,Q){const J=$/80,{keys:B}=Q;if(B[this.key])this.camera.moveCam(0,J,0);else if(this.dropping){this.camera.moveCam(0,-J,0);const[K,Y,Z]=this.camera.getPosition();if(Y<0)this.camera.setPosition(K,0,Z),this.dropping=!1}}}class F${keyboard;active=!1;toggleIndex=0;pendingDeactivate;keys;auxiliaries;constructor({keyboard:$},Q){this.keyboard=$,this.keys=B0(Q.auxiliariesMapping,({key:J})=>J),this.keyboard.addListener({onKeyDown:(J)=>{if(this.keys.indexOf(J)>=0){const B=this.active;if(this.deactivate(),this.toggle(J),B)this.activate()}}}),this.auxiliaries=B0(Q.auxiliariesMapping,({aux:J})=>J)}get auxiliary(){return this.auxiliaries.at(this.toggleIndex)}toggle($){if(this.keys[this.toggleIndex]!==$)this.toggleIndex=this.keys.indexOf($);else{const Q=this.keys.length?(this.toggleIndex+1)%this.keys.length:0;if(this.keys[Q]===$)this.toggleIndex=Q}}refresh($){this.auxiliary?.refresh?.($)}activate(){if(!this.active)this.active=!0,this.pendingDeactivate=this.auxiliary?.activate?.()}deactivate(){if(this.active)this.active=!1,this.pendingDeactivate?.(),this.auxiliary?.deactivate?.()}}var jQ=0,PQ=1,OQ=2,UQ=3,NQ=4,W$=5,AQ=6,n=512;class j$ extends Y0{$;hudSpriteId=0;constructor($){super($);this.core=$;this.addMedia({id:jQ,type:"image",src:"dobuki.png"},{id:PQ,type:"draw",draw:(Q)=>{const{canvas:J}=Q;J.width=n,J.height=n;const B=J.width/2,K=J.height/2,Y=J.width/2;Q.imageSmoothingEnabled=!0,Q.fillStyle="#ddd",Q.lineWidth=J.width/50,Q.fillRect(0,0,J.width,J.height),Q.strokeStyle="black",Q.fillStyle="gold",Q.beginPath(),Q.arc(B,K,Y*0.8,0,2*Math.PI),Q.fill(),Q.stroke(),Q.beginPath(),Q.arc(B,K,Y*0.5,0,Math.PI),Q.stroke(),Q.beginPath(),Q.arc(J.width/3,J.height/3,Y*0.1,0,Math.PI,!0),Q.stroke(),Q.beginPath(),Q.arc(J.width/3*2,J.height/3,Y*0.1,0,Math.PI*2,!0),Q.stroke()}},{id:OQ,type:"draw",draw:(Q)=>{const{canvas:J}=Q;J.width=n,J.height=n,Q.imageSmoothingEnabled=!0,Q.fillStyle="#ddd",Q.lineWidth=J.width/50,Q.fillRect(0,0,J.width,J.height),Q.strokeStyle="black",Q.fillStyle="silver",Q.beginPath(),Q.rect(J.width*0.2,J.height*0.2,J.width*0.6,J.height*0.6),Q.fill(),Q.stroke()}},{id:UQ,type:"video",src:"sample.mp4",volume:0,fps:30,playSpeed:0.1,maxRefreshRate:30},{id:NQ,type:"draw",draw:(Q)=>{const{canvas:J}=Q;J.width=n,J.height=n,Q.imageSmoothingEnabled=!0,Q.lineWidth=5,Q.strokeStyle="green",Q.beginPath(),Q.rect(10,10,J.width-20,J.height-20),Q.stroke()}},{id:W$,type:"draw",draw:(Q)=>{const{canvas:J}=Q;J.width=n,J.height=n,Q.imageSmoothingEnabled=!0,Q.lineWidth=5,Q.setLineDash([5,2]),Q.strokeStyle="blue",Q.beginPath(),Q.rect(10,10,J.width-20,J.height-20),Q.stroke()}},{id:AQ,type:"draw",draw:(Q)=>{const{canvas:J}=Q;J.width=n,J.height=n,Q.imageSmoothingEnabled=!0,Q.fillStyle="green",Q.lineWidth=J.width/50,Q.fillRect(0,0,J.width,J.height),Q.strokeStyle="black",Q.fillStyle="#4f8",Q.beginPath(),Q.rect(J.width*0.2,J.height*0.2,J.width*0.6,J.height*0.6),Q.fill(),Q.stroke()}}),this.addSprites({imageId:jQ,transform:M.create().translate(0,0,-1)},...[M.create().translate(-1,0,0).rotateY(Math.PI/2).scale(1),M.create().translate(1,0,0).rotateY(-Math.PI/2).scale(1)].map((Q)=>({imageId:PQ,transform:Q})),...[M.create().translate(0,-1,0).rotateX(-Math.PI/2).scale(1),M.create().translate(0,-1,2).rotateX(-Math.PI/2).scale(1),M.create().translate(-2,-1,2).rotateX(-Math.PI/2).scale(1),M.create().translate(2,-1,2).rotateX(-Math.PI/2).scale(1)].map((Q)=>({imageId:OQ,transform:Q})),{imageId:UQ,transform:M.create().translate(0,1e4,-50000).scale(9600,5400,1)},...new Array(400).fill(0).map((Q,J)=>M.create().translate((J%20-10)*2,-1.5,(Math.floor(J/20)-10)*2).rotateX(-Math.PI/2).scale(1)).map((Q)=>({imageId:NQ,transform:Q})),...new Array(400).fill(0).map((Q,J)=>M.create().translate((J%20-10)*2,-1,(Math.floor(J/20)-10)*2).rotateX(-Math.PI/2).scale(1)).map((Q)=>({imageId:AQ,transform:Q})),...new Array(400).fill(0).map((Q,J)=>M.create().translate((J%20-10)*2,1,(Math.floor(J/20)-10)*2).rotateX(-Math.PI/2).scale(1)).map((Q)=>({imageId:W$,transform:Q})),...new Array(400).fill(0).map((Q,J)=>M.create().translate((J%20-10)*2,0,(Math.floor(J/20)-10)*2-1)).map((Q)=>({imageId:W$,transform:Q})))}activate(){const $=super.activate(),Q=this.core.addAuxiliary(new F$(this.core,{auxiliariesMapping:[{key:"Tab",aux:K0.from(new H$(this.core,{step:2,turnStep:Math.PI/2,tiltStep:Math.PI/4}),new G0(this.core,{key:"ShiftRight"}))},{key:"Tab",aux:K0.from(new V$(this.core),new X$(this.core),new G0(this.core,{key:"ShiftRight"}))}]}));return()=>{$(),Q()}}}async function WY(){console.log("Hello World!")}async function jY($){$.style.border="2px solid silver",$.addEventListener("mouseenter",()=>{$.style.borderColor="black"}),$.addEventListener("mouseleave",()=>{$.style.borderColor="silver"});const Q={x:0,y:0,pixel:0};$.addEventListener("mousemove",(K)=>{const Y=(K.pageX-$.offsetLeft)*2,Z=($.offsetHeight-(K.pageY-$.offsetTop))*2;Q.x=Y,Q.y=Z});const J=new Z$({canvas:$});J.engine.addPixelListener(Q);const B=new j$(J);return EQ=J.start(B),{core:J,world:B}}function PY(){EQ()}var EQ;export{jY as testCanvas,PY as stop,WY as hello,Y0 as World};

//# debugId=BEE990CDA837BE4164756e2164756e21
