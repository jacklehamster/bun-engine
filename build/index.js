var m$=Object.defineProperty;var U0=($,Q)=>{for(var J in Q)m$($,J,{get:Q[J],enumerable:!0,configurable:!0,set:(K)=>Q[J]=()=>K})};class $0{$;Q;constructor($,Q=$.camera){this.core=$;this.camera=Q;this.getSprite=this.getSprite.bind(this),this.getMedia=this.getMedia.bind(this)}onUpdate($,Q){console.warn("pass onUpdate to inform about changes in the world.",$,Q)}}class w{disposables;own($){if(!this.disposables)this.disposables=new Set;return this.disposables.add($),$}addOnDestroy($){this.disposables?.add({destroy:$})}destroy(){this.disposables?.forEach(($)=>$.destroy())}}var U=globalThis.WebGL2RenderingContext??{},u0="position",o0="index",E0="transform",R0="slotSize_and_number",a0="cam",t0="projection",$$="maxTextureSize",Q$="uTextures";var i$=function($,Q,J){function K(X,P){function j(C){return C===$?.VERTEX_SHADER?"vertex":C===$?.FRAGMENT_SHADER?"fragment":void 0}if(P!==$.VERTEX_SHADER&&P!==$.FRAGMENT_SHADER)throw new Error(`Shader error in ${j(P)}`);const A=$.createShader(P);if(!A)throw new Error(`Unable to generate ${j(P)} shader.`);if($.shaderSource(A,X),$.compileShader(A),!$.getShaderParameter(A,$.COMPILE_STATUS))console.error(`Shader compile error in ${j(P)}:`+$.getShaderInfoLog(A));return A}const B=$.createProgram();if(!B)throw new Error("Unable to create program.");const Y=K(Q,$.VERTEX_SHADER),Z=K(J,$.FRAGMENT_SHADER),V=$.getShaderInfoLog(Y),F=$.getShaderInfoLog(Z);if(V)console.log("VERTEX",V);if(F)console.log("FRAGMENT",F);$.attachShader(B,Y),$.attachShader(B,Z),$.linkProgram(B);const H=$.getProgramInfoLog(B);if(H)console.log("PROGRAM",H);if($.detachShader(B,Y),$.detachShader(B,Z),$.deleteShader(Y),$.deleteShader(Z),$.validateProgram(B),Object.entries(U).forEach(([X,P])=>{if(P&&$.getError()===P)console.log(`gl.${X}`)}),!$.getProgramParameter(B,$.LINK_STATUS))throw new Error("Unable to initialize the shader program:\n"+$.getProgramInfoLog(B));return B},d$=function($,Q){$.deleteProgram(Q)};class k0 extends w{gl;program;constructor($,Q,J){super();this.gl=$,this.program=i$($,Q.trim(),J.trim())}use(){this.gl.useProgram(this.program)}destroy(){super.destroy(),d$(this.gl,this.program)}}class N0 extends w{activeProgramId="";gl;programs={};constructor($){super();this.gl=$}addProgram($,Q,J){if(this.programs[$])this.removeProgram($);this.programs[$]=this.own(new k0(this.gl,Q,J))}useProgram($){if(this.activeProgramId!==$)this.activeProgramId=$,this.programs[$].use()}removeProgram($){this.programs[$].destroy(),delete this.programs[$]}getProgram($){return this.programs[$??this.activeProgramId]?.program}}class _0 extends w{gl;triangleArray;constructor($){super();this.gl=$,this.triangleArray=$.createVertexArray(),$.bindVertexArray(this.triangleArray)}destroy(){this.gl.deleteVertexArray(this.triangleArray)}}class D0 extends w{bufferRecord={};gl;programs;constructor($,Q){super();this.gl=$,this.programs=Q}getAttributeLocation($,Q){const J=this.programs.getProgram(Q);return J?this.gl.getAttribLocation(J,$)??-1:-1}createBuffer($){this.deleteBuffer($);const Q=this.gl?.createBuffer();if(!Q)throw new Error(`Unable to create buffer "${$}"`);const J={buffer:Q,location:this.getAttributeLocation($)};return this.bufferRecord[$]=J,J}deleteBuffer($){if(this.bufferRecord[$])this.gl.deleteBuffer(this.bufferRecord[$].buffer),delete this.bufferRecord[$]}getAttributeBuffer($){const Q=this.bufferRecord[$];if(!Q)throw new Error(`Attribute "${$}" not created. Make sure "createBuffer" is called.`);return Q}destroy(){Object.keys(this.bufferRecord).forEach(($)=>this.deleteBuffer($))}}class G0 extends w{gl;programs;constructor($,Q){super();this.gl=$,this.programs=Q}getUniformLocation($,Q){const J=this.programs.getProgram(Q);return this.gl.getUniformLocation(J,$)}}function J$($,Q=(J)=>J.key){var J=[];return q0($,"",!0,(K)=>J.push(K),Q),J.join("")}var q0=function($,Q,J,K,B){if($){K(`${Q}${J?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 "}${B($)}\n`);const Y=Q+(J?"    ":"\u2502   ");if($.left)q0($.left,Y,!1,K,B);if($.right)q0($.right,Y,!0,K,B)}};function Q0($){if($===null)return!0;var Q=J0($.left),J=J0($.right);if(Math.abs(Q-J)<=1&&Q0($.left)&&Q0($.right))return!0;return!1}var J0=function($){return $?1+Math.max(J0($.left),J0($.right)):0};function K0($,Q,J,K,B){const Y=B-K;if(Y>0){const Z=K+Math.floor(Y/2),V=Q[Z],F=J[Z],H={key:V,data:F,parent:$};return H.left=K0(H,Q,J,K,Z),H.right=K0(H,Q,J,Z+1,B),H}return null}function B0($){if($===null)return 0;const Q=B0($.left),J=B0($.right);return $.balanceFactor=Q-J,Math.max(Q,J)+1}function Y0($,Q,J,K,B){if(J>=K)return;const Y=$[J+K>>1];let Z=J-1,V=K+1;while(!0){do Z++;while(B($[Z],Y)<0);do V--;while(B($[V],Y)>0);if(Z>=V)break;let F=$[Z];$[Z]=$[V],$[V]=F,F=Q[Z],Q[Z]=Q[V],Q[V]=F}Y0($,Q,J,V,B),Y0($,Q,V+1,K,B)}var s$=function($,Q){return $>Q?1:$<Q?-1:0},Z0=function($){var Q=$.right;if($.right=Q.left,Q.left)Q.left.parent=$;if(Q.parent=$.parent,Q.parent)if(Q.parent.left===$)Q.parent.left=Q;else Q.parent.right=Q;if($.parent=Q,Q.left=$,$.balanceFactor+=1,Q.balanceFactor<0)$.balanceFactor-=Q.balanceFactor;if(Q.balanceFactor+=1,$.balanceFactor>0)Q.balanceFactor+=$.balanceFactor;return Q},V0=function($){var Q=$.left;if($.left=Q.right,$.left)$.left.parent=$;if(Q.parent=$.parent,Q.parent)if(Q.parent.left===$)Q.parent.left=Q;else Q.parent.right=Q;if($.parent=Q,Q.right=$,$.balanceFactor-=1,Q.balanceFactor>0)$.balanceFactor-=Q.balanceFactor;if(Q.balanceFactor-=1,$.balanceFactor<0)Q.balanceFactor+=$.balanceFactor;return Q};class d{constructor($,Q=!1){this._comparator=$||s$,this._root=null,this._size=0,this._noDuplicates=!!Q}destroy(){return this.clear()}clear(){return this._root=null,this._size=0,this}get size(){return this._size}contains($){if(this._root){var Q=this._root,J=this._comparator;while(Q){var K=J($,Q.key);if(K===0)return!0;else if(K<0)Q=Q.left;else Q=Q.right}}return!1}next($){var Q=$;if(Q)if(Q.right){Q=Q.right;while(Q.left)Q=Q.left}else{Q=$.parent;while(Q&&Q.right===$)$=Q,Q=Q.parent}return Q}prev($){var Q=$;if(Q)if(Q.left){Q=Q.left;while(Q.right)Q=Q.right}else{Q=$.parent;while(Q&&Q.left===$)$=Q,Q=Q.parent}return Q}forEach($){var Q=this._root,J=[],K=!1,B=0;while(!K)if(Q)J.push(Q),Q=Q.left;else if(J.length>0)Q=J.pop(),$(Q,B++),Q=Q.right;else K=!0;return this}range($,Q,J,K){const B=[],Y=this._comparator;let Z=this._root,V;while(B.length!==0||Z)if(Z)B.push(Z),Z=Z.left;else{if(Z=B.pop(),V=Y(Z.key,Q),V>0)break;else if(Y(Z.key,$)>=0){if(J.call(K,Z))return this}Z=Z.right}return this}keys(){var $=this._root,Q=[],J=[],K=!1;while(!K)if($)Q.push($),$=$.left;else if(Q.length>0)$=Q.pop(),J.push($.key),$=$.right;else K=!0;return J}values(){var $=this._root,Q=[],J=[],K=!1;while(!K)if($)Q.push($),$=$.left;else if(Q.length>0)$=Q.pop(),J.push($.data),$=$.right;else K=!0;return J}at($){var Q=this._root,J=[],K=!1,B=0;while(!K)if(Q)J.push(Q),Q=Q.left;else if(J.length>0){if(Q=J.pop(),B===$)return Q;B++,Q=Q.right}else K=!0;return null}minNode(){var $=this._root;if(!$)return null;while($.left)$=$.left;return $}maxNode(){var $=this._root;if(!$)return null;while($.right)$=$.right;return $}min(){var $=this._root;if(!$)return null;while($.left)$=$.left;return $.key}max(){var $=this._root;if(!$)return null;while($.right)$=$.right;return $.key}isEmpty(){return!this._root}pop(){var $=this._root,Q=null;if($){while($.left)$=$.left;Q={key:$.key,data:$.data},this.remove($.key)}return Q}popMax(){var $=this._root,Q=null;if($){while($.right)$=$.right;Q={key:$.key,data:$.data},this.remove($.key)}return Q}find($){var Q=this._root,J=Q,K,B=this._comparator;while(J)if(K=B($,J.key),K===0)return J;else if(K<0)J=J.left;else J=J.right;return null}insert($,Q){if(!this._root)return this._root={parent:null,left:null,right:null,balanceFactor:0,key:$,data:Q},this._size++,this._root;var J=this._comparator,K=this._root,B=null,Y=0;if(this._noDuplicates)while(K)if(Y=J($,K.key),B=K,Y===0)return null;else if(Y<0)K=K.left;else K=K.right;else while(K)if(Y=J($,K.key),B=K,Y<=0)K=K.left;else K=K.right;var Z={left:null,right:null,balanceFactor:0,parent:B,key:$,data:Q},V;if(Y<=0)B.left=Z;else B.right=Z;while(B){if(Y=J(B.key,$),Y<0)B.balanceFactor-=1;else B.balanceFactor+=1;if(B.balanceFactor===0)break;else if(B.balanceFactor<-1){if(B.right.balanceFactor===1)V0(B.right);if(V=Z0(B),B===this._root)this._root=V;break}else if(B.balanceFactor>1){if(B.left.balanceFactor===-1)Z0(B.left);if(V=V0(B),B===this._root)this._root=V;break}B=B.parent}return this._size++,Z}remove($){if(!this._root)return null;var Q=this._root,J=this._comparator,K=0;while(Q)if(K=J($,Q.key),K===0)break;else if(K<0)Q=Q.left;else Q=Q.right;if(!Q)return null;var B=Q.key,Y,Z;if(Q.left){Y=Q.left;while(Y.left||Y.right){while(Y.right)Y=Y.right;if(Q.key=Y.key,Q.data=Y.data,Y.left)Q=Y,Y=Y.left}Q.key=Y.key,Q.data=Y.data,Q=Y}if(Q.right){Z=Q.right;while(Z.left||Z.right){while(Z.left)Z=Z.left;if(Q.key=Z.key,Q.data=Z.data,Z.right)Q=Z,Z=Z.right}Q.key=Z.key,Q.data=Z.data,Q=Z}var V=Q.parent,F=Q,H;while(V){if(V.left===F)V.balanceFactor-=1;else V.balanceFactor+=1;if(V.balanceFactor<-1){if(V.right.balanceFactor===1)V0(V.right);if(H=Z0(V),V===this._root)this._root=H;V=H}else if(V.balanceFactor>1){if(V.left.balanceFactor===-1)Z0(V.left);if(H=V0(V),V===this._root)this._root=H;V=H}if(V.balanceFactor===-1||V.balanceFactor===1)break;F=V,V=V.parent}if(Q.parent)if(Q.parent.left===Q)Q.parent.left=null;else Q.parent.right=null;if(Q===this._root)this._root=null;return this._size--,B}load($=[],Q=[],J){if(this._size!==0)throw new Error("bulk-load: tree is not empty");const K=$.length;if(J)Y0($,Q,0,K-1,this._comparator);return this._root=K0(null,$,Q,0,K),B0(this._root),this._size=K,this}isBalanced(){return Q0(this._root)}toString($){return J$(this._root,$)}}d.default=d;class x{size;slotNumber;x;y;textureIndex;parent;sibbling;textureSizeLimits;constructor($,Q,J,K){this.textureSizeLimits=J?.textureSizeLimits??K??{min:M0,max:L0},this.size=$,this.slotNumber=Q,this.parent=J,this.sibbling=void 0;const{x:B,y:Y,textureIndex:Z}=this.calculatePosition($,Q);this.x=B,this.y=Y,this.textureIndex=Z}calculateTextureIndex($,Q){const[J,K]=$,B=this.textureSizeLimits.max/J*(this.textureSizeLimits.max/K);return Math.floor(Q/B)}calculatePosition($,Q){const[J,K]=$,B=this.textureSizeLimits.max/J,Y=this.textureSizeLimits.max/K,Z=Q%B*J,V=Math.floor(Q/B)%Y*K;return{x:Z,y:V,textureIndex:this.calculateTextureIndex($,Q)}}getTag(){return x.getTag(this)}static getTag($){return`${$.size[0]}x${$.size[1]}-#${$.slotNumber}`}static positionToTextureSlot($,Q,J,K,B){const[Y,Z]=J,V=B.textureSizeLimits.max/Y,H=B.textureSizeLimits.max/Y*(B.textureSizeLimits.max/Z)*K+Q/Z*V+$/Y;return new x(J,H,B)}getPosition(){return{x:this.x,y:this.y,size:this.size,textureIndex:this.textureIndex}}canSplitHorizontally(){const[,$]=this.size;return $>this.textureSizeLimits.min}canSplitVertically(){const[$]=this.size;return $>this.textureSizeLimits.min}splitHorizontally(){const{x:$,y:Q,size:J,textureIndex:K}=this,[B,Y]=J;if(!this.canSplitHorizontally())throw new Error(`Cannot split texture slot of size ${B} horizontally`);const Z=B/2,V=x.positionToTextureSlot($,Q,[Z,Y],K,this),F=x.positionToTextureSlot($+Z,Q,[Z,Y],K,this);return V.sibbling=F,F.sibbling=V,[V,F]}splitVertically(){const{x:$,y:Q,size:J,textureIndex:K}=this,[B,Y]=J;if(!this.canSplitVertically())throw new Error(`Cannot split texture slot of size ${Y} vertically`);const Z=Y/2,V=x.positionToTextureSlot($,Q,[B,Z],K,this),F=x.positionToTextureSlot($,Q+Z,[B,Z],K,this);return V.sibbling=F,F.sibbling=V,[V,F]}}function F0($,Q){return Math.max(Q,Math.pow(2,Math.ceil(Math.log($)/Math.log(2))))}function K$($,Q,J,K){if(J<1)throw new Error("Invalid count");const B=F0($,K.min),Y=F0(Q,K.min),Z=new Map;let V=K.min;for(let F=1;F<=J;F++){V=F0(B*F,K.min);const H=F0(Y*Math.ceil(J/F),K.min);Z.set(V,H)}for(let F=V;F<=K.max;F*=2)if(!Z.has(F))Z.set(F,Y);return Z}var b$=!1,M0=16,L0=4096,r$=16;class H0{textureSlots=new d(($,Q)=>{const J=$.size[0]*$.size[1]-Q.size[0]*Q.size[1];if(J!==0)return J;return $.slotNumber-Q.slotNumber},!1);allocatedTextures={};minTextureSize;maxTextureSize;numTextureSheets;initialSlots=[];constructor({numTextureSheets:$,minTextureSize:Q,maxTextureSize:J,excludeTexture:K}={},B){if(this.numTextureSheets=$??r$,this.minTextureSize=Q??M0,this.maxTextureSize=J??L0,B)this.numTextureSheets=Math.min(this.numTextureSheets,B.getParameter(WebGL2RenderingContext.MAX_TEXTURE_IMAGE_UNITS)),this.maxTextureSize=Math.min(this.maxTextureSize,B.getParameter(WebGL2RenderingContext.MAX_TEXTURE_SIZE)),this.minTextureSize=Math.min(this.minTextureSize,this.maxTextureSize);for(let Y=0;Y<this.numTextureSheets;Y++){if(K?.(Y))continue;this.initialSlots.push(new x([this.maxTextureSize,this.maxTextureSize],Y,void 0,{min:this.minTextureSize,max:this.maxTextureSize}))}this.initialSlots.forEach((Y)=>this.textureSlots.insert(Y))}allocate($,Q,J=1){const{size:K,slotNumber:B,x:Y,y:Z,textureIndex:V}=this.allocateHelper($,Q,J);return{size:K,slotNumber:B,x:Y,y:Z,textureIndex:V}}deallocate($){if(!this.isSlotUsed($))throw new Error("Slot is not allocated");const Q=this.allocatedTextures[x.getTag($)];this.deallocateHelper(Q)}get countUsedTextureSheets(){return this.initialSlots.filter(($)=>this.isSlotUsed($)).length}allocateHelper($,Q,J=1){const K=K$($,Q,J,{min:this.minTextureSize,max:this.maxTextureSize}),B=this.findSlot(K);if(!B)throw new Error(`Could not find a slot for texture to fit ${J} sprites of size ${$}x${Q}`);this.textureSlots.remove(B);const[Y,Z]=this.bestFit(K,B);return this.fitSlot(B,Y,Z)}findSlot($){for(let Q=0;Q<this.textureSlots.size;Q++){const K=this.textureSlots.at(Q).key,[B,Y]=K.size;if($.get(B)<=Y)return K}return null}calculateRatio($,Q){return Math.max($/Q,Q/$)}bestFit($,Q){const[J,K]=Q.size;let B=Q.textureSizeLimits.max;return $.forEach((Y,Z)=>{if(Z<=J&&Y<=K){const V=Z*Y,F=$.get(B)*B;if(V<F)B=Z;else if(V===F){if(this.calculateRatio(Z,Y)<this.calculateRatio(B,$.get(B)))B=Z}}}),[B,$.get(B)]}isSlotUsed($){return!!this.allocatedTextures[x.getTag($)]}deallocateHelper($){if($.parent&&$.sibbling&&!this.isSlotUsed($.sibbling)){const Q=$.sibbling;if(this.textureSlots.remove(Q),b$&&this.textureSlots.find($))throw new Error("Slot is not expected to be in the tree");const J=$.parent;this.deallocateHelper(J);return}this.textureSlots.insert($),delete this.allocatedTextures[$.getTag()]}trySplitHorizontally($,Q,J){if($.canSplitHorizontally()){const[K,B]=$.splitHorizontally();if(K.size[0]>=Q)return this.textureSlots.insert(B),this.fitSlot(K,Q,J)}return null}trySplitVertically($,Q,J){if($.canSplitVertically()){const[K,B]=$.splitVertically();if(K.size[1]>=J)return this.textureSlots.insert(B),this.fitSlot(K,Q,J)}return null}fitSlot($,Q,J){if(this.allocatedTextures[$.getTag()]=$,$.size[0]>$.size[1]){const K=this.trySplitHorizontally($,Q,J)??this.trySplitVertically($,Q,J);if(K)return K}else{const K=this.trySplitVertically($,Q,J)??this.trySplitHorizontally($,Q,J);if(K)return K}return $}listSlots(){this.textureSlots.forEach(($)=>{console.log($.key?.getTag())})}}var X0=15;class T0 extends w{gl;uniforms;textureBuffers={};tempContext=new OffscreenCanvas(1,1).getContext("2d");textureSlotAllocator=new H0({excludeTexture:($)=>$===X0});textureSlotAllocatorForVideo=new H0({excludeTexture:($)=>$!==X0});constructor($,Q){super();this.gl=$,this.uniforms=Q,this.tempContext.imageSmoothingEnabled=!0}initialize(){this.initTextureUniforms(),this.initMaxTexture()}getTexture($){if(!this.textureBuffers[$]){const Q=this.gl.createTexture();if(!Q)return;this.gl.bindTexture(U.TEXTURE_2D,Q),this.gl.texImage2D(U.TEXTURE_2D,0,U.RGBA,this.textureSlotAllocator.maxTextureSize,this.textureSlotAllocator.maxTextureSize,0,U.RGBA,U.UNSIGNED_BYTE,null),this.textureBuffers[$]=Q,this.addOnDestroy(()=>this.gl.deleteTexture(Q))}return this.textureBuffers[$]}loadTexture($,Q,J,K,B){this.gl.activeTexture(U[Q]),this.gl.bindTexture(U.TEXTURE_2D,J),this.applyTexImage2d($,K,B),this.gl.texParameteri(U.TEXTURE_2D,U.TEXTURE_MIN_FILTER,U.LINEAR)}applyTexImage2d($,[Q,J,K,B],[Y,Z,V,F]){if(K===V&&B===F&&!Q&&!J)this.gl.texSubImage2D(U.TEXTURE_2D,0,Y,Z,V,F,U.RGBA,U.UNSIGNED_BYTE,$.texImgSrc);else{const H=this.tempContext.canvas;if($.texImgSrc instanceof ImageData){if(H.width=V||$.width,H.height=F||$.height,this.tempContext.putImageData($.texImgSrc,0,0),Q||J)console.warn("Offset not available when sending imageData")}else{const X=K||$.width,P=B||$.height;H.width=V||X,H.height=F||P,this.tempContext.drawImage($.texImgSrc,Q,J,X,P,0,0,H.width,H.height)}this.gl.texSubImage2D(U.TEXTURE_2D,0,Y,Z,H.width,H.height,U.RGBA,U.UNSIGNED_BYTE,H)}}allocateSlotForImage($){const J=($.isVideo?this.textureSlotAllocatorForVideo:this.textureSlotAllocator).allocate($.width,$.height),K=`TEXTURE${J.textureIndex}`,B=this.getTexture(K);if(!B)throw new Error(`Invalid texture Id ${K}`);const Y=this.assignImageToTexture($,K,B,[0,0,$.width,$.height],[J.x,J.y,...J.size]);return{slot:J,refreshCallback:Y}}assignImageToTexture($,Q,J,K,B){const Y=K??[0,0,$.width,$.height],Z=B??[0,0,Y[2],Y[3]],V=()=>{this.gl.bindTexture(U.TEXTURE_2D,J),this.applyTexImage2d($,Y,Z)};if($.active)V();else this.loadTexture($,Q,J,Y,Z),$.active=!0;return V}setupTextureForVideo($){const Q=this.getTexture($);if(Q)this.gl.activeTexture(U[$]),this.gl.bindTexture(U.TEXTURE_2D,Q),this.gl.texParameteri(U.TEXTURE_2D,U.TEXTURE_MIN_FILTER,U.LINEAR),this.gl.texParameteri(U.TEXTURE_2D,U.TEXTURE_MAG_FILTER,U.LINEAR)}generateMipMap($){const Q=this.getTexture($);if(Q)this.gl.activeTexture(U[$]),this.gl.bindTexture(U.TEXTURE_2D,Q),this.gl.texParameteri(U.TEXTURE_2D,U.TEXTURE_MIN_FILTER,U.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(U.TEXTURE_2D,U.TEXTURE_MAG_FILTER,U.LINEAR),this.gl.generateMipmap(U.TEXTURE_2D)}initTextureUniforms(){const $=this.gl.getParameter(U.MAX_TEXTURE_IMAGE_UNITS),Q=new Array($).fill(null).map((K,B)=>B),J=this.uniforms.getUniformLocation(Q$);this.gl.uniform1iv(J,Q)}initMaxTexture(){const $=this.uniforms.getUniformLocation($$);this.gl.uniform1f($,this.textureSlotAllocator.maxTextureSize)}}class c extends w{texImgSrc;active=!1;width;height;isVideo;schedule;constructor($,Q){super();this.texImgSrc=$;const J=$;if(this.isVideo=!!(J.videoWidth||J.videoHeight),this.width=J.naturalWidth??J.videoWidth??J.displayWidth??J.width?.baseValue?.value??J.width,this.height=J.naturalHeight??J.videoHeight??J.displayHeight??J.height?.baseValue?.value??J.height,this.schedule=Q?{period:1000/Q}:void 0,!this.width||!this.height)throw new Error("Invalid image")}update(){this.refreshCallback?.()}static createFromCanvas($){return new c($)}static async loadImage($){const Q=await new Promise((J,K)=>{const B=new Image,Y=(Z)=>K(Z.error);B.addEventListener("error",Y),B.addEventListener("load",()=>J(B),{once:!0}),B.src=$});return new c(Q)}static async loadVideo($,Q,J=30){const K=await new Promise((Y,Z)=>{const V=document.createElement("video");if(V.loop=!0,Q!==void 0)V.volume=Q;V.addEventListener("loadedmetadata",()=>{V.play(),Y(V)},{once:!0}),V.addEventListener("error",(F)=>Z(F.error)),V.src=$}),B=new c(K,J);return B.addOnDestroy(()=>K.pause()),B}static async loadWebcam($){const Q=await new Promise((B,Y)=>{const Z=document.createElement("video");Z.loop=!0,Z.addEventListener("loadedmetadata",()=>Z.play()),Z.addEventListener("playing",()=>B(Z),{once:!0}),Z.addEventListener("error",(V)=>Y(V.error))}),J=new c(Q);let K=!1;return navigator.mediaDevices.getUserMedia({video:{deviceId:$}}).then((B)=>{if(!K)Q.srcObject=B,J.addOnDestroy(()=>B.getTracks().forEach((Y)=>Y.stop()))}),J.addOnDestroy(()=>{K=!0,Q.pause()}),J}}var e=function($){return $};class S0 extends w{constructor(){super(...arguments)}images={};renderProcedures={image:e(($,Q)=>this.loadImage($,Q.src)),video:e(($,Q)=>this.loadVideo($,Q.src,Q.volume,Q.fps)),draw:e(($,Q)=>this.drawImage($,Q.draw)),canvas:e(($,Q)=>this.loadCanvas($,Q.canvas)),webcam:e(($,Q)=>this.loadWebCam($,Q.deviceId))};hasImageId($){return!!this.getMedia($)}getMedia($){return this.images[$]}setImage($,Q){this.images[$]=Q}async renderMedia($,Q){return this.renderProcedures[Q.type]($,Q)}async drawImage($,Q){const J=new OffscreenCanvas(1,1);Q(J.getContext("2d"));const K=c.createFromCanvas(J);return this.images[$]=this.own(K),K}async loadCanvas($,Q){const J=c.createFromCanvas(Q);return Q.getContext("2d"),this.images[$]=this.own(J),J}async loadImage($,Q){const J=await c.loadImage(Q);return this.images[$]=this.own(J),J}async loadVideo($,Q,J,K){const B=await c.loadVideo(Q,J,K);return this.images[$]=this.own(B),B}async loadWebCam($,Q){const J=await c.loadWebcam(Q);return this.images[$]=this.own(J),J}}var B$=`#version 300 es
//  ~{AUTHOR}

precision highp float;

//  IN
//  shape
layout(location = 0) in vec2 position;
layout(location = 1) in mat4 transform;
//  2, 3, 4 reserved for transform
//  animation
layout(location = 5) in vec2 slotSize_and_number;

//  UNIFORM
uniform float maxTextureSize;
uniform mat4 cam;
uniform mat4 projection;

//  OUT
out vec2 vTex;
out float textureIndex;

void main() {
  vec2 tex = position.xy * vec2(0.49, -0.49) + 0.5;
  vec2 slotSize = vec2(
    pow(2.0, floor(slotSize_and_number.x / 16.0)),
    pow(2.0, mod(slotSize_and_number.x, 16.0)));
  float slotNumber = slotSize_and_number.y;
  float maxCols = maxTextureSize / slotSize.x;
  float maxRows = maxTextureSize / slotSize.y;
  float slotX = mod(slotNumber, maxCols);
  float slotY = mod(floor(slotNumber / maxCols), maxRows);

  gl_Position = projection * cam * transform * vec4(position, 0.0, 1.0);
  vTex = (vec2(slotX, slotY) + tex) * slotSize / maxTextureSize;
  textureIndex = floor(slotNumber / (maxCols * maxRows));
}
`;var Y$=`#version 300 es
//  ~{AUTHOR}
precision highp float;

//  CONST
const int NUM_TEXTURES = 16;
const float threshold = 0.00001;

//  IN
//  texture
uniform sampler2D uTextures[NUM_TEXTURES];
in float textureIndex;
in vec2 vTex;
in float opacity;

//  OUT
out vec4 fragColor;

//  FUNCTIONS
vec4 getTextureColor(float textureSlot, vec2 vTexturePoint);

void main() {
  vec4 color = getTextureColor(textureIndex, vTex);
  if (color.a <= .0001) {
    discard;
  };
  fragColor = color;
}

vec4 getTextureColor(float textureSlot, vec2 vTexturePoint) {
  if (abs(0.0 - textureSlot) < threshold) {
    return texture(uTextures[0], vTexturePoint);
  }
  if (abs(1.0 - textureSlot) < threshold) {
    return texture(uTextures[1], vTexturePoint);
  }
  if (abs(2.0 - textureSlot) < threshold) {
    return texture(uTextures[2], vTexturePoint);
  }
  if (abs(3.0 - textureSlot) < threshold) {
    return texture(uTextures[3], vTexturePoint);
  }
  if (abs(4.0 - textureSlot) < threshold) {
    return texture(uTextures[4], vTexturePoint);
  }
  if (abs(5.0 - textureSlot) < threshold) {
    return texture(uTextures[5], vTexturePoint);
  }
  if (abs(6.0 - textureSlot) < threshold) {
    return texture(uTextures[6], vTexturePoint);
  }
  if (abs(7.0 - textureSlot) < threshold) {
    return texture(uTextures[7], vTexturePoint);
  }
  if (abs(8.0 - textureSlot) < threshold) {
    return texture(uTextures[8], vTexturePoint);
  }
  if (abs(9.0 - textureSlot) < threshold) {
    return texture(uTextures[9], vTexturePoint);
  }
  if (abs(10.0 - textureSlot) < threshold) {
    return texture(uTextures[10], vTexturePoint);
  }
  if (abs(11.0 - textureSlot) < threshold) {
    return texture(uTextures[11], vTexturePoint);
  }
  if (abs(12.0 - textureSlot) < threshold) {
    return texture(uTextures[12], vTexturePoint);
  }
  if (abs(13.0 - textureSlot) < threshold) {
    return texture(uTextures[13], vTexturePoint);
  }
  if (abs(14.0 - textureSlot) < threshold) {
    return texture(uTextures[14], vTexturePoint);
  }
  if (abs(15.0 - textureSlot) < threshold) {
    return texture(uTextures[15], vTexturePoint);
  }
  return texture(uTextures[0], vTexturePoint);
}
`;function h0($,Q){return $.replace(/~\{(\w+)\}/g,(J,K)=>{return Q?.[K]||J})}var D=0.000001,T=typeof Float32Array!=="undefined"?Float32Array:Array,n=Math.random,mK=Math.PI/180;if(!Math.hypot)Math.hypot=function(){var $=0,Q=arguments.length;while(Q--)$+=arguments[Q]*arguments[Q];return Math.sqrt($)};function Z$(){var $=new T(9);if(T!=Float32Array)$[1]=0,$[2]=0,$[3]=0,$[5]=0,$[6]=0,$[7]=0;return $[0]=1,$[4]=1,$[8]=1,$}var M={};U0(M,{transpose:()=>{{return KQ}},translate:()=>{{return VQ}},targetTo:()=>{{return wQ}},subtract:()=>{{return A$}},sub:()=>{{return lQ}},str:()=>{{return vQ}},set:()=>{{return JQ}},scale:()=>{{return FQ}},rotateZ:()=>{{return WQ}},rotateY:()=>{{return PQ}},rotateX:()=>{{return XQ}},rotate:()=>{{return HQ}},perspectiveZO:()=>{{return LQ}},perspectiveNO:()=>{{return P$}},perspectiveFromFieldOfView:()=>{{return TQ}},perspective:()=>{{return MQ}},orthoZO:()=>{{return hQ}},orthoNO:()=>{{return W$}},ortho:()=>{{return SQ}},multiplyScalarAndAdd:()=>{{return yQ}},multiplyScalar:()=>{{return zQ}},multiply:()=>{{return F$}},mul:()=>{{return cQ}},lookAt:()=>{{return IQ}},invert:()=>{{return BQ}},identity:()=>{{return V$}},getTranslation:()=>{{return kQ}},getScaling:()=>{{return X$}},getRotation:()=>{{return NQ}},frustum:()=>{{return qQ}},fromZRotation:()=>{{return EQ}},fromYRotation:()=>{{return UQ}},fromXRotation:()=>{{return CQ}},fromValues:()=>{{return QQ}},fromTranslation:()=>{{return AQ}},fromScaling:()=>{{return jQ}},fromRotationTranslationScaleOrigin:()=>{{return DQ}},fromRotationTranslationScale:()=>{{return _Q}},fromRotationTranslation:()=>{{return H$}},fromRotation:()=>{{return OQ}},fromQuat2:()=>{{return RQ}},fromQuat:()=>{{return GQ}},frob:()=>{{return fQ}},exactEquals:()=>{{return pQ}},equals:()=>{{return xQ}},determinant:()=>{{return ZQ}},create:()=>{{return a$}},copy:()=>{{return $Q}},clone:()=>{{return t$}},adjoint:()=>{{return YQ}},add:()=>{{return gQ}}});function a$(){var $=new T(16);if(T!=Float32Array)$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[6]=0,$[7]=0,$[8]=0,$[9]=0,$[11]=0,$[12]=0,$[13]=0,$[14]=0;return $[0]=1,$[5]=1,$[10]=1,$[15]=1,$}function t$($){var Q=new T(16);return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q[3]=$[3],Q[4]=$[4],Q[5]=$[5],Q[6]=$[6],Q[7]=$[7],Q[8]=$[8],Q[9]=$[9],Q[10]=$[10],Q[11]=$[11],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15],Q}function $Q($,Q){return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$[3]=Q[3],$[4]=Q[4],$[5]=Q[5],$[6]=Q[6],$[7]=Q[7],$[8]=Q[8],$[9]=Q[9],$[10]=Q[10],$[11]=Q[11],$[12]=Q[12],$[13]=Q[13],$[14]=Q[14],$[15]=Q[15],$}function QQ($,Q,J,K,B,Y,Z,V,F,H,X,P,j,A,C,O){var W=new T(16);return W[0]=$,W[1]=Q,W[2]=J,W[3]=K,W[4]=B,W[5]=Y,W[6]=Z,W[7]=V,W[8]=F,W[9]=H,W[10]=X,W[11]=P,W[12]=j,W[13]=A,W[14]=C,W[15]=O,W}function JQ($,Q,J,K,B,Y,Z,V,F,H,X,P,j,A,C,O,W){return $[0]=Q,$[1]=J,$[2]=K,$[3]=B,$[4]=Y,$[5]=Z,$[6]=V,$[7]=F,$[8]=H,$[9]=X,$[10]=P,$[11]=j,$[12]=A,$[13]=C,$[14]=O,$[15]=W,$}function V$($){return $[0]=1,$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=1,$[6]=0,$[7]=0,$[8]=0,$[9]=0,$[10]=1,$[11]=0,$[12]=0,$[13]=0,$[14]=0,$[15]=1,$}function KQ($,Q){if($===Q){var J=Q[1],K=Q[2],B=Q[3],Y=Q[6],Z=Q[7],V=Q[11];$[1]=Q[4],$[2]=Q[8],$[3]=Q[12],$[4]=J,$[6]=Q[9],$[7]=Q[13],$[8]=K,$[9]=Y,$[11]=Q[14],$[12]=B,$[13]=Z,$[14]=V}else $[0]=Q[0],$[1]=Q[4],$[2]=Q[8],$[3]=Q[12],$[4]=Q[1],$[5]=Q[5],$[6]=Q[9],$[7]=Q[13],$[8]=Q[2],$[9]=Q[6],$[10]=Q[10],$[11]=Q[14],$[12]=Q[3],$[13]=Q[7],$[14]=Q[11],$[15]=Q[15];return $}function BQ($,Q){var J=Q[0],K=Q[1],B=Q[2],Y=Q[3],Z=Q[4],V=Q[5],F=Q[6],H=Q[7],X=Q[8],P=Q[9],j=Q[10],A=Q[11],C=Q[12],O=Q[13],W=Q[14],E=Q[15],G=J*V-K*Z,_=J*F-B*Z,N=J*H-Y*Z,R=K*F-B*V,k=K*H-Y*V,v=B*H-Y*F,S=X*O-P*C,h=X*W-j*C,I=X*E-A*C,f=P*W-j*O,g=P*E-A*O,z=j*E-A*W,q=G*z-_*g+N*f+R*I-k*h+v*S;if(!q)return null;return q=1/q,$[0]=(V*z-F*g+H*f)*q,$[1]=(B*g-K*z-Y*f)*q,$[2]=(O*v-W*k+E*R)*q,$[3]=(j*k-P*v-A*R)*q,$[4]=(F*I-Z*z-H*h)*q,$[5]=(J*z-B*I+Y*h)*q,$[6]=(W*N-C*v-E*_)*q,$[7]=(X*v-j*N+A*_)*q,$[8]=(Z*g-V*I+H*S)*q,$[9]=(K*I-J*g-Y*S)*q,$[10]=(C*k-O*N+E*G)*q,$[11]=(P*N-X*k-A*G)*q,$[12]=(V*h-Z*f-F*S)*q,$[13]=(J*f-K*h+B*S)*q,$[14]=(O*_-C*R-W*G)*q,$[15]=(X*R-P*_+j*G)*q,$}function YQ($,Q){var J=Q[0],K=Q[1],B=Q[2],Y=Q[3],Z=Q[4],V=Q[5],F=Q[6],H=Q[7],X=Q[8],P=Q[9],j=Q[10],A=Q[11],C=Q[12],O=Q[13],W=Q[14],E=Q[15];return $[0]=V*(j*E-A*W)-P*(F*E-H*W)+O*(F*A-H*j),$[1]=-(K*(j*E-A*W)-P*(B*E-Y*W)+O*(B*A-Y*j)),$[2]=K*(F*E-H*W)-V*(B*E-Y*W)+O*(B*H-Y*F),$[3]=-(K*(F*A-H*j)-V*(B*A-Y*j)+P*(B*H-Y*F)),$[4]=-(Z*(j*E-A*W)-X*(F*E-H*W)+C*(F*A-H*j)),$[5]=J*(j*E-A*W)-X*(B*E-Y*W)+C*(B*A-Y*j),$[6]=-(J*(F*E-H*W)-Z*(B*E-Y*W)+C*(B*H-Y*F)),$[7]=J*(F*A-H*j)-Z*(B*A-Y*j)+X*(B*H-Y*F),$[8]=Z*(P*E-A*O)-X*(V*E-H*O)+C*(V*A-H*P),$[9]=-(J*(P*E-A*O)-X*(K*E-Y*O)+C*(K*A-Y*P)),$[10]=J*(V*E-H*O)-Z*(K*E-Y*O)+C*(K*H-Y*V),$[11]=-(J*(V*A-H*P)-Z*(K*A-Y*P)+X*(K*H-Y*V)),$[12]=-(Z*(P*W-j*O)-X*(V*W-F*O)+C*(V*j-F*P)),$[13]=J*(P*W-j*O)-X*(K*W-B*O)+C*(K*j-B*P),$[14]=-(J*(V*W-F*O)-Z*(K*W-B*O)+C*(K*F-B*V)),$[15]=J*(V*j-F*P)-Z*(K*j-B*P)+X*(K*F-B*V),$}function ZQ($){var Q=$[0],J=$[1],K=$[2],B=$[3],Y=$[4],Z=$[5],V=$[6],F=$[7],H=$[8],X=$[9],P=$[10],j=$[11],A=$[12],C=$[13],O=$[14],W=$[15],E=Q*Z-J*Y,G=Q*V-K*Y,_=Q*F-B*Y,N=J*V-K*Z,R=J*F-B*Z,k=K*F-B*V,v=H*C-X*A,S=H*O-P*A,h=H*W-j*A,I=X*O-P*C,f=X*W-j*C,g=P*W-j*O;return E*g-G*f+_*I+N*h-R*S+k*v}function F$($,Q,J){var K=Q[0],B=Q[1],Y=Q[2],Z=Q[3],V=Q[4],F=Q[5],H=Q[6],X=Q[7],P=Q[8],j=Q[9],A=Q[10],C=Q[11],O=Q[12],W=Q[13],E=Q[14],G=Q[15],_=J[0],N=J[1],R=J[2],k=J[3];return $[0]=_*K+N*V+R*P+k*O,$[1]=_*B+N*F+R*j+k*W,$[2]=_*Y+N*H+R*A+k*E,$[3]=_*Z+N*X+R*C+k*G,_=J[4],N=J[5],R=J[6],k=J[7],$[4]=_*K+N*V+R*P+k*O,$[5]=_*B+N*F+R*j+k*W,$[6]=_*Y+N*H+R*A+k*E,$[7]=_*Z+N*X+R*C+k*G,_=J[8],N=J[9],R=J[10],k=J[11],$[8]=_*K+N*V+R*P+k*O,$[9]=_*B+N*F+R*j+k*W,$[10]=_*Y+N*H+R*A+k*E,$[11]=_*Z+N*X+R*C+k*G,_=J[12],N=J[13],R=J[14],k=J[15],$[12]=_*K+N*V+R*P+k*O,$[13]=_*B+N*F+R*j+k*W,$[14]=_*Y+N*H+R*A+k*E,$[15]=_*Z+N*X+R*C+k*G,$}function VQ($,Q,J){var K=J[0],B=J[1],Y=J[2],Z,V,F,H,X,P,j,A,C,O,W,E;if(Q===$)$[12]=Q[0]*K+Q[4]*B+Q[8]*Y+Q[12],$[13]=Q[1]*K+Q[5]*B+Q[9]*Y+Q[13],$[14]=Q[2]*K+Q[6]*B+Q[10]*Y+Q[14],$[15]=Q[3]*K+Q[7]*B+Q[11]*Y+Q[15];else Z=Q[0],V=Q[1],F=Q[2],H=Q[3],X=Q[4],P=Q[5],j=Q[6],A=Q[7],C=Q[8],O=Q[9],W=Q[10],E=Q[11],$[0]=Z,$[1]=V,$[2]=F,$[3]=H,$[4]=X,$[5]=P,$[6]=j,$[7]=A,$[8]=C,$[9]=O,$[10]=W,$[11]=E,$[12]=Z*K+X*B+C*Y+Q[12],$[13]=V*K+P*B+O*Y+Q[13],$[14]=F*K+j*B+W*Y+Q[14],$[15]=H*K+A*B+E*Y+Q[15];return $}function FQ($,Q,J){var K=J[0],B=J[1],Y=J[2];return $[0]=Q[0]*K,$[1]=Q[1]*K,$[2]=Q[2]*K,$[3]=Q[3]*K,$[4]=Q[4]*B,$[5]=Q[5]*B,$[6]=Q[6]*B,$[7]=Q[7]*B,$[8]=Q[8]*Y,$[9]=Q[9]*Y,$[10]=Q[10]*Y,$[11]=Q[11]*Y,$[12]=Q[12],$[13]=Q[13],$[14]=Q[14],$[15]=Q[15],$}function HQ($,Q,J,K){var B=K[0],Y=K[1],Z=K[2],V=Math.hypot(B,Y,Z),F,H,X,P,j,A,C,O,W,E,G,_,N,R,k,v,S,h,I,f,g,z,q,p;if(V<D)return null;if(V=1/V,B*=V,Y*=V,Z*=V,F=Math.sin(J),H=Math.cos(J),X=1-H,P=Q[0],j=Q[1],A=Q[2],C=Q[3],O=Q[4],W=Q[5],E=Q[6],G=Q[7],_=Q[8],N=Q[9],R=Q[10],k=Q[11],v=B*B*X+H,S=Y*B*X+Z*F,h=Z*B*X-Y*F,I=B*Y*X-Z*F,f=Y*Y*X+H,g=Z*Y*X+B*F,z=B*Z*X+Y*F,q=Y*Z*X-B*F,p=Z*Z*X+H,$[0]=P*v+O*S+_*h,$[1]=j*v+W*S+N*h,$[2]=A*v+E*S+R*h,$[3]=C*v+G*S+k*h,$[4]=P*I+O*f+_*g,$[5]=j*I+W*f+N*g,$[6]=A*I+E*f+R*g,$[7]=C*I+G*f+k*g,$[8]=P*z+O*q+_*p,$[9]=j*z+W*q+N*p,$[10]=A*z+E*q+R*p,$[11]=C*z+G*q+k*p,Q!==$)$[12]=Q[12],$[13]=Q[13],$[14]=Q[14],$[15]=Q[15];return $}function XQ($,Q,J){var K=Math.sin(J),B=Math.cos(J),Y=Q[4],Z=Q[5],V=Q[6],F=Q[7],H=Q[8],X=Q[9],P=Q[10],j=Q[11];if(Q!==$)$[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$[3]=Q[3],$[12]=Q[12],$[13]=Q[13],$[14]=Q[14],$[15]=Q[15];return $[4]=Y*B+H*K,$[5]=Z*B+X*K,$[6]=V*B+P*K,$[7]=F*B+j*K,$[8]=H*B-Y*K,$[9]=X*B-Z*K,$[10]=P*B-V*K,$[11]=j*B-F*K,$}function PQ($,Q,J){var K=Math.sin(J),B=Math.cos(J),Y=Q[0],Z=Q[1],V=Q[2],F=Q[3],H=Q[8],X=Q[9],P=Q[10],j=Q[11];if(Q!==$)$[4]=Q[4],$[5]=Q[5],$[6]=Q[6],$[7]=Q[7],$[12]=Q[12],$[13]=Q[13],$[14]=Q[14],$[15]=Q[15];return $[0]=Y*B-H*K,$[1]=Z*B-X*K,$[2]=V*B-P*K,$[3]=F*B-j*K,$[8]=Y*K+H*B,$[9]=Z*K+X*B,$[10]=V*K+P*B,$[11]=F*K+j*B,$}function WQ($,Q,J){var K=Math.sin(J),B=Math.cos(J),Y=Q[0],Z=Q[1],V=Q[2],F=Q[3],H=Q[4],X=Q[5],P=Q[6],j=Q[7];if(Q!==$)$[8]=Q[8],$[9]=Q[9],$[10]=Q[10],$[11]=Q[11],$[12]=Q[12],$[13]=Q[13],$[14]=Q[14],$[15]=Q[15];return $[0]=Y*B+H*K,$[1]=Z*B+X*K,$[2]=V*B+P*K,$[3]=F*B+j*K,$[4]=H*B-Y*K,$[5]=X*B-Z*K,$[6]=P*B-V*K,$[7]=j*B-F*K,$}function AQ($,Q){return $[0]=1,$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=1,$[6]=0,$[7]=0,$[8]=0,$[9]=0,$[10]=1,$[11]=0,$[12]=Q[0],$[13]=Q[1],$[14]=Q[2],$[15]=1,$}function jQ($,Q){return $[0]=Q[0],$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=Q[1],$[6]=0,$[7]=0,$[8]=0,$[9]=0,$[10]=Q[2],$[11]=0,$[12]=0,$[13]=0,$[14]=0,$[15]=1,$}function OQ($,Q,J){var K=J[0],B=J[1],Y=J[2],Z=Math.hypot(K,B,Y),V,F,H;if(Z<D)return null;return Z=1/Z,K*=Z,B*=Z,Y*=Z,V=Math.sin(Q),F=Math.cos(Q),H=1-F,$[0]=K*K*H+F,$[1]=B*K*H+Y*V,$[2]=Y*K*H-B*V,$[3]=0,$[4]=K*B*H-Y*V,$[5]=B*B*H+F,$[6]=Y*B*H+K*V,$[7]=0,$[8]=K*Y*H+B*V,$[9]=B*Y*H-K*V,$[10]=Y*Y*H+F,$[11]=0,$[12]=0,$[13]=0,$[14]=0,$[15]=1,$}function CQ($,Q){var J=Math.sin(Q),K=Math.cos(Q);return $[0]=1,$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=K,$[6]=J,$[7]=0,$[8]=0,$[9]=-J,$[10]=K,$[11]=0,$[12]=0,$[13]=0,$[14]=0,$[15]=1,$}function UQ($,Q){var J=Math.sin(Q),K=Math.cos(Q);return $[0]=K,$[1]=0,$[2]=-J,$[3]=0,$[4]=0,$[5]=1,$[6]=0,$[7]=0,$[8]=J,$[9]=0,$[10]=K,$[11]=0,$[12]=0,$[13]=0,$[14]=0,$[15]=1,$}function EQ($,Q){var J=Math.sin(Q),K=Math.cos(Q);return $[0]=K,$[1]=J,$[2]=0,$[3]=0,$[4]=-J,$[5]=K,$[6]=0,$[7]=0,$[8]=0,$[9]=0,$[10]=1,$[11]=0,$[12]=0,$[13]=0,$[14]=0,$[15]=1,$}function H$($,Q,J){var K=Q[0],B=Q[1],Y=Q[2],Z=Q[3],V=K+K,F=B+B,H=Y+Y,X=K*V,P=K*F,j=K*H,A=B*F,C=B*H,O=Y*H,W=Z*V,E=Z*F,G=Z*H;return $[0]=1-(A+O),$[1]=P+G,$[2]=j-E,$[3]=0,$[4]=P-G,$[5]=1-(X+O),$[6]=C+W,$[7]=0,$[8]=j+E,$[9]=C-W,$[10]=1-(X+A),$[11]=0,$[12]=J[0],$[13]=J[1],$[14]=J[2],$[15]=1,$}function RQ($,Q){var J=new T(3),K=-Q[0],B=-Q[1],Y=-Q[2],Z=Q[3],V=Q[4],F=Q[5],H=Q[6],X=Q[7],P=K*K+B*B+Y*Y+Z*Z;if(P>0)J[0]=(V*Z+X*K+F*Y-H*B)*2/P,J[1]=(F*Z+X*B+H*K-V*Y)*2/P,J[2]=(H*Z+X*Y+V*B-F*K)*2/P;else J[0]=(V*Z+X*K+F*Y-H*B)*2,J[1]=(F*Z+X*B+H*K-V*Y)*2,J[2]=(H*Z+X*Y+V*B-F*K)*2;return H$($,Q,J),$}function kQ($,Q){return $[0]=Q[12],$[1]=Q[13],$[2]=Q[14],$}function X$($,Q){var J=Q[0],K=Q[1],B=Q[2],Y=Q[4],Z=Q[5],V=Q[6],F=Q[8],H=Q[9],X=Q[10];return $[0]=Math.hypot(J,K,B),$[1]=Math.hypot(Y,Z,V),$[2]=Math.hypot(F,H,X),$}function NQ($,Q){var J=new T(3);X$(J,Q);var K=1/J[0],B=1/J[1],Y=1/J[2],Z=Q[0]*K,V=Q[1]*B,F=Q[2]*Y,H=Q[4]*K,X=Q[5]*B,P=Q[6]*Y,j=Q[8]*K,A=Q[9]*B,C=Q[10]*Y,O=Z+X+C,W=0;if(O>0)W=Math.sqrt(O+1)*2,$[3]=0.25*W,$[0]=(P-A)/W,$[1]=(j-F)/W,$[2]=(V-H)/W;else if(Z>X&&Z>C)W=Math.sqrt(1+Z-X-C)*2,$[3]=(P-A)/W,$[0]=0.25*W,$[1]=(V+H)/W,$[2]=(j+F)/W;else if(X>C)W=Math.sqrt(1+X-Z-C)*2,$[3]=(j-F)/W,$[0]=(V+H)/W,$[1]=0.25*W,$[2]=(P+A)/W;else W=Math.sqrt(1+C-Z-X)*2,$[3]=(V-H)/W,$[0]=(j+F)/W,$[1]=(P+A)/W,$[2]=0.25*W;return $}function _Q($,Q,J,K){var B=Q[0],Y=Q[1],Z=Q[2],V=Q[3],F=B+B,H=Y+Y,X=Z+Z,P=B*F,j=B*H,A=B*X,C=Y*H,O=Y*X,W=Z*X,E=V*F,G=V*H,_=V*X,N=K[0],R=K[1],k=K[2];return $[0]=(1-(C+W))*N,$[1]=(j+_)*N,$[2]=(A-G)*N,$[3]=0,$[4]=(j-_)*R,$[5]=(1-(P+W))*R,$[6]=(O+E)*R,$[7]=0,$[8]=(A+G)*k,$[9]=(O-E)*k,$[10]=(1-(P+C))*k,$[11]=0,$[12]=J[0],$[13]=J[1],$[14]=J[2],$[15]=1,$}function DQ($,Q,J,K,B){var Y=Q[0],Z=Q[1],V=Q[2],F=Q[3],H=Y+Y,X=Z+Z,P=V+V,j=Y*H,A=Y*X,C=Y*P,O=Z*X,W=Z*P,E=V*P,G=F*H,_=F*X,N=F*P,R=K[0],k=K[1],v=K[2],S=B[0],h=B[1],I=B[2],f=(1-(O+E))*R,g=(A+N)*R,z=(C-_)*R,q=(A-N)*k,p=(1-(j+E))*k,b=(W+G)*k,r=(C+_)*v,r0=(W-G)*v,e0=(1-(j+O))*v;return $[0]=f,$[1]=g,$[2]=z,$[3]=0,$[4]=q,$[5]=p,$[6]=b,$[7]=0,$[8]=r,$[9]=r0,$[10]=e0,$[11]=0,$[12]=J[0]+S-(f*S+q*h+r*I),$[13]=J[1]+h-(g*S+p*h+r0*I),$[14]=J[2]+I-(z*S+b*h+e0*I),$[15]=1,$}function GQ($,Q){var J=Q[0],K=Q[1],B=Q[2],Y=Q[3],Z=J+J,V=K+K,F=B+B,H=J*Z,X=K*Z,P=K*V,j=B*Z,A=B*V,C=B*F,O=Y*Z,W=Y*V,E=Y*F;return $[0]=1-P-C,$[1]=X+E,$[2]=j-W,$[3]=0,$[4]=X-E,$[5]=1-H-C,$[6]=A+O,$[7]=0,$[8]=j+W,$[9]=A-O,$[10]=1-H-P,$[11]=0,$[12]=0,$[13]=0,$[14]=0,$[15]=1,$}function qQ($,Q,J,K,B,Y,Z){var V=1/(J-Q),F=1/(B-K),H=1/(Y-Z);return $[0]=Y*2*V,$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=Y*2*F,$[6]=0,$[7]=0,$[8]=(J+Q)*V,$[9]=(B+K)*F,$[10]=(Z+Y)*H,$[11]=-1,$[12]=0,$[13]=0,$[14]=Z*Y*2*H,$[15]=0,$}function P$($,Q,J,K,B){var Y=1/Math.tan(Q/2),Z;if($[0]=Y/J,$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=Y,$[6]=0,$[7]=0,$[8]=0,$[9]=0,$[11]=-1,$[12]=0,$[13]=0,$[15]=0,B!=null&&B!==Infinity)Z=1/(K-B),$[10]=(B+K)*Z,$[14]=2*B*K*Z;else $[10]=-1,$[14]=-2*K;return $}function LQ($,Q,J,K,B){var Y=1/Math.tan(Q/2),Z;if($[0]=Y/J,$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=Y,$[6]=0,$[7]=0,$[8]=0,$[9]=0,$[11]=-1,$[12]=0,$[13]=0,$[15]=0,B!=null&&B!==Infinity)Z=1/(K-B),$[10]=B*Z,$[14]=B*K*Z;else $[10]=-1,$[14]=-K;return $}function TQ($,Q,J,K){var B=Math.tan(Q.upDegrees*Math.PI/180),Y=Math.tan(Q.downDegrees*Math.PI/180),Z=Math.tan(Q.leftDegrees*Math.PI/180),V=Math.tan(Q.rightDegrees*Math.PI/180),F=2/(Z+V),H=2/(B+Y);return $[0]=F,$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=H,$[6]=0,$[7]=0,$[8]=-((Z-V)*F*0.5),$[9]=(B-Y)*H*0.5,$[10]=K/(J-K),$[11]=-1,$[12]=0,$[13]=0,$[14]=K*J/(J-K),$[15]=0,$}function W$($,Q,J,K,B,Y,Z){var V=1/(Q-J),F=1/(K-B),H=1/(Y-Z);return $[0]=-2*V,$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=-2*F,$[6]=0,$[7]=0,$[8]=0,$[9]=0,$[10]=2*H,$[11]=0,$[12]=(Q+J)*V,$[13]=(B+K)*F,$[14]=(Z+Y)*H,$[15]=1,$}function hQ($,Q,J,K,B,Y,Z){var V=1/(Q-J),F=1/(K-B),H=1/(Y-Z);return $[0]=-2*V,$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=-2*F,$[6]=0,$[7]=0,$[8]=0,$[9]=0,$[10]=H,$[11]=0,$[12]=(Q+J)*V,$[13]=(B+K)*F,$[14]=Y*H,$[15]=1,$}function IQ($,Q,J,K){var B,Y,Z,V,F,H,X,P,j,A,C=Q[0],O=Q[1],W=Q[2],E=K[0],G=K[1],_=K[2],N=J[0],R=J[1],k=J[2];if(Math.abs(C-N)<D&&Math.abs(O-R)<D&&Math.abs(W-k)<D)return V$($);if(X=C-N,P=O-R,j=W-k,A=1/Math.hypot(X,P,j),X*=A,P*=A,j*=A,B=G*j-_*P,Y=_*X-E*j,Z=E*P-G*X,A=Math.hypot(B,Y,Z),!A)B=0,Y=0,Z=0;else A=1/A,B*=A,Y*=A,Z*=A;if(V=P*Z-j*Y,F=j*B-X*Z,H=X*Y-P*B,A=Math.hypot(V,F,H),!A)V=0,F=0,H=0;else A=1/A,V*=A,F*=A,H*=A;return $[0]=B,$[1]=V,$[2]=X,$[3]=0,$[4]=Y,$[5]=F,$[6]=P,$[7]=0,$[8]=Z,$[9]=H,$[10]=j,$[11]=0,$[12]=-(B*C+Y*O+Z*W),$[13]=-(V*C+F*O+H*W),$[14]=-(X*C+P*O+j*W),$[15]=1,$}function wQ($,Q,J,K){var B=Q[0],Y=Q[1],Z=Q[2],V=K[0],F=K[1],H=K[2],X=B-J[0],P=Y-J[1],j=Z-J[2],A=X*X+P*P+j*j;if(A>0)A=1/Math.sqrt(A),X*=A,P*=A,j*=A;var C=F*j-H*P,O=H*X-V*j,W=V*P-F*X;if(A=C*C+O*O+W*W,A>0)A=1/Math.sqrt(A),C*=A,O*=A,W*=A;return $[0]=C,$[1]=O,$[2]=W,$[3]=0,$[4]=P*W-j*O,$[5]=j*C-X*W,$[6]=X*O-P*C,$[7]=0,$[8]=X,$[9]=P,$[10]=j,$[11]=0,$[12]=B,$[13]=Y,$[14]=Z,$[15]=1,$}function vQ($){return"mat4("+$[0]+", "+$[1]+", "+$[2]+", "+$[3]+", "+$[4]+", "+$[5]+", "+$[6]+", "+$[7]+", "+$[8]+", "+$[9]+", "+$[10]+", "+$[11]+", "+$[12]+", "+$[13]+", "+$[14]+", "+$[15]+")"}function fQ($){return Math.hypot($[0],$[1],$[2],$[3],$[4],$[5],$[6],$[7],$[8],$[9],$[10],$[11],$[12],$[13],$[14],$[15])}function gQ($,Q,J){return $[0]=Q[0]+J[0],$[1]=Q[1]+J[1],$[2]=Q[2]+J[2],$[3]=Q[3]+J[3],$[4]=Q[4]+J[4],$[5]=Q[5]+J[5],$[6]=Q[6]+J[6],$[7]=Q[7]+J[7],$[8]=Q[8]+J[8],$[9]=Q[9]+J[9],$[10]=Q[10]+J[10],$[11]=Q[11]+J[11],$[12]=Q[12]+J[12],$[13]=Q[13]+J[13],$[14]=Q[14]+J[14],$[15]=Q[15]+J[15],$}function A$($,Q,J){return $[0]=Q[0]-J[0],$[1]=Q[1]-J[1],$[2]=Q[2]-J[2],$[3]=Q[3]-J[3],$[4]=Q[4]-J[4],$[5]=Q[5]-J[5],$[6]=Q[6]-J[6],$[7]=Q[7]-J[7],$[8]=Q[8]-J[8],$[9]=Q[9]-J[9],$[10]=Q[10]-J[10],$[11]=Q[11]-J[11],$[12]=Q[12]-J[12],$[13]=Q[13]-J[13],$[14]=Q[14]-J[14],$[15]=Q[15]-J[15],$}function zQ($,Q,J){return $[0]=Q[0]*J,$[1]=Q[1]*J,$[2]=Q[2]*J,$[3]=Q[3]*J,$[4]=Q[4]*J,$[5]=Q[5]*J,$[6]=Q[6]*J,$[7]=Q[7]*J,$[8]=Q[8]*J,$[9]=Q[9]*J,$[10]=Q[10]*J,$[11]=Q[11]*J,$[12]=Q[12]*J,$[13]=Q[13]*J,$[14]=Q[14]*J,$[15]=Q[15]*J,$}function yQ($,Q,J,K){return $[0]=Q[0]+J[0]*K,$[1]=Q[1]+J[1]*K,$[2]=Q[2]+J[2]*K,$[3]=Q[3]+J[3]*K,$[4]=Q[4]+J[4]*K,$[5]=Q[5]+J[5]*K,$[6]=Q[6]+J[6]*K,$[7]=Q[7]+J[7]*K,$[8]=Q[8]+J[8]*K,$[9]=Q[9]+J[9]*K,$[10]=Q[10]+J[10]*K,$[11]=Q[11]+J[11]*K,$[12]=Q[12]+J[12]*K,$[13]=Q[13]+J[13]*K,$[14]=Q[14]+J[14]*K,$[15]=Q[15]+J[15]*K,$}function pQ($,Q){return $[0]===Q[0]&&$[1]===Q[1]&&$[2]===Q[2]&&$[3]===Q[3]&&$[4]===Q[4]&&$[5]===Q[5]&&$[6]===Q[6]&&$[7]===Q[7]&&$[8]===Q[8]&&$[9]===Q[9]&&$[10]===Q[10]&&$[11]===Q[11]&&$[12]===Q[12]&&$[13]===Q[13]&&$[14]===Q[14]&&$[15]===Q[15]}function xQ($,Q){var J=$[0],K=$[1],B=$[2],Y=$[3],Z=$[4],V=$[5],F=$[6],H=$[7],X=$[8],P=$[9],j=$[10],A=$[11],C=$[12],O=$[13],W=$[14],E=$[15],G=Q[0],_=Q[1],N=Q[2],R=Q[3],k=Q[4],v=Q[5],S=Q[6],h=Q[7],I=Q[8],f=Q[9],g=Q[10],z=Q[11],q=Q[12],p=Q[13],b=Q[14],r=Q[15];return Math.abs(J-G)<=D*Math.max(1,Math.abs(J),Math.abs(G))&&Math.abs(K-_)<=D*Math.max(1,Math.abs(K),Math.abs(_))&&Math.abs(B-N)<=D*Math.max(1,Math.abs(B),Math.abs(N))&&Math.abs(Y-R)<=D*Math.max(1,Math.abs(Y),Math.abs(R))&&Math.abs(Z-k)<=D*Math.max(1,Math.abs(Z),Math.abs(k))&&Math.abs(V-v)<=D*Math.max(1,Math.abs(V),Math.abs(v))&&Math.abs(F-S)<=D*Math.max(1,Math.abs(F),Math.abs(S))&&Math.abs(H-h)<=D*Math.max(1,Math.abs(H),Math.abs(h))&&Math.abs(X-I)<=D*Math.max(1,Math.abs(X),Math.abs(I))&&Math.abs(P-f)<=D*Math.max(1,Math.abs(P),Math.abs(f))&&Math.abs(j-g)<=D*Math.max(1,Math.abs(j),Math.abs(g))&&Math.abs(A-z)<=D*Math.max(1,Math.abs(A),Math.abs(z))&&Math.abs(C-q)<=D*Math.max(1,Math.abs(C),Math.abs(q))&&Math.abs(O-p)<=D*Math.max(1,Math.abs(O),Math.abs(p))&&Math.abs(W-b)<=D*Math.max(1,Math.abs(W),Math.abs(b))&&Math.abs(E-r)<=D*Math.max(1,Math.abs(E),Math.abs(r))}var MQ=P$,SQ=W$,cQ=F$,lQ=A$;var a={};U0(a,{str:()=>{{return yJ}},squaredLength:()=>{{return n$}},sqrLen:()=>{{return sJ}},sqlerp:()=>{{return uJ}},slerp:()=>{{return j0}},setAxisAngle:()=>{{return f$}},setAxes:()=>{{return oJ}},set:()=>{{return lJ}},scale:()=>{{return x$}},rotationTo:()=>{{return eJ}},rotateZ:()=>{{return hJ}},rotateY:()=>{{return SJ}},rotateX:()=>{{return TJ}},random:()=>{{return vJ}},pow:()=>{{return wJ}},normalize:()=>{{return f0}},multiply:()=>{{return g$}},mul:()=>{{return mJ}},ln:()=>{{return y$}},lerp:()=>{{return iJ}},length:()=>{{return l$}},len:()=>{{return dJ}},invert:()=>{{return fJ}},identity:()=>{{return qJ}},getAxisAngle:()=>{{return MJ}},getAngle:()=>{{return LJ}},fromValues:()=>{{return xJ}},fromMat3:()=>{{return p$}},fromEuler:()=>{{return zJ}},exp:()=>{{return z$}},exactEquals:()=>{{return bJ}},equals:()=>{{return rJ}},dot:()=>{{return c$}},create:()=>{{return v0}},copy:()=>{{return cJ}},conjugate:()=>{{return gJ}},clone:()=>{{return pJ}},calculateW:()=>{{return IJ}},add:()=>{{return nJ}}});var s={};U0(s,{zero:()=>{{return WJ}},transformQuat:()=>{{return VJ}},transformMat4:()=>{{return YJ}},transformMat3:()=>{{return ZJ}},subtract:()=>{{return O$}},sub:()=>{{return CJ}},str:()=>{{return AJ}},squaredLength:()=>{{return k$}},squaredDistance:()=>{{return R$}},sqrLen:()=>{{return NJ}},sqrDist:()=>{{return kJ}},set:()=>{{return iQ}},scaleAndAdd:()=>{{return aQ}},scale:()=>{{return oQ}},round:()=>{{return uQ}},rotateZ:()=>{{return XJ}},rotateY:()=>{{return HJ}},rotateX:()=>{{return FJ}},random:()=>{{return BJ}},normalize:()=>{{return I0}},negate:()=>{{return tQ}},multiply:()=>{{return C$}},mul:()=>{{return UJ}},min:()=>{{return rQ}},max:()=>{{return eQ}},lerp:()=>{{return QJ}},length:()=>{{return j$}},len:()=>{{return w0}},inverse:()=>{{return $J}},hermite:()=>{{return JJ}},fromValues:()=>{{return W0}},forEach:()=>{{return _J}},floor:()=>{{return bQ}},exactEquals:()=>{{return jJ}},equals:()=>{{return OJ}},dot:()=>{{return A0}},divide:()=>{{return U$}},div:()=>{{return EJ}},distance:()=>{{return E$}},dist:()=>{{return RJ}},cross:()=>{{return o}},create:()=>{{return P0}},copy:()=>{{return mQ}},clone:()=>{{return nQ}},ceil:()=>{{return sQ}},bezier:()=>{{return KJ}},angle:()=>{{return PJ}},add:()=>{{return dQ}}});function P0(){var $=new T(3);if(T!=Float32Array)$[0]=0,$[1]=0,$[2]=0;return $}function nQ($){var Q=new T(3);return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q}function j$($){var Q=$[0],J=$[1],K=$[2];return Math.hypot(Q,J,K)}function W0($,Q,J){var K=new T(3);return K[0]=$,K[1]=Q,K[2]=J,K}function mQ($,Q){return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$}function iQ($,Q,J,K){return $[0]=Q,$[1]=J,$[2]=K,$}function dQ($,Q,J){return $[0]=Q[0]+J[0],$[1]=Q[1]+J[1],$[2]=Q[2]+J[2],$}function O$($,Q,J){return $[0]=Q[0]-J[0],$[1]=Q[1]-J[1],$[2]=Q[2]-J[2],$}function C$($,Q,J){return $[0]=Q[0]*J[0],$[1]=Q[1]*J[1],$[2]=Q[2]*J[2],$}function U$($,Q,J){return $[0]=Q[0]/J[0],$[1]=Q[1]/J[1],$[2]=Q[2]/J[2],$}function sQ($,Q){return $[0]=Math.ceil(Q[0]),$[1]=Math.ceil(Q[1]),$[2]=Math.ceil(Q[2]),$}function bQ($,Q){return $[0]=Math.floor(Q[0]),$[1]=Math.floor(Q[1]),$[2]=Math.floor(Q[2]),$}function rQ($,Q,J){return $[0]=Math.min(Q[0],J[0]),$[1]=Math.min(Q[1],J[1]),$[2]=Math.min(Q[2],J[2]),$}function eQ($,Q,J){return $[0]=Math.max(Q[0],J[0]),$[1]=Math.max(Q[1],J[1]),$[2]=Math.max(Q[2],J[2]),$}function uQ($,Q){return $[0]=Math.round(Q[0]),$[1]=Math.round(Q[1]),$[2]=Math.round(Q[2]),$}function oQ($,Q,J){return $[0]=Q[0]*J,$[1]=Q[1]*J,$[2]=Q[2]*J,$}function aQ($,Q,J,K){return $[0]=Q[0]+J[0]*K,$[1]=Q[1]+J[1]*K,$[2]=Q[2]+J[2]*K,$}function E$($,Q){var J=Q[0]-$[0],K=Q[1]-$[1],B=Q[2]-$[2];return Math.hypot(J,K,B)}function R$($,Q){var J=Q[0]-$[0],K=Q[1]-$[1],B=Q[2]-$[2];return J*J+K*K+B*B}function k$($){var Q=$[0],J=$[1],K=$[2];return Q*Q+J*J+K*K}function tQ($,Q){return $[0]=-Q[0],$[1]=-Q[1],$[2]=-Q[2],$}function $J($,Q){return $[0]=1/Q[0],$[1]=1/Q[1],$[2]=1/Q[2],$}function I0($,Q){var J=Q[0],K=Q[1],B=Q[2],Y=J*J+K*K+B*B;if(Y>0)Y=1/Math.sqrt(Y);return $[0]=Q[0]*Y,$[1]=Q[1]*Y,$[2]=Q[2]*Y,$}function A0($,Q){return $[0]*Q[0]+$[1]*Q[1]+$[2]*Q[2]}function o($,Q,J){var K=Q[0],B=Q[1],Y=Q[2],Z=J[0],V=J[1],F=J[2];return $[0]=B*F-Y*V,$[1]=Y*Z-K*F,$[2]=K*V-B*Z,$}function QJ($,Q,J,K){var B=Q[0],Y=Q[1],Z=Q[2];return $[0]=B+K*(J[0]-B),$[1]=Y+K*(J[1]-Y),$[2]=Z+K*(J[2]-Z),$}function JJ($,Q,J,K,B,Y){var Z=Y*Y,V=Z*(2*Y-3)+1,F=Z*(Y-2)+Y,H=Z*(Y-1),X=Z*(3-2*Y);return $[0]=Q[0]*V+J[0]*F+K[0]*H+B[0]*X,$[1]=Q[1]*V+J[1]*F+K[1]*H+B[1]*X,$[2]=Q[2]*V+J[2]*F+K[2]*H+B[2]*X,$}function KJ($,Q,J,K,B,Y){var Z=1-Y,V=Z*Z,F=Y*Y,H=V*Z,X=3*Y*V,P=3*F*Z,j=F*Y;return $[0]=Q[0]*H+J[0]*X+K[0]*P+B[0]*j,$[1]=Q[1]*H+J[1]*X+K[1]*P+B[1]*j,$[2]=Q[2]*H+J[2]*X+K[2]*P+B[2]*j,$}function BJ($,Q){Q=Q||1;var J=n()*2*Math.PI,K=n()*2-1,B=Math.sqrt(1-K*K)*Q;return $[0]=Math.cos(J)*B,$[1]=Math.sin(J)*B,$[2]=K*Q,$}function YJ($,Q,J){var K=Q[0],B=Q[1],Y=Q[2],Z=J[3]*K+J[7]*B+J[11]*Y+J[15];return Z=Z||1,$[0]=(J[0]*K+J[4]*B+J[8]*Y+J[12])/Z,$[1]=(J[1]*K+J[5]*B+J[9]*Y+J[13])/Z,$[2]=(J[2]*K+J[6]*B+J[10]*Y+J[14])/Z,$}function ZJ($,Q,J){var K=Q[0],B=Q[1],Y=Q[2];return $[0]=K*J[0]+B*J[3]+Y*J[6],$[1]=K*J[1]+B*J[4]+Y*J[7],$[2]=K*J[2]+B*J[5]+Y*J[8],$}function VJ($,Q,J){var K=J[0],B=J[1],Y=J[2],Z=J[3],V=Q[0],F=Q[1],H=Q[2],X=B*H-Y*F,P=Y*V-K*H,j=K*F-B*V,A=B*j-Y*P,C=Y*X-K*j,O=K*P-B*X,W=Z*2;return X*=W,P*=W,j*=W,A*=2,C*=2,O*=2,$[0]=V+X+A,$[1]=F+P+C,$[2]=H+j+O,$}function FJ($,Q,J,K){var B=[],Y=[];return B[0]=Q[0]-J[0],B[1]=Q[1]-J[1],B[2]=Q[2]-J[2],Y[0]=B[0],Y[1]=B[1]*Math.cos(K)-B[2]*Math.sin(K),Y[2]=B[1]*Math.sin(K)+B[2]*Math.cos(K),$[0]=Y[0]+J[0],$[1]=Y[1]+J[1],$[2]=Y[2]+J[2],$}function HJ($,Q,J,K){var B=[],Y=[];return B[0]=Q[0]-J[0],B[1]=Q[1]-J[1],B[2]=Q[2]-J[2],Y[0]=B[2]*Math.sin(K)+B[0]*Math.cos(K),Y[1]=B[1],Y[2]=B[2]*Math.cos(K)-B[0]*Math.sin(K),$[0]=Y[0]+J[0],$[1]=Y[1]+J[1],$[2]=Y[2]+J[2],$}function XJ($,Q,J,K){var B=[],Y=[];return B[0]=Q[0]-J[0],B[1]=Q[1]-J[1],B[2]=Q[2]-J[2],Y[0]=B[0]*Math.cos(K)-B[1]*Math.sin(K),Y[1]=B[0]*Math.sin(K)+B[1]*Math.cos(K),Y[2]=B[2],$[0]=Y[0]+J[0],$[1]=Y[1]+J[1],$[2]=Y[2]+J[2],$}function PJ($,Q){var J=$[0],K=$[1],B=$[2],Y=Q[0],Z=Q[1],V=Q[2],F=Math.sqrt(J*J+K*K+B*B),H=Math.sqrt(Y*Y+Z*Z+V*V),X=F*H,P=X&&A0($,Q)/X;return Math.acos(Math.min(Math.max(P,-1),1))}function WJ($){return $[0]=0,$[1]=0,$[2]=0,$}function AJ($){return"vec3("+$[0]+", "+$[1]+", "+$[2]+")"}function jJ($,Q){return $[0]===Q[0]&&$[1]===Q[1]&&$[2]===Q[2]}function OJ($,Q){var J=$[0],K=$[1],B=$[2],Y=Q[0],Z=Q[1],V=Q[2];return Math.abs(J-Y)<=D*Math.max(1,Math.abs(J),Math.abs(Y))&&Math.abs(K-Z)<=D*Math.max(1,Math.abs(K),Math.abs(Z))&&Math.abs(B-V)<=D*Math.max(1,Math.abs(B),Math.abs(V))}var CJ=O$,UJ=C$,EJ=U$,RJ=E$,kJ=R$,w0=j$,NJ=k$,_J=function(){var $=P0();return function(Q,J,K,B,Y,Z){var V,F;if(!J)J=3;if(!K)K=0;if(B)F=Math.min(B*J+K,Q.length);else F=Q.length;for(V=K;V<F;V+=J)$[0]=Q[V],$[1]=Q[V+1],$[2]=Q[V+2],Y($,$,Z),Q[V]=$[0],Q[V+1]=$[1],Q[V+2]=$[2];return Q}}();function DJ(){var $=new T(4);if(T!=Float32Array)$[0]=0,$[1]=0,$[2]=0,$[3]=0;return $}function N$($){var Q=new T(4);return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q[3]=$[3],Q}function _$($,Q,J,K){var B=new T(4);return B[0]=$,B[1]=Q,B[2]=J,B[3]=K,B}function D$($,Q){return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$[3]=Q[3],$}function G$($,Q,J,K,B){return $[0]=Q,$[1]=J,$[2]=K,$[3]=B,$}function q$($,Q,J){return $[0]=Q[0]+J[0],$[1]=Q[1]+J[1],$[2]=Q[2]+J[2],$[3]=Q[3]+J[3],$}function M$($,Q,J){return $[0]=Q[0]*J,$[1]=Q[1]*J,$[2]=Q[2]*J,$[3]=Q[3]*J,$}function L$($){var Q=$[0],J=$[1],K=$[2],B=$[3];return Math.hypot(Q,J,K,B)}function T$($){var Q=$[0],J=$[1],K=$[2],B=$[3];return Q*Q+J*J+K*K+B*B}function S$($,Q){var J=Q[0],K=Q[1],B=Q[2],Y=Q[3],Z=J*J+K*K+B*B+Y*Y;if(Z>0)Z=1/Math.sqrt(Z);return $[0]=J*Z,$[1]=K*Z,$[2]=B*Z,$[3]=Y*Z,$}function h$($,Q){return $[0]*Q[0]+$[1]*Q[1]+$[2]*Q[2]+$[3]*Q[3]}function I$($,Q,J,K){var B=Q[0],Y=Q[1],Z=Q[2],V=Q[3];return $[0]=B+K*(J[0]-B),$[1]=Y+K*(J[1]-Y),$[2]=Z+K*(J[2]-Z),$[3]=V+K*(J[3]-V),$}function w$($,Q){return $[0]===Q[0]&&$[1]===Q[1]&&$[2]===Q[2]&&$[3]===Q[3]}function v$($,Q){var J=$[0],K=$[1],B=$[2],Y=$[3],Z=Q[0],V=Q[1],F=Q[2],H=Q[3];return Math.abs(J-Z)<=D*Math.max(1,Math.abs(J),Math.abs(Z))&&Math.abs(K-V)<=D*Math.max(1,Math.abs(K),Math.abs(V))&&Math.abs(B-F)<=D*Math.max(1,Math.abs(B),Math.abs(F))&&Math.abs(Y-H)<=D*Math.max(1,Math.abs(Y),Math.abs(H))}var iK=function(){var $=DJ();return function(Q,J,K,B,Y,Z){var V,F;if(!J)J=4;if(!K)K=0;if(B)F=Math.min(B*J+K,Q.length);else F=Q.length;for(V=K;V<F;V+=J)$[0]=Q[V],$[1]=Q[V+1],$[2]=Q[V+2],$[3]=Q[V+3],Y($,$,Z),Q[V]=$[0],Q[V+1]=$[1],Q[V+2]=$[2],Q[V+3]=$[3];return Q}}();function v0(){var $=new T(4);if(T!=Float32Array)$[0]=0,$[1]=0,$[2]=0;return $[3]=1,$}function qJ($){return $[0]=0,$[1]=0,$[2]=0,$[3]=1,$}function f$($,Q,J){J=J*0.5;var K=Math.sin(J);return $[0]=K*Q[0],$[1]=K*Q[1],$[2]=K*Q[2],$[3]=Math.cos(J),$}function MJ($,Q){var J=Math.acos(Q[3])*2,K=Math.sin(J/2);if(K>D)$[0]=Q[0]/K,$[1]=Q[1]/K,$[2]=Q[2]/K;else $[0]=1,$[1]=0,$[2]=0;return J}function LJ($,Q){var J=c$($,Q);return Math.acos(2*J*J-1)}function g$($,Q,J){var K=Q[0],B=Q[1],Y=Q[2],Z=Q[3],V=J[0],F=J[1],H=J[2],X=J[3];return $[0]=K*X+Z*V+B*H-Y*F,$[1]=B*X+Z*F+Y*V-K*H,$[2]=Y*X+Z*H+K*F-B*V,$[3]=Z*X-K*V-B*F-Y*H,$}function TJ($,Q,J){J*=0.5;var K=Q[0],B=Q[1],Y=Q[2],Z=Q[3],V=Math.sin(J),F=Math.cos(J);return $[0]=K*F+Z*V,$[1]=B*F+Y*V,$[2]=Y*F-B*V,$[3]=Z*F-K*V,$}function SJ($,Q,J){J*=0.5;var K=Q[0],B=Q[1],Y=Q[2],Z=Q[3],V=Math.sin(J),F=Math.cos(J);return $[0]=K*F-Y*V,$[1]=B*F+Z*V,$[2]=Y*F+K*V,$[3]=Z*F-B*V,$}function hJ($,Q,J){J*=0.5;var K=Q[0],B=Q[1],Y=Q[2],Z=Q[3],V=Math.sin(J),F=Math.cos(J);return $[0]=K*F+B*V,$[1]=B*F-K*V,$[2]=Y*F+Z*V,$[3]=Z*F-Y*V,$}function IJ($,Q){var J=Q[0],K=Q[1],B=Q[2];return $[0]=J,$[1]=K,$[2]=B,$[3]=Math.sqrt(Math.abs(1-J*J-K*K-B*B)),$}function z$($,Q){var J=Q[0],K=Q[1],B=Q[2],Y=Q[3],Z=Math.sqrt(J*J+K*K+B*B),V=Math.exp(Y),F=Z>0?V*Math.sin(Z)/Z:0;return $[0]=J*F,$[1]=K*F,$[2]=B*F,$[3]=V*Math.cos(Z),$}function y$($,Q){var J=Q[0],K=Q[1],B=Q[2],Y=Q[3],Z=Math.sqrt(J*J+K*K+B*B),V=Z>0?Math.atan2(Z,Y)/Z:0;return $[0]=J*V,$[1]=K*V,$[2]=B*V,$[3]=0.5*Math.log(J*J+K*K+B*B+Y*Y),$}function wJ($,Q,J){return y$($,Q),x$($,$,J),z$($,$),$}function j0($,Q,J,K){var B=Q[0],Y=Q[1],Z=Q[2],V=Q[3],F=J[0],H=J[1],X=J[2],P=J[3],j,A,C,O,W;if(A=B*F+Y*H+Z*X+V*P,A<0)A=-A,F=-F,H=-H,X=-X,P=-P;if(1-A>D)j=Math.acos(A),C=Math.sin(j),O=Math.sin((1-K)*j)/C,W=Math.sin(K*j)/C;else O=1-K,W=K;return $[0]=O*B+W*F,$[1]=O*Y+W*H,$[2]=O*Z+W*X,$[3]=O*V+W*P,$}function vJ($){var Q=n(),J=n(),K=n(),B=Math.sqrt(1-Q),Y=Math.sqrt(Q);return $[0]=B*Math.sin(2*Math.PI*J),$[1]=B*Math.cos(2*Math.PI*J),$[2]=Y*Math.sin(2*Math.PI*K),$[3]=Y*Math.cos(2*Math.PI*K),$}function fJ($,Q){var J=Q[0],K=Q[1],B=Q[2],Y=Q[3],Z=J*J+K*K+B*B+Y*Y,V=Z?1/Z:0;return $[0]=-J*V,$[1]=-K*V,$[2]=-B*V,$[3]=Y*V,$}function gJ($,Q){return $[0]=-Q[0],$[1]=-Q[1],$[2]=-Q[2],$[3]=Q[3],$}function p$($,Q){var J=Q[0]+Q[4]+Q[8],K;if(J>0)K=Math.sqrt(J+1),$[3]=0.5*K,K=0.5/K,$[0]=(Q[5]-Q[7])*K,$[1]=(Q[6]-Q[2])*K,$[2]=(Q[1]-Q[3])*K;else{var B=0;if(Q[4]>Q[0])B=1;if(Q[8]>Q[B*3+B])B=2;var Y=(B+1)%3,Z=(B+2)%3;K=Math.sqrt(Q[B*3+B]-Q[Y*3+Y]-Q[Z*3+Z]+1),$[B]=0.5*K,K=0.5/K,$[3]=(Q[Y*3+Z]-Q[Z*3+Y])*K,$[Y]=(Q[Y*3+B]+Q[B*3+Y])*K,$[Z]=(Q[Z*3+B]+Q[B*3+Z])*K}return $}function zJ($,Q,J,K){var B=0.5*Math.PI/180;Q*=B,J*=B,K*=B;var Y=Math.sin(Q),Z=Math.cos(Q),V=Math.sin(J),F=Math.cos(J),H=Math.sin(K),X=Math.cos(K);return $[0]=Y*F*X-Z*V*H,$[1]=Z*V*X+Y*F*H,$[2]=Z*F*H-Y*V*X,$[3]=Z*F*X+Y*V*H,$}function yJ($){return"quat("+$[0]+", "+$[1]+", "+$[2]+", "+$[3]+")"}var pJ=N$,xJ=_$,cJ=D$,lJ=G$,nJ=q$,mJ=g$,x$=M$,c$=h$,iJ=I$,l$=L$,dJ=l$,n$=T$,sJ=n$,f0=S$,bJ=w$,rJ=v$,eJ=function(){var $=P0(),Q=W0(1,0,0),J=W0(0,1,0);return function(K,B,Y){var Z=A0(B,Y);if(Z<-0.999999){if(o($,Q,B),w0($)<0.000001)o($,J,B);return I0($,$),f$(K,$,Math.PI),K}else if(Z>0.999999)return K[0]=0,K[1]=0,K[2]=0,K[3]=1,K;else return o($,B,Y),K[0]=$[0],K[1]=$[1],K[2]=$[2],K[3]=1+Z,f0(K,K)}}(),uJ=function(){var $=v0(),Q=v0();return function(J,K,B,Y,Z,V){return j0($,K,Z,V),j0(Q,B,Y,V),j0(J,$,Q,2*V*(1-V)),J}}(),oJ=function(){var $=Z$();return function(Q,J,K,B){return $[0]=K[0],$[3]=K[1],$[6]=K[2],$[1]=B[0],$[4]=B[1],$[7]=B[2],$[2]=-J[0],$[5]=-J[1],$[8]=-J[2],f0(Q,p$(Q,$))}}();var aJ=Math.PI/90;class l{m4=Float32Array.from(M.create());constructor(){this.identity()}static create(){return new l}identity(){return M.identity(this.m4),this}invert($){return M.invert(this.m4,$.getMatrix()),this}multiply($){return M.multiply(this.m4,this.m4,$.getMatrix()),this}multiply2($,Q){return M.multiply(this.m4,$.getMatrix(),Q.getMatrix()),this}multiply3($,Q,J){return this.multiply2($,Q),this.multiply(J),this}translate($,Q,J){return M.translate(this.m4,this.m4,[$,Q,J]),this}translateToMatrix($){const Q=$.getMatrix();return this.translate(-Q[12],-Q[13],-Q[14])}rotateX($){return M.rotateX(this.m4,this.m4,$),this}rotateY($){return M.rotateY(this.m4,this.m4,$),this}rotateZ($){return M.rotateZ(this.m4,this.m4,$),this}scale($,Q,J){return M.scale(this.m4,this.m4,[$,Q,J]),this}perspective($,Q,J,K){return M.perspective(this.m4,$*aJ,Q,J,K),this}ortho($,Q,J,K,B,Y){return M.ortho(this.m4,$,Q,J,K,B,Y),this}static aTemp=M.create();static bTemp=M.create();combine($,Q,J=0.5){return M.multiplyScalar(l.aTemp,$.getMatrix(),1-J),M.multiplyScalar(l.bTemp,Q.getMatrix(),J),M.add(this.m4,l.aTemp,l.bTemp),this}static tempQuat=a.create();moveMatrix($,Q,J,K){const B=s.fromValues(-$,Q,J);if(K)M.getRotation(l.tempQuat,K.getMatrix()),a.invert(l.tempQuat,l.tempQuat),s.transformQuat(B,B,l.tempQuat);return M.translate(this.m4,this.m4,B),this}getMatrix(){return this.m4}}var L=l;class g0 extends L{constructor(){super(...arguments)}perspectiveMatrix=L.create();orthoMatrix=L.create();perspectiveLevel=1;configPerspectiveMatrix($){this.perspectiveMatrix.perspective(45,$,0.01,1000)}configOrthoMatrix($){this.orthoMatrix.ortho(-$,$,-1,1,-1000,1000)}configure($,Q){const J=$/Q;this.configPerspectiveMatrix(J),this.configOrthoMatrix(J)}setPerspective($){this.perspectiveLevel=$,this.combine(this.orthoMatrix,this.perspectiveMatrix,this.perspectiveLevel)}}var y;(function(J){J[J["PROJECTION"]=0]="PROJECTION";J[J["VIEW"]=1]="VIEW"})(y||(y={}));class i{needsRefresh=!1;camPositionMatrix=L.create().translate(0,0,-1);projectionMatrix=new g0;camTiltMatrix=L.create();camTurnMatrix=L.create();camMatrix=L.create();hudMatrix=L.create();pespectiveLevel=1;cameraMatrices={[y.PROJECTION]:this.projectionMatrix,[y.VIEW]:this.camMatrix};configProjectionMatrix($,Q){this.projectionMatrix.configure($,Q),this.updatePerspective()}refresh(){if(!this.needsRefresh)return!1;return this.camMatrix.multiply3(this.camTiltMatrix,this.camTurnMatrix,this.camPositionMatrix),this.syncHud(this.hudMatrix),this.needsRefresh=!1,!0}updatePerspective($){this.projectionMatrix.setPerspective($??this.pespectiveLevel),this.needsRefresh=!0}getCameraMatrix($){return this.cameraMatrices[$].getMatrix()}moveCam($,Q,J){this.camPositionMatrix.moveMatrix($,Q,J,this.camTurnMatrix),this.needsRefresh=!0}turnCam($){this.camTurnMatrix.rotateY($),this.needsRefresh=!0}tilt($){this.camTiltMatrix.rotateX($),this.needsRefresh=!0}getHudMatrix(){return this.hudMatrix}static _position=[0,0,0];getPosition(){const $=this.camPositionMatrix.getMatrix();return i._position[0]=$[12],i._position[1]=$[13],i._position[2]=$[14],i._position}setPosition($,Q,J){const K=this.camPositionMatrix.getMatrix();K[12]=$,K[13]=Q,K[14]=J}invertedCamTurnMatrix=L.create();invertedCamTiltMatrix=L.create();syncHud($){this.invertedCamTiltMatrix.invert(this.camTiltMatrix),this.invertedCamTurnMatrix.invert(this.camTurnMatrix),$?.identity().translateToMatrix(this.camPositionMatrix).multiply(this.invertedCamTurnMatrix).multiply(this.invertedCamTiltMatrix).translate(0,0,-0.9)}}var JK=function($){if(!QK)return $;return new Proxy($,{get(J,K){const B=J,Y=B[K];if(typeof Y==="function")return(...V)=>{const F=Y.apply(B,V);return console.log(`gl.${String(K)}(`,V,") = ",F),F};else return console.log(`gl.${String(K)} = `,Y),Y}})},tJ={alpha:!0,antialias:!1,depth:!0,desynchronized:!0,failIfMajorPerformanceCaveat:void 0,powerPreference:"default",premultipliedAlpha:!0,preserveDrawingBuffer:!1,stencil:!1},$K=6,QK=!1;class O0 extends w{gl;programs;attributeBuffers;uniforms;canvas;textureManager;imageManager;textureSlots={};onResize=new Set;spriteCount=0;cameraMatrixUniforms={};constructor($,{attributes:Q}={}){super();const J=$.getContext("webgl2",{...tJ,...Q});this.gl=JK(J),this.canvas=$,this.programs=this.own(new N0(this.gl)),this.uniforms=this.own(new G0(this.gl,this.programs)),this.attributeBuffers=this.own(new D0(this.gl,this.programs)),this.textureManager=new T0(this.gl,this.uniforms),this.imageManager=new S0;const K=this.checkCanvasSize.bind(this);window.addEventListener("resize",K),this.addOnDestroy(()=>window.removeEventListener("resize",K)),this.initialize()}addResizeListener($){$(this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.onResize.add($)}removeResizeListener($){this.onResize.delete($)}clearTextureSlots(){for(let $ in this.textureSlots)delete this.textureSlots[$]}checkCanvasSize(){if(this.canvas instanceof HTMLCanvasElement)this.canvas.width=this.canvas.offsetWidth*2,this.canvas.height=this.canvas.offsetHeight*2;this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.onResize.forEach(($)=>$(this.gl.drawingBufferWidth,this.gl.drawingBufferHeight))}initialize(){const Q={AUTHOR:"Jack le hamster"};this.programs.addProgram("main",h0(B$,Q),h0(Y$,Q)),this.programs.useProgram("main"),this.cameraMatrixUniforms[y.PROJECTION]=this.uniforms.getUniformLocation(t0,"main"),this.cameraMatrixUniforms[y.VIEW]=this.uniforms.getUniformLocation(a0,"main"),this.gl.enable(U.DEPTH_TEST),this.gl.depthFunc(U.LESS),this.gl.clearDepth(1),this.gl.enable(U.BLEND),this.gl.blendFunc(U.SRC_ALPHA,U.ONE_MINUS_SRC_ALPHA),this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.gl.disable(this.gl.CULL_FACE),this.textureManager.initialize(),this.checkCanvasSize()}onCleanupBuffers=new Set;initializeBuffers($){if(this.onCleanupBuffers.forEach((Q)=>Q()),this.onCleanupBuffers.clear(),$)[this.initializeIndexBuffer(o0),this.initializePositionBuffer(u0),this.initializeTransformBuffer(E0,$),this.initializeSlotSizeBuffer(R0,$)].forEach((J)=>this.onCleanupBuffers.add(J))}initializeIndexBuffer($){const Q=this.attributeBuffers.createBuffer($);return this.gl.bindBuffer(U.ELEMENT_ARRAY_BUFFER,Q.buffer),this.gl.bufferData(U.ELEMENT_ARRAY_BUFFER,Uint16Array.from([0,1,2,2,3,0]),U.STATIC_DRAW),()=>{this.attributeBuffers.deleteBuffer($)}}initializePositionBuffer($){const Q=this.attributeBuffers.createBuffer($);return this.gl.bindBuffer(U.ARRAY_BUFFER,Q.buffer),this.gl.vertexAttribPointer(Q.location,2,U.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(Q.location),this.gl.bufferData(U.ARRAY_BUFFER,Float32Array.from([-1,-1,1,-1,1,1,-1,1]),U.STATIC_DRAW),()=>{this.gl.disableVertexAttribArray(Q.location),this.attributeBuffers.deleteBuffer($)}}initializeTransformBuffer($,Q){const J=this.attributeBuffers.createBuffer($);this.gl.bindBuffer(U.ARRAY_BUFFER,J.buffer);for(let K=0;K<4;K++){const B=J.location+K;this.gl.vertexAttribPointer(B,4,U.FLOAT,!1,16*Float32Array.BYTES_PER_ELEMENT,K*4*Float32Array.BYTES_PER_ELEMENT),this.gl.enableVertexAttribArray(B),this.gl.vertexAttribDivisor(B,1)}return this.gl.bufferData(U.ARRAY_BUFFER,Q*4*4*Float32Array.BYTES_PER_ELEMENT,U.DYNAMIC_DRAW),()=>{this.gl.disableVertexAttribArray(J.location),this.attributeBuffers.deleteBuffer($)}}initializeSlotSizeBuffer($,Q){const J=this.attributeBuffers.createBuffer($);this.gl.bindBuffer(U.ARRAY_BUFFER,J.buffer);const K=J.location;return this.gl.vertexAttribPointer(K,2,U.FLOAT,!1,2*Float32Array.BYTES_PER_ELEMENT,0),this.gl.enableVertexAttribArray(K),this.gl.vertexAttribDivisor(K,1),this.gl.bufferData(U.ARRAY_BUFFER,Q*2*Float32Array.BYTES_PER_ELEMENT,U.DYNAMIC_DRAW),()=>{this.gl.disableVertexAttribArray(J.location),this.attributeBuffers.deleteBuffer($)}}async updateTextures($,Q){const J=(await Promise.all($.map(async(Y)=>{const Z=Q(Y);if(!Z){console.warn(`No media for imageId ${Y}`);return}return{mediaData:await this.imageManager.renderMedia(Y,Z),imageId:Y}}))).filter((Y)=>!!Y),K=await Promise.all(J.map(async({mediaData:Y,imageId:Z})=>{const{slot:V,refreshCallback:F}=this.textureManager.allocateSlotForImage(Y),H=Math.log2(V.size[0]),X=Math.log2(V.size[1]),P=H*16+X;return this.textureSlots[Z]={buffer:Float32Array.from([P,V.slotNumber])},Y.refreshCallback=F,V.textureIndex}));return new Set(K).forEach((Y)=>{if(Y===X0)this.textureManager.setupTextureForVideo(`TEXTURE${Y}`);else this.textureManager.generateMipMap(`TEXTURE${Y}`)}),J.map(({mediaData:Y})=>Y)}drawElementsInstanced($,Q){this.gl.drawElementsInstanced(U.TRIANGLES,$,U.UNSIGNED_SHORT,0,Q)}static spriteMatrix=L.create();updateSpriteTransforms($,Q){const J=this.attributeBuffers.getAttributeBuffer(E0);this.gl.bindBuffer(U.ARRAY_BUFFER,J.buffer);let K=this.spriteCount-1;$.forEach((B)=>{const Y=O0.spriteMatrix.identity().getMatrix(),Z=Q(B);if(Z?.transforms.forEach((V)=>M.multiply(Y,Y,V)),this.gl.bufferSubData(U.ARRAY_BUFFER,16*Float32Array.BYTES_PER_ELEMENT*B,Y),Z)K=Math.max(K,B)}),$.clear();while(K>=0&&!Q(K))K--;this.spriteCount=Math.max(this.spriteCount,K+1)}updateSpriteAnims($,Q){const J=this.attributeBuffers.getAttributeBuffer(R0);this.gl.bindBuffer(U.ARRAY_BUFFER,J.buffer),$.forEach((K)=>{const B=Q(K),Y=this.textureSlots[B?.imageId??-1];if(Y){const{buffer:Z}=Y;this.gl.bufferSubData(U.ARRAY_BUFFER,2*Float32Array.BYTES_PER_ELEMENT*K,Z),$.delete(K)}})}updateCameraMatrix($,Q){this.gl.uniformMatrix4fv(this.cameraMatrixUniforms[$],!1,Q)}bindVertexArray(){return this.own(new _0(this.gl))}update(){this.drawElementsInstanced($K,this.spriteCount)}}var KK=50,t;(function(J){J[J["DEFAULT"]=0]="DEFAULT";J[J["LAST"]=1]="LAST"})(t||(t={}));class z0{updateSchedule=new Map;time=0;loop($,Q,J,K){this.registerUpdate($,{period:Q?1000/Q:1,expirationTime:K,priority:J})}registerUpdate($,Q={}){Q.triggerTime=Q.triggerTime??this.time,Q.expirationTime=Q.expirationTime??Infinity,Q.period=Q.period,Q.priority=Q.priority??t.DEFAULT,this.updateSchedule.set($,Q)}start(){let $=0,Q=0;const J={deltaTime:0},K=[],B=[],Y=[K,B],Z=(V)=>{J.deltaTime=Math.min(V-Q,KK),$=requestAnimationFrame(Z),Q=V,this.time=V,K.length=0,B.length=0,this.updateSchedule.forEach((F,H)=>{if(V<F.triggerTime)return;if(Y[F.priority].push(H),F.period&&V<F.expirationTime)F.triggerTime=Math.max(F.triggerTime+F.period,V);else this.updateSchedule.delete(H)}),Y.forEach((F)=>F.forEach((H)=>H.update(J)))};requestAnimationFrame(Z),this.stop=()=>{cancelAnimationFrame($),this.stop=()=>{}}}stop=()=>{}}class C0{$;Q;J;constructor($,Q,J){this.type=$;this.camera=Q;this.engine=J}update(){const{camera:$,engine:Q}=this;Q.updateCameraMatrix(this.type,$.getCameraMatrix(this.type))}}class y0{$;Q;J;updatedImageIds=new Set;constructor($,Q,J){this.motor=$;this.getMedia=Q;this.engine=J}withImageId($){return this.updatedImageIds.add($),this}update(){const $=Array.from(this.updatedImageIds);this.updatedImageIds.clear(),this.engine.updateTextures($,this.getMedia).then((Q)=>{Q.forEach((J)=>{if(J.isVideo)this.motor.registerUpdate(J,J.schedule)})})}}class p0{$;Q;updatedSpriteIds=new Set;constructor($,Q){this.getSprite=$;this.engine=Q}withSpriteId($){return this.updatedSpriteIds.add($),this}update(){this.engine.updateSpriteTransforms(this.updatedSpriteIds,this.getSprite)}}class x0{$;Q;J;updatedSpriteIds=new Set;constructor($,Q,J){this.motor=$;this.getSprite=Q;this.engine=J}withSpriteId($){return this.updatedSpriteIds.add($),this}update(){if(this.engine.updateSpriteAnims(this.updatedSpriteIds,this.getSprite),this.updatedSpriteIds.size)this.motor.registerUpdate(this)}}class c0 extends w{motor;engine;camera;cameraMatrixUpdates;onDeactivateWorld(){}constructor({motor:$,canvas:Q,engine:J,size:K,camera:B}){super();this.motor=$??new z0,this.engine=J??new O0(Q??new OffscreenCanvas(K[0],K[1])),this.camera=B??new i,this.cameraMatrixUpdates={[y.VIEW]:new C0(y.VIEW,this.camera,this.engine),[y.PROJECTION]:new C0(y.PROJECTION,this.camera,this.engine)},this.onResize=this.onResize.bind(this),this.initialize()}initialize(){const{engine:$,motor:Q}=this;Q.loop($,void 0,t.LAST),$.addResizeListener(this.onResize)}onResize($,Q){this.camera.configProjectionMatrix($,Q),this.motor.registerUpdate(this.cameraMatrixUpdates[y.PROJECTION])}start($){const{engine:Q,motor:J}=this,K=new y0(J,$.getMedia,Q),B=new p0($.getSprite,Q),Y=new x0(J,$.getSprite,Q),Z={["SpriteAnim"]:(V)=>J.registerUpdate(Y.withSpriteId(V)),["SpriteTransform"]:(V)=>J.registerUpdate(B.withSpriteId(V)),["Media"]:(V)=>J.registerUpdate(K.withImageId(V)),["Camera"]:(V)=>J.registerUpdate(this.cameraMatrixUpdates[V])};Q.initializeBuffers($.getMaxSpriteCount()),Q.clearTextureSlots(),this.onDeactivateWorld=$?.activate({onUpdate(V,F){Z[V](F)}}),J.loop($),J.start()}destroy(){super.destroy(),this.engine.removeResizeListener(this.onResize),this.onDeactivateWorld()}}var l0=0,n0=1,m0=2,i0=3,d0=4,s0=5,m=512,BK=200;class b0 extends $0{sprites;hudSpriteId=0;medias={[d0]:{type:"video",src:"sample.mp4",volume:0,fps:30},[l0]:{type:"image",src:"dobuki.png"},[n0]:{type:"draw",draw:($)=>{const{canvas:Q}=$;Q.width=m,Q.height=m;const J=Q.width/2,K=Q.height/2,B=Q.width/2;$.imageSmoothingEnabled=!0,$.fillStyle="#ddd",$.lineWidth=Q.width/50,$.fillRect(0,0,Q.width,Q.height),$.strokeStyle="black",$.fillStyle="gold",$.beginPath(),$.arc(J,K,B*0.8,0,2*Math.PI),$.fill(),$.stroke(),$.beginPath(),$.arc(J,K,B*0.5,0,Math.PI),$.stroke(),$.beginPath(),$.arc(Q.width/3,Q.height/3,B*0.1,0,Math.PI,!0),$.stroke(),$.beginPath(),$.arc(Q.width/3*2,Q.height/3,B*0.1,0,Math.PI*2,!0),$.stroke()}},[m0]:{type:"draw",draw:($)=>{const{canvas:Q}=$;Q.width=m,Q.height=m,$.imageSmoothingEnabled=!0,$.fillStyle="#ddd",$.lineWidth=Q.width/50,$.fillRect(0,0,Q.width,Q.height),$.strokeStyle="black",$.fillStyle="silver",$.beginPath(),$.rect(Q.width*0.2,Q.height*0.2,Q.width*0.6,Q.height*0.6),$.fill(),$.stroke()}},[i0]:{type:"draw",draw:($)=>{const{canvas:Q}=$;Q.width=m,Q.height=m,$.lineWidth=Q.width/50,$.strokeStyle="black",$.beginPath(),$.rect(30,30,Q.width-60,Q.height-60),$.stroke()}},[s0]:{type:"draw",draw:($)=>{const{canvas:Q}=$;Q.width=m,Q.height=m,$.imageSmoothingEnabled=!0,$.lineWidth=5,$.strokeStyle="green",$.beginPath(),$.rect(10,10,Q.width-20,Q.height-20),$.stroke()}}};constructor($,Q){super($,Q);this.sprites=[{imageId:i0,transforms:[this.camera.getHudMatrix().getMatrix()]},{imageId:l0,transforms:[L.create().translate(0,0,0).getMatrix()]},...[L.create().translate(-1,0,1).rotateY(Math.PI/2).scale(1,1,1).getMatrix(),L.create().translate(1,0,1).rotateY(-Math.PI/2).scale(1,1,1).getMatrix()].map((J)=>({imageId:n0,transforms:[J]})),...[L.create().translate(0,-1,1).rotateX(-Math.PI/2).scale(1,1,1).getMatrix(),L.create().translate(0,-1,3).rotateX(-Math.PI/2).scale(1,1,1).getMatrix(),L.create().translate(-2,-1,3).rotateX(-Math.PI/2).scale(1,1,1).getMatrix(),L.create().translate(2,-1,3).rotateX(-Math.PI/2).scale(1,1,1).getMatrix()].map((J)=>({imageId:m0,transforms:[J]})),{imageId:d0,transforms:[L.create().translate(0,5,-10).scale(9.6,5.4,1).getMatrix()]},...new Array(400).fill(0).map((J,K)=>L.create().translate(K%20-10,-1.5,Math.floor(K/20)-10).rotateX(-Math.PI/2).scale(1,1,1).getMatrix()).map((J)=>({imageId:s0,transforms:[J]}))]}getMedia($){return this.medias[$]}getMaxSpriteCount(){return this.sprites.length}getSprite($){return this.sprites[$]}spaceForRiseAndDrop({deltaTime:$}){const Q=$/80;if(this.keys.Space)this.camera.moveCam(0,-Q,0);else if(this.keysUp.Space){this.camera.moveCam(0,Q,0);const[J,K,B]=this.camera.getPosition();if(K>0)this.camera.setPosition(J,0,B),this.keysUp.Space=0}}update($){const{deltaTime:Q}=$,J=Q/80,K=Q/400;if(this.keys.KeyW||this.keys.ArrowUp&&!this.keys.ShiftRight)this.camera.moveCam(0,0,J);if(this.keys.KeyS||this.keys.ArrowDown&&!this.keys.ShiftRight)this.camera.moveCam(0,0,-J);if(this.keys.KeyA||this.keys.ArrowLeft&&!this.keys.ShiftRight)this.camera.moveCam(-J,0,0);if(this.keys.KeyD||this.keys.ArrowRight&&!this.keys.ShiftRight)this.camera.moveCam(J,0,0);if(this.keys.KeyQ||this.keys.ArrowLeft&&this.keys.ShiftRight)this.camera.turnCam(-K);if(this.keys.KeyE||this.keys.ArrowRight&&this.keys.ShiftRight)this.camera.turnCam(K);if(this.keys.ArrowUp&&this.keys.ShiftRight)this.camera.tilt(-K);if(this.keys.ArrowDown&&this.keys.ShiftRight)this.camera.tilt(K);if(this.spaceForRiseAndDrop($),this.camera.refresh())this.onUpdate("Camera",y.VIEW),this.onUpdate("SpriteTransform",this.hudSpriteId)}keys={};keysUp={};activate({onUpdate:$}){this.onUpdate=$;const Q=(K)=>{if(!this.keys[K.code])this.keys[K.code]=this.core.motor.time},J=(K)=>{if(this.core.motor.time-this.keys[K.code]<BK)this.keysUp[K.code]=this.keysUp[K.code]?0:this.core.motor.time;else this.keysUp[K.code]=0;this.keys[K.code]=0};return document.addEventListener("keydown",Q),document.addEventListener("keyup",J),this.onUpdate("Camera",y.PROJECTION),this.onUpdate("Camera",y.VIEW),this.onUpdate("SpriteTransform",this.hudSpriteId),[n0,m0,i0,l0,d0,s0].forEach((K)=>this.onUpdate("Media",K)),this.sprites.forEach((K,B)=>{this.onUpdate("SpriteTransform",B),this.onUpdate("SpriteAnim",B)}),()=>{document.removeEventListener("keydown",Q),document.removeEventListener("keyup",J),this.onUpdate=()=>{}}}}async function x8(){console.log("Hello World!")}async function c8($){$.style.border="2px solid silver",$.style.cursor="grab",$.addEventListener("mouseenter",()=>{$.style.borderColor="black"}),$.addEventListener("mouseleave",()=>{$.style.borderColor="silver"});const Q=new c0({canvas:$}),J=new b0(Q);return Q.start(J),Q}export{c8 as testCanvas,x8 as hello,$0 as World};

//# debugId=746BEF543E82E86764756e2164756e21
