var rQ=Object.defineProperty;var U0=(Q,$)=>{for(var J in $)rQ(Q,J,{get:$[J],enumerable:!0,configurable:!0,set:(K)=>$[J]=()=>K})};class Q0{Q;$;constructor(Q,$){this.core=Q;this.auxiliaries=$}informUpdate(Q,$){console.warn("pass onUpdate to inform about changes in the world.",Q,$)}refresh(Q){}medias=[];activate(Q){const{updateCallback:$,core:J}=Q;this.informUpdate=$,this.auxiliaries.forEach((Y)=>Y.activate(Q)),this.medias.forEach((Y)=>this.informUpdate("Media",Y.id));const K=J.motor.loop(this);return()=>{this.informUpdate=()=>{},K()}}addMedia(...Q){for(let $ of Q)this.medias[$.id]=$}addAuxiliary(...Q){this.auxiliaries.push(...Q)}}class w{disposables;own(Q){if(!this.disposables)this.disposables=new Set;return this.disposables.add(Q),Q}addOnDestroy(Q){if(Q)this.disposables?.add({destroy:Q})}destroy(){this.disposables?.forEach((Q)=>Q.destroy())}}var U=globalThis.WebGL2RenderingContext??{},r0="position",e0="index",N0="transform",E0="slotSize_and_number",u0="cam",o0="projection",a0="maxTextureSize",t0="uTextures";var eQ=function(Q,$,J){function K(X,W){function P(O){return O===Q?.VERTEX_SHADER?"vertex":O===Q?.FRAGMENT_SHADER?"fragment":void 0}if(W!==Q.VERTEX_SHADER&&W!==Q.FRAGMENT_SHADER)throw new Error(`Shader error in ${P(W)}`);const A=Q.createShader(W);if(!A)throw new Error(`Unable to generate ${P(W)} shader.`);if(Q.shaderSource(A,X),Q.compileShader(A),!Q.getShaderParameter(A,Q.COMPILE_STATUS))console.error(`Shader compile error in ${P(W)}:`+Q.getShaderInfoLog(A));return A}const Y=Q.createProgram();if(!Y)throw new Error("Unable to create program.");const B=K($,Q.VERTEX_SHADER),V=K(J,Q.FRAGMENT_SHADER),Z=Q.getShaderInfoLog(B),F=Q.getShaderInfoLog(V);if(Z)console.log("VERTEX",Z);if(F)console.log("FRAGMENT",F);Q.attachShader(Y,B),Q.attachShader(Y,V),Q.linkProgram(Y);const H=Q.getProgramInfoLog(Y);if(H)console.log("PROGRAM",H);if(Q.detachShader(Y,B),Q.detachShader(Y,V),Q.deleteShader(B),Q.deleteShader(V),Q.validateProgram(Y),Object.entries(U).forEach(([X,W])=>{if(W&&Q.getError()===W)console.log(`gl.${X}`)}),!Q.getProgramParameter(Y,Q.LINK_STATUS))throw new Error("Unable to initialize the shader program:\n"+Q.getProgramInfoLog(Y));return Y},uQ=function(Q,$){Q.deleteProgram($)};class _0 extends w{gl;program;constructor(Q,$,J){super();this.gl=Q,this.program=eQ(Q,$.trim(),J.trim())}use(){this.gl.useProgram(this.program)}destroy(){super.destroy(),uQ(this.gl,this.program)}}class D0 extends w{activeProgramId="";gl;programs={};constructor(Q){super();this.gl=Q}addProgram(Q,$,J){if(this.programs[Q])this.removeProgram(Q);this.programs[Q]=this.own(new _0(this.gl,$,J))}useProgram(Q){if(this.activeProgramId!==Q)this.activeProgramId=Q,this.programs[Q].use()}removeProgram(Q){this.programs[Q].destroy(),delete this.programs[Q]}getProgram(Q){return this.programs[Q??this.activeProgramId]?.program}}class R0 extends w{gl;triangleArray;constructor(Q){super();this.gl=Q,this.triangleArray=Q.createVertexArray(),Q.bindVertexArray(this.triangleArray)}destroy(){this.gl.deleteVertexArray(this.triangleArray)}}class G0 extends w{bufferRecord={};gl;programs;constructor(Q,$){super();this.gl=Q,this.programs=$}getAttributeLocation(Q,$){const J=this.programs.getProgram($);return J?this.gl.getAttribLocation(J,Q)??-1:-1}createBuffer(Q){this.deleteBuffer(Q);const $=this.gl?.createBuffer();if(!$)throw new Error(`Unable to create buffer "${Q}"`);const J={buffer:$,location:this.getAttributeLocation(Q)};return this.bufferRecord[Q]=J,J}deleteBuffer(Q){if(this.bufferRecord[Q])this.gl.deleteBuffer(this.bufferRecord[Q].buffer),delete this.bufferRecord[Q]}getAttributeBuffer(Q){const $=this.bufferRecord[Q];if(!$)throw new Error(`Attribute "${Q}" not created. Make sure "createBuffer" is called.`);return $}destroy(){Object.keys(this.bufferRecord).forEach((Q)=>this.deleteBuffer(Q))}}class k0 extends w{gl;programs;constructor(Q,$){super();this.gl=Q,this.programs=$}getUniformLocation(Q,$){const J=this.programs.getProgram($);return this.gl.getUniformLocation(J,Q)}}function QQ(Q,$=(J)=>J.key){var J=[];return q0(Q,"",!0,(K)=>J.push(K),$),J.join("")}var q0=function(Q,$,J,K,Y){if(Q){K(`${$}${J?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 "}${Y(Q)}\n`);const B=$+(J?"    ":"\u2502   ");if(Q.left)q0(Q.left,B,!1,K,Y);if(Q.right)q0(Q.right,B,!0,K,Y)}};function $0(Q){if(Q===null)return!0;var $=J0(Q.left),J=J0(Q.right);if(Math.abs($-J)<=1&&$0(Q.left)&&$0(Q.right))return!0;return!1}var J0=function(Q){return Q?1+Math.max(J0(Q.left),J0(Q.right)):0};function K0(Q,$,J,K,Y){const B=Y-K;if(B>0){const V=K+Math.floor(B/2),Z=$[V],F=J[V],H={key:Z,data:F,parent:Q};return H.left=K0(H,$,J,K,V),H.right=K0(H,$,J,V+1,Y),H}return null}function Y0(Q){if(Q===null)return 0;const $=Y0(Q.left),J=Y0(Q.right);return Q.balanceFactor=$-J,Math.max($,J)+1}function B0(Q,$,J,K,Y){if(J>=K)return;const B=Q[J+K>>1];let V=J-1,Z=K+1;while(!0){do V++;while(Y(Q[V],B)<0);do Z--;while(Y(Q[Z],B)>0);if(V>=Z)break;let F=Q[V];Q[V]=Q[Z],Q[Z]=F,F=$[V],$[V]=$[Z],$[Z]=F}B0(Q,$,J,Z,Y),B0(Q,$,Z+1,K,Y)}var oQ=function(Q,$){return Q>$?1:Q<$?-1:0},V0=function(Q){var $=Q.right;if(Q.right=$.left,$.left)$.left.parent=Q;if($.parent=Q.parent,$.parent)if($.parent.left===Q)$.parent.left=$;else $.parent.right=$;if(Q.parent=$,$.left=Q,Q.balanceFactor+=1,$.balanceFactor<0)Q.balanceFactor-=$.balanceFactor;if($.balanceFactor+=1,Q.balanceFactor>0)$.balanceFactor+=Q.balanceFactor;return $},Z0=function(Q){var $=Q.left;if(Q.left=$.right,Q.left)Q.left.parent=Q;if($.parent=Q.parent,$.parent)if($.parent.left===Q)$.parent.left=$;else $.parent.right=$;if(Q.parent=$,$.right=Q,Q.balanceFactor-=1,$.balanceFactor>0)Q.balanceFactor-=$.balanceFactor;if($.balanceFactor-=1,Q.balanceFactor<0)$.balanceFactor+=Q.balanceFactor;return $};class i{constructor(Q,$=!1){this._comparator=Q||oQ,this._root=null,this._size=0,this._noDuplicates=!!$}destroy(){return this.clear()}clear(){return this._root=null,this._size=0,this}get size(){return this._size}contains(Q){if(this._root){var $=this._root,J=this._comparator;while($){var K=J(Q,$.key);if(K===0)return!0;else if(K<0)$=$.left;else $=$.right}}return!1}next(Q){var $=Q;if($)if($.right){$=$.right;while($.left)$=$.left}else{$=Q.parent;while($&&$.right===Q)Q=$,$=$.parent}return $}prev(Q){var $=Q;if($)if($.left){$=$.left;while($.right)$=$.right}else{$=Q.parent;while($&&$.left===Q)Q=$,$=$.parent}return $}forEach(Q){var $=this._root,J=[],K=!1,Y=0;while(!K)if($)J.push($),$=$.left;else if(J.length>0)$=J.pop(),Q($,Y++),$=$.right;else K=!0;return this}range(Q,$,J,K){const Y=[],B=this._comparator;let V=this._root,Z;while(Y.length!==0||V)if(V)Y.push(V),V=V.left;else{if(V=Y.pop(),Z=B(V.key,$),Z>0)break;else if(B(V.key,Q)>=0){if(J.call(K,V))return this}V=V.right}return this}keys(){var Q=this._root,$=[],J=[],K=!1;while(!K)if(Q)$.push(Q),Q=Q.left;else if($.length>0)Q=$.pop(),J.push(Q.key),Q=Q.right;else K=!0;return J}values(){var Q=this._root,$=[],J=[],K=!1;while(!K)if(Q)$.push(Q),Q=Q.left;else if($.length>0)Q=$.pop(),J.push(Q.data),Q=Q.right;else K=!0;return J}at(Q){var $=this._root,J=[],K=!1,Y=0;while(!K)if($)J.push($),$=$.left;else if(J.length>0){if($=J.pop(),Y===Q)return $;Y++,$=$.right}else K=!0;return null}minNode(){var Q=this._root;if(!Q)return null;while(Q.left)Q=Q.left;return Q}maxNode(){var Q=this._root;if(!Q)return null;while(Q.right)Q=Q.right;return Q}min(){var Q=this._root;if(!Q)return null;while(Q.left)Q=Q.left;return Q.key}max(){var Q=this._root;if(!Q)return null;while(Q.right)Q=Q.right;return Q.key}isEmpty(){return!this._root}pop(){var Q=this._root,$=null;if(Q){while(Q.left)Q=Q.left;$={key:Q.key,data:Q.data},this.remove(Q.key)}return $}popMax(){var Q=this._root,$=null;if(Q){while(Q.right)Q=Q.right;$={key:Q.key,data:Q.data},this.remove(Q.key)}return $}find(Q){var $=this._root,J=$,K,Y=this._comparator;while(J)if(K=Y(Q,J.key),K===0)return J;else if(K<0)J=J.left;else J=J.right;return null}insert(Q,$){if(!this._root)return this._root={parent:null,left:null,right:null,balanceFactor:0,key:Q,data:$},this._size++,this._root;var J=this._comparator,K=this._root,Y=null,B=0;if(this._noDuplicates)while(K)if(B=J(Q,K.key),Y=K,B===0)return null;else if(B<0)K=K.left;else K=K.right;else while(K)if(B=J(Q,K.key),Y=K,B<=0)K=K.left;else K=K.right;var V={left:null,right:null,balanceFactor:0,parent:Y,key:Q,data:$},Z;if(B<=0)Y.left=V;else Y.right=V;while(Y){if(B=J(Y.key,Q),B<0)Y.balanceFactor-=1;else Y.balanceFactor+=1;if(Y.balanceFactor===0)break;else if(Y.balanceFactor<-1){if(Y.right.balanceFactor===1)Z0(Y.right);if(Z=V0(Y),Y===this._root)this._root=Z;break}else if(Y.balanceFactor>1){if(Y.left.balanceFactor===-1)V0(Y.left);if(Z=Z0(Y),Y===this._root)this._root=Z;break}Y=Y.parent}return this._size++,V}remove(Q){if(!this._root)return null;var $=this._root,J=this._comparator,K=0;while($)if(K=J(Q,$.key),K===0)break;else if(K<0)$=$.left;else $=$.right;if(!$)return null;var Y=$.key,B,V;if($.left){B=$.left;while(B.left||B.right){while(B.right)B=B.right;if($.key=B.key,$.data=B.data,B.left)$=B,B=B.left}$.key=B.key,$.data=B.data,$=B}if($.right){V=$.right;while(V.left||V.right){while(V.left)V=V.left;if($.key=V.key,$.data=V.data,V.right)$=V,V=V.right}$.key=V.key,$.data=V.data,$=V}var Z=$.parent,F=$,H;while(Z){if(Z.left===F)Z.balanceFactor-=1;else Z.balanceFactor+=1;if(Z.balanceFactor<-1){if(Z.right.balanceFactor===1)Z0(Z.right);if(H=V0(Z),Z===this._root)this._root=H;Z=H}else if(Z.balanceFactor>1){if(Z.left.balanceFactor===-1)V0(Z.left);if(H=Z0(Z),Z===this._root)this._root=H;Z=H}if(Z.balanceFactor===-1||Z.balanceFactor===1)break;F=Z,Z=Z.parent}if($.parent)if($.parent.left===$)$.parent.left=null;else $.parent.right=null;if($===this._root)this._root=null;return this._size--,Y}load(Q=[],$=[],J){if(this._size!==0)throw new Error("bulk-load: tree is not empty");const K=Q.length;if(J)B0(Q,$,0,K-1,this._comparator);return this._root=K0(null,Q,$,0,K),Y0(this._root),this._size=K,this}isBalanced(){return $0(this._root)}toString(Q){return QQ(this._root,Q)}}i.default=i;class x{size;slotNumber;x;y;textureIndex;parent;sibbling;textureSizeLimits;constructor(Q,$,J,K){this.textureSizeLimits=J?.textureSizeLimits??K??{min:M0,max:L0},this.size=Q,this.slotNumber=$,this.parent=J,this.sibbling=void 0;const{x:Y,y:B,textureIndex:V}=this.calculatePosition(Q,$);this.x=Y,this.y=B,this.textureIndex=V}calculateTextureIndex(Q,$){const[J,K]=Q,Y=this.textureSizeLimits.max/J*(this.textureSizeLimits.max/K);return Math.floor($/Y)}calculatePosition(Q,$){const[J,K]=Q,Y=this.textureSizeLimits.max/J,B=this.textureSizeLimits.max/K,V=$%Y*J,Z=Math.floor($/Y)%B*K;return{x:V,y:Z,textureIndex:this.calculateTextureIndex(Q,$)}}getTag(){return x.getTag(this)}static getTag(Q){return`${Q.size[0]}x${Q.size[1]}-#${Q.slotNumber}`}static positionToTextureSlot(Q,$,J,K,Y){const[B,V]=J,Z=Y.textureSizeLimits.max/B,H=Y.textureSizeLimits.max/B*(Y.textureSizeLimits.max/V)*K+$/V*Z+Q/B;return new x(J,H,Y)}getPosition(){return{x:this.x,y:this.y,size:this.size,textureIndex:this.textureIndex}}canSplitHorizontally(){const[,Q]=this.size;return Q>this.textureSizeLimits.min}canSplitVertically(){const[Q]=this.size;return Q>this.textureSizeLimits.min}splitHorizontally(){const{x:Q,y:$,size:J,textureIndex:K}=this,[Y,B]=J;if(!this.canSplitHorizontally())throw new Error(`Cannot split texture slot of size ${Y} horizontally`);const V=Y/2,Z=x.positionToTextureSlot(Q,$,[V,B],K,this),F=x.positionToTextureSlot(Q+V,$,[V,B],K,this);return Z.sibbling=F,F.sibbling=Z,[Z,F]}splitVertically(){const{x:Q,y:$,size:J,textureIndex:K}=this,[Y,B]=J;if(!this.canSplitVertically())throw new Error(`Cannot split texture slot of size ${B} vertically`);const V=B/2,Z=x.positionToTextureSlot(Q,$,[Y,V],K,this),F=x.positionToTextureSlot(Q,$+V,[Y,V],K,this);return Z.sibbling=F,F.sibbling=Z,[Z,F]}}function F0(Q,$){return Math.max($,Math.pow(2,Math.ceil(Math.log(Q)/Math.log(2))))}function $Q(Q,$,J,K){if(J<1)throw new Error("Invalid count");const Y=F0(Q,K.min),B=F0($,K.min),V=new Map;let Z=K.min;for(let F=1;F<=J;F++){Z=F0(Y*F,K.min);const H=F0(B*Math.ceil(J/F),K.min);V.set(Z,H)}for(let F=Z;F<=K.max;F*=2)if(!V.has(F))V.set(F,B);return V}var aQ=!1,M0=16,L0=4096,tQ=16;class H0{textureSlots=new i((Q,$)=>{const J=Q.size[0]*Q.size[1]-$.size[0]*$.size[1];if(J!==0)return J;return Q.slotNumber-$.slotNumber},!1);allocatedTextures={};minTextureSize;maxTextureSize;numTextureSheets;initialSlots=[];constructor({numTextureSheets:Q,minTextureSize:$,maxTextureSize:J,excludeTexture:K}={},Y){if(this.numTextureSheets=Q??tQ,this.minTextureSize=$??M0,this.maxTextureSize=J??L0,Y)this.numTextureSheets=Math.min(this.numTextureSheets,Y.getParameter(WebGL2RenderingContext.MAX_TEXTURE_IMAGE_UNITS)),this.maxTextureSize=Math.min(this.maxTextureSize,Y.getParameter(WebGL2RenderingContext.MAX_TEXTURE_SIZE)),this.minTextureSize=Math.min(this.minTextureSize,this.maxTextureSize);for(let B=0;B<this.numTextureSheets;B++){if(K?.(B))continue;this.initialSlots.push(new x([this.maxTextureSize,this.maxTextureSize],B,void 0,{min:this.minTextureSize,max:this.maxTextureSize}))}this.initialSlots.forEach((B)=>this.textureSlots.insert(B))}allocate(Q,$,J=1){const{size:K,slotNumber:Y,x:B,y:V,textureIndex:Z}=this.allocateHelper(Q,$,J);return{size:K,slotNumber:Y,x:B,y:V,textureIndex:Z}}deallocate(Q){if(!this.isSlotUsed(Q))throw new Error("Slot is not allocated");const $=this.allocatedTextures[x.getTag(Q)];this.deallocateHelper($)}get countUsedTextureSheets(){return this.initialSlots.filter((Q)=>this.isSlotUsed(Q)).length}allocateHelper(Q,$,J=1){const K=$Q(Q,$,J,{min:this.minTextureSize,max:this.maxTextureSize}),Y=this.findSlot(K);if(!Y)throw new Error(`Could not find a slot for texture to fit ${J} sprites of size ${Q}x${$}`);this.textureSlots.remove(Y);const[B,V]=this.bestFit(K,Y);return this.fitSlot(Y,B,V)}findSlot(Q){for(let $=0;$<this.textureSlots.size;$++){const K=this.textureSlots.at($).key,[Y,B]=K.size;if(Q.get(Y)<=B)return K}return null}calculateRatio(Q,$){return Math.max(Q/$,$/Q)}bestFit(Q,$){const[J,K]=$.size;let Y=$.textureSizeLimits.max;return Q.forEach((B,V)=>{if(V<=J&&B<=K){const Z=V*B,F=Q.get(Y)*Y;if(Z<F)Y=V;else if(Z===F){if(this.calculateRatio(V,B)<this.calculateRatio(Y,Q.get(Y)))Y=V}}}),[Y,Q.get(Y)]}isSlotUsed(Q){return!!this.allocatedTextures[x.getTag(Q)]}deallocateHelper(Q){if(Q.parent&&Q.sibbling&&!this.isSlotUsed(Q.sibbling)){const $=Q.sibbling;if(this.textureSlots.remove($),aQ&&this.textureSlots.find(Q))throw new Error("Slot is not expected to be in the tree");const J=Q.parent;this.deallocateHelper(J);return}this.textureSlots.insert(Q),delete this.allocatedTextures[Q.getTag()]}trySplitHorizontally(Q,$,J){if(Q.canSplitHorizontally()){const[K,Y]=Q.splitHorizontally();if(K.size[0]>=$)return this.textureSlots.insert(Y),this.fitSlot(K,$,J)}return null}trySplitVertically(Q,$,J){if(Q.canSplitVertically()){const[K,Y]=Q.splitVertically();if(K.size[1]>=J)return this.textureSlots.insert(Y),this.fitSlot(K,$,J)}return null}fitSlot(Q,$,J){if(this.allocatedTextures[Q.getTag()]=Q,Q.size[0]>Q.size[1]){const K=this.trySplitHorizontally(Q,$,J)??this.trySplitVertically(Q,$,J);if(K)return K}else{const K=this.trySplitVertically(Q,$,J)??this.trySplitHorizontally(Q,$,J);if(K)return K}return Q}listSlots(){this.textureSlots.forEach((Q)=>{console.log(Q.key?.getTag())})}}var X0=15;class T0 extends w{gl;uniforms;textureBuffers={};tempContext=new OffscreenCanvas(1,1).getContext("2d");textureSlotAllocator=new H0({excludeTexture:(Q)=>Q===X0});textureSlotAllocatorForVideo=new H0({excludeTexture:(Q)=>Q!==X0});constructor(Q,$){super();this.gl=Q,this.uniforms=$,this.tempContext.imageSmoothingEnabled=!0}initialize(){this.initTextureUniforms(),this.initMaxTexture()}getTexture(Q){if(!this.textureBuffers[Q]){const $=this.gl.createTexture();if(!$)return;this.gl.bindTexture(U.TEXTURE_2D,$),this.gl.texImage2D(U.TEXTURE_2D,0,U.RGBA,this.textureSlotAllocator.maxTextureSize,this.textureSlotAllocator.maxTextureSize,0,U.RGBA,U.UNSIGNED_BYTE,null),this.textureBuffers[Q]=$,this.addOnDestroy(()=>this.gl.deleteTexture($))}return this.textureBuffers[Q]}loadTexture(Q,$,J,K,Y){this.gl.activeTexture(U[$]),this.gl.bindTexture(U.TEXTURE_2D,J),this.applyTexImage2d(Q,K,Y),this.gl.texParameteri(U.TEXTURE_2D,U.TEXTURE_MIN_FILTER,U.LINEAR)}applyTexImage2d(Q,[$,J,K,Y],[B,V,Z,F]){if(K===Z&&Y===F&&!$&&!J)this.gl.texSubImage2D(U.TEXTURE_2D,0,B,V,Z,F,U.RGBA,U.UNSIGNED_BYTE,Q.texImgSrc);else{const H=this.tempContext.canvas;if(Q.texImgSrc instanceof ImageData){if(H.width=Z||Q.width,H.height=F||Q.height,this.tempContext.putImageData(Q.texImgSrc,0,0),$||J)console.warn("Offset not available when sending imageData")}else{const X=K||Q.width,W=Y||Q.height;H.width=Z||X,H.height=F||W,this.tempContext.drawImage(Q.texImgSrc,$,J,X,W,0,0,H.width,H.height)}this.gl.texSubImage2D(U.TEXTURE_2D,0,B,V,H.width,H.height,U.RGBA,U.UNSIGNED_BYTE,H)}}allocateSlotForImage(Q){const J=(Q.isVideo?this.textureSlotAllocatorForVideo:this.textureSlotAllocator).allocate(Q.width,Q.height),K=`TEXTURE${J.textureIndex}`,Y=this.getTexture(K);if(!Y)throw new Error(`Invalid texture Id ${K}`);const B=this.assignImageToTexture(Q,K,Y,[0,0,Q.width,Q.height],[J.x,J.y,...J.size]);return{slot:J,refreshCallback:B}}assignImageToTexture(Q,$,J,K,Y){const B=K??[0,0,Q.width,Q.height],V=Y??[0,0,B[2],B[3]],Z=()=>{this.gl.bindTexture(U.TEXTURE_2D,J),this.applyTexImage2d(Q,B,V)};if(Q.active)Z();else this.loadTexture(Q,$,J,B,V),Q.active=!0;return Z}setupTextureForVideo(Q){const $=this.getTexture(Q);if($)this.gl.activeTexture(U[Q]),this.gl.bindTexture(U.TEXTURE_2D,$),this.gl.texParameteri(U.TEXTURE_2D,U.TEXTURE_MIN_FILTER,U.LINEAR),this.gl.texParameteri(U.TEXTURE_2D,U.TEXTURE_MAG_FILTER,U.LINEAR)}generateMipMap(Q){const $=this.getTexture(Q);if($)this.gl.activeTexture(U[Q]),this.gl.bindTexture(U.TEXTURE_2D,$),this.gl.texParameteri(U.TEXTURE_2D,U.TEXTURE_MIN_FILTER,U.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(U.TEXTURE_2D,U.TEXTURE_MAG_FILTER,U.LINEAR),this.gl.generateMipmap(U.TEXTURE_2D)}initTextureUniforms(){const Q=this.gl.getParameter(U.MAX_TEXTURE_IMAGE_UNITS),$=new Array(Q).fill(null).map((K,Y)=>Y),J=this.uniforms.getUniformLocation(t0);this.gl.uniform1iv(J,$)}initMaxTexture(){const Q=this.uniforms.getUniformLocation(a0);this.gl.uniform1f(Q,this.textureSlotAllocator.maxTextureSize)}}class l extends w{texImgSrc;active=!1;width;height;isVideo;schedule;constructor(Q,$){super();this.texImgSrc=Q;const J=Q;if(this.isVideo=!!(J.videoWidth||J.videoHeight),this.width=J.naturalWidth??J.videoWidth??J.displayWidth??J.width?.baseValue?.value??J.width,this.height=J.naturalHeight??J.videoHeight??J.displayHeight??J.height?.baseValue?.value??J.height,this.schedule=$?{period:1000/$}:void 0,!this.width||!this.height)throw new Error("Invalid image")}refresh(){this.refreshCallback?.()}static createFromCanvas(Q){return new l(Q)}static async loadImage(Q){const $=await new Promise((J,K)=>{const Y=new Image,B=(V)=>K(V.error);Y.addEventListener("error",B),Y.addEventListener("load",()=>J(Y),{once:!0}),Y.src=Q});return new l($)}static async loadVideo(Q,$,J=30){const K=await new Promise((B,V)=>{const Z=document.createElement("video");if(Z.loop=!0,$!==void 0)Z.volume=$;Z.addEventListener("loadedmetadata",()=>{Z.play(),B(Z)},{once:!0}),Z.addEventListener("error",(F)=>V(F.error)),Z.src=Q}),Y=new l(K,J);return Y.addOnDestroy(()=>K.pause()),Y}static async loadWebcam(Q){const $=await new Promise((Y,B)=>{const V=document.createElement("video");V.loop=!0,V.addEventListener("loadedmetadata",()=>V.play()),V.addEventListener("playing",()=>Y(V),{once:!0}),V.addEventListener("error",(Z)=>B(Z.error))}),J=new l($);let K=!1;return navigator.mediaDevices.getUserMedia({video:{deviceId:Q}}).then((Y)=>{if(!K)$.srcObject=Y,J.addOnDestroy(()=>Y.getTracks().forEach((B)=>B.stop()))}),J.addOnDestroy(()=>{K=!0,$.pause()}),J}}var e=function(Q){return Q};class S0 extends w{constructor(){super(...arguments)}images={};renderProcedures={image:e((Q,$)=>this.loadImage(Q,$.src)),video:e((Q,$)=>this.loadVideo(Q,$.src,$.volume,$.fps)),draw:e((Q,$)=>this.drawImage(Q,$.draw)),canvas:e((Q,$)=>this.loadCanvas(Q,$.canvas)),webcam:e((Q,$)=>this.loadWebCam(Q,$.deviceId))};hasImageId(Q){return!!this.getMedia(Q)}getMedia(Q){return this.images[Q]}setImage(Q,$){this.images[Q]=$}async renderMedia(Q,$){return this.renderProcedures[$.type](Q,$)}async drawImage(Q,$){const J=new OffscreenCanvas(1,1);$(J.getContext("2d"));const K=l.createFromCanvas(J);return this.images[Q]=this.own(K),K}async loadCanvas(Q,$){const J=l.createFromCanvas($);return $.getContext("2d"),this.images[Q]=this.own(J),J}async loadImage(Q,$){const J=await l.loadImage($);return this.images[Q]=this.own(J),J}async loadVideo(Q,$,J,K){const Y=await l.loadVideo($,J,K);return this.images[Q]=this.own(Y),Y}async loadWebCam(Q,$){const J=await l.loadWebcam($);return this.images[Q]=this.own(J),J}}var JQ=`#version 300 es
//  ~{AUTHOR}

precision highp float;

//  IN
//  shape
layout(location = 0) in vec2 position;
layout(location = 1) in mat4 transform;
//  2, 3, 4 reserved for transform
//  animation
layout(location = 5) in vec2 slotSize_and_number;

//  UNIFORM
uniform float maxTextureSize;
uniform mat4 cam;
uniform mat4 projection;

//  OUT
out vec2 vTex;
out float textureIndex;

void main() {
  vec2 tex = position.xy * vec2(0.49, -0.49) + 0.5;
  vec2 slotSize = vec2(
    pow(2.0, floor(slotSize_and_number.x / 16.0)),
    pow(2.0, mod(slotSize_and_number.x, 16.0)));
  float slotNumber = slotSize_and_number.y;
  float maxCols = maxTextureSize / slotSize.x;
  float maxRows = maxTextureSize / slotSize.y;
  float slotX = mod(slotNumber, maxCols);
  float slotY = mod(floor(slotNumber / maxCols), maxRows);

  gl_Position = projection * cam * transform * vec4(position, 0.0, 1.0);
  vTex = (vec2(slotX, slotY) + tex) * slotSize / maxTextureSize;
  textureIndex = floor(slotNumber / (maxCols * maxRows));
}
`;var KQ=`#version 300 es
//  ~{AUTHOR}
precision highp float;

//  CONST
const int NUM_TEXTURES = 16;
const float threshold = 0.00001;

//  IN
//  texture
uniform sampler2D uTextures[NUM_TEXTURES];
in float textureIndex;
in vec2 vTex;
in float opacity;

//  OUT
out vec4 fragColor;

//  FUNCTIONS
vec4 getTextureColor(float textureSlot, vec2 vTexturePoint);

void main() {
  vec4 color = getTextureColor(textureIndex, vTex);
  if (color.a <= .0001) {
    discard;
  };
  fragColor = color;
}

vec4 getTextureColor(float textureSlot, vec2 vTexturePoint) {
  if (abs(0.0 - textureSlot) < threshold) {
    return texture(uTextures[0], vTexturePoint);
  }
  if (abs(1.0 - textureSlot) < threshold) {
    return texture(uTextures[1], vTexturePoint);
  }
  if (abs(2.0 - textureSlot) < threshold) {
    return texture(uTextures[2], vTexturePoint);
  }
  if (abs(3.0 - textureSlot) < threshold) {
    return texture(uTextures[3], vTexturePoint);
  }
  if (abs(4.0 - textureSlot) < threshold) {
    return texture(uTextures[4], vTexturePoint);
  }
  if (abs(5.0 - textureSlot) < threshold) {
    return texture(uTextures[5], vTexturePoint);
  }
  if (abs(6.0 - textureSlot) < threshold) {
    return texture(uTextures[6], vTexturePoint);
  }
  if (abs(7.0 - textureSlot) < threshold) {
    return texture(uTextures[7], vTexturePoint);
  }
  if (abs(8.0 - textureSlot) < threshold) {
    return texture(uTextures[8], vTexturePoint);
  }
  if (abs(9.0 - textureSlot) < threshold) {
    return texture(uTextures[9], vTexturePoint);
  }
  if (abs(10.0 - textureSlot) < threshold) {
    return texture(uTextures[10], vTexturePoint);
  }
  if (abs(11.0 - textureSlot) < threshold) {
    return texture(uTextures[11], vTexturePoint);
  }
  if (abs(12.0 - textureSlot) < threshold) {
    return texture(uTextures[12], vTexturePoint);
  }
  if (abs(13.0 - textureSlot) < threshold) {
    return texture(uTextures[13], vTexturePoint);
  }
  if (abs(14.0 - textureSlot) < threshold) {
    return texture(uTextures[14], vTexturePoint);
  }
  if (abs(15.0 - textureSlot) < threshold) {
    return texture(uTextures[15], vTexturePoint);
  }
  return texture(uTextures[0], vTexturePoint);
}
`;function h0(Q,$){return Q.replace(/~\{(\w+)\}/g,(J,K)=>{return $?.[K]||J})}var G=0.000001,T=typeof Float32Array!=="undefined"?Float32Array:Array,c=Math.random,rK=Math.PI/180;if(!Math.hypot)Math.hypot=function(){var Q=0,$=arguments.length;while($--)Q+=arguments[$]*arguments[$];return Math.sqrt(Q)};function YQ(){var Q=new T(9);if(T!=Float32Array)Q[1]=0,Q[2]=0,Q[3]=0,Q[5]=0,Q[6]=0,Q[7]=0;return Q[0]=1,Q[4]=1,Q[8]=1,Q}var L={};U0(L,{transpose:()=>{{return F$}},translate:()=>{{return j$}},targetTo:()=>{{return p$}},subtract:()=>{{return WQ}},sub:()=>{{return s$}},str:()=>{{return y$}},set:()=>{{return Z$}},scale:()=>{{return P$}},rotateZ:()=>{{return U$}},rotateY:()=>{{return O$}},rotateX:()=>{{return C$}},rotate:()=>{{return A$}},perspectiveZO:()=>{{return w$}},perspectiveNO:()=>{{return HQ}},perspectiveFromFieldOfView:()=>{{return v$}},perspective:()=>{{return I$}},orthoZO:()=>{{return f$}},orthoNO:()=>{{return XQ}},ortho:()=>{{return g$}},multiplyScalarAndAdd:()=>{{return n$}},multiplyScalar:()=>{{return m$}},multiply:()=>{{return VQ}},mul:()=>{{return i$}},lookAt:()=>{{return z$}},invert:()=>{{return H$}},identity:()=>{{return BQ}},getTranslation:()=>{{return q$}},getScaling:()=>{{return FQ}},getRotation:()=>{{return M$}},frustum:()=>{{return h$}},fromZRotation:()=>{{return G$}},fromYRotation:()=>{{return R$}},fromXRotation:()=>{{return D$}},fromValues:()=>{{return V$}},fromTranslation:()=>{{return N$}},fromScaling:()=>{{return E$}},fromRotationTranslationScaleOrigin:()=>{{return T$}},fromRotationTranslationScale:()=>{{return L$}},fromRotationTranslation:()=>{{return ZQ}},fromRotation:()=>{{return _$}},fromQuat2:()=>{{return k$}},fromQuat:()=>{{return S$}},frob:()=>{{return x$}},exactEquals:()=>{{return c$}},equals:()=>{{return d$}},determinant:()=>{{return W$}},create:()=>{{return K$}},copy:()=>{{return B$}},clone:()=>{{return Y$}},adjoint:()=>{{return X$}},add:()=>{{return l$}}});function K$(){var Q=new T(16);if(T!=Float32Array)Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0;return Q[0]=1,Q[5]=1,Q[10]=1,Q[15]=1,Q}function Y$(Q){var $=new T(16);return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$[3]=Q[3],$[4]=Q[4],$[5]=Q[5],$[6]=Q[6],$[7]=Q[7],$[8]=Q[8],$[9]=Q[9],$[10]=Q[10],$[11]=Q[11],$[12]=Q[12],$[13]=Q[13],$[14]=Q[14],$[15]=Q[15],$}function B$(Q,$){return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q[3]=$[3],Q[4]=$[4],Q[5]=$[5],Q[6]=$[6],Q[7]=$[7],Q[8]=$[8],Q[9]=$[9],Q[10]=$[10],Q[11]=$[11],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15],Q}function V$(Q,$,J,K,Y,B,V,Z,F,H,X,W,P,A,O,C){var j=new T(16);return j[0]=Q,j[1]=$,j[2]=J,j[3]=K,j[4]=Y,j[5]=B,j[6]=V,j[7]=Z,j[8]=F,j[9]=H,j[10]=X,j[11]=W,j[12]=P,j[13]=A,j[14]=O,j[15]=C,j}function Z$(Q,$,J,K,Y,B,V,Z,F,H,X,W,P,A,O,C,j){return Q[0]=$,Q[1]=J,Q[2]=K,Q[3]=Y,Q[4]=B,Q[5]=V,Q[6]=Z,Q[7]=F,Q[8]=H,Q[9]=X,Q[10]=W,Q[11]=P,Q[12]=A,Q[13]=O,Q[14]=C,Q[15]=j,Q}function BQ(Q){return Q[0]=1,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=1,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=1,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function F$(Q,$){if(Q===$){var J=$[1],K=$[2],Y=$[3],B=$[6],V=$[7],Z=$[11];Q[1]=$[4],Q[2]=$[8],Q[3]=$[12],Q[4]=J,Q[6]=$[9],Q[7]=$[13],Q[8]=K,Q[9]=B,Q[11]=$[14],Q[12]=Y,Q[13]=V,Q[14]=Z}else Q[0]=$[0],Q[1]=$[4],Q[2]=$[8],Q[3]=$[12],Q[4]=$[1],Q[5]=$[5],Q[6]=$[9],Q[7]=$[13],Q[8]=$[2],Q[9]=$[6],Q[10]=$[10],Q[11]=$[14],Q[12]=$[3],Q[13]=$[7],Q[14]=$[11],Q[15]=$[15];return Q}function H$(Q,$){var J=$[0],K=$[1],Y=$[2],B=$[3],V=$[4],Z=$[5],F=$[6],H=$[7],X=$[8],W=$[9],P=$[10],A=$[11],O=$[12],C=$[13],j=$[14],N=$[15],k=J*Z-K*V,R=J*F-Y*V,D=J*H-B*V,E=K*F-Y*Z,_=K*H-B*Z,v=Y*H-B*F,S=X*C-W*O,h=X*j-P*O,I=X*N-A*O,g=W*j-P*C,f=W*N-A*C,z=P*N-A*j,q=k*z-R*f+D*g+E*I-_*h+v*S;if(!q)return null;return q=1/q,Q[0]=(Z*z-F*f+H*g)*q,Q[1]=(Y*f-K*z-B*g)*q,Q[2]=(C*v-j*_+N*E)*q,Q[3]=(P*_-W*v-A*E)*q,Q[4]=(F*I-V*z-H*h)*q,Q[5]=(J*z-Y*I+B*h)*q,Q[6]=(j*D-O*v-N*R)*q,Q[7]=(X*v-P*D+A*R)*q,Q[8]=(V*f-Z*I+H*S)*q,Q[9]=(K*I-J*f-B*S)*q,Q[10]=(O*_-C*D+N*k)*q,Q[11]=(W*D-X*_-A*k)*q,Q[12]=(Z*h-V*g-F*S)*q,Q[13]=(J*g-K*h+Y*S)*q,Q[14]=(C*R-O*E-j*k)*q,Q[15]=(X*E-W*R+P*k)*q,Q}function X$(Q,$){var J=$[0],K=$[1],Y=$[2],B=$[3],V=$[4],Z=$[5],F=$[6],H=$[7],X=$[8],W=$[9],P=$[10],A=$[11],O=$[12],C=$[13],j=$[14],N=$[15];return Q[0]=Z*(P*N-A*j)-W*(F*N-H*j)+C*(F*A-H*P),Q[1]=-(K*(P*N-A*j)-W*(Y*N-B*j)+C*(Y*A-B*P)),Q[2]=K*(F*N-H*j)-Z*(Y*N-B*j)+C*(Y*H-B*F),Q[3]=-(K*(F*A-H*P)-Z*(Y*A-B*P)+W*(Y*H-B*F)),Q[4]=-(V*(P*N-A*j)-X*(F*N-H*j)+O*(F*A-H*P)),Q[5]=J*(P*N-A*j)-X*(Y*N-B*j)+O*(Y*A-B*P),Q[6]=-(J*(F*N-H*j)-V*(Y*N-B*j)+O*(Y*H-B*F)),Q[7]=J*(F*A-H*P)-V*(Y*A-B*P)+X*(Y*H-B*F),Q[8]=V*(W*N-A*C)-X*(Z*N-H*C)+O*(Z*A-H*W),Q[9]=-(J*(W*N-A*C)-X*(K*N-B*C)+O*(K*A-B*W)),Q[10]=J*(Z*N-H*C)-V*(K*N-B*C)+O*(K*H-B*Z),Q[11]=-(J*(Z*A-H*W)-V*(K*A-B*W)+X*(K*H-B*Z)),Q[12]=-(V*(W*j-P*C)-X*(Z*j-F*C)+O*(Z*P-F*W)),Q[13]=J*(W*j-P*C)-X*(K*j-Y*C)+O*(K*P-Y*W),Q[14]=-(J*(Z*j-F*C)-V*(K*j-Y*C)+O*(K*F-Y*Z)),Q[15]=J*(Z*P-F*W)-V*(K*P-Y*W)+X*(K*F-Y*Z),Q}function W$(Q){var $=Q[0],J=Q[1],K=Q[2],Y=Q[3],B=Q[4],V=Q[5],Z=Q[6],F=Q[7],H=Q[8],X=Q[9],W=Q[10],P=Q[11],A=Q[12],O=Q[13],C=Q[14],j=Q[15],N=$*V-J*B,k=$*Z-K*B,R=$*F-Y*B,D=J*Z-K*V,E=J*F-Y*V,_=K*F-Y*Z,v=H*O-X*A,S=H*C-W*A,h=H*j-P*A,I=X*C-W*O,g=X*j-P*O,f=W*j-P*C;return N*f-k*g+R*I+D*h-E*S+_*v}function VQ(Q,$,J){var K=$[0],Y=$[1],B=$[2],V=$[3],Z=$[4],F=$[5],H=$[6],X=$[7],W=$[8],P=$[9],A=$[10],O=$[11],C=$[12],j=$[13],N=$[14],k=$[15],R=J[0],D=J[1],E=J[2],_=J[3];return Q[0]=R*K+D*Z+E*W+_*C,Q[1]=R*Y+D*F+E*P+_*j,Q[2]=R*B+D*H+E*A+_*N,Q[3]=R*V+D*X+E*O+_*k,R=J[4],D=J[5],E=J[6],_=J[7],Q[4]=R*K+D*Z+E*W+_*C,Q[5]=R*Y+D*F+E*P+_*j,Q[6]=R*B+D*H+E*A+_*N,Q[7]=R*V+D*X+E*O+_*k,R=J[8],D=J[9],E=J[10],_=J[11],Q[8]=R*K+D*Z+E*W+_*C,Q[9]=R*Y+D*F+E*P+_*j,Q[10]=R*B+D*H+E*A+_*N,Q[11]=R*V+D*X+E*O+_*k,R=J[12],D=J[13],E=J[14],_=J[15],Q[12]=R*K+D*Z+E*W+_*C,Q[13]=R*Y+D*F+E*P+_*j,Q[14]=R*B+D*H+E*A+_*N,Q[15]=R*V+D*X+E*O+_*k,Q}function j$(Q,$,J){var K=J[0],Y=J[1],B=J[2],V,Z,F,H,X,W,P,A,O,C,j,N;if($===Q)Q[12]=$[0]*K+$[4]*Y+$[8]*B+$[12],Q[13]=$[1]*K+$[5]*Y+$[9]*B+$[13],Q[14]=$[2]*K+$[6]*Y+$[10]*B+$[14],Q[15]=$[3]*K+$[7]*Y+$[11]*B+$[15];else V=$[0],Z=$[1],F=$[2],H=$[3],X=$[4],W=$[5],P=$[6],A=$[7],O=$[8],C=$[9],j=$[10],N=$[11],Q[0]=V,Q[1]=Z,Q[2]=F,Q[3]=H,Q[4]=X,Q[5]=W,Q[6]=P,Q[7]=A,Q[8]=O,Q[9]=C,Q[10]=j,Q[11]=N,Q[12]=V*K+X*Y+O*B+$[12],Q[13]=Z*K+W*Y+C*B+$[13],Q[14]=F*K+P*Y+j*B+$[14],Q[15]=H*K+A*Y+N*B+$[15];return Q}function P$(Q,$,J){var K=J[0],Y=J[1],B=J[2];return Q[0]=$[0]*K,Q[1]=$[1]*K,Q[2]=$[2]*K,Q[3]=$[3]*K,Q[4]=$[4]*Y,Q[5]=$[5]*Y,Q[6]=$[6]*Y,Q[7]=$[7]*Y,Q[8]=$[8]*B,Q[9]=$[9]*B,Q[10]=$[10]*B,Q[11]=$[11]*B,Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15],Q}function A$(Q,$,J,K){var Y=K[0],B=K[1],V=K[2],Z=Math.hypot(Y,B,V),F,H,X,W,P,A,O,C,j,N,k,R,D,E,_,v,S,h,I,g,f,z,q,y;if(Z<G)return null;if(Z=1/Z,Y*=Z,B*=Z,V*=Z,F=Math.sin(J),H=Math.cos(J),X=1-H,W=$[0],P=$[1],A=$[2],O=$[3],C=$[4],j=$[5],N=$[6],k=$[7],R=$[8],D=$[9],E=$[10],_=$[11],v=Y*Y*X+H,S=B*Y*X+V*F,h=V*Y*X-B*F,I=Y*B*X-V*F,g=B*B*X+H,f=V*B*X+Y*F,z=Y*V*X+B*F,q=B*V*X-Y*F,y=V*V*X+H,Q[0]=W*v+C*S+R*h,Q[1]=P*v+j*S+D*h,Q[2]=A*v+N*S+E*h,Q[3]=O*v+k*S+_*h,Q[4]=W*I+C*g+R*f,Q[5]=P*I+j*g+D*f,Q[6]=A*I+N*g+E*f,Q[7]=O*I+k*g+_*f,Q[8]=W*z+C*q+R*y,Q[9]=P*z+j*q+D*y,Q[10]=A*z+N*q+E*y,Q[11]=O*z+k*q+_*y,$!==Q)Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q}function C$(Q,$,J){var K=Math.sin(J),Y=Math.cos(J),B=$[4],V=$[5],Z=$[6],F=$[7],H=$[8],X=$[9],W=$[10],P=$[11];if($!==Q)Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q[3]=$[3],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q[4]=B*Y+H*K,Q[5]=V*Y+X*K,Q[6]=Z*Y+W*K,Q[7]=F*Y+P*K,Q[8]=H*Y-B*K,Q[9]=X*Y-V*K,Q[10]=W*Y-Z*K,Q[11]=P*Y-F*K,Q}function O$(Q,$,J){var K=Math.sin(J),Y=Math.cos(J),B=$[0],V=$[1],Z=$[2],F=$[3],H=$[8],X=$[9],W=$[10],P=$[11];if($!==Q)Q[4]=$[4],Q[5]=$[5],Q[6]=$[6],Q[7]=$[7],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q[0]=B*Y-H*K,Q[1]=V*Y-X*K,Q[2]=Z*Y-W*K,Q[3]=F*Y-P*K,Q[8]=B*K+H*Y,Q[9]=V*K+X*Y,Q[10]=Z*K+W*Y,Q[11]=F*K+P*Y,Q}function U$(Q,$,J){var K=Math.sin(J),Y=Math.cos(J),B=$[0],V=$[1],Z=$[2],F=$[3],H=$[4],X=$[5],W=$[6],P=$[7];if($!==Q)Q[8]=$[8],Q[9]=$[9],Q[10]=$[10],Q[11]=$[11],Q[12]=$[12],Q[13]=$[13],Q[14]=$[14],Q[15]=$[15];return Q[0]=B*Y+H*K,Q[1]=V*Y+X*K,Q[2]=Z*Y+W*K,Q[3]=F*Y+P*K,Q[4]=H*Y-B*K,Q[5]=X*Y-V*K,Q[6]=W*Y-Z*K,Q[7]=P*Y-F*K,Q}function N$(Q,$){return Q[0]=1,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=1,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=1,Q[11]=0,Q[12]=$[0],Q[13]=$[1],Q[14]=$[2],Q[15]=1,Q}function E$(Q,$){return Q[0]=$[0],Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=$[1],Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=$[2],Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function _$(Q,$,J){var K=J[0],Y=J[1],B=J[2],V=Math.hypot(K,Y,B),Z,F,H;if(V<G)return null;return V=1/V,K*=V,Y*=V,B*=V,Z=Math.sin($),F=Math.cos($),H=1-F,Q[0]=K*K*H+F,Q[1]=Y*K*H+B*Z,Q[2]=B*K*H-Y*Z,Q[3]=0,Q[4]=K*Y*H-B*Z,Q[5]=Y*Y*H+F,Q[6]=B*Y*H+K*Z,Q[7]=0,Q[8]=K*B*H+Y*Z,Q[9]=Y*B*H-K*Z,Q[10]=B*B*H+F,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function D$(Q,$){var J=Math.sin($),K=Math.cos($);return Q[0]=1,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=K,Q[6]=J,Q[7]=0,Q[8]=0,Q[9]=-J,Q[10]=K,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function R$(Q,$){var J=Math.sin($),K=Math.cos($);return Q[0]=K,Q[1]=0,Q[2]=-J,Q[3]=0,Q[4]=0,Q[5]=1,Q[6]=0,Q[7]=0,Q[8]=J,Q[9]=0,Q[10]=K,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function G$(Q,$){var J=Math.sin($),K=Math.cos($);return Q[0]=K,Q[1]=J,Q[2]=0,Q[3]=0,Q[4]=-J,Q[5]=K,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=1,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function ZQ(Q,$,J){var K=$[0],Y=$[1],B=$[2],V=$[3],Z=K+K,F=Y+Y,H=B+B,X=K*Z,W=K*F,P=K*H,A=Y*F,O=Y*H,C=B*H,j=V*Z,N=V*F,k=V*H;return Q[0]=1-(A+C),Q[1]=W+k,Q[2]=P-N,Q[3]=0,Q[4]=W-k,Q[5]=1-(X+C),Q[6]=O+j,Q[7]=0,Q[8]=P+N,Q[9]=O-j,Q[10]=1-(X+A),Q[11]=0,Q[12]=J[0],Q[13]=J[1],Q[14]=J[2],Q[15]=1,Q}function k$(Q,$){var J=new T(3),K=-$[0],Y=-$[1],B=-$[2],V=$[3],Z=$[4],F=$[5],H=$[6],X=$[7],W=K*K+Y*Y+B*B+V*V;if(W>0)J[0]=(Z*V+X*K+F*B-H*Y)*2/W,J[1]=(F*V+X*Y+H*K-Z*B)*2/W,J[2]=(H*V+X*B+Z*Y-F*K)*2/W;else J[0]=(Z*V+X*K+F*B-H*Y)*2,J[1]=(F*V+X*Y+H*K-Z*B)*2,J[2]=(H*V+X*B+Z*Y-F*K)*2;return ZQ(Q,$,J),Q}function q$(Q,$){return Q[0]=$[12],Q[1]=$[13],Q[2]=$[14],Q}function FQ(Q,$){var J=$[0],K=$[1],Y=$[2],B=$[4],V=$[5],Z=$[6],F=$[8],H=$[9],X=$[10];return Q[0]=Math.hypot(J,K,Y),Q[1]=Math.hypot(B,V,Z),Q[2]=Math.hypot(F,H,X),Q}function M$(Q,$){var J=new T(3);FQ(J,$);var K=1/J[0],Y=1/J[1],B=1/J[2],V=$[0]*K,Z=$[1]*Y,F=$[2]*B,H=$[4]*K,X=$[5]*Y,W=$[6]*B,P=$[8]*K,A=$[9]*Y,O=$[10]*B,C=V+X+O,j=0;if(C>0)j=Math.sqrt(C+1)*2,Q[3]=0.25*j,Q[0]=(W-A)/j,Q[1]=(P-F)/j,Q[2]=(Z-H)/j;else if(V>X&&V>O)j=Math.sqrt(1+V-X-O)*2,Q[3]=(W-A)/j,Q[0]=0.25*j,Q[1]=(Z+H)/j,Q[2]=(P+F)/j;else if(X>O)j=Math.sqrt(1+X-V-O)*2,Q[3]=(P-F)/j,Q[0]=(Z+H)/j,Q[1]=0.25*j,Q[2]=(W+A)/j;else j=Math.sqrt(1+O-V-X)*2,Q[3]=(Z-H)/j,Q[0]=(P+F)/j,Q[1]=(W+A)/j,Q[2]=0.25*j;return Q}function L$(Q,$,J,K){var Y=$[0],B=$[1],V=$[2],Z=$[3],F=Y+Y,H=B+B,X=V+V,W=Y*F,P=Y*H,A=Y*X,O=B*H,C=B*X,j=V*X,N=Z*F,k=Z*H,R=Z*X,D=K[0],E=K[1],_=K[2];return Q[0]=(1-(O+j))*D,Q[1]=(P+R)*D,Q[2]=(A-k)*D,Q[3]=0,Q[4]=(P-R)*E,Q[5]=(1-(W+j))*E,Q[6]=(C+N)*E,Q[7]=0,Q[8]=(A+k)*_,Q[9]=(C-N)*_,Q[10]=(1-(W+O))*_,Q[11]=0,Q[12]=J[0],Q[13]=J[1],Q[14]=J[2],Q[15]=1,Q}function T$(Q,$,J,K,Y){var B=$[0],V=$[1],Z=$[2],F=$[3],H=B+B,X=V+V,W=Z+Z,P=B*H,A=B*X,O=B*W,C=V*X,j=V*W,N=Z*W,k=F*H,R=F*X,D=F*W,E=K[0],_=K[1],v=K[2],S=Y[0],h=Y[1],I=Y[2],g=(1-(C+N))*E,f=(A+D)*E,z=(O-R)*E,q=(A-D)*_,y=(1-(P+N))*_,b=(j+k)*_,r=(O+R)*v,s0=(j-k)*v,b0=(1-(P+C))*v;return Q[0]=g,Q[1]=f,Q[2]=z,Q[3]=0,Q[4]=q,Q[5]=y,Q[6]=b,Q[7]=0,Q[8]=r,Q[9]=s0,Q[10]=b0,Q[11]=0,Q[12]=J[0]+S-(g*S+q*h+r*I),Q[13]=J[1]+h-(f*S+y*h+s0*I),Q[14]=J[2]+I-(z*S+b*h+b0*I),Q[15]=1,Q}function S$(Q,$){var J=$[0],K=$[1],Y=$[2],B=$[3],V=J+J,Z=K+K,F=Y+Y,H=J*V,X=K*V,W=K*Z,P=Y*V,A=Y*Z,O=Y*F,C=B*V,j=B*Z,N=B*F;return Q[0]=1-W-O,Q[1]=X+N,Q[2]=P-j,Q[3]=0,Q[4]=X-N,Q[5]=1-H-O,Q[6]=A+C,Q[7]=0,Q[8]=P+j,Q[9]=A-C,Q[10]=1-H-W,Q[11]=0,Q[12]=0,Q[13]=0,Q[14]=0,Q[15]=1,Q}function h$(Q,$,J,K,Y,B,V){var Z=1/(J-$),F=1/(Y-K),H=1/(B-V);return Q[0]=B*2*Z,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=B*2*F,Q[6]=0,Q[7]=0,Q[8]=(J+$)*Z,Q[9]=(Y+K)*F,Q[10]=(V+B)*H,Q[11]=-1,Q[12]=0,Q[13]=0,Q[14]=V*B*2*H,Q[15]=0,Q}function HQ(Q,$,J,K,Y){var B=1/Math.tan($/2),V;if(Q[0]=B/J,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=B,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[11]=-1,Q[12]=0,Q[13]=0,Q[15]=0,Y!=null&&Y!==Infinity)V=1/(K-Y),Q[10]=(Y+K)*V,Q[14]=2*Y*K*V;else Q[10]=-1,Q[14]=-2*K;return Q}function w$(Q,$,J,K,Y){var B=1/Math.tan($/2),V;if(Q[0]=B/J,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=B,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[11]=-1,Q[12]=0,Q[13]=0,Q[15]=0,Y!=null&&Y!==Infinity)V=1/(K-Y),Q[10]=Y*V,Q[14]=Y*K*V;else Q[10]=-1,Q[14]=-K;return Q}function v$(Q,$,J,K){var Y=Math.tan($.upDegrees*Math.PI/180),B=Math.tan($.downDegrees*Math.PI/180),V=Math.tan($.leftDegrees*Math.PI/180),Z=Math.tan($.rightDegrees*Math.PI/180),F=2/(V+Z),H=2/(Y+B);return Q[0]=F,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=H,Q[6]=0,Q[7]=0,Q[8]=-((V-Z)*F*0.5),Q[9]=(Y-B)*H*0.5,Q[10]=K/(J-K),Q[11]=-1,Q[12]=0,Q[13]=0,Q[14]=K*J/(J-K),Q[15]=0,Q}function XQ(Q,$,J,K,Y,B,V){var Z=1/($-J),F=1/(K-Y),H=1/(B-V);return Q[0]=-2*Z,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=-2*F,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=2*H,Q[11]=0,Q[12]=($+J)*Z,Q[13]=(Y+K)*F,Q[14]=(V+B)*H,Q[15]=1,Q}function f$(Q,$,J,K,Y,B,V){var Z=1/($-J),F=1/(K-Y),H=1/(B-V);return Q[0]=-2*Z,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=0,Q[5]=-2*F,Q[6]=0,Q[7]=0,Q[8]=0,Q[9]=0,Q[10]=H,Q[11]=0,Q[12]=($+J)*Z,Q[13]=(Y+K)*F,Q[14]=B*H,Q[15]=1,Q}function z$(Q,$,J,K){var Y,B,V,Z,F,H,X,W,P,A,O=$[0],C=$[1],j=$[2],N=K[0],k=K[1],R=K[2],D=J[0],E=J[1],_=J[2];if(Math.abs(O-D)<G&&Math.abs(C-E)<G&&Math.abs(j-_)<G)return BQ(Q);if(X=O-D,W=C-E,P=j-_,A=1/Math.hypot(X,W,P),X*=A,W*=A,P*=A,Y=k*P-R*W,B=R*X-N*P,V=N*W-k*X,A=Math.hypot(Y,B,V),!A)Y=0,B=0,V=0;else A=1/A,Y*=A,B*=A,V*=A;if(Z=W*V-P*B,F=P*Y-X*V,H=X*B-W*Y,A=Math.hypot(Z,F,H),!A)Z=0,F=0,H=0;else A=1/A,Z*=A,F*=A,H*=A;return Q[0]=Y,Q[1]=Z,Q[2]=X,Q[3]=0,Q[4]=B,Q[5]=F,Q[6]=W,Q[7]=0,Q[8]=V,Q[9]=H,Q[10]=P,Q[11]=0,Q[12]=-(Y*O+B*C+V*j),Q[13]=-(Z*O+F*C+H*j),Q[14]=-(X*O+W*C+P*j),Q[15]=1,Q}function p$(Q,$,J,K){var Y=$[0],B=$[1],V=$[2],Z=K[0],F=K[1],H=K[2],X=Y-J[0],W=B-J[1],P=V-J[2],A=X*X+W*W+P*P;if(A>0)A=1/Math.sqrt(A),X*=A,W*=A,P*=A;var O=F*P-H*W,C=H*X-Z*P,j=Z*W-F*X;if(A=O*O+C*C+j*j,A>0)A=1/Math.sqrt(A),O*=A,C*=A,j*=A;return Q[0]=O,Q[1]=C,Q[2]=j,Q[3]=0,Q[4]=W*j-P*C,Q[5]=P*O-X*j,Q[6]=X*C-W*O,Q[7]=0,Q[8]=X,Q[9]=W,Q[10]=P,Q[11]=0,Q[12]=Y,Q[13]=B,Q[14]=V,Q[15]=1,Q}function y$(Q){return"mat4("+Q[0]+", "+Q[1]+", "+Q[2]+", "+Q[3]+", "+Q[4]+", "+Q[5]+", "+Q[6]+", "+Q[7]+", "+Q[8]+", "+Q[9]+", "+Q[10]+", "+Q[11]+", "+Q[12]+", "+Q[13]+", "+Q[14]+", "+Q[15]+")"}function x$(Q){return Math.hypot(Q[0],Q[1],Q[2],Q[3],Q[4],Q[5],Q[6],Q[7],Q[8],Q[9],Q[10],Q[11],Q[12],Q[13],Q[14],Q[15])}function l$(Q,$,J){return Q[0]=$[0]+J[0],Q[1]=$[1]+J[1],Q[2]=$[2]+J[2],Q[3]=$[3]+J[3],Q[4]=$[4]+J[4],Q[5]=$[5]+J[5],Q[6]=$[6]+J[6],Q[7]=$[7]+J[7],Q[8]=$[8]+J[8],Q[9]=$[9]+J[9],Q[10]=$[10]+J[10],Q[11]=$[11]+J[11],Q[12]=$[12]+J[12],Q[13]=$[13]+J[13],Q[14]=$[14]+J[14],Q[15]=$[15]+J[15],Q}function WQ(Q,$,J){return Q[0]=$[0]-J[0],Q[1]=$[1]-J[1],Q[2]=$[2]-J[2],Q[3]=$[3]-J[3],Q[4]=$[4]-J[4],Q[5]=$[5]-J[5],Q[6]=$[6]-J[6],Q[7]=$[7]-J[7],Q[8]=$[8]-J[8],Q[9]=$[9]-J[9],Q[10]=$[10]-J[10],Q[11]=$[11]-J[11],Q[12]=$[12]-J[12],Q[13]=$[13]-J[13],Q[14]=$[14]-J[14],Q[15]=$[15]-J[15],Q}function m$(Q,$,J){return Q[0]=$[0]*J,Q[1]=$[1]*J,Q[2]=$[2]*J,Q[3]=$[3]*J,Q[4]=$[4]*J,Q[5]=$[5]*J,Q[6]=$[6]*J,Q[7]=$[7]*J,Q[8]=$[8]*J,Q[9]=$[9]*J,Q[10]=$[10]*J,Q[11]=$[11]*J,Q[12]=$[12]*J,Q[13]=$[13]*J,Q[14]=$[14]*J,Q[15]=$[15]*J,Q}function n$(Q,$,J,K){return Q[0]=$[0]+J[0]*K,Q[1]=$[1]+J[1]*K,Q[2]=$[2]+J[2]*K,Q[3]=$[3]+J[3]*K,Q[4]=$[4]+J[4]*K,Q[5]=$[5]+J[5]*K,Q[6]=$[6]+J[6]*K,Q[7]=$[7]+J[7]*K,Q[8]=$[8]+J[8]*K,Q[9]=$[9]+J[9]*K,Q[10]=$[10]+J[10]*K,Q[11]=$[11]+J[11]*K,Q[12]=$[12]+J[12]*K,Q[13]=$[13]+J[13]*K,Q[14]=$[14]+J[14]*K,Q[15]=$[15]+J[15]*K,Q}function c$(Q,$){return Q[0]===$[0]&&Q[1]===$[1]&&Q[2]===$[2]&&Q[3]===$[3]&&Q[4]===$[4]&&Q[5]===$[5]&&Q[6]===$[6]&&Q[7]===$[7]&&Q[8]===$[8]&&Q[9]===$[9]&&Q[10]===$[10]&&Q[11]===$[11]&&Q[12]===$[12]&&Q[13]===$[13]&&Q[14]===$[14]&&Q[15]===$[15]}function d$(Q,$){var J=Q[0],K=Q[1],Y=Q[2],B=Q[3],V=Q[4],Z=Q[5],F=Q[6],H=Q[7],X=Q[8],W=Q[9],P=Q[10],A=Q[11],O=Q[12],C=Q[13],j=Q[14],N=Q[15],k=$[0],R=$[1],D=$[2],E=$[3],_=$[4],v=$[5],S=$[6],h=$[7],I=$[8],g=$[9],f=$[10],z=$[11],q=$[12],y=$[13],b=$[14],r=$[15];return Math.abs(J-k)<=G*Math.max(1,Math.abs(J),Math.abs(k))&&Math.abs(K-R)<=G*Math.max(1,Math.abs(K),Math.abs(R))&&Math.abs(Y-D)<=G*Math.max(1,Math.abs(Y),Math.abs(D))&&Math.abs(B-E)<=G*Math.max(1,Math.abs(B),Math.abs(E))&&Math.abs(V-_)<=G*Math.max(1,Math.abs(V),Math.abs(_))&&Math.abs(Z-v)<=G*Math.max(1,Math.abs(Z),Math.abs(v))&&Math.abs(F-S)<=G*Math.max(1,Math.abs(F),Math.abs(S))&&Math.abs(H-h)<=G*Math.max(1,Math.abs(H),Math.abs(h))&&Math.abs(X-I)<=G*Math.max(1,Math.abs(X),Math.abs(I))&&Math.abs(W-g)<=G*Math.max(1,Math.abs(W),Math.abs(g))&&Math.abs(P-f)<=G*Math.max(1,Math.abs(P),Math.abs(f))&&Math.abs(A-z)<=G*Math.max(1,Math.abs(A),Math.abs(z))&&Math.abs(O-q)<=G*Math.max(1,Math.abs(O),Math.abs(q))&&Math.abs(C-y)<=G*Math.max(1,Math.abs(C),Math.abs(y))&&Math.abs(j-b)<=G*Math.max(1,Math.abs(j),Math.abs(b))&&Math.abs(N-r)<=G*Math.max(1,Math.abs(N),Math.abs(r))}var I$=HQ,g$=XQ,i$=VQ,s$=WQ;var a={};U0(a,{str:()=>{{return nJ}},squaredLength:()=>{{return lQ}},sqrLen:()=>{{return oJ}},sqlerp:()=>{{return $K}},slerp:()=>{{return A0}},setAxisAngle:()=>{{return wQ}},setAxes:()=>{{return JK}},set:()=>{{return sJ}},scale:()=>{{return pQ}},rotationTo:()=>{{return QK}},rotateZ:()=>{{return fJ}},rotateY:()=>{{return gJ}},rotateX:()=>{{return vJ}},random:()=>{{return yJ}},pow:()=>{{return pJ}},normalize:()=>{{return g0}},multiply:()=>{{return vQ}},mul:()=>{{return rJ}},ln:()=>{{return fQ}},lerp:()=>{{return eJ}},length:()=>{{return xQ}},len:()=>{{return uJ}},invert:()=>{{return xJ}},identity:()=>{{return hJ}},getAxisAngle:()=>{{return IJ}},getAngle:()=>{{return wJ}},fromValues:()=>{{return dJ}},fromMat3:()=>{{return zQ}},fromEuler:()=>{{return mJ}},exp:()=>{{return gQ}},exactEquals:()=>{{return aJ}},equals:()=>{{return tJ}},dot:()=>{{return yQ}},create:()=>{{return v0}},copy:()=>{{return iJ}},conjugate:()=>{{return lJ}},clone:()=>{{return cJ}},calculateW:()=>{{return zJ}},add:()=>{{return bJ}}});var s={};U0(s,{zero:()=>{{return UJ}},transformQuat:()=>{{return jJ}},transformMat4:()=>{{return XJ}},transformMat3:()=>{{return WJ}},subtract:()=>{{return PQ}},sub:()=>{{return DJ}},str:()=>{{return NJ}},squaredLength:()=>{{return NQ}},squaredDistance:()=>{{return UQ}},sqrLen:()=>{{return MJ}},sqrDist:()=>{{return qJ}},set:()=>{{return e$}},scaleAndAdd:()=>{{return KJ}},scale:()=>{{return JJ}},round:()=>{{return $J}},rotateZ:()=>{{return CJ}},rotateY:()=>{{return AJ}},rotateX:()=>{{return PJ}},random:()=>{{return HJ}},normalize:()=>{{return I0}},negate:()=>{{return YJ}},multiply:()=>{{return AQ}},mul:()=>{{return RJ}},min:()=>{{return t$}},max:()=>{{return QJ}},lerp:()=>{{return VJ}},length:()=>{{return jQ}},len:()=>{{return w0}},inverse:()=>{{return BJ}},hermite:()=>{{return ZJ}},fromValues:()=>{{return j0}},forEach:()=>{{return LJ}},floor:()=>{{return a$}},exactEquals:()=>{{return EJ}},equals:()=>{{return _J}},dot:()=>{{return P0}},divide:()=>{{return CQ}},div:()=>{{return GJ}},distance:()=>{{return OQ}},dist:()=>{{return kJ}},cross:()=>{{return o}},create:()=>{{return W0}},copy:()=>{{return r$}},clone:()=>{{return b$}},ceil:()=>{{return o$}},bezier:()=>{{return FJ}},angle:()=>{{return OJ}},add:()=>{{return u$}}});function W0(){var Q=new T(3);if(T!=Float32Array)Q[0]=0,Q[1]=0,Q[2]=0;return Q}function b$(Q){var $=new T(3);return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$}function jQ(Q){var $=Q[0],J=Q[1],K=Q[2];return Math.hypot($,J,K)}function j0(Q,$,J){var K=new T(3);return K[0]=Q,K[1]=$,K[2]=J,K}function r$(Q,$){return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q}function e$(Q,$,J,K){return Q[0]=$,Q[1]=J,Q[2]=K,Q}function u$(Q,$,J){return Q[0]=$[0]+J[0],Q[1]=$[1]+J[1],Q[2]=$[2]+J[2],Q}function PQ(Q,$,J){return Q[0]=$[0]-J[0],Q[1]=$[1]-J[1],Q[2]=$[2]-J[2],Q}function AQ(Q,$,J){return Q[0]=$[0]*J[0],Q[1]=$[1]*J[1],Q[2]=$[2]*J[2],Q}function CQ(Q,$,J){return Q[0]=$[0]/J[0],Q[1]=$[1]/J[1],Q[2]=$[2]/J[2],Q}function o$(Q,$){return Q[0]=Math.ceil($[0]),Q[1]=Math.ceil($[1]),Q[2]=Math.ceil($[2]),Q}function a$(Q,$){return Q[0]=Math.floor($[0]),Q[1]=Math.floor($[1]),Q[2]=Math.floor($[2]),Q}function t$(Q,$,J){return Q[0]=Math.min($[0],J[0]),Q[1]=Math.min($[1],J[1]),Q[2]=Math.min($[2],J[2]),Q}function QJ(Q,$,J){return Q[0]=Math.max($[0],J[0]),Q[1]=Math.max($[1],J[1]),Q[2]=Math.max($[2],J[2]),Q}function $J(Q,$){return Q[0]=Math.round($[0]),Q[1]=Math.round($[1]),Q[2]=Math.round($[2]),Q}function JJ(Q,$,J){return Q[0]=$[0]*J,Q[1]=$[1]*J,Q[2]=$[2]*J,Q}function KJ(Q,$,J,K){return Q[0]=$[0]+J[0]*K,Q[1]=$[1]+J[1]*K,Q[2]=$[2]+J[2]*K,Q}function OQ(Q,$){var J=$[0]-Q[0],K=$[1]-Q[1],Y=$[2]-Q[2];return Math.hypot(J,K,Y)}function UQ(Q,$){var J=$[0]-Q[0],K=$[1]-Q[1],Y=$[2]-Q[2];return J*J+K*K+Y*Y}function NQ(Q){var $=Q[0],J=Q[1],K=Q[2];return $*$+J*J+K*K}function YJ(Q,$){return Q[0]=-$[0],Q[1]=-$[1],Q[2]=-$[2],Q}function BJ(Q,$){return Q[0]=1/$[0],Q[1]=1/$[1],Q[2]=1/$[2],Q}function I0(Q,$){var J=$[0],K=$[1],Y=$[2],B=J*J+K*K+Y*Y;if(B>0)B=1/Math.sqrt(B);return Q[0]=$[0]*B,Q[1]=$[1]*B,Q[2]=$[2]*B,Q}function P0(Q,$){return Q[0]*$[0]+Q[1]*$[1]+Q[2]*$[2]}function o(Q,$,J){var K=$[0],Y=$[1],B=$[2],V=J[0],Z=J[1],F=J[2];return Q[0]=Y*F-B*Z,Q[1]=B*V-K*F,Q[2]=K*Z-Y*V,Q}function VJ(Q,$,J,K){var Y=$[0],B=$[1],V=$[2];return Q[0]=Y+K*(J[0]-Y),Q[1]=B+K*(J[1]-B),Q[2]=V+K*(J[2]-V),Q}function ZJ(Q,$,J,K,Y,B){var V=B*B,Z=V*(2*B-3)+1,F=V*(B-2)+B,H=V*(B-1),X=V*(3-2*B);return Q[0]=$[0]*Z+J[0]*F+K[0]*H+Y[0]*X,Q[1]=$[1]*Z+J[1]*F+K[1]*H+Y[1]*X,Q[2]=$[2]*Z+J[2]*F+K[2]*H+Y[2]*X,Q}function FJ(Q,$,J,K,Y,B){var V=1-B,Z=V*V,F=B*B,H=Z*V,X=3*B*Z,W=3*F*V,P=F*B;return Q[0]=$[0]*H+J[0]*X+K[0]*W+Y[0]*P,Q[1]=$[1]*H+J[1]*X+K[1]*W+Y[1]*P,Q[2]=$[2]*H+J[2]*X+K[2]*W+Y[2]*P,Q}function HJ(Q,$){$=$||1;var J=c()*2*Math.PI,K=c()*2-1,Y=Math.sqrt(1-K*K)*$;return Q[0]=Math.cos(J)*Y,Q[1]=Math.sin(J)*Y,Q[2]=K*$,Q}function XJ(Q,$,J){var K=$[0],Y=$[1],B=$[2],V=J[3]*K+J[7]*Y+J[11]*B+J[15];return V=V||1,Q[0]=(J[0]*K+J[4]*Y+J[8]*B+J[12])/V,Q[1]=(J[1]*K+J[5]*Y+J[9]*B+J[13])/V,Q[2]=(J[2]*K+J[6]*Y+J[10]*B+J[14])/V,Q}function WJ(Q,$,J){var K=$[0],Y=$[1],B=$[2];return Q[0]=K*J[0]+Y*J[3]+B*J[6],Q[1]=K*J[1]+Y*J[4]+B*J[7],Q[2]=K*J[2]+Y*J[5]+B*J[8],Q}function jJ(Q,$,J){var K=J[0],Y=J[1],B=J[2],V=J[3],Z=$[0],F=$[1],H=$[2],X=Y*H-B*F,W=B*Z-K*H,P=K*F-Y*Z,A=Y*P-B*W,O=B*X-K*P,C=K*W-Y*X,j=V*2;return X*=j,W*=j,P*=j,A*=2,O*=2,C*=2,Q[0]=Z+X+A,Q[1]=F+W+O,Q[2]=H+P+C,Q}function PJ(Q,$,J,K){var Y=[],B=[];return Y[0]=$[0]-J[0],Y[1]=$[1]-J[1],Y[2]=$[2]-J[2],B[0]=Y[0],B[1]=Y[1]*Math.cos(K)-Y[2]*Math.sin(K),B[2]=Y[1]*Math.sin(K)+Y[2]*Math.cos(K),Q[0]=B[0]+J[0],Q[1]=B[1]+J[1],Q[2]=B[2]+J[2],Q}function AJ(Q,$,J,K){var Y=[],B=[];return Y[0]=$[0]-J[0],Y[1]=$[1]-J[1],Y[2]=$[2]-J[2],B[0]=Y[2]*Math.sin(K)+Y[0]*Math.cos(K),B[1]=Y[1],B[2]=Y[2]*Math.cos(K)-Y[0]*Math.sin(K),Q[0]=B[0]+J[0],Q[1]=B[1]+J[1],Q[2]=B[2]+J[2],Q}function CJ(Q,$,J,K){var Y=[],B=[];return Y[0]=$[0]-J[0],Y[1]=$[1]-J[1],Y[2]=$[2]-J[2],B[0]=Y[0]*Math.cos(K)-Y[1]*Math.sin(K),B[1]=Y[0]*Math.sin(K)+Y[1]*Math.cos(K),B[2]=Y[2],Q[0]=B[0]+J[0],Q[1]=B[1]+J[1],Q[2]=B[2]+J[2],Q}function OJ(Q,$){var J=Q[0],K=Q[1],Y=Q[2],B=$[0],V=$[1],Z=$[2],F=Math.sqrt(J*J+K*K+Y*Y),H=Math.sqrt(B*B+V*V+Z*Z),X=F*H,W=X&&P0(Q,$)/X;return Math.acos(Math.min(Math.max(W,-1),1))}function UJ(Q){return Q[0]=0,Q[1]=0,Q[2]=0,Q}function NJ(Q){return"vec3("+Q[0]+", "+Q[1]+", "+Q[2]+")"}function EJ(Q,$){return Q[0]===$[0]&&Q[1]===$[1]&&Q[2]===$[2]}function _J(Q,$){var J=Q[0],K=Q[1],Y=Q[2],B=$[0],V=$[1],Z=$[2];return Math.abs(J-B)<=G*Math.max(1,Math.abs(J),Math.abs(B))&&Math.abs(K-V)<=G*Math.max(1,Math.abs(K),Math.abs(V))&&Math.abs(Y-Z)<=G*Math.max(1,Math.abs(Y),Math.abs(Z))}var DJ=PQ,RJ=AQ,GJ=CQ,kJ=OQ,qJ=UQ,w0=jQ,MJ=NQ,LJ=function(){var Q=W0();return function($,J,K,Y,B,V){var Z,F;if(!J)J=3;if(!K)K=0;if(Y)F=Math.min(Y*J+K,$.length);else F=$.length;for(Z=K;Z<F;Z+=J)Q[0]=$[Z],Q[1]=$[Z+1],Q[2]=$[Z+2],B(Q,Q,V),$[Z]=Q[0],$[Z+1]=Q[1],$[Z+2]=Q[2];return $}}();function TJ(){var Q=new T(4);if(T!=Float32Array)Q[0]=0,Q[1]=0,Q[2]=0,Q[3]=0;return Q}function EQ(Q){var $=new T(4);return $[0]=Q[0],$[1]=Q[1],$[2]=Q[2],$[3]=Q[3],$}function _Q(Q,$,J,K){var Y=new T(4);return Y[0]=Q,Y[1]=$,Y[2]=J,Y[3]=K,Y}function DQ(Q,$){return Q[0]=$[0],Q[1]=$[1],Q[2]=$[2],Q[3]=$[3],Q}function RQ(Q,$,J,K,Y){return Q[0]=$,Q[1]=J,Q[2]=K,Q[3]=Y,Q}function GQ(Q,$,J){return Q[0]=$[0]+J[0],Q[1]=$[1]+J[1],Q[2]=$[2]+J[2],Q[3]=$[3]+J[3],Q}function kQ(Q,$,J){return Q[0]=$[0]*J,Q[1]=$[1]*J,Q[2]=$[2]*J,Q[3]=$[3]*J,Q}function qQ(Q){var $=Q[0],J=Q[1],K=Q[2],Y=Q[3];return Math.hypot($,J,K,Y)}function MQ(Q){var $=Q[0],J=Q[1],K=Q[2],Y=Q[3];return $*$+J*J+K*K+Y*Y}function LQ(Q,$){var J=$[0],K=$[1],Y=$[2],B=$[3],V=J*J+K*K+Y*Y+B*B;if(V>0)V=1/Math.sqrt(V);return Q[0]=J*V,Q[1]=K*V,Q[2]=Y*V,Q[3]=B*V,Q}function TQ(Q,$){return Q[0]*$[0]+Q[1]*$[1]+Q[2]*$[2]+Q[3]*$[3]}function SQ(Q,$,J,K){var Y=$[0],B=$[1],V=$[2],Z=$[3];return Q[0]=Y+K*(J[0]-Y),Q[1]=B+K*(J[1]-B),Q[2]=V+K*(J[2]-V),Q[3]=Z+K*(J[3]-Z),Q}function hQ(Q,$){return Q[0]===$[0]&&Q[1]===$[1]&&Q[2]===$[2]&&Q[3]===$[3]}function IQ(Q,$){var J=Q[0],K=Q[1],Y=Q[2],B=Q[3],V=$[0],Z=$[1],F=$[2],H=$[3];return Math.abs(J-V)<=G*Math.max(1,Math.abs(J),Math.abs(V))&&Math.abs(K-Z)<=G*Math.max(1,Math.abs(K),Math.abs(Z))&&Math.abs(Y-F)<=G*Math.max(1,Math.abs(Y),Math.abs(F))&&Math.abs(B-H)<=G*Math.max(1,Math.abs(B),Math.abs(H))}var eK=function(){var Q=TJ();return function($,J,K,Y,B,V){var Z,F;if(!J)J=4;if(!K)K=0;if(Y)F=Math.min(Y*J+K,$.length);else F=$.length;for(Z=K;Z<F;Z+=J)Q[0]=$[Z],Q[1]=$[Z+1],Q[2]=$[Z+2],Q[3]=$[Z+3],B(Q,Q,V),$[Z]=Q[0],$[Z+1]=Q[1],$[Z+2]=Q[2],$[Z+3]=Q[3];return $}}();function v0(){var Q=new T(4);if(T!=Float32Array)Q[0]=0,Q[1]=0,Q[2]=0;return Q[3]=1,Q}function hJ(Q){return Q[0]=0,Q[1]=0,Q[2]=0,Q[3]=1,Q}function wQ(Q,$,J){J=J*0.5;var K=Math.sin(J);return Q[0]=K*$[0],Q[1]=K*$[1],Q[2]=K*$[2],Q[3]=Math.cos(J),Q}function IJ(Q,$){var J=Math.acos($[3])*2,K=Math.sin(J/2);if(K>G)Q[0]=$[0]/K,Q[1]=$[1]/K,Q[2]=$[2]/K;else Q[0]=1,Q[1]=0,Q[2]=0;return J}function wJ(Q,$){var J=yQ(Q,$);return Math.acos(2*J*J-1)}function vQ(Q,$,J){var K=$[0],Y=$[1],B=$[2],V=$[3],Z=J[0],F=J[1],H=J[2],X=J[3];return Q[0]=K*X+V*Z+Y*H-B*F,Q[1]=Y*X+V*F+B*Z-K*H,Q[2]=B*X+V*H+K*F-Y*Z,Q[3]=V*X-K*Z-Y*F-B*H,Q}function vJ(Q,$,J){J*=0.5;var K=$[0],Y=$[1],B=$[2],V=$[3],Z=Math.sin(J),F=Math.cos(J);return Q[0]=K*F+V*Z,Q[1]=Y*F+B*Z,Q[2]=B*F-Y*Z,Q[3]=V*F-K*Z,Q}function gJ(Q,$,J){J*=0.5;var K=$[0],Y=$[1],B=$[2],V=$[3],Z=Math.sin(J),F=Math.cos(J);return Q[0]=K*F-B*Z,Q[1]=Y*F+V*Z,Q[2]=B*F+K*Z,Q[3]=V*F-Y*Z,Q}function fJ(Q,$,J){J*=0.5;var K=$[0],Y=$[1],B=$[2],V=$[3],Z=Math.sin(J),F=Math.cos(J);return Q[0]=K*F+Y*Z,Q[1]=Y*F-K*Z,Q[2]=B*F+V*Z,Q[3]=V*F-B*Z,Q}function zJ(Q,$){var J=$[0],K=$[1],Y=$[2];return Q[0]=J,Q[1]=K,Q[2]=Y,Q[3]=Math.sqrt(Math.abs(1-J*J-K*K-Y*Y)),Q}function gQ(Q,$){var J=$[0],K=$[1],Y=$[2],B=$[3],V=Math.sqrt(J*J+K*K+Y*Y),Z=Math.exp(B),F=V>0?Z*Math.sin(V)/V:0;return Q[0]=J*F,Q[1]=K*F,Q[2]=Y*F,Q[3]=Z*Math.cos(V),Q}function fQ(Q,$){var J=$[0],K=$[1],Y=$[2],B=$[3],V=Math.sqrt(J*J+K*K+Y*Y),Z=V>0?Math.atan2(V,B)/V:0;return Q[0]=J*Z,Q[1]=K*Z,Q[2]=Y*Z,Q[3]=0.5*Math.log(J*J+K*K+Y*Y+B*B),Q}function pJ(Q,$,J){return fQ(Q,$),pQ(Q,Q,J),gQ(Q,Q),Q}function A0(Q,$,J,K){var Y=$[0],B=$[1],V=$[2],Z=$[3],F=J[0],H=J[1],X=J[2],W=J[3],P,A,O,C,j;if(A=Y*F+B*H+V*X+Z*W,A<0)A=-A,F=-F,H=-H,X=-X,W=-W;if(1-A>G)P=Math.acos(A),O=Math.sin(P),C=Math.sin((1-K)*P)/O,j=Math.sin(K*P)/O;else C=1-K,j=K;return Q[0]=C*Y+j*F,Q[1]=C*B+j*H,Q[2]=C*V+j*X,Q[3]=C*Z+j*W,Q}function yJ(Q){var $=c(),J=c(),K=c(),Y=Math.sqrt(1-$),B=Math.sqrt($);return Q[0]=Y*Math.sin(2*Math.PI*J),Q[1]=Y*Math.cos(2*Math.PI*J),Q[2]=B*Math.sin(2*Math.PI*K),Q[3]=B*Math.cos(2*Math.PI*K),Q}function xJ(Q,$){var J=$[0],K=$[1],Y=$[2],B=$[3],V=J*J+K*K+Y*Y+B*B,Z=V?1/V:0;return Q[0]=-J*Z,Q[1]=-K*Z,Q[2]=-Y*Z,Q[3]=B*Z,Q}function lJ(Q,$){return Q[0]=-$[0],Q[1]=-$[1],Q[2]=-$[2],Q[3]=$[3],Q}function zQ(Q,$){var J=$[0]+$[4]+$[8],K;if(J>0)K=Math.sqrt(J+1),Q[3]=0.5*K,K=0.5/K,Q[0]=($[5]-$[7])*K,Q[1]=($[6]-$[2])*K,Q[2]=($[1]-$[3])*K;else{var Y=0;if($[4]>$[0])Y=1;if($[8]>$[Y*3+Y])Y=2;var B=(Y+1)%3,V=(Y+2)%3;K=Math.sqrt($[Y*3+Y]-$[B*3+B]-$[V*3+V]+1),Q[Y]=0.5*K,K=0.5/K,Q[3]=($[B*3+V]-$[V*3+B])*K,Q[B]=($[B*3+Y]+$[Y*3+B])*K,Q[V]=($[V*3+Y]+$[Y*3+V])*K}return Q}function mJ(Q,$,J,K){var Y=0.5*Math.PI/180;$*=Y,J*=Y,K*=Y;var B=Math.sin($),V=Math.cos($),Z=Math.sin(J),F=Math.cos(J),H=Math.sin(K),X=Math.cos(K);return Q[0]=B*F*X-V*Z*H,Q[1]=V*Z*X+B*F*H,Q[2]=V*F*H-B*Z*X,Q[3]=V*F*X+B*Z*H,Q}function nJ(Q){return"quat("+Q[0]+", "+Q[1]+", "+Q[2]+", "+Q[3]+")"}var cJ=EQ,dJ=_Q,iJ=DQ,sJ=RQ,bJ=GQ,rJ=vQ,pQ=kQ,yQ=TQ,eJ=SQ,xQ=qQ,uJ=xQ,lQ=MQ,oJ=lQ,g0=LQ,aJ=hQ,tJ=IQ,QK=function(){var Q=W0(),$=j0(1,0,0),J=j0(0,1,0);return function(K,Y,B){var V=P0(Y,B);if(V<-0.999999){if(o(Q,$,Y),w0(Q)<0.000001)o(Q,J,Y);return I0(Q,Q),wQ(K,Q,Math.PI),K}else if(V>0.999999)return K[0]=0,K[1]=0,K[2]=0,K[3]=1,K;else return o(Q,Y,B),K[0]=Q[0],K[1]=Q[1],K[2]=Q[2],K[3]=1+V,g0(K,K)}}(),$K=function(){var Q=v0(),$=v0();return function(J,K,Y,B,V,Z){return A0(Q,K,V,Z),A0($,Y,B,Z),A0(J,Q,$,2*Z*(1-Z)),J}}(),JK=function(){var Q=YQ();return function($,J,K,Y){return Q[0]=K[0],Q[3]=K[1],Q[6]=K[2],Q[1]=Y[0],Q[4]=Y[1],Q[7]=Y[2],Q[2]=-J[0],Q[5]=-J[1],Q[8]=-J[2],g0($,zQ($,Q))}}();var KK=Math.PI/90;class m{m4=Float32Array.from(L.create());constructor(){this.identity()}static create(){return new m}identity(){return L.identity(this.m4),this}invert(Q){return L.invert(this.m4,Q.getMatrix()),this}multiply(Q){return L.multiply(this.m4,this.m4,Q.getMatrix()),this}multiply2(Q,$){return L.multiply(this.m4,Q.getMatrix(),$.getMatrix()),this}multiply3(Q,$,J){return this.multiply2(Q,$),this.multiply(J),this}translate(Q,$,J){return L.translate(this.m4,this.m4,[Q,$,J]),this}translateToMatrix(Q){const $=Q.getMatrix();return this.translate(-$[12],-$[13],-$[14])}rotateX(Q){return L.rotateX(this.m4,this.m4,Q),this}rotateY(Q){return L.rotateY(this.m4,this.m4,Q),this}rotateZ(Q){return L.rotateZ(this.m4,this.m4,Q),this}scale(Q,$,J){return L.scale(this.m4,this.m4,[Q,$??Q,J??Q]),this}perspective(Q,$,J,K){return L.perspective(this.m4,Q*KK,$,J,K),this}ortho(Q,$,J,K,Y,B){return L.ortho(this.m4,Q,$,J,K,Y,B),this}static aTemp=L.create();static bTemp=L.create();combine(Q,$,J=0.5){return L.multiplyScalar(m.aTemp,Q.getMatrix(),1-J),L.multiplyScalar(m.bTemp,$.getMatrix(),J),L.add(this.m4,m.aTemp,m.bTemp),this}static tempQuat=a.create();moveMatrix(Q,$,J,K){const Y=s.fromValues(-Q,$,J);if(K)L.getRotation(m.tempQuat,K.getMatrix()),a.invert(m.tempQuat,m.tempQuat),s.transformQuat(Y,Y,m.tempQuat);return L.translate(this.m4,this.m4,Y),this}getMatrix(){return this.m4}}var M=m;class f0 extends M{constructor(){super(...arguments)}perspectiveMatrix=M.create();orthoMatrix=M.create();perspectiveLevel=1;configPerspectiveMatrix(Q){this.perspectiveMatrix.perspective(45,Q,0.01,1000)}configOrthoMatrix(Q){this.orthoMatrix.ortho(-Q,Q,-1,1,-1000,1000)}configure(Q,$){const J=Q/$;this.configPerspectiveMatrix(J),this.configOrthoMatrix(J)}setPerspective(Q){this.perspectiveLevel=Q,this.combine(this.orthoMatrix,this.perspectiveMatrix,this.perspectiveLevel)}}var p;(function(J){J[J["PROJECTION"]=0]="PROJECTION";J[J["VIEW"]=1]="VIEW"})(p||(p={}));class d{Q;camPositionMatrix=M.create().translate(0,0,-1);projectionMatrix=new f0;camTiltMatrix=M.create();camTurnMatrix=M.create();camMatrix=M.create();hudMatrix=M.create();pespectiveLevel=1;updateListeners=new Set;constructor(Q){this.core=Q}cameraMatrices={[p.PROJECTION]:this.projectionMatrix,[p.VIEW]:this.camMatrix};addUpdateListener(Q){return this.updateListeners.add(Q),()=>{this.removeUpdateListener(Q)}}removeUpdateListener(Q){this.updateListeners.delete(Q)}configProjectionMatrix(Q,$){this.projectionMatrix.configure(Q,$),this.updatePerspective()}refresh(){this.camMatrix.multiply3(this.camTiltMatrix,this.camTurnMatrix,this.camPositionMatrix),this.syncHud(this.hudMatrix),this.updateListeners.forEach((Q)=>Q.onCameraUpdate(this))}onCameraUpdate(){this.core.motor.registerUpdate(this)}updatePerspective(Q){this.projectionMatrix.setPerspective(Q??this.pespectiveLevel),this.onCameraUpdate()}getCameraMatrix(Q){return this.cameraMatrices[Q].getMatrix()}moveCam(Q,$,J){this.camPositionMatrix.moveMatrix(Q,$,J,this.camTurnMatrix),this.onCameraUpdate()}turnCam(Q){this.camTurnMatrix.rotateY(Q),this.onCameraUpdate()}tilt(Q){this.camTiltMatrix.rotateX(Q),this.onCameraUpdate()}getHudMatrix(){return this.hudMatrix}static _position=[0,0,0];getPosition(){const Q=this.camPositionMatrix.getMatrix();return d._position[0]=Q[12],d._position[1]=Q[13],d._position[2]=Q[14],d._position}setPosition(Q,$,J){const K=this.camPositionMatrix.getMatrix();K[12]=Q,K[13]=$,K[14]=J}invertedCamTurnMatrix=M.create();invertedCamTiltMatrix=M.create();syncHud(Q){this.invertedCamTiltMatrix.invert(this.camTiltMatrix),this.invertedCamTurnMatrix.invert(this.camTurnMatrix),Q?.identity().translateToMatrix(this.camPositionMatrix).multiply(this.invertedCamTurnMatrix).multiply(this.invertedCamTiltMatrix).translate(0,0,-0.9)}}var ZK=function(Q){if(!VK)return Q;return new Proxy(Q,{get(J,K){const Y=J,B=Y[K];if(typeof B==="function")return(...Z)=>{const F=B.apply(Y,Z);return console.log(`gl.${String(K)}(`,Z,") = ",F),F};else return console.log(`gl.${String(K)} = `,B),B}})},YK={alpha:!0,antialias:!1,depth:!0,desynchronized:!0,failIfMajorPerformanceCaveat:void 0,powerPreference:"default",premultipliedAlpha:!0,preserveDrawingBuffer:!1,stencil:!1},BK=6,VK=!1;class C0 extends w{gl;programs;attributeBuffers;uniforms;canvas;textureManager;imageManager;textureSlots={};onResize=new Set;spriteCount=0;cameraMatrixUniforms={};constructor(Q,{attributes:$}={}){super();const J=Q.getContext("webgl2",{...YK,...$});this.gl=ZK(J),this.canvas=Q,this.programs=this.own(new D0(this.gl)),this.uniforms=this.own(new k0(this.gl,this.programs)),this.attributeBuffers=this.own(new G0(this.gl,this.programs)),this.textureManager=new T0(this.gl,this.uniforms),this.imageManager=new S0;const K=this.checkCanvasSize.bind(this);window.addEventListener("resize",K),this.addOnDestroy(()=>window.removeEventListener("resize",K)),this.initialize()}addResizeListener(Q){Q(this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.onResize.add(Q)}removeResizeListener(Q){this.onResize.delete(Q)}clearTextureSlots(){for(let Q in this.textureSlots)delete this.textureSlots[Q]}checkCanvasSize(){if(this.canvas instanceof HTMLCanvasElement)this.canvas.width=this.canvas.offsetWidth*2,this.canvas.height=this.canvas.offsetHeight*2;this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.onResize.forEach((Q)=>Q(this.gl.drawingBufferWidth,this.gl.drawingBufferHeight))}initialize(){const $={AUTHOR:"Jack le hamster"};this.programs.addProgram("main",h0(JQ,$),h0(KQ,$)),this.programs.useProgram("main"),this.cameraMatrixUniforms[p.PROJECTION]=this.uniforms.getUniformLocation(o0,"main"),this.cameraMatrixUniforms[p.VIEW]=this.uniforms.getUniformLocation(u0,"main"),this.gl.enable(U.DEPTH_TEST),this.gl.depthFunc(U.LESS),this.gl.clearDepth(1),this.gl.enable(U.BLEND),this.gl.blendFunc(U.SRC_ALPHA,U.ONE_MINUS_SRC_ALPHA),this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.gl.disable(this.gl.CULL_FACE),this.textureManager.initialize(),this.checkCanvasSize()}onCleanupBuffers=new Set;initializeBuffers(Q){if(this.onCleanupBuffers.forEach(($)=>$()),this.onCleanupBuffers.clear(),Q)[this.initializeIndexBuffer(e0),this.initializePositionBuffer(r0),this.initializeTransformBuffer(N0,Q),this.initializeSlotSizeBuffer(E0,Q)].forEach((J)=>this.onCleanupBuffers.add(J))}initializeIndexBuffer(Q){const $=this.attributeBuffers.createBuffer(Q);return this.gl.bindBuffer(U.ELEMENT_ARRAY_BUFFER,$.buffer),this.gl.bufferData(U.ELEMENT_ARRAY_BUFFER,Uint16Array.from([0,1,2,2,3,0]),U.STATIC_DRAW),()=>{this.attributeBuffers.deleteBuffer(Q)}}initializePositionBuffer(Q){const $=this.attributeBuffers.createBuffer(Q);return this.gl.bindBuffer(U.ARRAY_BUFFER,$.buffer),this.gl.vertexAttribPointer($.location,2,U.FLOAT,!1,0,0),this.gl.enableVertexAttribArray($.location),this.gl.bufferData(U.ARRAY_BUFFER,Float32Array.from([-1,-1,1,-1,1,1,-1,1]),U.STATIC_DRAW),()=>{this.gl.disableVertexAttribArray($.location),this.attributeBuffers.deleteBuffer(Q)}}initializeTransformBuffer(Q,$){const J=this.attributeBuffers.createBuffer(Q);this.gl.bindBuffer(U.ARRAY_BUFFER,J.buffer);for(let K=0;K<4;K++){const Y=J.location+K;this.gl.vertexAttribPointer(Y,4,U.FLOAT,!1,16*Float32Array.BYTES_PER_ELEMENT,K*4*Float32Array.BYTES_PER_ELEMENT),this.gl.enableVertexAttribArray(Y),this.gl.vertexAttribDivisor(Y,1)}return this.gl.bufferData(U.ARRAY_BUFFER,$*4*4*Float32Array.BYTES_PER_ELEMENT,U.DYNAMIC_DRAW),()=>{this.gl.disableVertexAttribArray(J.location),this.attributeBuffers.deleteBuffer(Q)}}initializeSlotSizeBuffer(Q,$){const J=this.attributeBuffers.createBuffer(Q);this.gl.bindBuffer(U.ARRAY_BUFFER,J.buffer);const K=J.location;return this.gl.vertexAttribPointer(K,2,U.FLOAT,!1,2*Float32Array.BYTES_PER_ELEMENT,0),this.gl.enableVertexAttribArray(K),this.gl.vertexAttribDivisor(K,1),this.gl.bufferData(U.ARRAY_BUFFER,$*2*Float32Array.BYTES_PER_ELEMENT,U.DYNAMIC_DRAW),()=>{this.gl.disableVertexAttribArray(J.location),this.attributeBuffers.deleteBuffer(Q)}}async updateTextures(Q,$){const J=(await Promise.all(Q.map(async(B)=>{const V=$(B);if(!V){console.warn(`No media for imageId ${B}`);return}return{mediaData:await this.imageManager.renderMedia(B,V),imageId:B}}))).filter((B)=>!!B),K=await Promise.all(J.map(async({mediaData:B,imageId:V})=>{const{slot:Z,refreshCallback:F}=this.textureManager.allocateSlotForImage(B),H=Math.log2(Z.size[0]),X=Math.log2(Z.size[1]),W=H*16+X;return this.textureSlots[V]={buffer:Float32Array.from([W,Z.slotNumber])},B.refreshCallback=F,Z.textureIndex}));return new Set(K).forEach((B)=>{if(B===X0)this.textureManager.setupTextureForVideo(`TEXTURE${B}`);else this.textureManager.generateMipMap(`TEXTURE${B}`)}),J.map(({mediaData:B})=>B)}drawElementsInstanced(Q,$){this.gl.drawElementsInstanced(U.TRIANGLES,Q,U.UNSIGNED_SHORT,0,$)}static spriteMatrix=M.create();updateSpriteTransforms(Q,$){const J=this.attributeBuffers.getAttributeBuffer(N0);this.gl.bindBuffer(U.ARRAY_BUFFER,J.buffer);let K=this.spriteCount-1;Q.forEach((Y)=>{const B=C0.spriteMatrix.identity().getMatrix(),V=$(Y);if(V?.transforms.forEach((Z)=>L.multiply(B,B,Z)),this.gl.bufferSubData(U.ARRAY_BUFFER,16*Float32Array.BYTES_PER_ELEMENT*Y,B),V)K=Math.max(K,Y)}),Q.clear();while(K>=0&&!$(K))K--;this.spriteCount=Math.max(this.spriteCount,K+1)}updateSpriteAnims(Q,$){const J=this.attributeBuffers.getAttributeBuffer(E0);this.gl.bindBuffer(U.ARRAY_BUFFER,J.buffer),Q.forEach((K)=>{const Y=$(K),B=this.textureSlots[Y?.imageId??-1];if(B){const{buffer:V}=B;this.gl.bufferSubData(U.ARRAY_BUFFER,2*Float32Array.BYTES_PER_ELEMENT*K,V),Q.delete(K)}})}updateCameraMatrix(Q,$){this.gl.uniformMatrix4fv(this.cameraMatrixUniforms[Q],!1,$)}bindVertexArray(){return this.own(new R0(this.gl))}refresh(){this.drawElementsInstanced(BK,this.spriteCount)}}var FK=50,t;(function(J){J[J["DEFAULT"]=0]="DEFAULT";J[J["LAST"]=1]="LAST"})(t||(t={}));class z0{updateSchedule=new Map;time=0;loop(Q,$,J,K){return this.registerUpdate(Q,{period:$?1000/$:1,expirationTime:K,priority:J})}registerUpdate(Q,$={}){return $.triggerTime=$.triggerTime??this.time,$.expirationTime=$.expirationTime??Infinity,$.period=$.period,$.priority=$.priority??t.DEFAULT,this.updateSchedule.set(Q,$),()=>this.deregisterUpdate(Q)}deregisterUpdate(Q){this.updateSchedule.delete(Q)}start(){let Q=0;const $={time:0,deltaTime:0},J=[],K=[],Y=[J,K],B=(V)=>{$.deltaTime=Math.min(V-$.time,FK),$.time=V,Q=requestAnimationFrame(B),this.time=V,J.length=0,K.length=0,this.updateSchedule.forEach((Z,F)=>{if(V<Z.triggerTime)return;if(Y[Z.priority].push(F),Z.period&&V<Z.expirationTime)Z.triggerTime=Math.max(Z.triggerTime+Z.period,V);else this.updateSchedule.delete(F)}),Y.forEach((Z)=>Z.forEach((F)=>F.refresh($)))};return requestAnimationFrame(B),()=>cancelAnimationFrame(Q)}}class p0{Q;$;updatedTypes=new Set;constructor(Q,$){this.getCameraMatrix=Q;this.engine=$}withCameraType(Q){return this.updatedTypes.add(Q),this}refresh(){this.updatedTypes.forEach((Q)=>this.engine.updateCameraMatrix(Q,this.getCameraMatrix(Q)))}}class y0{Q;$;J;updatedImageIds=new Set;constructor(Q,$,J){this.motor=Q;this.getMedia=$;this.engine=J}withImageId(Q){return this.updatedImageIds.add(Q),this}refresh(){const Q=Array.from(this.updatedImageIds);this.updatedImageIds.clear(),this.engine.updateTextures(Q,this.getMedia).then(($)=>{$.forEach((J)=>{if(J.isVideo)this.motor.registerUpdate(J,J.schedule)})})}}class x0{Q;$;updatedSpriteIds=new Set;constructor(Q,$){this.getSprite=Q;this.engine=$}withSpriteId(Q){return this.updatedSpriteIds.add(Q),this}refresh(){this.engine.updateSpriteTransforms(this.updatedSpriteIds,this.getSprite)}}class l0{Q;$;J;updatedSpriteIds=new Set;constructor(Q,$,J){this.motor=Q;this.getSprite=$;this.engine=J}withSpriteId(Q){return this.updatedSpriteIds.add(Q),this}refresh(){if(this.engine.updateSpriteAnims(this.updatedSpriteIds,this.getSprite),this.updatedSpriteIds.size)this.motor.registerUpdate(this)}}var HK=200;class m0{keys={};keysUp={};activate(Q){const{core:$}=Q,J=(Y)=>{if(!this.keys[Y.code])this.keys[Y.code]=$.motor.time},K=(Y)=>{if($.motor.time-this.keys[Y.code]<HK)this.keysUp[Y.code]=this.keysUp[Y.code]?0:$.motor.time;else this.keysUp[Y.code]=0;this.keys[Y.code]=0};return document.addEventListener("keydown",J),document.addEventListener("keyup",K),()=>{document.removeEventListener("keydown",J),document.removeEventListener("keyup",K)}}}class n0 extends w{motor;engine;keyboard;camera;constructor({motor:Q,canvas:$,engine:J,keyboard:K,size:Y,camera:B}){super();this.motor=Q??new z0,this.engine=J??new C0($??new OffscreenCanvas(Y[0],Y[1])),this.keyboard=K??new m0,this.camera=B??new d(this),this.initialize()}initialize(){const{engine:Q,motor:$}=this,J=$.loop(Q,void 0,t.LAST);this.addOnDestroy(()=>{J()})}start(Q){const{engine:$,motor:J}=this;$.initializeBuffers(Q.sprites.length),$.clearTextureSlots();const K=this.activate(Q,[Q,this.keyboard]),Y=J.start();return()=>{Y(),K()}}activate(Q,$){const{engine:J,motor:K}=this,Y=new y0(K,Q.medias.at.bind(Q.medias),J),B=new x0(Q.sprites.at.bind(Q.sprites),J),V=new l0(K,Q.sprites.at.bind(Q.sprites),J),Z=new p0(this.camera.getCameraMatrix.bind(this.camera),J),F={["SpriteAnim"]:(W)=>K.registerUpdate(V.withSpriteId(W)),["SpriteTransform"]:(W)=>K.registerUpdate(B.withSpriteId(W)),["Media"]:(W)=>K.registerUpdate(Y.withImageId(W)),["CameraMatrix"]:(W)=>K.registerUpdate(Z.withCameraType(W))},H=new Set;H.add(this.handleResize(F)),H.add(this.handleCamera(F));const X={updateCallback(W,P){F[W](P)},core:this};return $.forEach((W)=>{const P=W.activate(X);H.add(P)}),()=>{H.forEach((W)=>W())}}handleCamera(Q){const $={onCameraUpdate(){Q.CameraMatrix(p.VIEW)}};return this.camera.addUpdateListener($),Q.CameraMatrix(p.PROJECTION),Q.CameraMatrix(p.VIEW),()=>{this.camera.removeUpdateListener($)}}handleResize(Q){const{engine:$}=this,J=(K,Y)=>{this.camera.configProjectionMatrix(K,Y),Q.CameraMatrix(p.PROJECTION)};return $.addResizeListener(J),()=>{$.removeResizeListener(J)}}}class c0{Q;keyboard;constructor(Q){this.camera=Q}activate({core:Q}){this.keyboard=Q.keyboard;const $=Q.motor.loop(this);return()=>{$()}}refresh(Q){if(!this.keyboard)return;const{keys:$}=this.keyboard,{deltaTime:J}=Q,K=J/80,Y=J/400;if($.KeyW||$.ArrowUp&&!$.ShiftRight)this.camera.moveCam(0,0,K);if($.KeyS||$.ArrowDown&&!$.ShiftRight)this.camera.moveCam(0,0,-K);if($.KeyA||$.ArrowLeft&&!$.ShiftRight)this.camera.moveCam(-K,0,0);if($.KeyD||$.ArrowRight&&!$.ShiftRight)this.camera.moveCam(K,0,0);if($.KeyQ||$.ArrowLeft&&$.ShiftRight)this.camera.turnCam(-Y);if($.KeyE||$.ArrowRight&&$.ShiftRight)this.camera.turnCam(Y);if($.ArrowUp&&$.ShiftRight)this.camera.tilt(-Y);if($.ArrowDown&&$.ShiftRight)this.camera.tilt(Y)}}class d0{Q;keyboard;constructor(Q){this.camera=Q}activate({core:Q}){this.keyboard=Q.keyboard;const $=Q.motor.loop(this);return()=>{$()}}refresh(Q){if(!this.keyboard)return;const{deltaTime:$}=Q;this.spaceForRiseAndDrop($,this.keyboard)}spaceForRiseAndDrop(Q,$){const J=Q/80,{keys:K,keysUp:Y}=$;if(K.Space)this.camera.moveCam(0,-J,0);else if(Y.Space){this.camera.moveCam(0,J,0);const[B,V,Z]=this.camera.getPosition();if(V>0)this.camera.setPosition(B,0,Z),Y.Space=0}}}var mQ=0,nQ=1,cQ=2,dQ=3,iQ=4,sQ=5,O0=6,n=512;class i0 extends Q0{sprites;hudSpriteId=0;constructor(Q){super(Q,[new c0(Q.camera),new d0(Q.camera)]);this.addMedia({id:mQ,type:"image",src:"dobuki.png"},{id:nQ,type:"draw",draw:($)=>{const{canvas:J}=$;J.width=n,J.height=n;const K=J.width/2,Y=J.height/2,B=J.width/2;$.imageSmoothingEnabled=!0,$.fillStyle="#ddd",$.lineWidth=J.width/50,$.fillRect(0,0,J.width,J.height),$.strokeStyle="black",$.fillStyle="gold",$.beginPath(),$.arc(K,Y,B*0.8,0,2*Math.PI),$.fill(),$.stroke(),$.beginPath(),$.arc(K,Y,B*0.5,0,Math.PI),$.stroke(),$.beginPath(),$.arc(J.width/3,J.height/3,B*0.1,0,Math.PI,!0),$.stroke(),$.beginPath(),$.arc(J.width/3*2,J.height/3,B*0.1,0,Math.PI*2,!0),$.stroke()}},{id:cQ,type:"draw",draw:($)=>{const{canvas:J}=$;J.width=n,J.height=n,$.imageSmoothingEnabled=!0,$.fillStyle="#ddd",$.lineWidth=J.width/50,$.fillRect(0,0,J.width,J.height),$.strokeStyle="black",$.fillStyle="silver",$.beginPath(),$.rect(J.width*0.2,J.height*0.2,J.width*0.6,J.height*0.6),$.fill(),$.stroke()}},{id:dQ,type:"draw",draw:($)=>{const{canvas:J}=$;J.width=n,J.height=n,$.lineWidth=J.width/50,$.strokeStyle="black",$.beginPath(),$.rect(30,30,J.width-60,J.height-60),$.stroke()}},{id:iQ,type:"video",src:"sample.mp4",volume:0,fps:30},{id:sQ,type:"draw",draw:($)=>{const{canvas:J}=$;J.width=n,J.height=n,$.imageSmoothingEnabled=!0,$.lineWidth=5,$.strokeStyle="green",$.beginPath(),$.rect(10,10,J.width-20,J.height-20),$.stroke()}},{id:O0,type:"draw",draw:($)=>{const{canvas:J}=$;J.width=n,J.height=n,$.imageSmoothingEnabled=!0,$.lineWidth=5,$.setLineDash([5,2]),$.strokeStyle="blue",$.beginPath(),$.rect(10,10,J.width-20,J.height-20),$.stroke()}}),this.sprites=[{imageId:dQ,transforms:[this.core.camera.getHudMatrix().getMatrix()]},{imageId:mQ,transforms:[M.create().translate(0,0,0).getMatrix()]},...[M.create().translate(-1,0,1).rotateY(Math.PI/2).scale(1).getMatrix(),M.create().translate(1,0,1).rotateY(-Math.PI/2).scale(1).getMatrix()].map(($)=>({imageId:nQ,transforms:[$]})),...[M.create().translate(0,-1,1).rotateX(-Math.PI/2).scale(1).getMatrix(),M.create().translate(0,-1,3).rotateX(-Math.PI/2).scale(1).getMatrix(),M.create().translate(-2,-1,3).rotateX(-Math.PI/2).scale(1).getMatrix(),M.create().translate(2,-1,3).rotateX(-Math.PI/2).scale(1).getMatrix()].map(($)=>({imageId:cQ,transforms:[$]})),{imageId:iQ,transforms:[M.create().translate(0,5,-10).scale(9.6,5.4,1).getMatrix()]},...new Array(400).fill(0).map(($,J)=>M.create().translate((J%20-10)*2,-1.5,(Math.floor(J/20)-10)*2+1).rotateX(-Math.PI/2).scale(1).getMatrix()).map(($)=>({imageId:sQ,transforms:[$]})),...new Array(400).fill(0).map(($,J)=>M.create().translate((J%20-10)*2,-1,(Math.floor(J/20)-10)*2+1).rotateX(-Math.PI/2).scale(1).getMatrix()).map(($)=>({imageId:O0,transforms:[$]})),...new Array(400).fill(0).map(($,J)=>M.create().translate((J%20-10)*2,1,(Math.floor(J/20)-10)*2+1).rotateX(-Math.PI/2).scale(1).getMatrix()).map(($)=>({imageId:O0,transforms:[$]})),...new Array(400).fill(0).map(($,J)=>M.create().translate((J%20-10)*2,0,(Math.floor(J/20)-10)*2+1).getMatrix()).map(($)=>({imageId:O0,transforms:[$]}))]}activate(Q){const $=super.activate(Q);this.sprites.forEach((K,Y)=>{this.informUpdate("SpriteTransform",Y),this.informUpdate("SpriteAnim",Y)});const J=Q.core.camera.addUpdateListener({onCameraUpdate:()=>this.informUpdate("SpriteTransform",this.hudSpriteId)});return()=>{J(),$()}}}async function e8(){console.log("Hello World!")}async function u8(Q){Q.style.border="2px solid silver",Q.style.cursor="grab",Q.addEventListener("mouseenter",()=>{Q.style.borderColor="black"}),Q.addEventListener("mouseleave",()=>{Q.style.borderColor="silver"});const $=new n0({canvas:Q}),J=new i0($);return bQ=$.start(J),$}function o8(){bQ()}var bQ;export{u8 as testCanvas,o8 as stop,e8 as hello,Q0 as World};

//# debugId=BB2A65BCE658DC7764756e2164756e21
